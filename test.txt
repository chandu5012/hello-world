### App.py

from flask import Flask, render_template, request, jsonify, Response, send_file
from flask_socketio import SocketIO, emit
import json
import time
import paramiko
import shlex
import threading
import uuid
import os
from io import StringIO, BytesIO
from queue import Queue
from collections import defaultdict
from datetime import datetime
import tempfile

# Excel parsing
try:
    import openpyxl
    OPENPYXL_AVAILABLE = True
except ImportError:
    OPENPYXL_AVAILABLE = False

app = Flask(__name__)
app.config['SECRET_KEY'] = 'your-secret-key-here'
app.config['MAX_CONTENT_LENGTH'] = 50 * 1024 * 1024  # 50MB max upload
socketio = SocketIO(app, cors_allowed_origins="*")

# ============================================================
# RUN REGISTRY - In-memory storage for execution state
# ============================================================
run_registry = {}
# Structure:
# {
#   run_id: {
#     'status': 'PENDING' | 'RUNNING' | 'SUCCESS' | 'FAILED' | 'STOPPED' | 'PARTIAL_SUCCESS',
#     'logs': [],
#     'tab': str,
#     'params': dict,
#     'thread': Thread,
#     'ssh_client': SSHClient or None,
#     'stop_requested': bool,
#     'rows_status': [],  # For multi-table runs: [{row_index, table, keys, status, error}]
#     'total_rows': 0,
#     'started_at': datetime,
#     'finished_at': datetime
#   }
# }

# Tab to script mapping
TAB_SCRIPT_MAP = {
    'data_comparison': 'compare_job.sh',  # Script name only (not path) - for single_table mode
    'data_load': 'run_data_load.sh',
    'schema_generation': 'run_schema_generation.sh',
    'file_load': 'run_file_load.sh',
    'file_download': 'run_file_download.sh'
}

# Multi-table script (used only when mode == 'multiple_tables')
MULTI_TABLE_SCRIPT = 'run_data_comparison.sh'

# Single-table script for data comparison
SINGLE_TABLE_SCRIPT = 'compare_job.sh'

# ============================================================
# GLOBAL WORKING DIRECTORY MANAGEMENT
# ============================================================
def resolve_execution_context(params, run_id=None):
    """
    Resolve execution context including working_dir, batch_id, and env.
    
    This is the CENTRAL function for computing working_dir.
    All execution paths MUST use this function to get execution context.
    
    Returns:
        dict: {
            'working_dir': str,  # e.g., '/home/chandra/BATCH001/dev'
            'batch_id': str,
            'env': str,
            'unix_config': dict,
            'error': str or None
        }
    """
    # Get Unix config from params
    unix_config = get_unix_config_from_params(params)
    
    # Check for missing host error
    if 'error' in unix_config:
        return {
            'working_dir': None,
            'batch_id': None,
            'env': None,
            'unix_config': unix_config,
            'error': unix_config['error']
        }
    
    # Validate batch_id is provided
    batch_id = unix_config.get('batch_id', '').strip()
    if not batch_id:
        return {
            'working_dir': None,
            'batch_id': None,
            'env': None,
            'unix_config': unix_config,
            'error': 'Batch ID is required for execution'
        }
    
    # Determine environment from unix host
    env, env_error = determine_environment_from_host(unix_config['host'])
    if env_error:
        return {
            'working_dir': None,
            'batch_id': batch_id,
            'env': None,
            'unix_config': unix_config,
            'error': env_error
        }
    
    # Compute working directory ONCE
    working_dir = f'/home/chandra/{batch_id}/{env}'
    
    return {
        'working_dir': working_dir,
        'batch_id': batch_id,
        'env': env,
        'unix_config': unix_config,
        'error': None
    }


def get_working_dir(run_id):
    """
    Get the global working_dir for a run from the registry.
    
    This ensures all execution paths use the same working_dir.
    """
    if run_id in run_registry:
        return run_registry[run_id].get('working_dir')
    return None


def set_execution_context(run_id, working_dir, batch_id, env):
    """
    Store execution context in run registry.
    Called once when execution starts.
    """
    if run_id in run_registry:
        run_registry[run_id]['working_dir'] = working_dir
        run_registry[run_id]['batch_id'] = batch_id
        run_registry[run_id]['env'] = env


def determine_environment_from_host(unix_host):
    """
    Determine environment (dev/sit/uat) from unix_host.
    
    Mapping:
    - compute-1 or compute-2 -> dev
    - compute-3 or compute-4 -> sit
    - compute-5 or compute-6 -> uat
    
    Returns: (env, error) tuple. If env cannot be determined, returns (None, error_message).
    """
    host_lower = unix_host.lower() if unix_host else ''
    
    if 'compute-1' in host_lower or 'compute-2' in host_lower:
        return ('dev', None)
    elif 'compute-3' in host_lower or 'compute-4' in host_lower:
        return ('sit', None)
    elif 'compute-5' in host_lower or 'compute-6' in host_lower:
        return ('uat', None)
    else:
        return (None, f"Unable to determine environment (dev/sit/uat) from unix host: {unix_host}")


def build_command_with_working_dir(script_path, params, batch_id, env):
    """
    Build shell command with cd to working directory and properly escaped arguments.
    
    Command format: cd /home/chandra/{batch_id}/{env}/ && {script_path} {args}
    """
    working_dir = f'/home/chandra/{batch_id}/{env}'
    
    # Build argument list
    command_parts = [script_path]
    
    for key, value in params.items():
        if value is not None and value != '':
            escaped_value = escape_shell_arg(value)
            # Convert camelCase to snake_case for CLI args
            cli_key = ''.join(['_' + c.lower() if c.isupper() else c for c in key]).lstrip('_')
            command_parts.append(f'--{cli_key}={escaped_value}')
    
    script_command = ' '.join(command_parts)
    
    # Build full command with cd
    full_command = f'cd {shlex.quote(working_dir)} && {script_command}'
    
    return full_command, working_dir


def normalize_comparison_mode(params):
    """
    Extract and normalize the comparison mode from request params.
    
    Accepts common names: mode, compare_mode, comparison_mode, table_mode
    Normalizes values like "Single Table", "single", "single_table" into "single_table"
    Normalizes "Multiple Tables", "multi", "multiple_tables" into "multiple_tables"
    
    Returns: 'single_table' (default) or 'multiple_tables'
    """
    # Extract mode from various possible field names
    raw_mode = (
        params.get('mode') or
        params.get('compare_mode') or
        params.get('comparison_mode') or
        params.get('table_mode') or
        params.get('tableMode') or
        ''
    ).strip().lower().replace(' ', '_').replace('-', '_')
    
    # Normalize to canonical values
    if raw_mode in ['multiple_tables', 'multi', 'multiple', 'multi_table']:
        return 'multiple_tables'
    
    # Default to single_table
    return 'single_table'


def normalize_comparison_type(params):
    """
    Extract and normalize the comparison type from request params.
    
    Returns: 'database_to_database', 'file_to_database', 'file_to_file', 'database_to_file'
    """
    raw_type = (
        params.get('comparison_type') or
        params.get('comparisonType') or
        params.get('comparison-type-select') or
        ''
    ).strip().lower().replace('-', '_')
    
    if raw_type in ['db_to_db', 'database_to_database', 'db_db']:
        return 'database_to_database'
    elif raw_type in ['file_to_db', 'file_to_database', 'file_db']:
        return 'file_to_database'
    elif raw_type in ['file_to_file', 'file_file']:
        return 'file_to_file'
    elif raw_type in ['db_to_file', 'database_to_file', 'db_file']:
        return 'database_to_file'
    
    # Default
    return 'database_to_database'


def determine_download_filename(params):
    """
    Determine the output filename for single_table comparison based on comparison type.
    
    Output filename rules:
    - database_to_database â†’ {target_table}.csv
    - file_to_database â†’ {target_table}.csv
    - file_to_file â†’ file_to_file.csv
    - database_to_file â†’ db_to_file.csv
    
    Returns dict with 'filename' and 'unix_path'
    """
    comparison_type = normalize_comparison_type(params)
    
    # Get target table name for db_to_db and file_to_db
    target_table = (
        params.get('target_table_name') or
        params.get('targetTableName') or
        params.get('comparisonTargetTableName') or
        params.get('target_table') or
        params.get('targetTable') or
        ''
    ).strip()
    
    if comparison_type == 'database_to_database':
        if target_table:
            filename = f'{target_table}.csv'
        else:
            filename = 'comparison_output.csv'
    elif comparison_type == 'file_to_database':
        if target_table:
            filename = f'{target_table}.csv'
        else:
            filename = 'comparison_output.csv'
    elif comparison_type == 'file_to_file':
        filename = 'file_to_file.csv'
    elif comparison_type == 'database_to_file':
        filename = 'db_to_file.csv'
    else:
        filename = 'comparison_output.csv'
    
    # Assume the script outputs to /tmp/output.csv or a known location
    # The download endpoint will try multiple paths if the primary fails
    unix_path = '/tmp/output.csv'
    
    return {
        'filename': filename,
        'unix_path': unix_path
    }


def extract_time_zone(params):
    """
    Extract time zone from request params.
    
    Returns the time zone value or 'N/A' as default.
    Accepts: time_zone, timeZone, comparisonTimeZone, loadTimeZone
    """
    time_zone = (
        params.get('time_zone') or
        params.get('timeZone') or
        params.get('comparisonTimeZone') or
        params.get('comparison_time_zone') or
        params.get('loadTimeZone') or
        params.get('load_time_zone') or
        ''
    ).strip()
    
    return time_zone if time_zone else 'N/A'


def extract_data_load_fields(params):
    """
    Extract Data Load specific fields from request params.
    
    Returns dict with:
    - target_load_type: 'overwrite' or 'append'
    - hadoop_path: Hadoop path (required if target is Hive)
    - partition_id: Partition ID (defaults to 'N/A' if empty)
    - target_db_type: Target database type for Hive detection
    """
    result = {}
    
    # Target Load Type (overwrite/append)
    target_load_type = (
        params.get('target_load_type') or
        params.get('targetLoadType') or
        params.get('loadTargetLoadType') or
        ''
    ).strip().lower()
    result['target_load_type'] = target_load_type
    
    # Target Database Type (to detect Hive)
    target_db_type = (
        params.get('loadTargetType') or
        params.get('load_target_type') or
        params.get('target_type') or
        params.get('targetType') or
        ''
    ).strip()
    result['target_db_type'] = target_db_type
    
    # Hive-specific fields
    if target_db_type.lower() == 'hive':
        # Hadoop Path (required for Hive)
        hadoop_path = (
            params.get('hadoop_path') or
            params.get('hadoopPath') or
            params.get('loadTargetHadoopPath') or
            ''
        ).strip()
        result['hadoop_path'] = hadoop_path
        
        # Partition ID (defaults to N/A)
        partition_id = (
            params.get('partition_id') or
            params.get('partitionId') or
            params.get('loadTargetPartitionId') or
            ''
        ).strip()
        result['partition_id'] = partition_id if partition_id else 'N/A'
    else:
        result['hadoop_path'] = ''
        result['partition_id'] = ''
    
    return result


def validate_data_load_params(params):
    """
    Validate Data Load specific parameters.
    
    Returns (is_valid, error_message) tuple.
    """
    load_fields = extract_data_load_fields(params)
    
    # Validate target_load_type is present
    if not load_fields['target_load_type']:
        return (False, 'Target Load Type is required (overwrite or append)')
    
    if load_fields['target_load_type'] not in ['overwrite', 'append']:
        return (False, f'Invalid Target Load Type: {load_fields["target_load_type"]}. Must be "overwrite" or "append"')
    
    # If target is Hive, require hadoop_path
    if load_fields['target_db_type'].lower() == 'hive':
        if not load_fields['hadoop_path']:
            return (False, 'Hadoop Path is required when target database is Hive')
    
    return (True, None)


def extract_file_load_source_fields(params):
    """
    Extract File Load SOURCE fields (file-based) from request params.
    
    Returns dict with:
    - source_file_type: CSV, JSON, XML, Parquet, Excel
    - source_location_type: unix, hadoop, upload
    - source_unix_path / source_hadoop_path
    - source_delimiter
    - source_file_sql_query
    - source_key_columns
    """
    result = {}
    
    # File Type
    source_file_type = (
        params.get('source_file_type') or
        params.get('sourceFileType') or
        params.get('fileloadSourceFileType') or
        ''
    ).strip().lower()
    result['source_file_type'] = source_file_type
    
    # Location Type
    source_location_type = (
        params.get('source_location_type') or
        params.get('sourceLocationType') or
        params.get('fileloadSourceLocationType') or
        ''
    ).strip().lower()
    result['source_location_type'] = source_location_type
    
    # File paths based on location type
    if source_location_type == 'unix':
        result['source_unix_path'] = (
            params.get('source_unix_path') or
            params.get('sourceUnixPath') or
            params.get('fileloadSourceUnixPath') or
            ''
        ).strip()
        result['source_hadoop_path'] = ''
    elif source_location_type == 'hadoop':
        result['source_hadoop_path'] = (
            params.get('source_hadoop_path') or
            params.get('sourceHadoopPath') or
            params.get('fileloadSourceHadoopPath') or
            ''
        ).strip()
        result['source_unix_path'] = ''
    else:
        result['source_unix_path'] = ''
        result['source_hadoop_path'] = ''
    
    # Delimiter (for CSV)
    source_delimiter = (
        params.get('source_delimiter') or
        params.get('sourceDelimiter') or
        params.get('fileloadSourceDelimiter') or
        ','
    ).strip()
    result['source_delimiter'] = source_delimiter
    
    # SQL Query (default to N/A)
    source_sql = (
        params.get('source_file_sql_query') or
        params.get('sourceFileSqlQuery') or
        params.get('fileloadSourceFileSqlQuery') or
        ''
    ).strip()
    result['source_file_sql_query'] = source_sql if source_sql else 'N/A'
    
    # Key Columns
    source_key_columns = (
        params.get('source_key_columns') or
        params.get('sourceKeyColumns') or
        params.get('fileloadSourceKeyColumns') or
        ''
    ).strip()
    result['source_key_columns'] = source_key_columns
    
    return result


def extract_file_load_target_fields(params):
    """
    Extract File Load TARGET fields (database) from request params.
    Same as Data Load target fields.
    
    Returns dict with:
    - target_load_type: 'overwrite' or 'append'
    - target_db_type: Database type (for Hive detection)
    - hadoop_path: Hadoop path (for Hive)
    - partition_id: Partition ID (for Hive, defaults to N/A)
    """
    result = {}
    
    # Target Load Type (overwrite/append)
    target_load_type = (
        params.get('target_load_type') or
        params.get('targetLoadType') or
        params.get('fileloadTargetLoadType') or
        ''
    ).strip().lower()
    result['target_load_type'] = target_load_type
    
    # Target Database Type (to detect Hive)
    target_db_type = (
        params.get('fileloadTargetType') or
        params.get('fileload_target_type') or
        params.get('target_type') or
        params.get('targetType') or
        ''
    ).strip()
    result['target_db_type'] = target_db_type
    
    # Hive-specific fields
    if target_db_type.lower() == 'hive':
        # Hadoop Path (required for Hive)
        hadoop_path = (
            params.get('hadoop_path') or
            params.get('hadoopPath') or
            params.get('fileloadTargetHadoopPath') or
            ''
        ).strip()
        result['hadoop_path'] = hadoop_path
        
        # Partition ID (defaults to N/A)
        partition_id = (
            params.get('partition_id') or
            params.get('partitionId') or
            params.get('fileloadTargetPartitionId') or
            ''
        ).strip()
        result['partition_id'] = partition_id if partition_id else 'N/A'
    else:
        result['hadoop_path'] = ''
        result['partition_id'] = ''
    
    return result


def validate_file_load_params(params):
    """
    Validate File Load specific parameters (File-to-Database).
    
    Returns (is_valid, error_message) tuple.
    """
    source_fields = extract_file_load_source_fields(params)
    target_fields = extract_file_load_target_fields(params)
    
    # Validate source file type is present
    if not source_fields['source_file_type']:
        return (False, 'Source File Type is required')
    
    # Validate source location type is present
    if not source_fields['source_location_type']:
        return (False, 'Source Location Type is required')
    
    # Validate path based on location type
    if source_fields['source_location_type'] == 'unix' and not source_fields['source_unix_path']:
        return (False, 'Source Unix Path is required when location type is Unix')
    
    if source_fields['source_location_type'] == 'hadoop' and not source_fields['source_hadoop_path']:
        return (False, 'Source Hadoop Path is required when location type is Hadoop')
    
    # Validate target_load_type is present
    if not target_fields['target_load_type']:
        return (False, 'Target Load Type is required (overwrite or append)')
    
    if target_fields['target_load_type'] not in ['overwrite', 'append']:
        return (False, f'Invalid Target Load Type: {target_fields["target_load_type"]}. Must be "overwrite" or "append"')
    
    # If target is Hive, require hadoop_path
    if target_fields['target_db_type'].lower() == 'hive':
        if not target_fields['hadoop_path']:
            return (False, 'Hadoop Path is required when target database is Hive')
    
    return (True, None)

# ============================================================
# UNIX SSH CONFIG FROM ENVIRONMENT VARIABLES
# ============================================================
def get_unix_config():
    """Get Unix server configuration from environment variables"""
    return {
        'host': os.environ.get('UNIX_HOST', 'localhost'),
        'port': int(os.environ.get('UNIX_PORT', '22')),
        'username': os.environ.get('UNIX_USER', 'user'),
        'auth_method': os.environ.get('UNIX_AUTH_METHOD', 'password'),  # 'key' or 'password'
        'private_key': os.environ.get('UNIX_PRIVATE_KEY', ''),
        'password': os.environ.get('UNIX_PASSWORD', '')
    }

def get_unix_config_from_params(params):
    """
    Get Unix server configuration from request params with environment variable fallback.
    
    UI-provided unix_host MUST override any default or env-based host.
    Returns error dict if unix_host is missing.
    
    Expected field names (checked in order):
    - unix_host / unixHost / unixHostname / executionHost
    - user_email / userEmail (for audit/logging purposes)
    - unix_username / unixUsername / unix_user / unixUser
    - unix_password / unixPassword
    - batch_id / batchId
    
    NOTE: SSH port is ALWAYS hardcoded to 22.
    NOTE: SSH key authentication has been removed. Password auth only.
    """
    # Extract Unix host - check multiple possible field names
    unix_host = (
        params.get('unix_host') or 
        params.get('unixHost') or 
        params.get('unixHostname') or 
        params.get('executionHost') or
        params.get('comparisonUnixHost') or
        params.get('loadUnixHost') or
        params.get('schemaUnixHost') or
        params.get('fileloadUnixHost') or
        params.get('filedownloadUnixHost') or
        params.get('mismatchUnixHost') or
        ''
    ).strip()
    
    # Validate unix_host is provided - do not default to localhost
    if not unix_host:
        return {
            'error': 'Unix host is required for execution. Please provide a valid Unix host in the form.'
        }
    
    # SSH port is ALWAYS 22 - hardcoded, not from UI
    unix_port = 22
    
    # Extract User Email (for audit/logging purposes)
    user_email = (
        params.get('user_email') or
        params.get('userEmail') or
        params.get('comparisonUserEmail') or
        params.get('loadUserEmail') or
        params.get('schemaUserEmail') or
        params.get('fileloadUserEmail') or
        params.get('filedownloadUserEmail') or
        params.get('mismatchUserEmail') or
        ''
    ).strip()
    
    # Extract Unix username
    unix_username = (
        params.get('unix_username') or 
        params.get('unixUsername') or
        params.get('unix_user') or
        params.get('unixUser') or
        params.get('comparisonUnixUsername') or
        params.get('loadUnixUsername') or
        params.get('schemaUnixUsername') or
        params.get('fileloadUnixUsername') or
        params.get('filedownloadUnixUsername') or
        params.get('mismatchUnixUsername') or
        os.environ.get('UNIX_USER', 'user')
    ).strip()
    
    # Extract Unix password - do NOT strip internal spaces, only ends
    unix_password = (
        params.get('unix_password') or 
        params.get('unixPassword') or
        params.get('comparisonUnixPassword') or
        params.get('loadUnixPassword') or
        params.get('schemaUnixPassword') or
        params.get('fileloadUnixPassword') or
        params.get('filedownloadUnixPassword') or
        params.get('mismatchUnixPassword') or
        os.environ.get('UNIX_PASSWORD', '')
    )
    if unix_password:
        unix_password = unix_password.lstrip().rstrip()  # Safe strip
    
    # Extract Batch ID
    batch_id = (
        params.get('batch_id') or 
        params.get('batchId') or
        params.get('comparisonBatchId') or
        params.get('loadBatchId') or
        params.get('schemaBatchId') or
        params.get('fileloadBatchId') or
        params.get('filedownloadBatchId') or
        params.get('mismatchBatchId') or
        ''
    ).strip()
    
    # Always use password authentication (SSH key auth removed)
    return {
        'host': unix_host,
        'port': unix_port,  # Always 22
        'username': unix_username,
        'auth_method': 'password',
        'password': unix_password,
        'batch_id': batch_id,
        'user_email': user_email  # Captured for audit/logging
    }


def extract_file_path_fields(params):
    """
    Extract file path fields from request params.
    
    Handles location_type (unix/hadoop) and returns the appropriate path fields.
    Also handles file_sql_query - defaults to "N/A" if empty.
    
    Returns dict with:
    - source_unix_path / source_hadoop_path
    - target_unix_path / target_hadoop_path
    - source_file_sql_query / target_file_sql_query
    - source_location_type / target_location_type
    """
    result = {}
    
    # Source location type handling
    source_location_type = (
        params.get('source_location_type') or
        params.get('sourceLocationType') or
        params.get('comparisonSourceLocationType') or
        ''
    ).strip().lower()
    
    result['source_location_type'] = source_location_type
    
    if source_location_type == 'unix':
        result['source_unix_path'] = (
            params.get('source_unix_path') or
            params.get('sourceUnixPath') or
            params.get('comparisonSourceUnixPath') or
            ''
        ).strip()
        result['source_hadoop_path'] = ''
    elif source_location_type == 'hadoop':
        result['source_hadoop_path'] = (
            params.get('source_hadoop_path') or
            params.get('sourceHadoopPath') or
            params.get('comparisonSourceHadoopPath') or
            ''
        ).strip()
        result['source_unix_path'] = ''
    else:
        # Fallback: check for generic file path
        result['source_unix_path'] = (
            params.get('source_file_path') or
            params.get('sourceFilePath') or
            params.get('comparisonSourceFilePath') or
            ''
        ).strip()
        result['source_hadoop_path'] = ''
    
    # Target location type handling
    target_location_type = (
        params.get('target_location_type') or
        params.get('targetLocationType') or
        params.get('comparisonTargetLocationType') or
        ''
    ).strip().lower()
    
    result['target_location_type'] = target_location_type
    
    if target_location_type == 'unix':
        result['target_unix_path'] = (
            params.get('target_unix_path') or
            params.get('targetUnixPath') or
            params.get('comparisonTargetUnixPath') or
            ''
        ).strip()
        result['target_hadoop_path'] = ''
    elif target_location_type == 'hadoop':
        result['target_hadoop_path'] = (
            params.get('target_hadoop_path') or
            params.get('targetHadoopPath') or
            params.get('comparisonTargetHadoopPath') or
            ''
        ).strip()
        result['target_unix_path'] = ''
    else:
        # Fallback: check for generic file path
        result['target_unix_path'] = (
            params.get('target_file_path') or
            params.get('targetFilePath') or
            params.get('comparisonTargetFilePath') or
            ''
        ).strip()
        result['target_hadoop_path'] = ''
    
    # Handle file SQL query - default to "N/A" if empty
    source_file_sql = (
        params.get('source_file_sql_query') or
        params.get('sourceFileSqlQuery') or
        params.get('comparisonSourceFileSqlQuery') or
        ''
    ).strip()
    result['source_file_sql_query'] = source_file_sql if source_file_sql else 'N/A'
    
    target_file_sql = (
        params.get('target_file_sql_query') or
        params.get('targetFileSqlQuery') or
        params.get('comparisonTargetFileSqlQuery') or
        ''
    ).strip()
    result['target_file_sql_query'] = target_file_sql if target_file_sql else 'N/A'
    
    return result


# ============================================================
# ROUTES
# ============================================================
@app.route('/')
def index():
    return render_template('index.html')

# ============================================================
# STATIC EXECUTION API - POST /api/static/run
# ============================================================
@app.route('/api/static/run', methods=['POST'])
def static_run():
    """
    Generic execution endpoint for static UI.
    Request payload:
    {
        "tab": "data_comparison" | "data_load" | "schema_generation" | "file_load" | "file_download",
        "params": { all form fields visible in the selected tab }
    }
    Returns: { "run_id": "uuid", "status": "PENDING" }
    """
    try:
        data = request.json
        tab = data.get('tab')
        params = data.get('params', {})
        
        if not tab or tab not in TAB_SCRIPT_MAP:
            return jsonify({
                'error': f'Invalid tab: {tab}. Must be one of: {list(TAB_SCRIPT_MAP.keys())}'
            }), 400
        
        # Generate unique run ID
        run_id = str(uuid.uuid4())[:8]
        
        # Initialize run entry
        run_registry[run_id] = {
            'status': 'PENDING',
            'logs': [],
            'tab': tab,
            'params': params,
            'thread': None,
            'ssh_client': None,
            'stop_requested': False
        }
        
        # Start execution in background thread
        thread = threading.Thread(
            target=execute_static_operation,
            args=(run_id, tab, params)
        )
        thread.daemon = True
        run_registry[run_id]['thread'] = thread
        thread.start()
        
        return jsonify({
            'run_id': run_id,
            'status': 'PENDING',
            'message': f'{tab} operation started'
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

# ============================================================
# STATIC LOGS API - GET /api/static/logs/<run_id> (SSE)
# ============================================================
@app.route('/api/static/logs/<run_id>')
def static_logs(run_id):
    """
    Server-Sent Events endpoint for real-time log streaming.
    Streams stdout + stderr line by line until completion.
    """
    def generate():
        if run_id not in run_registry:
            yield f"data: {json.dumps({'type': 'error', 'message': 'Run ID not found'})}\n\n"
            return
        
        run_entry = run_registry[run_id]
        last_index = 0
        
        # Send initial status
        yield f"data: {json.dumps({'type': 'status', 'status': run_entry['status']})}\n\n"
        
        while True:
            # Check if run exists
            if run_id not in run_registry:
                yield f"data: {json.dumps({'type': 'end', 'message': 'Run cleared'})}\n\n"
                break
            
            run_entry = run_registry[run_id]
            
            # Send any new logs
            current_logs = run_entry['logs']
            if len(current_logs) > last_index:
                for log in current_logs[last_index:]:
                    yield f"data: {json.dumps({'type': 'log', 'message': log})}\n\n"
                last_index = len(current_logs)
            
            # Check if execution is complete
            status = run_entry['status']
            if status in ['SUCCESS', 'FAILED', 'STOPPED', 'PARTIAL_SUCCESS']:
                # For multi-table runs, include summary
                summary = {}
                if run_entry.get('rows_status'):
                    rows_status = run_entry['rows_status']
                    summary = {
                        'total_rows': run_entry.get('total_rows', 0),
                        'success_count': sum(1 for r in rows_status if r.get('status') == 'SUCCESS'),
                        'failed_count': sum(1 for r in rows_status if r.get('status') == 'FAILED')
                    }
                
                # For single_table data_comparison, include download info
                download_info = {}
                if run_entry.get('download_available'):
                    download_info = {
                        'download_available': True,
                        'download_url': f'/api/static/comparison/download/{run_id}',
                        'download_filename': run_entry.get('download_filename', 'output.csv')
                    }
                
                yield f"data: {json.dumps({'type': 'status', 'status': status, 'summary': summary, **download_info})}\n\n"
                yield f"data: {json.dumps({'type': 'end', 'status': status, 'summary': summary, **download_info})}\n\n"
                break
            
            # Small delay to prevent CPU spinning
            time.sleep(0.1)
    
    return Response(
        generate(),
        mimetype='text/event-stream',
        headers={
            'Cache-Control': 'no-cache',
            'Connection': 'keep-alive',
            'X-Accel-Buffering': 'no'
        }
    )

# ============================================================
# CONTROL ENDPOINTS
# ============================================================
@app.route('/api/static/stop/<run_id>', methods=['POST'])
def static_stop(run_id):
    """Stop execution for a given run_id"""
    if run_id not in run_registry:
        return jsonify({'error': 'Run ID not found'}), 404
    
    run_entry = run_registry[run_id]
    run_entry['stop_requested'] = True
    
    # Close SSH connection if active
    if run_entry.get('ssh_client'):
        try:
            run_entry['ssh_client'].close()
        except:
            pass
    
    run_entry['status'] = 'STOPPED'
    add_log(run_id, 'â›” Execution stopped by user')
    
    return jsonify({'status': 'STOPPED', 'message': 'Execution stopped'})

@app.route('/api/static/clear/<run_id>', methods=['POST'])
def static_clear(run_id):
    """Clear logs for a given run_id"""
    if run_id not in run_registry:
        return jsonify({'error': 'Run ID not found'}), 404
    
    run_registry[run_id]['logs'] = []
    
    return jsonify({'status': 'cleared', 'message': 'Logs cleared'})

@app.route('/api/static/status/<run_id>')
def static_status(run_id):
    """Get current status for a run"""
    if run_id not in run_registry:
        return jsonify({'error': 'Run ID not found'}), 404
    
    run_entry = run_registry[run_id]
    response = {
        'run_id': run_id,
        'status': run_entry['status'],
        'log_count': len(run_entry['logs']),
        'tab': run_entry['tab']
    }
    
    # Include download info if available
    if run_entry.get('download_available'):
        response['download_available'] = True
        response['download_filename'] = run_entry.get('download_filename', 'output.csv')
    
    return jsonify(response)


# ============================================================
# SINGLE TABLE COMPARISON - FILE DOWNLOAD ENDPOINT
# ============================================================
@app.route('/api/static/comparison/download/<run_id>')
def static_comparison_download(run_id):
    """
    Download the comparison output file from Unix server /tmp/ folder.
    
    This endpoint is for single_table mode only.
    After the comparison script completes, this fetches the output CSV
    from the Unix server and returns it as a downloadable file.
    
    Output filename rules:
    - database_to_database â†’ {target_table}.csv
    - file_to_database â†’ {target_table}.csv
    - file_to_file â†’ file_to_file.csv
    - database_to_file â†’ db_to_file.csv
    """
    try:
        if run_id not in run_registry:
            return jsonify({'error': 'Run ID not found'}), 404
        
        run_entry = run_registry[run_id]
        
        # Validate this is a completed single_table data_comparison run
        if run_entry['tab'] != 'data_comparison':
            return jsonify({'error': 'Download is only available for data comparison runs'}), 400
        
        if run_entry['status'] not in ['SUCCESS', 'PARTIAL_SUCCESS']:
            return jsonify({'error': f'Cannot download - run status is {run_entry["status"]}'}), 400
        
        # Get download info from run_entry
        if not run_entry.get('download_available'):
            return jsonify({'error': 'No download available for this run. This may be a multiple_tables run.'}), 400
        
        unix_source_path = run_entry.get('unix_output_path')
        download_filename = run_entry.get('download_filename', 'output.csv')
        
        if not unix_source_path:
            return jsonify({'error': 'Output file path not found in run registry'}), 500
        
        # Get Unix config from params
        params = run_entry.get('params', {})
        unix_config = get_unix_config_from_params(params)
        
        if 'error' in unix_config:
            return jsonify({'error': unix_config['error']}), 400
        
        print(f"â¬‡ï¸ Preparing download from Unix: {unix_source_path} as {download_filename}")
        
        # Connect to Unix server via SFTP
        try:
            ssh_client = paramiko.SSHClient()
            ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            
            ssh_client.connect(
                hostname=unix_config['host'],
                port=unix_config['port'],
                username=unix_config['username'],
                password=unix_config['password'],
                timeout=30
            )
            
            sftp = ssh_client.open_sftp()
            
            # Create a temporary file to store the downloaded content
            temp_file = tempfile.NamedTemporaryFile(delete=False, suffix='.csv')
            temp_path = temp_file.name
            temp_file.close()
            
            try:
                # Download file from Unix server
                sftp.get(unix_source_path, temp_path)
                print(f"âœ… Downloaded file from {unix_source_path} to {temp_path}")
            except FileNotFoundError:
                # Try alternative paths in /tmp
                alt_paths = [
                    '/tmp/output.csv',
                    '/tmp/comparison_output.csv',
                    f'/tmp/{download_filename}'
                ]
                
                file_found = False
                for alt_path in alt_paths:
                    try:
                        sftp.get(alt_path, temp_path)
                        print(f"âœ… Found and downloaded file from alternative path: {alt_path}")
                        file_found = True
                        break
                    except FileNotFoundError:
                        continue
                
                if not file_found:
                    # List files in /tmp and find the most recent CSV
                    try:
                        tmp_files = sftp.listdir_attr('/tmp')
                        csv_files = [f for f in tmp_files if f.filename.endswith('.csv')]
                        
                        if csv_files:
                            # Sort by modification time (most recent first)
                            csv_files.sort(key=lambda x: x.st_mtime, reverse=True)
                            most_recent = csv_files[0].filename
                            sftp.get(f'/tmp/{most_recent}', temp_path)
                            print(f"âœ… Downloaded most recent CSV from /tmp: {most_recent}")
                            file_found = True
                    except Exception as e:
                        print(f"âŒ Error listing /tmp directory: {str(e)}")
                
                if not file_found:
                    sftp.close()
                    ssh_client.close()
                    os.unlink(temp_path)
                    print(f"âŒ Output CSV not found in /tmp for this run")
                    return jsonify({'error': 'Output CSV not found in /tmp for this run'}), 404
            
            sftp.close()
            ssh_client.close()
            
            # Return the file as a download
            return send_file(
                temp_path,
                mimetype='text/csv',
                as_attachment=True,
                download_name=download_filename
            )
            
        except Exception as e:
            print(f"âŒ SFTP error: {str(e)}")
            return jsonify({'error': f'Failed to download file from Unix server: {str(e)}'}), 500
            
    except Exception as e:
        print(f"âŒ Download error: {str(e)}")
        return jsonify({'error': str(e)}), 500


# ============================================================
# FILE DOWNLOAD TAB - VALIDATION AND DOWNLOAD ENDPOINT
# ============================================================
def extract_file_download_fields(params):
    """
    Extract File Download specific fields from request params.
    
    Returns dict with:
    - source_type: 'file' or 'database'
    - target_file_type: CSV, TSV, JSON, Parquet, XML
    - target_delimiter: Delimiter for CSV/TSV
    - target_file_name: Output file name (mandatory)
    - number_of_rows: Max rows to download (max 10000)
    """
    result = {}
    
    # Source type
    source_type = (
        params.get('source_type') or
        params.get('sourceType') or
        ''
    ).strip().lower()
    result['source_type'] = source_type
    
    # Target file type
    target_file_type = (
        params.get('target_file_type') or
        params.get('targetFileType') or
        params.get('filedownloadTargetFileType') or
        ''
    ).strip()
    result['target_file_type'] = target_file_type
    
    # Target delimiter (for CSV/TSV)
    target_delimiter = (
        params.get('target_delimiter') or
        params.get('targetDelimiter') or
        params.get('filedownloadTargetDelimiter') or
        ','
    ).strip()
    result['target_delimiter'] = target_delimiter
    
    # Target file name (mandatory)
    target_file_name = (
        params.get('target_file_name') or
        params.get('targetFileName') or
        params.get('filedownloadTargetFileName') or
        ''
    ).strip()
    result['target_file_name'] = target_file_name
    
    # Number of rows (max 100000 for File Download tab)
    number_of_rows_str = (
        params.get('number_of_rows') or
        params.get('numberOfRows') or
        params.get('filedownloadTargetNumberOfRows') or
        ''
    )
    
    if number_of_rows_str:
        try:
            number_of_rows = int(number_of_rows_str)
            result['number_of_rows'] = number_of_rows
        except ValueError:
            result['number_of_rows'] = None
    else:
        result['number_of_rows'] = None
    
    return result


def validate_file_download_params(params):
    """
    Validate File Download specific parameters.
    
    Returns (is_valid, error_message) tuple.
    """
    fields = extract_file_download_fields(params)
    
    # Validate source_type is present
    if not fields['source_type']:
        return (False, 'Source Type is required (file or database)')
    
    if fields['source_type'] not in ['file', 'database']:
        return (False, f'Invalid Source Type: {fields["source_type"]}. Must be "file" or "database"')
    
    # Validate target_file_name is present (mandatory)
    if not fields['target_file_name']:
        return (False, 'Target File Name is required')
    
    # Validate number_of_rows does not exceed 100000 (File Download tab limit)
    if fields['number_of_rows'] is not None:
        if fields['number_of_rows'] > 100000:
            return (False, 'Number of Rows cannot exceed 100,000')
        if fields['number_of_rows'] < 1:
            return (False, 'Number of Rows must be at least 1')
    
    # Validate target_file_type
    if not fields['target_file_type']:
        return (False, 'Target File Type is required')
    
    valid_file_types = ['CSV', 'TSV', 'JSON', 'Parquet', 'XML', 'Excel', 'csv', 'tsv', 'json', 'parquet', 'xml', 'excel', 'XLSX', 'xlsx']
    if fields['target_file_type'] not in valid_file_types:
        return (False, f'Invalid Target File Type: {fields["target_file_type"]}')
    
    # Validate delimiter is present for CSV/TSV
    if fields['target_file_type'].upper() in ['CSV', 'TSV']:
        if not fields['target_delimiter']:
            return (False, 'Delimiter is required for CSV/TSV file types')
    
    return (True, None)


# ============================================================
# FILE DOWNLOAD TAB - WITH LOCAL FILE UPLOAD ENDPOINT
# ============================================================
@app.route('/api/static/filedownload/run-with-upload', methods=['POST'])
def static_filedownload_run_with_upload():
    """
    Execute File Download operation with local file upload.
    
    This endpoint handles multipart/form-data submissions where:
    - source_local_file: The uploaded file from user's local system
    - The file is transferred to Unix /tmp/{batch_id}_{original_filename}
    - The Unix path is then used as source input for the execution script
    
    Returns: { "run_id": "uuid", "status": "PENDING" }
    """
    try:
        # Debug logging
        print(f"[FileDownload Upload] Files received: {list(request.files.keys())}")
        print(f"[FileDownload Upload] Form fields received: {list(request.form.keys())}")
        
        # Check for uploaded file
        if 'source_local_file' not in request.files:
            return jsonify({
                'error': 'No file uploaded. Please select a local file to upload.'
            }), 400
        
        uploaded_file = request.files['source_local_file']
        
        if uploaded_file.filename == '':
            return jsonify({
                'error': 'No file selected. Please select a local file to upload.'
            }), 400
        
        # Read file content into memory
        file_content = uploaded_file.read()
        original_filename = uploaded_file.filename
        
        print(f"[FileDownload Upload] File received: {original_filename}, size: {len(file_content)} bytes")
        
        # Collect form parameters
        params = {}
        for key in request.form:
            params[key] = request.form[key]
        
        # Validate required fields
        target_file_name = params.get('target_file_name', '').strip()
        if not target_file_name:
            return jsonify({'error': 'Target File Name is required'}), 400
        
        # Validate number_of_rows (max 100000)
        number_of_rows_str = params.get('number_of_rows', '')
        if number_of_rows_str:
            try:
                number_of_rows = int(number_of_rows_str)
                if number_of_rows > 100000:
                    return jsonify({'error': 'Number of Rows cannot exceed 100,000'}), 400
                if number_of_rows < 1:
                    return jsonify({'error': 'Number of Rows must be at least 1'}), 400
            except ValueError:
                return jsonify({'error': 'Number of Rows must be a valid number'}), 400
        
        # Get Unix config from params
        unix_config = get_unix_config_from_params(params)
        if 'error' in unix_config:
            return jsonify({'error': unix_config['error']}), 400
        
        # Resolve execution context
        exec_context = resolve_execution_context(params)
        if exec_context['error']:
            return jsonify({'error': exec_context['error']}), 400
        
        batch_id = exec_context['batch_id']
        
        # Generate unique run ID
        run_id = str(uuid.uuid4())[:8]
        
        # Store file info for background thread
        # Preserve original filename (no batch_id prefix) - just sanitize special characters
        safe_filename = original_filename.replace(' ', '_').replace('/', '_').replace('\\', '_')
        unix_dest_path = f'/tmp/{safe_filename}'
        
        # Initialize run entry
        run_registry[run_id] = {
            'status': 'PENDING',
            'logs': [],
            'tab': 'file_download',
            'params': params,
            'thread': None,
            'ssh_client': None,
            'stop_requested': False,
            'uploaded_file_content': file_content,
            'uploaded_file_name': original_filename,
            'unix_file_path': unix_dest_path
        }
        
        # Start execution in background thread
        thread = threading.Thread(
            target=execute_filedownload_with_upload,
            args=(run_id, params, file_content, original_filename, unix_dest_path)
        )
        thread.daemon = True
        run_registry[run_id]['thread'] = thread
        thread.start()
        
        return jsonify({
            'run_id': run_id,
            'status': 'PENDING',
            'message': f'File Download operation started with uploaded file: {original_filename}'
        })
        
    except Exception as e:
        print(f"[FileDownload Upload] Error: {str(e)}")
        return jsonify({'error': str(e)}), 500


def execute_filedownload_with_upload(run_id, params, file_content, original_filename, unix_dest_path):
    """
    Execute File Download operation with local file upload.
    
    Steps:
    1. Connect to Unix server via SSH/SFTP
    2. Upload the file to /tmp/{original_filename} (preserving original filename)
    3. Update params with the Unix file path
    4. Execute the File Download script
    """
    try:
        run_registry[run_id]['status'] = 'RUNNING'
        add_log(run_id, f'ðŸš€ Starting File Download with local file upload...')
        add_log(run_id, f'ðŸ“¤ Uploaded file: {original_filename} ({len(file_content)} bytes)')
        
        # Resolve execution context
        exec_context = resolve_execution_context(params, run_id)
        
        if exec_context['error']:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, f'âŒ {exec_context["error"]}')
            return
        
        # Extract resolved context
        working_dir = exec_context['working_dir']
        batch_id = exec_context['batch_id']
        env = exec_context['env']
        unix_config = exec_context['unix_config']
        
        # Store in run registry
        set_execution_context(run_id, working_dir, batch_id, env)
        
        add_log(run_id, f'ðŸ“‚ Working directory: {working_dir}')
        add_log(run_id, f'ðŸŒ Environment: {env}, Batch ID: {batch_id}')
        add_log(run_id, f'ðŸ“¡ Connecting to Unix server {unix_config["host"]}:{unix_config["port"]}...')
        
        # Connect to Unix server
        ssh_client = connect_unix_server(unix_config, run_id)
        
        if not ssh_client:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, 'âŒ Failed to connect to Unix server')
            return
        
        run_registry[run_id]['ssh_client'] = ssh_client
        add_log(run_id, 'âœ… Connected to Unix server')
        
        # Step 1: Upload file to Unix /tmp via SFTP
        add_log(run_id, f'ðŸ“¤ Uploading file to Unix: {unix_dest_path}')
        
        try:
            sftp = ssh_client.open_sftp()
            
            # Write file content to Unix
            with sftp.file(unix_dest_path, 'wb') as remote_file:
                remote_file.write(file_content)
            
            sftp.close()
            add_log(run_id, f'âœ… File uploaded successfully to {unix_dest_path}')
            
        except Exception as e:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, f'âŒ Failed to upload file to Unix: {str(e)}')
            ssh_client.close()
            return
        
        # Step 2: Update params with Unix file path
        params['filedownloadSourceUnixPath'] = unix_dest_path
        params['filedownloadSourceLocationType'] = 'unix'  # Override to unix since file is now on Unix
        
        # Check if stop requested
        if run_registry[run_id]['stop_requested']:
            ssh_client.close()
            return
        
        # Step 3: Execute the File Download script
        script_path = TAB_SCRIPT_MAP['file_download']
        add_log(run_id, f'ðŸ“‹ Using script: {script_path}')
        
        # Build script arguments
        script_args = build_script_arguments(params)
        
        # Build full command
        add_log(run_id, f'â–¶ï¸ Executing script: {script_path}')
        command = f'cd {shlex.quote(working_dir)} && {script_path} {script_args}'
        
        # Execute command and stream output
        success = execute_command_streaming(ssh_client, command, run_id)
        
        # Close SSH connection
        ssh_client.close()
        run_registry[run_id]['ssh_client'] = None
        add_log(run_id, 'ðŸ”Œ Unix server connection closed')
        
        # Set final status
        if run_registry[run_id]['stop_requested']:
            run_registry[run_id]['status'] = 'STOPPED'
        elif success:
            run_registry[run_id]['status'] = 'SUCCESS'
            add_log(run_id, f'âœ… File Download completed successfully!')
            
            # Set up download info
            target_file_name = params.get('target_file_name', 'output.csv')
            run_registry[run_id]['download_available'] = True
            run_registry[run_id]['download_filename'] = target_file_name
            run_registry[run_id]['unix_output_path'] = '/tmp/output.csv'
            add_log(run_id, f'â¬‡ï¸ Output file ready for download: {target_file_name}')
        else:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, f'âŒ File Download failed')
            
    except Exception as e:
        run_registry[run_id]['status'] = 'FAILED'
        add_log(run_id, f'âŒ Error: {str(e)}')
        print(f"Error in execute_filedownload_with_upload: {str(e)}")


# ============================================================
# FILE LOAD TAB - WITH LOCAL FILE UPLOAD ENDPOINT
# ============================================================
@app.route('/api/static/fileload/run-with-upload', methods=['POST'])
def static_fileload_run_with_upload():
    """
    Execute File Load operation with local file upload.
    
    This endpoint handles multipart/form-data submissions where:
    - source_local_file: The uploaded file from user's local system
    - The file is transferred to Unix /tmp/{original_filename} (preserving original name)
    - The Unix path is then used as source input for the execution script
    
    Returns: { "run_id": "uuid", "status": "PENDING" }
    """
    try:
        # Debug logging
        print(f"[FileLoad Upload] Files received: {list(request.files.keys())}")
        print(f"[FileLoad Upload] Form fields received: {list(request.form.keys())}")
        
        # Check for uploaded file
        if 'source_local_file' not in request.files:
            return jsonify({
                'error': 'No file uploaded. Please select a local file to upload.'
            }), 400
        
        uploaded_file = request.files['source_local_file']
        
        if uploaded_file.filename == '':
            return jsonify({
                'error': 'No file selected. Please select a local file to upload.'
            }), 400
        
        # Read file content into memory
        file_content = uploaded_file.read()
        original_filename = uploaded_file.filename
        
        print(f"[FileLoad Upload] File received: {original_filename}, size: {len(file_content)} bytes")
        
        # Collect form parameters
        params = {}
        for key in request.form:
            params[key] = request.form[key]
        
        # Validate File Load specific params
        is_valid, error_msg = validate_file_load_params_for_upload(params)
        if not is_valid:
            return jsonify({'error': error_msg}), 400
        
        # Get Unix config from params
        unix_config = get_unix_config_from_params(params)
        if 'error' in unix_config:
            return jsonify({'error': unix_config['error']}), 400
        
        # Resolve execution context
        exec_context = resolve_execution_context(params)
        if exec_context['error']:
            return jsonify({'error': exec_context['error']}), 400
        
        batch_id = exec_context['batch_id']
        
        # Generate unique run ID
        run_id = str(uuid.uuid4())[:8]
        
        # Store file info for background thread
        # Preserve original filename (no batch_id prefix) - just sanitize special characters
        safe_filename = original_filename.replace(' ', '_').replace('/', '_').replace('\\', '_')
        unix_dest_path = f'/tmp/{safe_filename}'
        
        # Initialize run entry
        run_registry[run_id] = {
            'status': 'PENDING',
            'logs': [],
            'tab': 'file_load',
            'params': params,
            'thread': None,
            'ssh_client': None,
            'stop_requested': False,
            'uploaded_file_content': file_content,
            'uploaded_file_name': original_filename,
            'unix_file_path': unix_dest_path
        }
        
        # Start execution in background thread
        thread = threading.Thread(
            target=execute_fileload_with_upload,
            args=(run_id, params, file_content, original_filename, unix_dest_path)
        )
        thread.daemon = True
        run_registry[run_id]['thread'] = thread
        thread.start()
        
        return jsonify({
            'run_id': run_id,
            'status': 'PENDING',
            'message': f'File Load operation started with uploaded file: {original_filename}'
        })
        
    except Exception as e:
        print(f"[FileLoad Upload] Error: {str(e)}")
        return jsonify({'error': str(e)}), 500


def validate_file_load_params_for_upload(params):
    """
    Validate File Load parameters when using local file upload.
    Similar to validate_file_load_params but skips path validation since file is uploaded.
    """
    target_fields = extract_file_load_target_fields(params)
    
    # Source file type validation
    source_file_type = (
        params.get('source_file_type') or
        params.get('sourceFileType') or
        params.get('fileloadSourceFileType') or
        ''
    ).strip()
    
    if not source_file_type:
        return (False, 'Source File Type is required')
    
    # Validate target_load_type is present
    if not target_fields['target_load_type']:
        return (False, 'Target Load Type is required (overwrite or append)')
    
    if target_fields['target_load_type'] not in ['overwrite', 'append']:
        return (False, f'Invalid Target Load Type: {target_fields["target_load_type"]}. Must be "overwrite" or "append"')
    
    # If target is Hive, require hadoop_path
    if target_fields['target_db_type'].lower() == 'hive':
        if not target_fields['hadoop_path']:
            return (False, 'Hadoop Path is required when target database is Hive')
    
    return (True, None)


def execute_fileload_with_upload(run_id, params, file_content, original_filename, unix_dest_path):
    """
    Execute File Load operation with local file upload.
    
    Steps:
    1. Connect to Unix server via SSH/SFTP
    2. Upload the file to /tmp/{original_filename} (preserving original filename)
    3. Update params with the Unix file path
    4. Execute the File Load script
    """
    try:
        run_registry[run_id]['status'] = 'RUNNING'
        add_log(run_id, f'ðŸš€ Starting File Load with local file upload...')
        add_log(run_id, f'ðŸ“¤ Uploaded file: {original_filename} ({len(file_content)} bytes)')
        
        # Resolve execution context
        exec_context = resolve_execution_context(params, run_id)
        
        if exec_context['error']:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, f'âŒ {exec_context["error"]}')
            return
        
        # Extract resolved context
        working_dir = exec_context['working_dir']
        batch_id = exec_context['batch_id']
        env = exec_context['env']
        unix_config = exec_context['unix_config']
        
        # Store in run registry
        set_execution_context(run_id, working_dir, batch_id, env)
        
        add_log(run_id, f'ðŸ“‚ Working directory: {working_dir}')
        add_log(run_id, f'ðŸŒ Environment: {env}, Batch ID: {batch_id}')
        add_log(run_id, f'ðŸ“¡ Connecting to Unix server {unix_config["host"]}:{unix_config["port"]}...')
        
        # Connect to Unix server
        ssh_client = connect_unix_server(unix_config, run_id)
        
        if not ssh_client:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, 'âŒ Failed to connect to Unix server')
            return
        
        run_registry[run_id]['ssh_client'] = ssh_client
        add_log(run_id, 'âœ… Connected to Unix server')
        
        # Step 1: Upload file to Unix /tmp via SFTP
        add_log(run_id, f'ðŸ“¤ Uploading file to Unix: {unix_dest_path}')
        
        try:
            sftp = ssh_client.open_sftp()
            
            # Write file content to Unix
            with sftp.file(unix_dest_path, 'wb') as remote_file:
                remote_file.write(file_content)
            
            sftp.close()
            add_log(run_id, f'âœ… File uploaded successfully to {unix_dest_path}')
            
        except Exception as e:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, f'âŒ Failed to upload file to Unix: {str(e)}')
            ssh_client.close()
            return
        
        # Step 2: Update params with Unix file path
        params['fileloadSourceUnixPath'] = unix_dest_path
        params['source_unix_path'] = unix_dest_path
        params['source_location_type'] = 'unix'  # Override to unix since file is now on Unix
        params['fileloadSourceLocationType'] = 'unix'
        
        # Extract and add File Load source fields to params
        source_fields = extract_file_load_source_fields(params)
        params['source_file_type'] = source_fields['source_file_type']
        params['source_delimiter'] = source_fields['source_delimiter']
        params['source_file_sql_query'] = source_fields['source_file_sql_query']
        params['source_key_columns'] = source_fields['source_key_columns']
        
        # Extract and add File Load target fields
        target_fields = extract_file_load_target_fields(params)
        params['target_load_type'] = target_fields['target_load_type']
        
        add_log(run_id, f'ðŸ“„ Source File Type: {source_fields["source_file_type"]}')
        add_log(run_id, f'ðŸ“ Source Location: unix (uploaded to /tmp)')
        add_log(run_id, f'ðŸ“‚ Source Unix Path: {unix_dest_path}')
        add_log(run_id, f'âš¡ Target Load Type: {target_fields["target_load_type"]}')
        
        # Add Hive-specific fields if applicable
        if target_fields['target_db_type'].lower() == 'hive':
            params['hadoop_path'] = target_fields['hadoop_path']
            params['partition_id'] = target_fields['partition_id']
            add_log(run_id, f'ðŸ Target DB: Hive')
            add_log(run_id, f'ðŸ“‚ Hadoop Path: {target_fields["hadoop_path"]}')
            add_log(run_id, f'ðŸ”– Partition ID: {target_fields["partition_id"]}')
        
        # Extract and log time_zone
        time_zone = extract_time_zone(params)
        params['time_zone'] = time_zone
        add_log(run_id, f'ðŸ• Time Zone: {time_zone}')
        
        # Check if stop requested
        if run_registry[run_id]['stop_requested']:
            ssh_client.close()
            run_registry[run_id]['status'] = 'STOPPED'
            add_log(run_id, 'â›” Operation stopped by user')
            return
        
        # Step 3: Execute the File Load script
        script_path = TAB_SCRIPT_MAP['file_load']
        add_log(run_id, f'ðŸ“‹ Using script: {script_path}')
        
        # Build script arguments
        script_args = build_script_arguments(params)
        
        # Build full command
        add_log(run_id, f'â–¶ï¸ Executing script: {script_path}')
        command = f'cd {shlex.quote(working_dir)} && {script_path} {script_args}'
        
        # Execute command and stream output
        success = execute_command_streaming(ssh_client, command, run_id)
        
        # Close SSH connection
        ssh_client.close()
        run_registry[run_id]['ssh_client'] = None
        add_log(run_id, 'ðŸ”Œ Unix server connection closed')
        
        # Set final status
        if run_registry[run_id]['stop_requested']:
            run_registry[run_id]['status'] = 'STOPPED'
        elif success:
            run_registry[run_id]['status'] = 'SUCCESS'
            add_log(run_id, f'âœ… File Load completed successfully!')
        else:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, f'âŒ File Load failed')
            
    except Exception as e:
        run_registry[run_id]['status'] = 'FAILED'
        add_log(run_id, f'âŒ Error: {str(e)}')
        print(f"Error in execute_fileload_with_upload: {str(e)}")


@app.route('/api/static/filedownload/download/<run_id>')
def static_filedownload_download(run_id):
    """
    Download the generated file from Unix server for File Download tab.
    
    This endpoint serves the output file generated by the File Download operation.
    The downloaded file name is the target_file_name specified by the user.
    """
    try:
        if run_id not in run_registry:
            return jsonify({'error': 'Run ID not found'}), 404
        
        run_entry = run_registry[run_id]
        
        # Validate this is a completed file_download run
        if run_entry['tab'] != 'file_download':
            return jsonify({'error': 'Download is only available for file download runs'}), 400
        
        if run_entry['status'] not in ['SUCCESS', 'PARTIAL_SUCCESS']:
            return jsonify({'error': f'Cannot download - run status is {run_entry["status"]}'}), 400
        
        # Get download info from run_entry
        if not run_entry.get('download_available'):
            return jsonify({'error': 'No download available for this run'}), 400
        
        unix_source_path = run_entry.get('unix_output_path')
        download_filename = run_entry.get('download_filename', 'output.csv')
        
        if not unix_source_path:
            return jsonify({'error': 'Output file path not found in run registry'}), 500
        
        # Get Unix config from params
        params = run_entry.get('params', {})
        unix_config = get_unix_config_from_params(params)
        
        if 'error' in unix_config:
            return jsonify({'error': unix_config['error']}), 400
        
        print(f"â¬‡ï¸ Preparing File Download from Unix: {unix_source_path} as {download_filename}")
        
        # Connect to Unix server via SFTP
        try:
            ssh_client = paramiko.SSHClient()
            ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            
            ssh_client.connect(
                hostname=unix_config['host'],
                port=unix_config['port'],
                username=unix_config['username'],
                password=unix_config['password'],
                timeout=30
            )
            
            sftp = ssh_client.open_sftp()
            
            # Create a temporary file to store the downloaded content
            temp_file = tempfile.NamedTemporaryFile(delete=False, suffix='.tmp')
            temp_path = temp_file.name
            temp_file.close()
            
            try:
                # Download file from Unix server
                sftp.get(unix_source_path, temp_path)
                print(f"âœ… Downloaded file from {unix_source_path} to {temp_path}")
            except FileNotFoundError:
                # Try alternative paths in /tmp
                alt_paths = [
                    '/tmp/output.csv',
                    '/tmp/filedownload_output.csv',
                    f'/tmp/{download_filename}'
                ]
                
                file_found = False
                for alt_path in alt_paths:
                    try:
                        sftp.get(alt_path, temp_path)
                        print(f"âœ… Found and downloaded file from alternative path: {alt_path}")
                        file_found = True
                        break
                    except FileNotFoundError:
                        continue
                
                if not file_found:
                    sftp.close()
                    ssh_client.close()
                    os.unlink(temp_path)
                    print(f"âŒ Output file not found in /tmp for this run")
                    return jsonify({'error': 'Output file not found for this run'}), 404
            
            sftp.close()
            ssh_client.close()
            
            # Determine mimetype based on file extension
            mimetype = 'application/octet-stream'
            if download_filename.lower().endswith('.csv'):
                mimetype = 'text/csv'
            elif download_filename.lower().endswith('.json'):
                mimetype = 'application/json'
            elif download_filename.lower().endswith('.xml'):
                mimetype = 'application/xml'
            elif download_filename.lower().endswith('.parquet'):
                mimetype = 'application/octet-stream'
            elif download_filename.lower().endswith('.xlsx') or download_filename.lower().endswith('.xls'):
                mimetype = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            elif download_filename.lower().endswith('.tsv'):
                mimetype = 'text/tab-separated-values'
            
            # Return the file as a download
            return send_file(
                temp_path,
                mimetype=mimetype,
                as_attachment=True,
                download_name=download_filename
            )
            
        except Exception as e:
            print(f"âŒ SFTP error: {str(e)}")
            return jsonify({'error': f'Failed to download file from Unix server: {str(e)}'}), 500
            
    except Exception as e:
        print(f"âŒ File Download error: {str(e)}")
        return jsonify({'error': str(e)}), 500


# ============================================================
# SCHEMA GENERATION TAB - WITH FILE UPLOAD ENDPOINT
# ============================================================
@app.route('/api/static/schema/run-with-upload', methods=['POST'])
def static_schema_run_with_upload():
    """
    Execute Schema Generation operation with table list file upload.
    
    This endpoint handles multipart/form-data submissions where:
    - table_list_file: The uploaded file containing table names
    - The file is transferred to Unix /tmp/{original_filename}
    - The Unix path is then used as source input for the execution script
    
    Returns: { "run_id": "uuid", "status": "PENDING" }
    """
    try:
        # Debug logging
        print(f"[Schema Upload] Files received: {list(request.files.keys())}")
        print(f"[Schema Upload] Form fields received: {list(request.form.keys())}")
        
        # Check for uploaded file
        if 'table_list_file' not in request.files:
            return jsonify({
                'error': 'No file uploaded. Please select a table list file to upload.'
            }), 400
        
        uploaded_file = request.files['table_list_file']
        
        if uploaded_file.filename == '':
            return jsonify({
                'error': 'No file selected. Please select a table list file to upload.'
            }), 400
        
        # Read file content into memory
        file_content = uploaded_file.read()
        original_filename = uploaded_file.filename
        
        print(f"[Schema Upload] File received: {original_filename}, size: {len(file_content)} bytes")
        
        # Collect form parameters
        params = {}
        for key in request.form:
            params[key] = request.form[key]
        
        # Validate required fields
        output_file_name = params.get('output_file_name', '').strip()
        if not output_file_name:
            return jsonify({'error': 'Output File Name is required'}), 400
        
        schema_mode = params.get('schema_mode', '').strip()
        if schema_mode != 'multiple':
            return jsonify({'error': 'This endpoint is for Multiple schema mode only'}), 400
        
        # Get Unix config from params
        unix_config = get_unix_config_from_params(params)
        if 'error' in unix_config:
            return jsonify({'error': unix_config['error']}), 400
        
        # Resolve execution context
        exec_context = resolve_execution_context(params)
        if exec_context['error']:
            return jsonify({'error': exec_context['error']}), 400
        
        # Generate unique run ID
        run_id = str(uuid.uuid4())[:8]
        
        # Store file info for background thread
        # Preserve original filename (no batch_id prefix) - just sanitize special characters
        safe_filename = original_filename.replace(' ', '_').replace('/', '_').replace('\\', '_')
        unix_dest_path = f'/tmp/{safe_filename}'
        
        # Initialize run entry
        run_registry[run_id] = {
            'status': 'PENDING',
            'logs': [],
            'tab': 'schema_generation',
            'params': params,
            'thread': None,
            'ssh_client': None,
            'stop_requested': False,
            'uploaded_file_content': file_content,
            'uploaded_file_name': original_filename,
            'unix_file_path': unix_dest_path
        }
        
        # Start execution in background thread
        thread = threading.Thread(
            target=execute_schema_with_upload,
            args=(run_id, params, file_content, original_filename, unix_dest_path)
        )
        thread.daemon = True
        run_registry[run_id]['thread'] = thread
        thread.start()
        
        return jsonify({
            'run_id': run_id,
            'status': 'PENDING',
            'message': f'Schema Generation operation started with uploaded file: {original_filename}'
        })
        
    except Exception as e:
        print(f"[Schema Upload] Error: {str(e)}")
        return jsonify({'error': str(e)}), 500


def execute_schema_with_upload(run_id, params, file_content, original_filename, unix_dest_path):
    """
    Execute Schema Generation operation with table list file upload.
    
    Steps:
    1. Connect to Unix server via SSH/SFTP
    2. Upload the file to /tmp/{original_filename} (preserving original filename)
    3. Update params with the Unix file path
    4. Execute the Schema Generation script
    """
    try:
        run_registry[run_id]['status'] = 'RUNNING'
        add_log(run_id, f'ðŸš€ Starting Schema Generation with table list upload...')
        add_log(run_id, f'ðŸ“¤ Uploaded file: {original_filename} ({len(file_content)} bytes)')
        
        # Resolve execution context
        exec_context = resolve_execution_context(params, run_id)
        
        if exec_context['error']:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, f'âŒ {exec_context["error"]}')
            return
        
        # Extract resolved context
        working_dir = exec_context['working_dir']
        batch_id = exec_context['batch_id']
        env = exec_context['env']
        unix_config = exec_context['unix_config']
        
        # Store in run registry
        set_execution_context(run_id, working_dir, batch_id, env)
        
        add_log(run_id, f'ðŸ“‚ Working directory: {working_dir}')
        add_log(run_id, f'ðŸŒ Environment: {env}, Batch ID: {batch_id}')
        add_log(run_id, f'ðŸ“¡ Connecting to Unix server {unix_config["host"]}:{unix_config["port"]}...')
        
        # Connect to Unix server
        ssh_client = connect_unix_server(unix_config, run_id)
        
        if not ssh_client:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, 'âŒ Failed to connect to Unix server')
            return
        
        run_registry[run_id]['ssh_client'] = ssh_client
        add_log(run_id, 'âœ… Connected to Unix server')
        
        # Step 1: Upload file to Unix /tmp via SFTP
        add_log(run_id, f'ðŸ“¤ Uploading table list file to Unix: {unix_dest_path}')
        
        try:
            sftp = ssh_client.open_sftp()
            
            # Write file content to Unix
            with sftp.file(unix_dest_path, 'wb') as remote_file:
                remote_file.write(file_content)
            
            sftp.close()
            add_log(run_id, f'âœ… File uploaded successfully to {unix_dest_path}')
            
        except Exception as e:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, f'âŒ Failed to upload file to Unix: {str(e)}')
            ssh_client.close()
            return
        
        # Step 2: Update params with Unix file path
        params['schemaSourceTableListPath'] = unix_dest_path
        
        # Check if stop requested
        if run_registry[run_id]['stop_requested']:
            ssh_client.close()
            return
        
        # Step 3: Execute the Schema Generation script
        script_path = TAB_SCRIPT_MAP['schema_generation']
        add_log(run_id, f'ðŸ“‹ Using script: {script_path}')
        
        # Build script arguments
        script_args = build_script_arguments(params)
        
        # Build full command
        add_log(run_id, f'â–¶ï¸ Executing script: {script_path}')
        command = f'cd {shlex.quote(working_dir)} && {script_path} {script_args}'
        
        # Execute command and stream output
        success = execute_command_streaming(ssh_client, command, run_id)
        
        # Close SSH connection
        ssh_client.close()
        run_registry[run_id]['ssh_client'] = None
        add_log(run_id, 'ðŸ”Œ Unix server connection closed')
        
        # Set final status
        if run_registry[run_id]['stop_requested']:
            run_registry[run_id]['status'] = 'STOPPED'
        elif success:
            run_registry[run_id]['status'] = 'SUCCESS'
            add_log(run_id, f'âœ… Schema Generation completed successfully!')
            
            # Set up download info
            output_file_name = params.get('output_file_name', 'schema_output.sql')
            run_registry[run_id]['download_available'] = True
            run_registry[run_id]['download_filename'] = output_file_name
            run_registry[run_id]['unix_output_path'] = f'/tmp/{output_file_name}'
            add_log(run_id, f'â¬‡ï¸ Output file ready for download: {output_file_name}')
        else:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, f'âŒ Schema Generation failed')
            
    except Exception as e:
        run_registry[run_id]['status'] = 'FAILED'
        add_log(run_id, f'âŒ Error: {str(e)}')
        print(f"Error in execute_schema_with_upload: {str(e)}")


@app.route('/api/static/schema/download/<run_id>')
def static_schema_download(run_id):
    """
    Download the generated schema file from Unix server.
    
    This endpoint serves the output file generated by the Schema Generation operation.
    The downloaded file name is the output_file_name specified by the user.
    """
    try:
        if run_id not in run_registry:
            return jsonify({'error': 'Run ID not found'}), 404
        
        run_entry = run_registry[run_id]
        
        # Validate this is a completed schema_generation run
        if run_entry['tab'] != 'schema_generation':
            return jsonify({'error': 'Download is only available for schema generation runs'}), 400
        
        if run_entry['status'] not in ['SUCCESS', 'PARTIAL_SUCCESS']:
            return jsonify({'error': f'Cannot download - run status is {run_entry["status"]}'}), 400
        
        # Get download info from run_entry
        if not run_entry.get('download_available'):
            return jsonify({'error': 'No download available for this run'}), 400
        
        unix_source_path = run_entry.get('unix_output_path')
        download_filename = run_entry.get('download_filename', 'schema_output.sql')
        
        if not unix_source_path:
            return jsonify({'error': 'Output file path not found in run registry'}), 500
        
        # Get Unix config from params
        params = run_entry.get('params', {})
        unix_config = get_unix_config_from_params(params)
        
        if 'error' in unix_config:
            return jsonify({'error': unix_config['error']}), 400
        
        print(f"â¬‡ï¸ Preparing Schema Download from Unix: {unix_source_path} as {download_filename}")
        
        # Connect to Unix server via SFTP
        try:
            ssh_client = paramiko.SSHClient()
            ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            
            ssh_client.connect(
                hostname=unix_config['host'],
                port=unix_config['port'],
                username=unix_config['username'],
                password=unix_config['password'],
                timeout=30
            )
            
            sftp = ssh_client.open_sftp()
            
            # Create a temporary file to store the downloaded content
            temp_file = tempfile.NamedTemporaryFile(delete=False, suffix='.tmp')
            temp_path = temp_file.name
            temp_file.close()
            
            try:
                # Download file from Unix server
                sftp.get(unix_source_path, temp_path)
                print(f"âœ… Downloaded file from {unix_source_path} to {temp_path}")
            except FileNotFoundError:
                # Try alternative paths in /tmp
                alt_paths = [
                    '/tmp/schema_output.sql',
                    '/tmp/output.sql',
                    f'/tmp/{download_filename}'
                ]
                
                file_found = False
                for alt_path in alt_paths:
                    try:
                        sftp.get(alt_path, temp_path)
                        print(f"âœ… Found and downloaded file from alternative path: {alt_path}")
                        file_found = True
                        break
                    except FileNotFoundError:
                        continue
                
                if not file_found:
                    sftp.close()
                    ssh_client.close()
                    os.unlink(temp_path)
                    print(f"âŒ Output file not found in /tmp for this run")
                    return jsonify({'error': 'Output file not found for this run'}), 404
            
            sftp.close()
            ssh_client.close()
            
            # Determine mimetype based on file extension
            mimetype = 'application/octet-stream'
            if download_filename.lower().endswith('.sql'):
                mimetype = 'text/plain'
            elif download_filename.lower().endswith('.csv'):
                mimetype = 'text/csv'
            elif download_filename.lower().endswith('.json'):
                mimetype = 'application/json'
            elif download_filename.lower().endswith('.txt'):
                mimetype = 'text/plain'
            
            # Return the file as a download
            return send_file(
                temp_path,
                mimetype=mimetype,
                as_attachment=True,
                download_name=download_filename
            )
            
        except Exception as e:
            print(f"âŒ SFTP error: {str(e)}")
            return jsonify({'error': f'Failed to download file from Unix server: {str(e)}'}), 500
            
    except Exception as e:
        print(f"âŒ Schema Download error: {str(e)}")
        return jsonify({'error': str(e)}), 500


# ============================================================
# MULTI-TABLE EXCEL COMPARISON ENDPOINT
# ============================================================
@app.route('/api/static/comparison/run-multi', methods=['POST'])
def static_run_multi_comparison():
    """
    Execute multi-table database comparison from Excel file.
    
    Content-Type: multipart/form-data
    Form fields:
      - tab = "data_comparison"
      - comparison_type = "db_to_db"
      - mode = "multiple_tables"
      - source_excel_file = uploaded .xlsx file with source table configs
      - target_excel_file = uploaded .xlsx file with target table configs
      - Other common fields (source/target DB details, environment, etc.)
    
    Returns: { "run_id": "uuid", "status": "PENDING", "total_rows": N }
    """
    try:
        # Check if openpyxl is available
        if not OPENPYXL_AVAILABLE:
            return jsonify({
                'error': 'Excel parsing not available. Please install openpyxl: pip install openpyxl'
            }), 500
        
        # Debug: Log what files were received
        print(f"[DEBUG] Files received: {list(request.files.keys())}")
        print(f"[DEBUG] Form fields received: {list(request.form.keys())}")
        
        # Validate required fields
        tab = request.form.get('tab', 'data_comparison')
        comparison_type = request.form.get('comparison_type', 'db_to_db')
        mode = request.form.get('mode', 'multiple_tables')
        
        print(f"[DEBUG] tab={tab}, comparison_type={comparison_type}, mode={mode}")
        
        if mode != 'multiple_tables':
            return jsonify({
                'error': 'This endpoint is for multiple_tables mode only'
            }), 400
        
        # Check for BOTH Excel files
        if 'source_excel_file' not in request.files:
            print(f"[DEBUG] Missing source_excel_file. Available files: {list(request.files.keys())}")
            return jsonify({
                'error': f'Both Source and Target Excel files are required for multiple_tables mode. Missing: source_excel_file. Received files: {list(request.files.keys())}'
            }), 400
        
        if 'target_excel_file' not in request.files:
            print(f"[DEBUG] Missing target_excel_file. Available files: {list(request.files.keys())}")
            return jsonify({
                'error': f'Both Source and Target Excel files are required for multiple_tables mode. Missing: target_excel_file. Received files: {list(request.files.keys())}'
            }), 400
        
        source_excel_file = request.files['source_excel_file']
        target_excel_file = request.files['target_excel_file']
        
        # Log file info
        print(f"[DEBUG] Source file: {source_excel_file.filename}, size={source_excel_file.content_length}")
        print(f"[DEBUG] Target file: {target_excel_file.filename}, size={target_excel_file.content_length}")
        
        if source_excel_file.filename == '':
            return jsonify({
                'error': 'No source file selected'
            }), 400
        
        if target_excel_file.filename == '':
            return jsonify({
                'error': 'No target file selected'
            }), 400
        
        if not source_excel_file.filename.endswith(('.xlsx', '.xls')):
            return jsonify({
                'error': 'Invalid source file type. Please upload an Excel file (.xlsx or .xls)'
            }), 400
        
        if not target_excel_file.filename.endswith(('.xlsx', '.xls')):
            return jsonify({
                'error': 'Invalid target file type. Please upload an Excel file (.xlsx or .xls)'
            }), 400
        
        # Read both Excel file contents
        try:
            source_content = source_excel_file.read()
            target_content = target_excel_file.read()
            
            print(f"[DEBUG] Source content size: {len(source_content)} bytes")
            print(f"[DEBUG] Target content size: {len(target_content)} bytes")
            
            source_rows = parse_excel_for_multi_comparison(source_content, 'source')
            target_rows = parse_excel_for_multi_comparison(target_content, 'target')
            
            print(f"[DEBUG] Parsed source_rows: {len(source_rows)}")
            print(f"[DEBUG] Parsed target_rows: {len(target_rows)}")
            
            # Log first row of each for debugging
            if source_rows:
                print(f"[DEBUG] First source row: {source_rows[0]}")
            if target_rows:
                print(f"[DEBUG] First target row: {target_rows[0]}")
                
        except Exception as e:
            print(f"[DEBUG] Excel parsing error: {str(e)}")
            return jsonify({
                'error': f'Failed to parse Excel file: {str(e)}'
            }), 400
        
        if not source_rows:
            return jsonify({
                'error': 'Source Excel file is empty or has no valid rows'
            }), 400
        
        if not target_rows:
            return jsonify({
                'error': 'Target Excel file is empty or has no valid rows'
            }), 400
        
        # Collect common form parameters (excluding file)
        common_params = {}
        for key in request.form:
            if key not in ['tab', 'comparison_type', 'mode', 'source_excel_file', 'target_excel_file']:
                common_params[key] = request.form[key]
        
        # Generate unique run ID
        run_id = str(uuid.uuid4())[:8]
        
        # Determine rows to process (min of both)
        total_rows = min(len(source_rows), len(target_rows))
        
        # Initialize run entry with multi-table specific fields
        run_registry[run_id] = {
            'status': 'PENDING',
            'logs': [],
            'tab': tab,
            'params': common_params,
            'thread': None,
            'ssh_client': None,
            'stop_requested': False,
            'rows_status': [],
            'total_rows': total_rows,
            'started_at': datetime.now().isoformat(),
            'finished_at': None,
            'source_rows': source_rows,
            'target_rows': target_rows
        }
        
        # Start execution in background thread
        thread = threading.Thread(
            target=execute_multi_table_comparison_v2,
            args=(run_id, common_params, source_rows, target_rows)
        )
        thread.daemon = True
        run_registry[run_id]['thread'] = thread
        thread.start()
        
        return jsonify({
            'run_id': run_id,
            'status': 'PENDING',
            'total_rows': total_rows,
            'source_rows': len(source_rows),
            'target_rows': len(target_rows),
            'message': f'Multi-table comparison started with {total_rows} rows (source: {len(source_rows)}, target: {len(target_rows)})'
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/api/static/run/<run_id>/summary')
def get_run_summary(run_id):
    """
    Get execution summary for a completed run.
    Returns row-wise results for multi-table comparisons.
    """
    if run_id not in run_registry:
        return jsonify({'error': 'Run ID not found'}), 404
    
    run_entry = run_registry[run_id]
    
    # Calculate success/failure counts
    rows_status = run_entry.get('rows_status', [])
    success_count = sum(1 for r in rows_status if r.get('status') == 'SUCCESS')
    failed_count = sum(1 for r in rows_status if r.get('status') == 'FAILED')
    
    return jsonify({
        'run_id': run_id,
        'status': run_entry['status'],
        'tab': run_entry['tab'],
        'total_rows': run_entry.get('total_rows', 0),
        'success_count': success_count,
        'failed_count': failed_count,
        'rows_status': rows_status,
        'started_at': run_entry.get('started_at'),
        'finished_at': run_entry.get('finished_at')
    })


# ============================================================
# EXCEL PARSING FOR MULTI-TABLE COMPARISON
# ============================================================
def normalize_column_name(name):
    """
    Normalize column name: trim spaces, lowercase, replace spaces with underscores.
    """
    if not name:
        return ''
    return str(name).strip().lower().replace(' ', '_').replace('-', '_')


def parse_excel_for_multi_comparison(excel_content, file_type='source'):
    """
    Parse Excel file for multi-table comparison.
    
    file_type: 'source' or 'target'
    
    For SOURCE file, expects columns:
    - source_table_name (or aliases: table_name, src_table_name, src_table)
    - source_sql (or aliases: source_sql_query, sql_query, sql, src_sql)
    - source_key_columns (or aliases: key_columns, source_keys, src_keys)
    
    For TARGET file, expects columns:
    - target_table_name (or aliases: table_name, tgt_table_name, tgt_table)
    - target_sql (or aliases: target_sql_query, sql_query, sql, tgt_sql)
    - target_key_columns (or aliases: key_columns, target_keys, tgt_keys)
    
    Returns: List of row dictionaries with standardized keys
    """
    workbook = openpyxl.load_workbook(BytesIO(excel_content), read_only=True, data_only=True)
    sheet = workbook.active
    
    # Get headers from first row
    header_row = next(sheet.iter_rows(min_row=1, max_row=1, values_only=True))
    
    if not header_row:
        raise ValueError("Excel file has no header row")
    
    # Normalize headers
    headers = [normalize_column_name(h) for h in header_row]
    
    print(f"[DEBUG] {file_type.upper()} Excel headers (normalized): {headers}")
    
    # Define column aliases based on file type
    if file_type == 'source':
        column_aliases = {
            'table_name': ['source_table_name', 'src_table_name', 'src_table', 'table_name', 'tablename', 'source_table'],
            'sql_query': ['source_sql', 'source_sql_query', 'src_sql', 'src_sql_query', 'sql_query', 'sql', 'query'],
            'key_columns': ['source_key_columns', 'source_keys', 'src_keys', 'src_key_columns', 'key_columns', 'keys', 'primary_key']
        }
    else:  # target
        column_aliases = {
            'table_name': ['target_table_name', 'tgt_table_name', 'tgt_table', 'table_name', 'tablename', 'target_table'],
            'sql_query': ['target_sql', 'target_sql_query', 'tgt_sql', 'tgt_sql_query', 'sql_query', 'sql', 'query'],
            'key_columns': ['target_key_columns', 'target_keys', 'tgt_keys', 'tgt_key_columns', 'key_columns', 'keys', 'primary_key']
        }
    
    # Build header index map
    header_map = {}
    missing_columns = []
    
    for canonical_name, aliases in column_aliases.items():
        found = False
        for alias in aliases:
            if alias in headers:
                header_map[canonical_name] = headers.index(alias)
                found = True
                break
        if not found:
            missing_columns.append(f"{canonical_name} (or aliases: {', '.join(aliases[:3])})")
    
    print(f"[DEBUG] {file_type.upper()} Excel header_map: {header_map}")
    if missing_columns:
        print(f"[DEBUG] {file_type.upper()} Excel missing columns: {missing_columns}")
    
    # Warn about missing columns but don't fail if table_name is present
    if 'table_name' not in header_map:
        raise ValueError(f"Missing required columns in {file_type} Excel file: {', '.join(missing_columns)}. Detected headers: {headers}")
    
    # Parse data rows
    rows = []
    for row_num, row in enumerate(sheet.iter_rows(min_row=2, values_only=True), start=2):
        # Skip empty rows
        if not row or all(cell is None or str(cell).strip() == '' for cell in row):
            continue
        
        row_data = {
            'row_index': row_num - 1,  # 1-based index for display
            'table_name': '',
            'sql_query': '',
            'key_columns': ''
        }
        
        # Extract values using header map
        for canonical_name, col_index in header_map.items():
            if col_index < len(row) and row[col_index] is not None:
                row_data[canonical_name] = str(row[col_index]).strip()
        
        # Skip rows where table_name is empty
        if not row_data['table_name']:
            continue
        
        rows.append(row_data)
    
    workbook.close()
    print(f"[DEBUG] {file_type.upper()} Excel: parsed {len(rows)} valid data rows")
    return rows


def parse_excel_for_comparison(excel_content):
    """
    Parse Excel file and extract rows for comparison.
    
    Expected columns (case-insensitive, supports alternate names):
    - source_sql_query / source_query / source_sql
    - source_table_name / source_table / table_name
    - source_key_columns / source_keys / key_columns
    - target_sql_query / target_query / target_sql
    - target_table_name / target_table
    - target_key_columns / target_keys
    
    Returns: List of row dictionaries
    """
    workbook = openpyxl.load_workbook(BytesIO(excel_content), read_only=True, data_only=True)
    sheet = workbook.active
    
    # Get headers from first row
    headers = []
    header_row = next(sheet.iter_rows(min_row=1, max_row=1, values_only=True))
    
    if not header_row:
        raise ValueError("Excel file has no header row")
    
    # Normalize headers (lowercase, strip whitespace)
    headers = [str(h).lower().strip() if h else '' for h in header_row]
    
    # Column name mapping (alternate names -> canonical name)
    column_aliases = {
        'source_sql_query': ['source_sql_query', 'source_query', 'source_sql', 'src_query', 'src_sql'],
        'source_table_name': ['source_table_name', 'source_table', 'src_table', 'src_table_name'],
        'source_key_columns': ['source_key_columns', 'source_keys', 'src_keys', 'src_key_columns', 'key_columns'],
        'target_sql_query': ['target_sql_query', 'target_query', 'target_sql', 'tgt_query', 'tgt_sql'],
        'target_table_name': ['target_table_name', 'target_table', 'tgt_table', 'tgt_table_name'],
        'target_key_columns': ['target_key_columns', 'target_keys', 'tgt_keys', 'tgt_key_columns']
    }
    
    # Build header index map
    header_map = {}
    for canonical_name, aliases in column_aliases.items():
        for alias in aliases:
            if alias in headers:
                header_map[canonical_name] = headers.index(alias)
                break
    
    # Parse data rows
    rows = []
    for row_num, row in enumerate(sheet.iter_rows(min_row=2, values_only=True), start=2):
        # Skip empty rows
        if not row or all(cell is None or str(cell).strip() == '' for cell in row):
            continue
        
        row_data = {
            'row_index': row_num - 1,  # 1-based index for display
            'source_sql_query': '',
            'source_table_name': '',
            'source_key_columns': '',
            'target_sql_query': '',
            'target_table_name': '',
            'target_key_columns': ''
        }
        
        # Extract values using header map
        for canonical_name, col_index in header_map.items():
            if col_index < len(row) and row[col_index] is not None:
                row_data[canonical_name] = str(row[col_index]).strip()
        
        # Also capture any additional columns not in the mapping
        for i, header in enumerate(headers):
            if header and header not in ['', None] and i < len(row):
                normalized_header = header.replace(' ', '_').replace('-', '_')
                if normalized_header not in row_data and row[i] is not None:
                    row_data[normalized_header] = str(row[i]).strip()
        
        rows.append(row_data)
    
    workbook.close()
    return rows


# ============================================================
# MULTI-TABLE COMPARISON EXECUTION
# ============================================================
def execute_multi_table_comparison_v2(run_id, common_params, source_rows, target_rows):
    """
    Execute multi-table comparison by iterating through source and target Excel rows.
    Each row triggers a Unix script execution via Paramiko.
    """
    try:
        run_registry[run_id]['status'] = 'RUNNING'
        num_source_rows = len(source_rows)
        num_target_rows = len(target_rows)
        total_rows = min(num_source_rows, num_target_rows)
        
        add_log(run_id, f'ðŸš€ Starting Multi-Table Comparison...')
        add_log(run_id, f'ðŸ“Š Parsed source rows: {num_source_rows}, Parsed target rows: {num_target_rows}, Processing rows: {total_rows}')
        
        if num_source_rows != num_target_rows:
            add_log(run_id, f'âš ï¸ WARNING: Row count mismatch! Source has {num_source_rows} rows, Target has {num_target_rows} rows. Will process {total_rows} rows.')
        
        add_log(run_id, '=' * 60)
        
        # Log preview of first 2 rows for debugging
        for i in range(min(2, total_rows)):
            src = source_rows[i]
            tgt = target_rows[i]
            add_log(run_id, f'ðŸ“‹ Preview Row {i+1}:')
            add_log(run_id, f'   Source: table={src.get("table_name", "N/A")}, keys={src.get("key_columns", "N/A")}, sql={src.get("sql_query", "N/A")[:50]}...')
            add_log(run_id, f'   Target: table={tgt.get("table_name", "N/A")}, keys={tgt.get("key_columns", "N/A")}, sql={tgt.get("sql_query", "N/A")[:50]}...')
        
        add_log(run_id, '=' * 60)
        
        # Resolve execution context ONCE using central function
        exec_context = resolve_execution_context(common_params, run_id)
        
        if exec_context['error']:
            run_registry[run_id]['status'] = 'FAILED'
            run_registry[run_id]['finished_at'] = datetime.now().isoformat()
            add_log(run_id, f'âŒ {exec_context["error"]}')
            return
        
        # Extract resolved context
        working_dir = exec_context['working_dir']
        batch_id = exec_context['batch_id']
        env = exec_context['env']
        unix_config = exec_context['unix_config']
        
        # Store in run registry for global access
        set_execution_context(run_id, working_dir, batch_id, env)
        
        # Log working directory ONCE per run
        add_log(run_id, f'ðŸ“‚ Global working directory set to: {working_dir}')
        add_log(run_id, f'ðŸŒ Environment: {env}, Batch ID: {batch_id}')
        add_log(run_id, f'ðŸ”§ Unix host: {unix_config["host"]}')
        
        # Extract and log time_zone (default to N/A if not provided)
        time_zone = extract_time_zone(common_params)
        common_params['time_zone'] = time_zone  # Ensure it's in params for script args
        add_log(run_id, f'ðŸ• Time Zone: {time_zone}')
        
        add_log(run_id, f'ðŸ“¡ Connecting to Unix server {unix_config["host"]}:{unix_config["port"]}...')
        
        # Connect to Unix server
        ssh_client = connect_unix_server(unix_config, run_id)
        
        if not ssh_client:
            run_registry[run_id]['status'] = 'FAILED'
            run_registry[run_id]['finished_at'] = datetime.now().isoformat()
            add_log(run_id, 'âŒ Failed to connect to Unix server')
            return
        
        run_registry[run_id]['ssh_client'] = ssh_client
        add_log(run_id, 'âœ… Successfully connected to Unix server')
        add_log(run_id, '=' * 60)
        
        success_count = 0
        failed_count = 0
        
        # Process each row
        for i in range(total_rows):
            row_num = i + 1
            source_row = source_rows[i]
            target_row = target_rows[i]
            
            # Check if stop requested
            if run_registry[run_id]['stop_requested']:
                add_log(run_id, f'â›” Execution stopped by user at row {row_num}/{total_rows}')
                break
            
            source_table = source_row.get('table_name', 'unknown')
            source_sql = source_row.get('sql_query', '')
            source_keys = source_row.get('key_columns', '')
            
            target_table = target_row.get('table_name', 'unknown')
            target_sql = target_row.get('sql_query', '')
            target_keys = target_row.get('key_columns', '')
            
            add_log(run_id, '')
            add_log(run_id, f'[Row {row_num}/{total_rows}] START')
            add_log(run_id, f'[Row {row_num}/{total_rows}] Source table={source_table}, keys={source_keys}, sql={source_sql[:80] if source_sql else "N/A"}...')
            add_log(run_id, f'[Row {row_num}/{total_rows}] Target table={target_table}, keys={target_keys}, sql={target_sql[:80] if target_sql else "N/A"}...')
            
            row_status = {
                'row_index': row_num,
                'source_table': source_table,
                'target_table': target_table,
                'source_keys': source_keys,
                'target_keys': target_keys,
                'status': 'RUNNING',
                'error': None
            }
            
            try:
                # Build combined parameters: common UI fields + Excel row fields
                combined_params = {**common_params}
                
                # Add row-specific fields from both source and target
                combined_params['source_sql_query'] = source_sql
                combined_params['source_table_name'] = source_table
                combined_params['source_key_columns'] = source_keys
                combined_params['target_sql_query'] = target_sql
                combined_params['target_table_name'] = target_table
                combined_params['target_key_columns'] = target_keys
                combined_params['row_index'] = row_num
                combined_params['total_rows'] = total_rows
                
                # Use MULTI_TABLE_SCRIPT (global constant)
                script_path = MULTI_TABLE_SCRIPT
                script_args = build_script_arguments(combined_params)
                
                # Build full command using global working_dir (no redundant log)
                add_log(run_id, f'  â–¶ï¸ Executing script: {script_path}')
                command = f'cd {shlex.quote(working_dir)} && {script_path} {script_args}'
                
                # Execute command
                success = execute_command_streaming(ssh_client, command, run_id)
                
                if success:
                    row_status['status'] = 'SUCCESS'
                    success_count += 1
                    add_log(run_id, f'[Row {row_num}/{total_rows}] END status=SUCCESS âœ…')
                else:
                    row_status['status'] = 'FAILED'
                    row_status['error'] = 'Script execution failed'
                    failed_count += 1
                    add_log(run_id, f'[Row {row_num}/{total_rows}] END status=FAILED âŒ')
                
            except Exception as e:
                row_status['status'] = 'FAILED'
                row_status['error'] = str(e)
                failed_count += 1
                add_log(run_id, f'  âŒ Error: {str(e)}')
                add_log(run_id, f'[Row {row_num}/{total_rows}] END status=FAILED âŒ')
            
            # Record row status
            run_registry[run_id]['rows_status'].append(row_status)
        
        # Close SSH connection
        ssh_client.close()
        run_registry[run_id]['ssh_client'] = None
        
        add_log(run_id, '')
        add_log(run_id, '=' * 60)
        add_log(run_id, 'ðŸ”Œ Unix server connection closed')
        
        # Determine final status
        run_registry[run_id]['finished_at'] = datetime.now().isoformat()
        
        if run_registry[run_id]['stop_requested']:
            run_registry[run_id]['status'] = 'STOPPED'
            add_log(run_id, f'â›” Execution stopped. Processed: {success_count + failed_count}/{total_rows}')
        elif failed_count == 0:
            run_registry[run_id]['status'] = 'SUCCESS'
            add_log(run_id, f'âœ… All {total_rows} comparisons completed successfully!')
        elif success_count == 0:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, f'âŒ All {total_rows} comparisons failed')
        else:
            run_registry[run_id]['status'] = 'PARTIAL_SUCCESS'
            add_log(run_id, f'âš ï¸ Completed with partial success: {success_count} succeeded, {failed_count} failed')
        
        add_log(run_id, '=' * 60)
        add_log(run_id, f'ðŸ“Š Summary: {success_count} success, {failed_count} failed, {total_rows} total')
        
    except Exception as e:
        run_registry[run_id]['status'] = 'FAILED'
        run_registry[run_id]['finished_at'] = datetime.now().isoformat()
        add_log(run_id, f'âŒ Fatal error: {str(e)}')
        print(f"Error in execute_multi_table_comparison: {str(e)}")


def execute_multi_table_comparison(run_id, common_params, excel_rows):
    """
    Legacy: Execute multi-table comparison by iterating through Excel rows.
    Kept for backwards compatibility with single-file uploads.
    """
    try:
        run_registry[run_id]['status'] = 'RUNNING'
        total_rows = len(excel_rows)
        
        add_log(run_id, f'ðŸš€ Starting Multi-Table Comparison ({total_rows} tables)...')
        add_log(run_id, '=' * 60)
        
        # Get Unix config from params (UI-provided values override env vars)
        unix_config = get_unix_config_from_params(common_params)
        
        # Check for missing host error
        if 'error' in unix_config:
            run_registry[run_id]['status'] = 'FAILED'
            run_registry[run_id]['finished_at'] = datetime.now().isoformat()
            add_log(run_id, f'âŒ {unix_config["error"]}')
            return
        
        add_log(run_id, f'ðŸ“Š Parsed rows: {total_rows}')
        add_log(run_id, f'âŒ Legacy single-file mode is deprecated. Please use two-file upload.')
        run_registry[run_id]['status'] = 'FAILED'
        run_registry[run_id]['finished_at'] = datetime.now().isoformat()
        
    except Exception as e:
        run_registry[run_id]['status'] = 'FAILED'
        run_registry[run_id]['finished_at'] = datetime.now().isoformat()
        add_log(run_id, f'âŒ Fatal error: {str(e)}')


# ============================================================
# EXECUTION LOGIC
# ============================================================
def execute_static_operation(run_id, tab, params):
    """
    Execute operation in background thread with real-time logging.
    
    Uses centralized working_dir from resolve_execution_context().
    """
    try:
        run_registry[run_id]['status'] = 'RUNNING'
        add_log(run_id, f'ðŸš€ Starting {tab.replace("_", " ").title()} operation...')
        
        # Determine comparison mode for data_comparison tab
        comparison_mode = normalize_comparison_mode(params)
        if tab == 'data_comparison':
            add_log(run_id, f'ðŸ“Š Mode: {comparison_mode.replace("_", " ").title()}')
            
            # For multiple_tables mode via /api/static/run endpoint without Excel files,
            # we cannot iterate - Excel files are required
            if comparison_mode == 'multiple_tables':
                run_registry[run_id]['status'] = 'FAILED'
                add_log(run_id, 'âŒ Multiple Tables mode requires Excel file uploads.')
                add_log(run_id, 'âŒ Please use the /api/static/comparison/run-multi endpoint with source and target Excel files.')
                return
        
        # Data Load tab specific validation and field extraction
        if tab == 'data_load':
            # Validate Data Load specific params
            is_valid, error_msg = validate_data_load_params(params)
            if not is_valid:
                run_registry[run_id]['status'] = 'FAILED'
                add_log(run_id, f'âŒ Validation Error: {error_msg}')
                return
            
            # Extract and add Data Load fields to params
            load_fields = extract_data_load_fields(params)
            params['target_load_type'] = load_fields['target_load_type']
            add_log(run_id, f'âš¡ Load Type: {load_fields["target_load_type"]}')
            
            # Add Hive-specific fields if applicable
            if load_fields['target_db_type'].lower() == 'hive':
                params['hadoop_path'] = load_fields['hadoop_path']
                params['partition_id'] = load_fields['partition_id']
                add_log(run_id, f'ðŸ Target DB: Hive')
                add_log(run_id, f'ðŸ“‚ Hadoop Path: {load_fields["hadoop_path"]}')
                add_log(run_id, f'ðŸ”– Partition ID: {load_fields["partition_id"]}')
        
        # File Load tab specific validation and field extraction (File-to-Database)
        if tab == 'file_load':
            # Validate File Load specific params
            is_valid, error_msg = validate_file_load_params(params)
            if not is_valid:
                run_registry[run_id]['status'] = 'FAILED'
                add_log(run_id, f'âŒ Validation Error: {error_msg}')
                return
            
            # Extract and add File Load source fields to params
            source_fields = extract_file_load_source_fields(params)
            params['source_file_type'] = source_fields['source_file_type']
            params['source_location_type'] = source_fields['source_location_type']
            params['source_unix_path'] = source_fields['source_unix_path']
            params['source_hadoop_path'] = source_fields['source_hadoop_path']
            params['source_delimiter'] = source_fields['source_delimiter']
            params['source_file_sql_query'] = source_fields['source_file_sql_query']
            params['source_key_columns'] = source_fields['source_key_columns']
            
            add_log(run_id, f'ðŸ“„ Source File Type: {source_fields["source_file_type"]}')
            add_log(run_id, f'ðŸ“ Source Location: {source_fields["source_location_type"]}')
            if source_fields['source_unix_path']:
                add_log(run_id, f'ðŸ“‚ Source Unix Path: {source_fields["source_unix_path"]}')
            if source_fields['source_hadoop_path']:
                add_log(run_id, f'ðŸ“‚ Source Hadoop Path: {source_fields["source_hadoop_path"]}')
            
            # Extract and add File Load target fields (same as Data Load)
            target_fields = extract_file_load_target_fields(params)
            params['target_load_type'] = target_fields['target_load_type']
            add_log(run_id, f'âš¡ Target Load Type: {target_fields["target_load_type"]}')
            
            # Add Hive-specific fields if applicable
            if target_fields['target_db_type'].lower() == 'hive':
                params['hadoop_path'] = target_fields['hadoop_path']
                params['partition_id'] = target_fields['partition_id']
                add_log(run_id, f'ðŸ Target DB: Hive')
                add_log(run_id, f'ðŸ“‚ Hadoop Path: {target_fields["hadoop_path"]}')
                add_log(run_id, f'ðŸ”– Partition ID: {target_fields["partition_id"]}')
        
        # File Download tab specific validation and field extraction
        if tab == 'file_download':
            # Validate File Download specific params
            is_valid, error_msg = validate_file_download_params(params)
            if not is_valid:
                run_registry[run_id]['status'] = 'FAILED'
                add_log(run_id, f'âŒ Validation Error: {error_msg}')
                return
            
            # Extract and log File Download fields
            download_fields = extract_file_download_fields(params)
            params['source_type'] = download_fields['source_type']
            params['target_file_type'] = download_fields['target_file_type']
            params['target_file_name'] = download_fields['target_file_name']
            
            if download_fields['target_delimiter']:
                params['target_delimiter'] = download_fields['target_delimiter']
            if download_fields['number_of_rows']:
                params['number_of_rows'] = download_fields['number_of_rows']
            
            add_log(run_id, f'ðŸ“¥ Source Type: {download_fields["source_type"]}')
            add_log(run_id, f'ðŸ“„ Target File Type: {download_fields["target_file_type"]}')
            add_log(run_id, f'ðŸ“ Target File Name: {download_fields["target_file_name"]}')
            if download_fields['number_of_rows']:
                add_log(run_id, f'ðŸ”¢ Number of Rows: {download_fields["number_of_rows"]}')
        
        # Resolve execution context ONCE using central function
        exec_context = resolve_execution_context(params, run_id)
        
        if exec_context['error']:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, f'âŒ {exec_context["error"]}')
            return
        
        # Extract resolved context
        working_dir = exec_context['working_dir']
        batch_id = exec_context['batch_id']
        env = exec_context['env']
        unix_config = exec_context['unix_config']
        
        # Store in run registry for global access
        set_execution_context(run_id, working_dir, batch_id, env)
        
        # Log working directory ONCE per run
        add_log(run_id, f'ðŸ“‚ Global working directory set to: {working_dir}')
        add_log(run_id, f'ðŸŒ Environment: {env}, Batch ID: {batch_id}')
        add_log(run_id, f'ðŸ”§ Unix host: {unix_config["host"]}')
        
        # Extract and log time_zone (default to N/A if not provided)
        time_zone = extract_time_zone(params)
        params['time_zone'] = time_zone  # Ensure it's in params for script args
        add_log(run_id, f'ðŸ• Time Zone: {time_zone}')
        
        add_log(run_id, f'ðŸ“¡ Connecting to Unix server {unix_config["host"]}:{unix_config["port"]}...')
        
        # Connect to Unix server
        ssh_client = connect_unix_server(unix_config, run_id)
        
        if not ssh_client:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, 'âŒ Failed to connect to Unix server')
            return
        
        run_registry[run_id]['ssh_client'] = ssh_client
        add_log(run_id, 'âœ… Successfully connected to Unix server')
        
        # Check if stop requested
        if run_registry[run_id]['stop_requested']:
            ssh_client.close()
            return
        
        # Determine script path based on tab
        # For data_comparison single_table mode: use SINGLE_TABLE_SCRIPT
        # For other tabs: use TAB_SCRIPT_MAP
        if tab == 'data_comparison':
            # Single table mode only (multiple_tables is handled above with early return)
            script_path = SINGLE_TABLE_SCRIPT
            add_log(run_id, f'ðŸ“‹ Using single-table script: {script_path}')
        else:
            # Other tabs - use TAB_SCRIPT_MAP
            script_path = TAB_SCRIPT_MAP[tab]
            add_log(run_id, f'ðŸ“‹ Using script: {script_path}')
        
        # Build script arguments
        script_args = build_script_arguments(params)
        
        # Build full command using global working_dir (no redundant log)
        add_log(run_id, f'â–¶ï¸ Executing script: {script_path}')
        command = f'cd {shlex.quote(working_dir)} && {script_path} {script_args}'
        
        # Execute command and stream output
        success = execute_command_streaming(ssh_client, command, run_id)
        
        # Close SSH connection
        ssh_client.close()
        run_registry[run_id]['ssh_client'] = None
        add_log(run_id, 'ðŸ”Œ Unix server connection closed')
        
        # Set final status
        if run_registry[run_id]['stop_requested']:
            run_registry[run_id]['status'] = 'STOPPED'
        elif success:
            run_registry[run_id]['status'] = 'SUCCESS'
            add_log(run_id, f'âœ… {tab.replace("_", " ").title()} completed successfully!')
            
            # For single_table data_comparison, set up download info
            if tab == 'data_comparison' and comparison_mode == 'single_table':
                download_info = determine_download_filename(params)
                run_registry[run_id]['download_available'] = True
                run_registry[run_id]['download_filename'] = download_info['filename']
                run_registry[run_id]['unix_output_path'] = download_info['unix_path']
                add_log(run_id, f'â¬‡ï¸ Output file ready for download: {download_info["filename"]}')
            
            # For file_download tab, set up download info with user-specified filename
            if tab == 'file_download':
                download_fields = extract_file_download_fields(params)
                target_file_name = download_fields['target_file_name']
                run_registry[run_id]['download_available'] = True
                run_registry[run_id]['download_filename'] = target_file_name
                run_registry[run_id]['unix_output_path'] = '/tmp/output.csv'  # Default path, script should output here
                add_log(run_id, f'â¬‡ï¸ Output file ready for download: {target_file_name}')
            
            # For schema_generation tab, set up download info with user-specified output filename
            if tab == 'schema_generation':
                output_file_name = (
                    params.get('output_file_name') or
                    params.get('schemaTargetOutputFileName') or
                    'schema_output.sql'
                ).strip()
                run_registry[run_id]['download_available'] = True
                run_registry[run_id]['download_filename'] = output_file_name
                run_registry[run_id]['unix_output_path'] = f'/tmp/{output_file_name}'
                add_log(run_id, f'â¬‡ï¸ Output file ready for download: {output_file_name}')
        else:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, f'âŒ {tab.replace("_", " ").title()} failed')
            
    except Exception as e:
        run_registry[run_id]['status'] = 'FAILED'
        add_log(run_id, f'âŒ Error: {str(e)}')
        print(f"Error in execute_static_operation: {str(e)}")

def connect_unix_server(unix_config, run_id=None):
    """Connect to Unix server using Paramiko with environment-based config"""
    try:
        ssh_client = paramiko.SSHClient()
        ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        
        connect_kwargs = {
            'hostname': unix_config['host'],
            'port': unix_config['port'],
            'username': unix_config['username'],
            'timeout': 30
        }
        
        # Always use password authentication (SSH key auth removed)
        connect_kwargs['password'] = unix_config['password']
        if run_id:
            add_log(run_id, 'ðŸ” Using password authentication')
        
        ssh_client.connect(**connect_kwargs)
        return ssh_client
        
    except Exception as e:
        if run_id:
            add_log(run_id, f'âŒ SSH connection error: {str(e)}')
        print(f"SSH connection error: {str(e)}")
        return None

def execute_command_streaming(ssh_client, command, run_id):
    """Execute command and stream output to logs"""
    try:
        add_log(run_id, f'âš™ï¸ Running command...')
        
        # Execute command
        stdin, stdout, stderr = ssh_client.exec_command(command)
        
        # Stream stdout line by line
        for line in iter(stdout.readline, ''):
            if run_registry[run_id]['stop_requested']:
                return False
            if line:
                add_log(run_id, line.strip())
        
        # Check stderr
        stderr_output = stderr.read().decode()
        if stderr_output:
            for line in stderr_output.split('\n'):
                if line.strip():
                    add_log(run_id, f'âš ï¸ {line.strip()}')
        
        # Get exit status
        exit_status = stdout.channel.recv_exit_status()
        
        if exit_status == 0:
            add_log(run_id, 'âœ… Command executed successfully')
            return True
        else:
            add_log(run_id, f'âŒ Command failed with exit code {exit_status}')
            return False
            
    except Exception as e:
        add_log(run_id, f'âŒ Command execution error: {str(e)}')
        return False

def escape_shell_arg(arg):
    """Safely escape shell arguments to handle special characters"""
    if arg is None:
        return "''"
    
    arg_str = str(arg)
    return shlex.quote(arg_str)

def build_script_arguments(params):
    """Build properly escaped command-line arguments from params dict"""
    arg_parts = []
    
    # First, extract file path fields if this is a file-based comparison
    file_path_fields = extract_file_path_fields(params)
    
    # Merge file path fields into params for processing
    merged_params = {**params, **file_path_fields}
    
    for key, value in merged_params.items():
        if value is not None and value != '':
            escaped_value = escape_shell_arg(value)
            # Convert camelCase to snake_case for CLI args
            cli_key = ''.join(['_' + c.lower() if c.isupper() else c for c in key]).lstrip('_')
            arg_parts.append(f'--{cli_key}={escaped_value}')
    
    return ' '.join(arg_parts)

def build_command_with_args(script_path, params):
    """Build shell command with properly escaped arguments from params dict"""
    command_parts = [script_path]
    
    for key, value in params.items():
        if value is not None and value != '':
            escaped_value = escape_shell_arg(value)
            # Convert camelCase to snake_case for CLI args
            cli_key = ''.join(['_' + c.lower() if c.isupper() else c for c in key]).lstrip('_')
            command_parts.append(f'--{cli_key}={escaped_value}')
    
    return ' '.join(command_parts)

def add_log(run_id, message):
    """Add log message to run registry"""
    if run_id in run_registry:
        timestamp = time.strftime('%H:%M:%S')
        log_entry = f'[{timestamp}] {message}'
        run_registry[run_id]['logs'].append(log_entry)
        print(log_entry)

# ============================================================
# LEGACY WEBSOCKET ENDPOINTS (kept for backwards compatibility)
# ============================================================
@app.route('/api/execute-operation', methods=['POST'])
def execute_operation():
    data = request.json
    operation_type = data.get('operation', 'Unknown')
    
    print(f"Operation requested - Type: {operation_type}")
    print(f"Operation data: {data}")
    
    # Start operation in background thread
    thread = threading.Thread(target=process_operation, args=(data, operation_type))
    thread.daemon = True
    thread.start()
    
    return jsonify({"status": "success", "message": f"{operation_type} operation started"})

def process_operation(data, operation_type):
    """Process operation in background thread with real-time logging (legacy WebSocket)"""
    try:
        # Extract Unix server connection details from form data (legacy)
        unix_config = extract_unix_config(data)
        
        # Extract source and target configurations
        source_config = extract_source_config(data, operation_type)
        target_config = extract_target_config(data, operation_type)
        
        emit_log(f"Connecting to Unix server {unix_config['host']}:{unix_config['port']}...")
        ssh_client = connect_unix_server(unix_config)
        
        if not ssh_client:
            emit_error("Failed to connect to Unix server")
            return
        
        emit_log("Successfully connected to Unix server")
        
        # Execute operation based on type
        if operation_type == 'Data Comparison':
            execute_data_comparison(ssh_client, source_config, target_config, data)
        elif operation_type == 'Data Load':
            execute_data_load(ssh_client, source_config, target_config, data)
        elif operation_type == 'Schema Generation':
            execute_schema_generation(ssh_client, source_config, target_config, data)
        elif operation_type == 'File Load':
            execute_file_load(ssh_client, source_config, target_config, data)
        elif operation_type == 'File Download':
            execute_file_download(ssh_client, source_config, target_config, data)
        else:
            emit_error(f"Unknown operation type: {operation_type}")
        
        ssh_client.close()
        emit_log("Unix server connection closed")
        
    except Exception as e:
        emit_error(f"Operation failed: {str(e)}")
        print(f"Error in process_operation: {str(e)}")

def execute_command(ssh_client, command):
    """Execute command on Unix server and stream output (legacy)"""
    try:
        emit_log(f"Executing command: {command}")
        
        stdin, stdout, stderr = ssh_client.exec_command(command)
        
        for line in stdout:
            emit_log(line.strip())
        
        stderr_output = stderr.read().decode()
        if stderr_output:
            emit_log(f"Warnings/Errors: {stderr_output}")
        
        exit_status = stdout.channel.recv_exit_status()
        
        if exit_status == 0:
            emit_log("Command executed successfully")
            return True
        else:
            emit_error(f"Command failed with exit status {exit_status}")
            return False
            
    except Exception as e:
        emit_error(f"Command execution error: {str(e)}")
        return False

def execute_data_comparison(ssh_client, source_config, target_config, data):
    """Execute data comparison operation (legacy)"""
    try:
        emit_log("Starting data comparison operation...")
        
        comparison_type = data.get('comparison-type-select', 'database-to-database')
        table_mode = data.get('tableMode', 'single')
        key_columns = data.get('keyColumns', '')
        
        emit_log(f"Comparison Type: {comparison_type}")
        emit_log(f"Table Mode: {table_mode}")
        
        args = {
            'comparison_type': comparison_type,
            'table_mode': table_mode,
            'key_columns': key_columns,
            'source_type': source_config.get('type'),
            'source_host': source_config.get('host'),
            'source_port': source_config.get('port'),
            'source_database': source_config.get('database'),
            'source_username': source_config.get('username'),
            'source_password': source_config.get('password'),
            'source_table': source_config.get('table'),
            'source_sql': source_config.get('sql'),
            'source_file_type': source_config.get('file_type'),
            'source_delimiter': source_config.get('delimiter'),
            'source_file_path': source_config.get('file_path'),
            'target_type': target_config.get('type'),
            'target_host': target_config.get('host'),
            'target_port': target_config.get('port'),
            'target_database': target_config.get('database'),
            'target_username': target_config.get('username'),
            'target_password': target_config.get('password'),
            'target_table': target_config.get('table'),
            'target_sql': target_config.get('sql'),
            'target_file_type': target_config.get('file_type'),
            'target_delimiter': target_config.get('delimiter'),
            'target_file_path': target_config.get('file_path')
        }
        
        script_path = '/path/to/data_comparison.sh'
        command = build_command_with_args(script_path, args)
        
        success = execute_command(ssh_client, command)
        
        if success:
            report_path = f"/reports/comparison_{int(time.time())}.csv"
            socketio.emit('operation_complete', {
                'status': 'success',
                'operation': 'Data Comparison',
                'report_path': report_path
            })
        
    except Exception as e:
        emit_error(f"Data comparison failed: {str(e)}")

def execute_data_load(ssh_client, source_config, target_config, data):
    """Execute data load operation (legacy)"""
    try:
        emit_log("Starting data load operation...")
        
        args = {
            'source_type': source_config.get('type'),
            'source_host': source_config.get('host'),
            'source_database': source_config.get('database'),
            'source_username': source_config.get('username'),
            'source_password': source_config.get('password'),
            'source_table': source_config.get('table'),
            'target_type': target_config.get('type'),
            'target_host': target_config.get('host'),
            'target_database': target_config.get('database'),
            'target_username': target_config.get('username'),
            'target_password': target_config.get('password'),
            'target_table': target_config.get('table'),
            'batch_size': data.get('batchSize', '1000')
        }
        
        script_path = '/path/to/data_load.sh'
        command = build_command_with_args(script_path, args)
        
        success = execute_command(ssh_client, command)
        
        if success:
            socketio.emit('operation_complete', {
                'status': 'success',
                'operation': 'Data Load'
            })
        
    except Exception as e:
        emit_error(f"Data load failed: {str(e)}")

def execute_schema_generation(ssh_client, source_config, target_config, data):
    """Execute schema generation operation (legacy)"""
    try:
        emit_log("Starting schema generation operation...")
        
        args = {
            'source_database': source_config.get('database'),
            'source_host': source_config.get('host'),
            'source_username': source_config.get('username'),
            'source_password': source_config.get('password'),
            'target_database': target_config.get('database'),
            'schema_name': data.get('schemaName', ''),
            'output_format': data.get('outputFormat', 'DDL')
        }
        
        script_path = '/path/to/schema_generation.sh'
        command = build_command_with_args(script_path, args)
        
        success = execute_command(ssh_client, command)
        
        if success:
            socketio.emit('operation_complete', {
                'status': 'success',
                'operation': 'Schema Generation'
            })
        
    except Exception as e:
        emit_error(f"Schema generation failed: {str(e)}")

def execute_file_load(ssh_client, source_config, target_config, data):
    """Execute file load operation (legacy)"""
    try:
        emit_log("Starting file load operation...")
        
        args = {
            'file_type': source_config.get('file_type'),
            'file_path': source_config.get('file_path'),
            'target_database': target_config.get('database'),
            'target_table': target_config.get('table'),
            'target_host': target_config.get('host'),
            'target_username': target_config.get('username'),
            'target_password': target_config.get('password')
        }
        
        script_path = '/path/to/file_load.sh'
        command = build_command_with_args(script_path, args)
        
        success = execute_command(ssh_client, command)
        
        if success:
            socketio.emit('operation_complete', {
                'status': 'success',
                'operation': 'File Load'
            })
        
    except Exception as e:
        emit_error(f"File load failed: {str(e)}")

def execute_file_download(ssh_client, source_config, target_config, data):
    """Execute file download operation (legacy)"""
    try:
        emit_log("Starting file download operation...")
        
        args = {
            'source_path': source_config.get('file_path'),
            'target_path': target_config.get('file_path'),
            'file_format': data.get('exportFormat', 'CSV')
        }
        
        script_path = '/path/to/file_download.sh'
        command = build_command_with_args(script_path, args)
        
        success = execute_command(ssh_client, command)
        
        if success:
            socketio.emit('operation_complete', {
                'status': 'success',
                'operation': 'File Download'
            })
        
    except Exception as e:
        emit_error(f"File download failed: {str(e)}")

def extract_unix_config(data):
    """Extract Unix server configuration from request data (legacy)"""
    return {
        'host': data.get('comparisonUnixHost') or data.get('loadUnixHost') or data.get('schemaUnixHost') or data.get('fileloadUnixHost') or data.get('filedownloadUnixHost', 'localhost'),
        'port': data.get('comparisonUnixPort') or data.get('loadUnixPort') or data.get('schemaUnixPort') or data.get('fileloadUnixPort') or data.get('filedownloadUnixPort', '22'),
        'username': data.get('comparisonUnixUsername') or data.get('loadUnixUsername') or data.get('schemaUnixUsername') or data.get('fileloadUnixUsername') or data.get('filedownloadUnixUsername', 'user'),
        'password': data.get('comparisonUnixPassword') or data.get('loadUnixPassword') or data.get('schemaUnixPassword') or data.get('fileloadUnixPassword') or data.get('filedownloadUnixPassword', '')
    }

def extract_source_config(data, operation_type):
    """Extract source configuration from request data (legacy)"""
    prefix = get_prefix_for_operation(operation_type, 'source')
    
    return {
        'type': data.get(f'{prefix}Type'),
        'host': data.get(f'{prefix}Host'),
        'port': data.get(f'{prefix}Port'),
        'database': data.get(f'{prefix}Database'),
        'username': data.get(f'{prefix}Username'),
        'password': data.get(f'{prefix}Password'),
        'table': data.get(f'{prefix}TableName'),
        'sql': data.get(f'{prefix}SqlQuery'),
        'file_type': data.get(f'{prefix}FileType'),
        'delimiter': data.get(f'{prefix}Delimiter'),
        'file_path': data.get(f'{prefix}FilePath')
    }

def extract_target_config(data, operation_type):
    """Extract target configuration from request data (legacy)"""
    prefix = get_prefix_for_operation(operation_type, 'target')
    
    return {
        'type': data.get(f'{prefix}Type'),
        'host': data.get(f'{prefix}Host'),
        'port': data.get(f'{prefix}Port'),
        'database': data.get(f'{prefix}Database'),
        'username': data.get(f'{prefix}Username'),
        'password': data.get(f'{prefix}Password'),
        'table': data.get(f'{prefix}TableName'),
        'sql': data.get(f'{prefix}SqlQuery'),
        'file_type': data.get(f'{prefix}FileType'),
        'delimiter': data.get(f'{prefix}Delimiter'),
        'file_path': data.get(f'{prefix}FilePath')
    }

def get_prefix_for_operation(operation_type, side):
    """Get field prefix based on operation type and side (legacy)"""
    operation_prefixes = {
        'Data Comparison': 'comparison',
        'Data Load': 'load',
        'Schema Generation': 'schema',
        'File Load': 'fileload',
        'File Download': 'filedownload'
    }
    
    prefix = operation_prefixes.get(operation_type, 'comparison')
    return f"{prefix}{side.capitalize()}"

def emit_log(message):
    """Emit log message to connected clients (legacy WebSocket)"""
    timestamp = time.strftime('%H:%M:%S')
    log_message = f"[{timestamp}] {message}"
    socketio.emit('log', {'message': log_message})
    print(log_message)

def emit_error(error_message):
    """Emit error message to connected clients (legacy WebSocket)"""
    socketio.emit('operation_error', {'error': error_message})
    print(f"ERROR: {error_message}")

# ============================================================
# WEBSOCKET HANDLERS (legacy)
# ============================================================
@socketio.on('connect')
def handle_connect():
    print('Client connected')
    emit('connected', {'data': 'Connected to server'})

@socketio.on('disconnect')
def handle_disconnect():
    print('Client disconnected')


# ============================================================
# MISMATCH EXPLORER - In-memory storage for job results
# ============================================================
mismatch_jobs = {}
# Structure:
# {
#   job_id: {
#     'status': 'started' | 'completed' | 'failed',
#     'table': str,
#     'pkColumn': str,
#     'rules': dict,
#     'totalRecords': int,
#     'summaryRows': [],  # List of {pkValue, pkDisplay, mismatchCount, status}
#     'detailsCache': {},  # {pkValue: [field details]}
#     'created_at': datetime
#   }
# }


def parse_record_explorer_json(records_data, run_id=None):
     """
     Robustly parse records from the JSON report file format.
     Supports: JSON array, JSON Lines (NDJSON), single JSON object, and double-encoded JSON.
     Expected format: list of records with pk, pkDisplay, mismatchCount, status, fields
     
     Returns (summary_rows, details_cache, debug_info)
     """
     summary_rows = []
     details_cache = {}
     debug_info = {
         'detected_format': 'unknown',
         'raw_count': 0,
         'parsed_count': 0,
         'skipped_count': 0,
         'messages': []
     }
     
     # Step 1: Ensure records_data is a list of dicts
     if isinstance(records_data, str):
         # Double-encoded JSON safety
         try:
             records_data = json.loads(records_data)
             debug_info['messages'].append('Detected double-encoded JSON')
             if isinstance(records_data, str):
                 records_data = json.loads(records_data)
                 debug_info['messages'].append('Applied second decode')
         except json.JSONDecodeError as e:
             # Not valid JSON, try JSON Lines
             records_data = None
     
     # Step 2: Handle different JSON formats
     if records_data is None or (isinstance(records_data, str)):
         # Try JSON Lines format
         lines = records_data.strip().split('\n') if isinstance(records_data, str) else []
         if lines and len(lines) > 0:
             debug_info['detected_format'] = 'jsonlines'
             debug_info['messages'].append(f'Detected JSON Lines format with {len(lines)} lines')
             records_list = []
             for i, line in enumerate(lines):
                 line = line.strip()
                 if not line:
                     continue
                 try:
                     record = json.loads(line)
                     if isinstance(record, dict):
                         records_list.append(record)
                     else:
                         debug_info['skipped_count'] += 1
                         debug_info['messages'].append(f'Skipped line {i+1} (not a dict after parse)')
                 except json.JSONDecodeError:
                     debug_info['skipped_count'] += 1
                     debug_info['messages'].append(f'Skipped line {i+1} (invalid JSON)')
             records_data = records_list
     elif isinstance(records_data, dict):
         # Single JSON object, wrap in list
         debug_info['detected_format'] = 'single_object'
         debug_info['messages'].append('Detected single JSON object, wrapping in list')
         records_data = [records_data]
     elif isinstance(records_data, list):
         # Already a list, check format
         if len(records_data) > 0:
             if isinstance(records_data[0], dict):
                 debug_info['detected_format'] = 'array'
                 debug_info['messages'].append('Detected JSON array format')
             elif isinstance(records_data[0], str):
                 debug_info['detected_format'] = 'array_of_strings'
                 debug_info['messages'].append('Detected array of JSON strings, parsing each')
                 parsed_records = []
                 for i, item in enumerate(records_data):
                     try:
                         parsed_item = json.loads(item)
                         if isinstance(parsed_item, dict):
                             parsed_records.append(parsed_item)
                         else:
                             debug_info['skipped_count'] += 1
                             debug_info['messages'].append(f'Skipped index {i} (parsed to non-dict)')
                     except json.JSONDecodeError:
                         debug_info['skipped_count'] += 1
                         debug_info['messages'].append(f'Skipped index {i} (invalid JSON)')
                 records_data = parsed_records
     else:
         debug_info['messages'].append(f'Unexpected format: {type(records_data).__name__}')
         records_data = []
     
     # Step 3: Final validation and processing
     if not isinstance(records_data, list):
         records_data = []
     
     debug_info['raw_count'] = len(records_data)
     
     final_records = []
     for i, record in enumerate(records_data):
         if isinstance(record, dict):
             final_records.append(record)
         elif isinstance(record, str):
             # Try to parse string elements
             try:
                 parsed_record = json.loads(record)
                 if isinstance(parsed_record, dict):
                     final_records.append(parsed_record)
                 else:
                     debug_info['skipped_count'] += 1
                     debug_info['messages'].append(f'Skipped index {i} (re-parse not dict)')
             except json.JSONDecodeError:
                 debug_info['skipped_count'] += 1
                 debug_info['messages'].append(f'Skipped index {i} (cannot parse string)')
         else:
             debug_info['skipped_count'] += 1
             debug_info['messages'].append(f'Skipped index {i} (type: {type(record).__name__})')
     
     # Step 4: Build summary and details cache
     debug_info['parsed_count'] = len(final_records)
     for record in final_records:
         pk_display = record.get('pkDisplay', str(record.get('pk', 'UNKNOWN')))
         mismatch_count = record.get('mismatchCount', 0)
         status = record.get('status', 'MATCH')
         
         summary_rows.append({
             'pkValue': pk_display,
             'mismatchCount': mismatch_count,
             'status': status
         })
         
         # Store field details
         fields = record.get('fields', [])
         details_cache[pk_display] = fields
     
     # Log debug info if run_id provided
     if run_id:
         print(f"[Mismatch Explorer Fetch] Format: {debug_info['detected_format']}")
         print(f"[Mismatch Explorer Fetch] Raw records: {debug_info['raw_count']}")
         print(f"[Mismatch Explorer Fetch] Parsed records: {debug_info['parsed_count']}")
         print(f"[Mismatch Explorer Fetch] Skipped: {debug_info['skipped_count']}")
         for msg in debug_info['messages']:
             print(f"[Mismatch Explorer Fetch] {msg}")
     
     return summary_rows, details_cache, debug_info


def generate_mock_mismatch_data_from_records():
    """
    Generate mock mismatch data in the new JSON report format for testing.
    Returns list of records.
    """
    import random
    
    field_names = ['CUSTOMER_ID', 'FIRST_NAME', 'LAST_NAME', 'EMAIL', 'PHONE', 
                   'ADDRESS', 'CITY', 'STATE', 'ZIP_CODE', 'COUNTRY',
                   'CREATED_DATE', 'UPDATED_DATE', 'STATUS', 'BALANCE', 'ACCOUNT_TYPE']
    
    records = []
    num_records = random.randint(20, 100)
    
    for i in range(num_records):
        pk_obj = {
            'client_id': str(10 + i),
            'account_id': f'A{100 + i}',
            'batch_id': f'B{random.randint(1, 99)}'
        }
        pk_display = ' | '.join([f'{k}={v}' for k, v in pk_obj.items()])
        
        # Generate fields
        fields = []
        selected_fields = random.sample(field_names, random.randint(5, len(field_names)))
        mismatch_count = random.randint(0, 5)
        mismatch_indices = random.sample(range(len(selected_fields)), min(mismatch_count, len(selected_fields)))
        
        actual_mismatch_count = 0
        for j, field in enumerate(selected_fields):
            if j in mismatch_indices:
                source_val = f'SrcVal_{random.randint(100, 999)}'
                target_val = f'TgtVal_{random.randint(100, 999)}'
                field_status = 'MISMATCH'
                actual_mismatch_count += 1
            else:
                val = f'Val_{random.randint(100, 999)}'
                source_val = val
                target_val = val
                field_status = 'MATCH'
            
            fields.append({
                'fieldName': field,
                'sourceValue': source_val,
                'targetValue': target_val,
                'status': field_status
            })
        
        records.append({
            'pk': pk_obj,
            'pkDisplay': pk_display,
            'mismatchCount': actual_mismatch_count,
            'status': 'MISMATCH' if actual_mismatch_count > 0 else 'MATCH',
            'fields': fields
        })
    
    return records


# ============================================================
# MISMATCH EXPLORER ENDPOINTS
# ============================================================

@app.route('/api/mismatch-explorer/execute', methods=['POST'])
def mismatch_explorer_execute():
    """
    Execute Mismatch Explorer job via Paramiko on Unix.
    Returns run_id for log streaming.
    """
    try:
        data = request.get_json()
        
        # Extract Unix config
        unix_config = {
            'host': data.get('mismatchUnixHost', ''),
            'port': 22,
            'username': data.get('mismatchUnixUsername', ''),
            'password': data.get('mismatchUnixPassword', ''),
            'batch_id': data.get('mismatchBatchId', ''),
            'user_email': data.get('mismatchUserEmail', '')
        }
        
        # Validate required Unix fields
        if not unix_config['host']:
            return jsonify({'error': 'Unix Host is required'}), 400
        if not unix_config['username'] or not unix_config['password']:
            return jsonify({'error': 'Unix credentials are required'}), 400
        if not unix_config['batch_id']:
            return jsonify({'error': 'Batch ID is required'}), 400
        
        # Generate run ID
        run_id = f'mismatch_{uuid.uuid4().hex[:12]}'
        
        # Initialize run in registry
        run_registry[run_id] = {
            'status': 'PENDING',
            'logs': [],
            'tab': 'mismatch_explorer',
            'params': data,
            'unix_config': unix_config,
            'thread': None,
            'ssh_client': None,
            'stop_requested': False,
            'started_at': datetime.now()
        }
        
        # Start execution in background thread
        thread = threading.Thread(
            target=execute_mismatch_explorer_job,
            args=(run_id, data, unix_config)
        )
        run_registry[run_id]['thread'] = thread
        thread.start()
        
        return jsonify({
            'run_id': run_id,
            'status': 'started'
        })
        
    except Exception as e:
        print(f"Mismatch Explorer execute error: {str(e)}")
        return jsonify({'error': str(e)}), 500


def execute_mismatch_explorer_job(run_id, params, unix_config):
    """
    Background thread to execute Mismatch Explorer job via Paramiko.
    """
    try:
        run_registry[run_id]['status'] = 'RUNNING'
        add_log(run_id, "ðŸš€ Starting Mismatch Explorer execution...")
        
        # Log explicit connection details (NEVER log password)
        add_log(run_id, f"ðŸ“¡ Using Unix Host: {unix_config['host']}")
        add_log(run_id, f"ðŸ‘¤ Using Unix Username: {unix_config['username']}")
        add_log(run_id, f"ðŸ”Œ Using SSH Port: {unix_config['port']}")
        add_log(run_id, "ðŸ” Auth Method: password")
        add_log(run_id, "ðŸ“¡ Attempting SSH connection...")
        
        # Connect via SSH
        ssh_client = paramiko.SSHClient()
        ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        
        try:
            ssh_client.connect(
                hostname=unix_config['host'],
                port=unix_config['port'],
                username=unix_config['username'],
                password=unix_config['password'],
                timeout=30,
                allow_agent=False,
                look_for_keys=False
            )
            run_registry[run_id]['ssh_client'] = ssh_client
            add_log(run_id, f"âœ… SSH connected successfully to {unix_config['host']}")
            
        except paramiko.AuthenticationException as auth_err:
            add_log(run_id, f"âŒ SSH connection failed: Authentication failed - {str(auth_err)}")
            run_registry[run_id]['status'] = 'FAILED'
            run_registry[run_id]['finished_at'] = datetime.now()
            return
        except paramiko.SSHException as ssh_err:
            add_log(run_id, f"âŒ SSH connection failed: SSH error - {str(ssh_err)}")
            run_registry[run_id]['status'] = 'FAILED'
            run_registry[run_id]['finished_at'] = datetime.now()
            return
        except Exception as conn_error:
            add_log(run_id, f"âŒ SSH connection failed: {type(conn_error).__name__} - {str(conn_error)}")
            run_registry[run_id]['status'] = 'FAILED'
            run_registry[run_id]['finished_at'] = datetime.now()
            return
        
        # Resolve execution context using the unix_config we already have
        # Wrap unix_config as params for resolve_execution_context
        context_params = {
            'unix_host': unix_config['host'],
            'unixHost': unix_config['host'],
            'batch_id': unix_config['batch_id'],
            'batchId': unix_config['batch_id']
        }
        context = resolve_execution_context(context_params)
        if context.get('error'):
            add_log(run_id, f"âŒ Context error: {context['error']}")
            run_registry[run_id]['status'] = 'FAILED'
            run_registry[run_id]['finished_at'] = datetime.now()
            ssh_client.close()
            return
        
        working_dir = context['working_dir']
        batch_id = context['batch_id']
        env = context['env']
        
        add_log(run_id, f"ðŸ“‚ Working directory: {working_dir}")
        add_log(run_id, f"ðŸŒ Environment: {env}, Batch ID: {batch_id}")
        
        # Build the execution command
        script_name = '/home/chandra/etldsacd/dev/test/data_comparison.sh'
        command = f"cd {shlex.quote(working_dir)} && {script_name}"
        
        # Add parameters
        command += f" --run_id={shlex.quote(run_id)}"
        
        # Source config
        if params.get('mismatchSourceType'):
            command += f" --source_db_type={shlex.quote(params['mismatchSourceType'])}"
        if params.get('mismatchSourceHost'):
            command += f" --source_host={shlex.quote(params['mismatchSourceHost'])}"
        if params.get('mismatchSourcePort'):
            command += f" --source_port={shlex.quote(params['mismatchSourcePort'])}"
        if params.get('mismatchSourceDatabase'):
            command += f" --source_database={shlex.quote(params['mismatchSourceDatabase'])}"
        if params.get('mismatchSourceUsername'):
            command += f" --source_username={shlex.quote(params['mismatchSourceUsername'])}"
        if params.get('mismatchSourcePassword'):
            command += f" --source_password={shlex.quote(params['mismatchSourcePassword'])}"
        if params.get('mismatchSourceTableName'):
            command += f" --source_table={shlex.quote(params['mismatchSourceTableName'])}"
        if params.get('mismatchSourcePrimaryKey'):
            command += f" --source_pk={shlex.quote(params['mismatchSourcePrimaryKey'])}"
        if params.get('mismatchSourceSqlQuery'):
            command += f" --source_sql={shlex.quote(params['mismatchSourceSqlQuery'])}"
        
        # Target config
        if params.get('mismatchTargetType'):
            command += f" --target_db_type={shlex.quote(params['mismatchTargetType'])}"
        if params.get('mismatchTargetHost'):
            command += f" --target_host={shlex.quote(params['mismatchTargetHost'])}"
        if params.get('mismatchTargetPort'):
            command += f" --target_port={shlex.quote(params['mismatchTargetPort'])}"
        if params.get('mismatchTargetDatabase'):
            command += f" --target_database={shlex.quote(params['mismatchTargetDatabase'])}"
        if params.get('mismatchTargetUsername'):
            command += f" --target_username={shlex.quote(params['mismatchTargetUsername'])}"
        if params.get('mismatchTargetPassword'):
            command += f" --target_password={shlex.quote(params['mismatchTargetPassword'])}"
        if params.get('mismatchTargetTableName'):
            command += f" --target_table={shlex.quote(params['mismatchTargetTableName'])}"
        if params.get('mismatchTargetPrimaryKey'):
            command += f" --target_pk={shlex.quote(params['mismatchTargetPrimaryKey'])}"
        if params.get('mismatchTargetSqlQuery'):
            command += f" --target_sql={shlex.quote(params['mismatchTargetSqlQuery'])}"
        
        # Rules
        rules = params.get('rules', {})
        if rules:
            command += f" --trim_spaces={'true' if rules.get('trim_spaces') else 'false'}"
            command += f" --ignore_case={'true' if rules.get('ignore_case') else 'false'}"
            command += f" --null_equals_empty={'true' if rules.get('null_equals_empty') else 'false'}"
            command += f" --numeric_tolerance={rules.get('numeric_tolerance', 0)}"
            command += f" --time_zone={shlex.quote(rules.get('time_zone', 'N/A'))}"
        
        add_log(run_id, f"â–¶ï¸ Executing script: {script_name}")
        add_log(run_id, f"ðŸ“‹ Command: {command}")
        
        # Execute command
        stdin, stdout, stderr = ssh_client.exec_command(command, get_pty=True)
        
        # Stream output
        for line in iter(stdout.readline, ''):
            if run_registry[run_id].get('stop_requested'):
                add_log(run_id, "âš ï¸ Execution stopped by user")
                break
            line = line.strip()
            if line:
                add_log(run_id, line)
        
        # Check for errors
        error_output = stderr.read().decode('utf-8', errors='replace').strip()
        if error_output:
            add_log(run_id, f"âš ï¸ Stderr: {error_output}")
        
        exit_code = stdout.channel.recv_exit_status()
        
        if exit_code == 0:
            run_registry[run_id]['status'] = 'SUCCESS'
            add_log(run_id, "âœ… Execution completed successfully")
        else:
            run_registry[run_id]['status'] = 'FAILED'
            add_log(run_id, f"âŒ Execution failed with exit code: {exit_code}")
        
        ssh_client.close()
        add_log(run_id, "ðŸ”Œ SSH connection closed")
        
    except Exception as e:
        add_log(run_id, f"âŒ Error: {str(e)}")
        run_registry[run_id]['status'] = 'FAILED'
        print(f"Error in execute_mismatch_explorer_job: {str(e)}")
    
    run_registry[run_id]['finished_at'] = datetime.now()


@app.route('/api/mismatch-explorer/fetch/<run_id>', methods=['GET'])
def mismatch_explorer_fetch(run_id):
    """
    Fetch JSON report from Unix /tmp after execution completes.
    Parses the JSON and stores in mismatch_jobs for summary/details endpoints.
    """
    try:
        if run_id not in run_registry:
            return jsonify({'error': 'Invalid or expired run ID'}), 404
        
        run_info = run_registry[run_id]
        
        # Add log message to fetch step
        add_log(run_id, "ðŸ“¥ Fetching results from Unix...")
        
        # Check if we have mock data (from failed SSH)
        if 'mock_data' in run_info:
            add_log(run_id, "Using mock data from previous execution")
            records = run_info['mock_data']
            summary_rows, details_cache, debug_info = parse_record_explorer_json(records, run_id)
            
            # Log debug info
            for msg in debug_info.get('messages', []):
                add_log(run_id, f"  {msg}")
            add_log(run_id, f"  Format: {debug_info.get('detected_format', 'unknown')}")
            add_log(run_id, f"  Parsed: {debug_info.get('parsed_count')} records")
            
            # Create job entry
            job_id = f'job_{run_id}'
            mismatch_jobs[job_id] = {
                'status': 'completed',
                'totalRecords': len(summary_rows),
                'summaryRows': summary_rows,
                'detailsCache': details_cache,
                'created_at': datetime.now()
            }
            
            return jsonify({
                'jobId': job_id,
                'status': 'completed',
                'totalRecords': len(summary_rows)
            })
        
        # Try to fetch from Unix
        unix_config = run_info.get('unix_config', {})
        if not unix_config.get('host'):
            add_log(run_id, "âŒ No Unix configuration available")
            return jsonify({'error': 'No Unix configuration available'}), 400
        
        add_log(run_id, f"ðŸ“¡ Reading report file: /tmp/{run_id}_record_explorer.json")
        
        # Connect to fetch file
        ssh_client = paramiko.SSHClient()
        ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        
        try:
            ssh_client.connect(
                hostname=unix_config['host'],
                port=unix_config.get('port', 22),
                username=unix_config['username'],
                password=unix_config['password'],
                timeout=30
            )
            add_log(run_id, "âœ… SSH connected successfully for fetch")
        except Exception as conn_error:
            add_log(run_id, f"âš ï¸ SSH connection failed during fetch: {str(conn_error)}")
            # Return mock data if connection fails
            mock_records = generate_mock_mismatch_data_from_records()
            summary_rows, details_cache, debug_info = parse_record_explorer_json(mock_records, run_id)
            
            job_id = f'job_{run_id}'
            mismatch_jobs[job_id] = {
                'status': 'completed',
                'totalRecords': len(summary_rows),
                'summaryRows': summary_rows,
                'detailsCache': details_cache,
                'created_at': datetime.now()
            }
            
            add_log(run_id, "âœ… Using fallback mock data")
            return jsonify({
                'jobId': job_id,
                'status': 'completed',
                'totalRecords': len(summary_rows),
                'note': 'Using mock data (SSH connection failed)'
            })
        
        # Look for JSON report in /tmp
        json_filename = f'{run_id}_record_explorer.json'
        remote_path = f'/tmp/{json_filename}'
        
        sftp = ssh_client.open_sftp()
        
        try:
            with sftp.file(remote_path, 'r') as f:
                json_content = f.read().decode('utf-8')
            add_log(run_id, f"âœ… File read successfully ({len(json_content)} bytes)")
            records = json.loads(json_content)
        except FileNotFoundError:
            add_log(run_id, f"âš ï¸ Primary file not found: {remote_path}, trying alternatives...")
            # Try alternative filename patterns
            alternative_patterns = [
                f'/tmp/{run_id}_mismatch.json',
                f'/tmp/record_explorer_{run_id}.json',
                f'/tmp/mismatch_{run_id}.json'
            ]
            
            records = None
            for alt_path in alternative_patterns:
                try:
                    with sftp.file(alt_path, 'r') as f:
                        json_content = f.read().decode('utf-8')
                    add_log(run_id, f"âœ… Found alternative file: {alt_path}")
                    records = json.loads(json_content)
                    break
                except:
                    continue
            
            if records is None:
                add_log(run_id, "âŒ No report files found, using mock data")
                # Return mock data if file not found
                sftp.close()
                ssh_client.close()
                
                mock_records = generate_mock_mismatch_data_from_records()
                summary_rows, details_cache, debug_info = parse_record_explorer_json(mock_records, run_id)
                
                job_id = f'job_{run_id}'
                mismatch_jobs[job_id] = {
                    'status': 'completed',
                    'totalRecords': len(summary_rows),
                    'summaryRows': summary_rows,
                    'detailsCache': details_cache,
                    'created_at': datetime.now()
                }
                
                return jsonify({
                    'jobId': job_id,
                    'status': 'completed',
                    'totalRecords': len(summary_rows),
                    'note': 'Using mock data (file not found)'
                })
        except Exception as read_error:
            add_log(run_id, f"âŒ Error reading file: {str(read_error)}")
            sftp.close()
            ssh_client.close()
            return jsonify({'error': f'Failed to read report file: {str(read_error)}'}), 500
        
        sftp.close()
        ssh_client.close()
        
        # Parse records with robust parsing
        summary_rows, details_cache, debug_info = parse_record_explorer_json(records, run_id)
        
        # Log debug info to user
        add_log(run_id, f"ðŸ“Š Detected format: {debug_info.get('detected_format', 'unknown')}")
        add_log(run_id, f"ðŸ“Š Raw record count: {debug_info.get('raw_count', 0)}")
        add_log(run_id, f"ðŸ“Š Parsed record count: {debug_info.get('parsed_count', 0)}")
        if debug_info.get('skipped_count', 0) > 0:
            add_log(run_id, f"âš ï¸ Skipped invalid records: {debug_info.get('skipped_count', 0)}")
        for msg in debug_info.get('messages', []):
            add_log(run_id, f"  â„¹ï¸ {msg}")
        
        # Create job entry
        job_id = f'job_{run_id}'
        mismatch_jobs[job_id] = {
            'status': 'completed',
            'totalRecords': len(summary_rows),
            'summaryRows': summary_rows,
            'detailsCache': details_cache,
            'created_at': datetime.now()
        }
        
        add_log(run_id, f"âœ… Results ready: {len(summary_rows)} record(s) loaded")
        
        return jsonify({
            'jobId': job_id,
            'status': 'completed',
            'totalRecords': len(summary_rows)
        })
        
    except Exception as e:
        print(f"Mismatch Explorer fetch error: {str(e)}")
        add_log(run_id, f"âŒ Fetch error: {str(e)}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/mismatch-explorer/summary', methods=['GET'])
def mismatch_explorer_summary():
    """
    Get paginated summary of comparison results.
    """
    try:
        job_id = request.args.get('jobId', '')
        page = int(request.args.get('page', 1))
        page_size = int(request.args.get('pageSize', 50))
        
        if not job_id or job_id not in mismatch_jobs:
            return jsonify({'error': 'Invalid or expired job ID'}), 404
        
        job = mismatch_jobs[job_id]
        summary_rows = job['summaryRows']
        total_records = len(summary_rows)
        
        # Paginate
        start_idx = (page - 1) * page_size
        end_idx = start_idx + page_size
        paginated_rows = summary_rows[start_idx:end_idx]
        
        return jsonify({
            'totalRecords': total_records,
            'page': page,
            'pageSize': page_size,
            'totalPages': (total_records + page_size - 1) // page_size,
            'rows': paginated_rows
        })
        
    except Exception as e:
        print(f"Mismatch Explorer summary error: {str(e)}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/mismatch-explorer/details', methods=['GET'])
def mismatch_explorer_details():
    """
    Get field-level details for a specific PK value.
    """
    try:
        job_id = request.args.get('jobId', '')
        pk_value = request.args.get('pkValue', '')
        
        if not job_id or job_id not in mismatch_jobs:
            return jsonify({'error': 'Invalid or expired job ID'}), 404
        
        if not pk_value:
            return jsonify({'error': 'PK value is required'}), 400
        
        job = mismatch_jobs[job_id]
        details_cache = job['detailsCache']
        
        if pk_value not in details_cache:
            return jsonify({'error': f'No details found for PK: {pk_value}'}), 404
        
        return jsonify({
            'pkValue': pk_value,
            'fields': details_cache[pk_value]
        })
        
    except Exception as e:
        print(f"Mismatch Explorer details error: {str(e)}")
        return jsonify({'error': str(e)}), 500


@app.route('/api/mismatch-explorer/export', methods=['GET'])
def mismatch_explorer_export():
    """
    Export single record comparison as CSV.
    """
    try:
        job_id = request.args.get('jobId', '')
        pk_value = request.args.get('pkValue', '')
        
        if not job_id or job_id not in mismatch_jobs:
            return jsonify({'error': 'Invalid or expired job ID'}), 404
        
        if not pk_value:
            return jsonify({'error': 'PK value is required'}), 400
        
        job = mismatch_jobs[job_id]
        details_cache = job['detailsCache']
        
        if pk_value not in details_cache:
            return jsonify({'error': f'No details found for PK: {pk_value}'}), 404
        
        fields = details_cache[pk_value]
        
        # Build CSV content
        csv_lines = ['Field Name,Source Value,Target Value,Status']
        for field in fields:
            # Escape values for CSV
            field_name = field['fieldName'].replace('"', '""')
            source_val = str(field['sourceValue']).replace('"', '""')
            target_val = str(field['targetValue']).replace('"', '""')
            status = field['status']
            csv_lines.append(f'"{field_name}","{source_val}","{target_val}","{status}"')
        
        csv_content = '\n'.join(csv_lines)
        
        # Create response with CSV download
        safe_pk = pk_value.replace('|', '_').replace('/', '_').replace('\\', '_').replace(' ', '_')[:50]
        filename = f'mismatch_{safe_pk}.csv'
        
        return Response(
            csv_content,
            mimetype='text/csv',
            headers={'Content-Disposition': f'attachment; filename="{filename}"'}
        )
        
    except Exception as e:
        print(f"Mismatch Explorer export error: {str(e)}")
        return jsonify({'error': str(e)}), 500


if __name__ == '__main__':
    socketio.run(app, debug=True, host='0.0.0.0', port=5000)




### Script.js

// Global variables
console.log("JavaScript file loaded successfully");
let socket = null;
let isConnected = false;
let isPaused = false;
let logs = [];
let currentTab = "comparison";
let currentTableMode = "single";
let jobComplete = false;
let reportUrl = "";

// SSE Execution State
let currentRunId = null;
let eventSource = null;
let executionStatus = "IDLE"; // IDLE, RUNNING, SUCCESS, FAILED, STOPPED

// Data Load specific UI state (isolated from other tabs)
let dataLoadRunStatus = "IDLE";
let dataLoadButtonLabel = "Execute Data Load";

// Tab name to API tab mapping
const TAB_API_MAP = {
  comparison: "data_comparison",
  load: "data_load",
  schema: "schema_generation",
  fileload: "file_load",
  filedownload: "file_download",
  mismatch: "mismatch_explorer",
};

// Database configurations matching React component
const databaseConfigs = {
  PostgreSQL: {
    hosts: ["localhost", "postgres-server.local", "db.example.com"],
    ports: ["5432", "5433", "5434"],
    usernames: ["postgres", "admin", "dbuser"],
    databases: ["postgres", "myapp_db", "production_db", "staging_db"],
  },
  MySQL: {
    hosts: ["localhost", "mysql-server.local", "db.example.com"],
    ports: ["3306", "3307", "3308"],
    usernames: ["root", "mysql", "admin", "dbuser"],
    databases: ["mysql", "myapp_db", "production_db", "staging_db"],
  },
  Oracle: {
    hosts: ["localhost", "oracle-server.local", "db.example.com"],
    ports: ["1521", "1522", "1523"],
    usernames: ["system", "oracle", "admin", "dbuser"],
    databases: ["XE", "ORCL", "ORCLPDB", "production_db"],
  },
  "SQL Server": {
    hosts: ["localhost", "sqlserver.local", "db.example.com"],
    ports: ["1433", "1434", "1435"],
    usernames: ["sa", "admin", "dbuser"],
    databases: ["master", "myapp_db", "production_db", "staging_db"],
  },
  MongoDB: {
    hosts: ["localhost", "mongo-server.local", "db.example.com"],
    ports: ["27017", "27018", "27019"],
    usernames: ["admin", "root", "mongouser"],
    databases: ["admin", "myapp_db", "production_db", "staging_db"],
  },
  Snowflake: {
    hosts: [
      "account.snowflakecomputing.com",
      "account.us-east-1.snowflakecomputing.com",
    ],
    ports: ["443"],
    usernames: ["admin", "snowflake_user"],
    databases: ["DEMO_DB", "PRODUCTION_DB", "STAGING_DB", "ANALYTICS_DB"],
  },
  Hive: {
    hosts: ["hive-server.local", "hive.example.com", "localhost"],
    ports: ["10000", "10001"],
    usernames: ["hive", "hadoop", "admin"],
    databases: ["default", "warehouse", "staging", "production"],
  },
};

const databaseTypes = [
  "PostgreSQL",
  "MySQL",
  "Oracle",
  "SQL Server",
  "MongoDB",
  "Snowflake",
  "Hive",
  "Teradata",
  "File",
];

// Common IANA time zones for dropdown
const commonTimeZones = [
  "N/A",
  "UTC",
  "America/New_York",
  "America/Chicago",
  "America/Denver",
  "America/Phoenix",
  "America/Los_Angeles",
  "America/Anchorage",
  "Pacific/Honolulu",
  "Europe/London",
  "Europe/Paris",
  "Europe/Berlin",
  "Europe/Moscow",
  "Asia/Dubai",
  "Asia/Kolkata",
  "Asia/Singapore",
  "Asia/Tokyo",
  "Asia/Shanghai",
  "Asia/Hong_Kong",
  "Australia/Sydney",
  "Australia/Melbourne",
  "Pacific/Auckland",
  "Africa/Johannesburg",
  "America/Sao_Paulo",
  "America/Mexico_City",
  "America/Toronto",
  "Europe/Amsterdam",
  "Europe/Zurich",
  "Asia/Seoul",
  "Asia/Jakarta",
];

// Initialize when page loads
document.addEventListener("DOMContentLoaded", function () {
  console.log("Data Management Platform loaded");
  console.log("Starting initialization...");

  // Initialize tab switching
  console.log("Initializing tabs...");
  initializeTabs();

  // Initialize download section visibility for initial tab (comparison is default)
  updateDownloadSectionVisibility(currentTab);

  // Initialize log controls
  console.log("Initializing log controls...");
  initializeLogControls();

  // Initialize table mode selection
  console.log("Initializing table mode selection...");
  initializeTableModeSelection();

  // Generate initial forms
  console.log("Generating comparison form...");
  generateComparisonForm();
  console.log("Generating data load form...");
  generateDataLoadForm();
  console.log("Generating schema generation form...");
  generateSchemaGenerationForm();
  console.log("Generating file load form...");
  generateFileLoadForm();
  console.log("Generating file download form...");
  generateFileDownloadForm();
  console.log("Generating mismatch explorer form...");
  generateMismatchExplorerForm();

  // Initialize WebSocket connection (legacy - kept for backwards compatibility)
  console.log("Initializing WebSocket...");
  initializeWebSocket();

  // Initialize comparison type selection
  console.log("Initializing comparison type selection...");
  initializeComparisonTypeSelection();

  // Update connection status to show ready
  updateConnectionStatus();

  console.log("Initialization complete");
});

// Initialize table mode selection functionality
function initializeTableModeSelection() {
  const radioButtons = document.querySelectorAll('input[name="tableMode"]');
  radioButtons.forEach((radio) => {
    radio.addEventListener("change", function () {
      currentTableMode = this.value;
      console.log("Table mode changed to:", currentTableMode);
      handleTableModeChange(this.value);
    });
  });
}

// Initialize comparison type selection functionality
function initializeComparisonTypeSelection() {
  const comparisonTypeSelect = document.getElementById(
    "comparison-type-select"
  );
  if (comparisonTypeSelect) {
    comparisonTypeSelect.addEventListener("change", function () {
      const selectedType = this.value;
      console.log("Comparison type changed to:", selectedType);
      handleComparisonTypeChange(selectedType);
    });
  }
}

// Handle comparison type changes
function handleComparisonTypeChange(comparisonType) {
  const tableModeSection = document.getElementById("table-mode-selection");
  const comparisonForm = document.getElementById("comparison-form");

  // Show table mode selection only for database-to-database
  if (comparisonType === "database-to-database") {
    tableModeSection.style.display = "block";
  } else {
    tableModeSection.style.display = "none";
  }

  // Regenerate the comparison form based on the selected type
  if (comparisonType) {
    generateComparisonFormByType(comparisonType);
  } else {
    comparisonForm.innerHTML =
      '<p class="text-gray-500 text-center py-4">Please select a comparison type to continue</p>';
  }
}

// Tab switching functionality
function initializeTabs() {
  const tabButtons = document.querySelectorAll(".tab-button");
  const tabContents = document.querySelectorAll(".tab-content");

  console.log("Found tab buttons:", tabButtons.length);
  console.log("Found tab contents:", tabContents.length);

  tabButtons.forEach((button) => {
    console.log("Attaching event to button:", button.dataset.tab);
    button.addEventListener("click", function () {
      const targetTab = this.dataset.tab;
      console.log("Tab clicked:", targetTab);

      // Remove active class from all buttons and contents
      tabButtons.forEach((btn) => btn.classList.remove("active"));
      tabContents.forEach((content) => content.classList.remove("active"));

      // Add active class to clicked button and corresponding content
      this.classList.add("active");
      const targetContent = document.getElementById(targetTab);
      if (targetContent) {
        targetContent.classList.add("active");
        currentTab = targetTab;
        console.log("Tab switched to:", targetTab);

        // Update Real-time Logs title based on active tab
        updateLogTitle(targetTab);

        // Show/hide download button section based on tab
        updateDownloadSectionVisibility(targetTab);
      } else {
        console.error("Target content not found for tab:", targetTab);
      }
    });
  });
}

// Update the Real-time Logs title based on the active tab
function updateLogTitle(tabId) {
  const logTitleElement = document.getElementById("log-title");
  if (!logTitleElement) return;

  // Map tab IDs to display names
  const tabTitles = {
    comparison: "Data Comparison",
    load: "Data Load",
    schema: "Schema Generation",
    fileload: "File Load",
    filedownload: "File Download",
    mismatch: "Mismatch Explorer",
  };

  const tabDisplayName = tabTitles[tabId] || "Data Comparison";
  logTitleElement.textContent = `Real-time Logs - ${tabDisplayName}`;
  console.log("[UI] Log title updated to Real-time Logs - " + tabDisplayName);
}

// Show/hide download sections based on active tab
// Data Comparison download section, File Download download section, Schema Generation download section
function updateDownloadSectionVisibility(tabId) {
  const downloadSection = document.getElementById("download-report-section");
  const fileDownloadSection = document.getElementById(
    "filedownload-download-section"
  );
  const schemaDownloadSection = document.getElementById(
    "schema-download-section"
  );

  // Handle Data Comparison download section
  if (downloadSection) {
    if (tabId === "comparison") {
      downloadSection.classList.remove("hidden");
      console.log("[UI] Download section shown (comparison tab)");
    } else {
      downloadSection.classList.add("hidden");
      console.log("[UI] Download section hidden (tab=" + tabId + ")");
    }
  }

  // Handle File Download download section (only visible on filedownload tab when download is ready)
  if (fileDownloadSection) {
    if (tabId !== "filedownload") {
      // Hide when not on File Download tab
      fileDownloadSection.classList.add("hidden");
    }
    // Note: The section visibility is managed by startFileDownloadLogStreaming on success
  }

  // Handle Schema Generation download section (only visible on schema tab when download is ready)
  if (schemaDownloadSection) {
    if (tabId !== "schema") {
      // Hide when not on Schema Generation tab
      schemaDownloadSection.classList.add("hidden");
    }
    // Note: The section visibility is managed by startSchemaGenerationLogStreaming on success
  }
}

// Generate enhanced dropdown with manual entry option
function generateDropdownWithCustom(
  id,
  options,
  placeholder,
  currentValue = ""
) {
  const hasManualEntry = id.includes("Manual");

  if (hasManualEntry) {
    return `
            <div class="input-with-dropdown">
                <input type="text" 
                       id="${id}" 
                       class="form-input" 
                       placeholder="${placeholder}" 
                       value="${currentValue}"
                       maxlength="1500">
                <button type="button" 
                        class="back-button" 
                        onclick="switchToDropdown('${id}')">
                    â† Back to dropdown
                </button>
            </div>
        `;
  }

  return `
        <select id="${id}" class="form-select">
            <option value="">${placeholder}</option>
            ${options
              .map(
                (option) =>
                  `<option value="${option}" ${
                    option === currentValue ? "selected" : ""
                  }>${option}</option>`
              )
              .join("")}
            <option value="custom">Enter manually...</option>
        </select>
    `;
}

// Handle dropdown to manual switch
function handleDropdownChange(selectId, fieldType) {
  const select = document.getElementById(selectId);
  if (select.value === "custom") {
    const manualId = selectId + "Manual";
    const placeholder = `Enter custom ${fieldType}`;

    select.parentElement.innerHTML = generateDropdownWithCustom(
      manualId,
      [],
      placeholder
    );

    // Focus the new input
    const newInput = document.getElementById(manualId);
    if (newInput) {
      newInput.focus();
    }
  }
}

// Switch back to dropdown from manual entry
function switchToDropdown(manualId) {
  const input = document.getElementById(manualId);
  const baseId = manualId.replace("Manual", "");
  const fieldType = getFieldType(baseId);
  const dbType = getSelectedDatabaseType(baseId);

  let options = [];
  if (dbType && databaseConfigs[dbType]) {
    if (fieldType === "host") options = databaseConfigs[dbType].hosts;
    else if (fieldType === "port") options = databaseConfigs[dbType].ports;
    else if (fieldType === "username")
      options = databaseConfigs[dbType].usernames;
    else if (fieldType === "database")
      options = databaseConfigs[dbType].databases;
  }

  const placeholder = `Select ${fieldType}`;
  input.parentElement.innerHTML = generateDropdownWithCustom(
    baseId,
    options,
    placeholder
  );

  // Re-attach event listener
  const newSelect = document.getElementById(baseId);
  if (newSelect) {
    newSelect.addEventListener("change", function () {
      handleDropdownChange(this.id, fieldType);
    });
  }
}

// Get field type from ID
function getFieldType(id) {
  if (id.includes("Host")) return "host";
  if (id.includes("Port")) return "port";
  if (id.includes("Username")) return "username";
  if (id.includes("Database")) return "database";
  return "";
}

// Get selected database type for a field
function getSelectedDatabaseType(fieldId) {
  const prefix = fieldId.split(/Host|Port|Username|Database/)[0];
  const typeSelectId = prefix + "Type";
  const typeSelect = document.getElementById(typeSelectId);
  return typeSelect ? typeSelect.value : "";
}

// Generate form fields for source or target
function generateFormFields(prefix, isFileTab = false) {
  const isSource = prefix.includes("source") || prefix.includes("Source");
  const cardType = isSource ? "source" : "target";
  const cardTitle = isSource ? "Source Configuration" : "Target Configuration";

  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-red flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
                    ${cardTitle}
                </h3>
                <p>Configure your data ${
                  isSource ? "source" : "target"
                } connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select database type</option>
                        ${databaseTypes
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <div id="${prefix}HostContainer">
                            <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <div id="${prefix}PortContainer">
                            <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <div id="${prefix}DatabaseContainer">
                        <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <div id="${prefix}UsernameContainer">
                            <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                ${
                  !isFileTab
                    ? `
                <div class="form-group">
                    <label for="${prefix}TableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
                    <input type="text" id="${prefix}TableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter table name" maxlength="255">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}PrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
                    <input type="text" id="${prefix}PrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
                    <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}SqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}SqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
                </div>
                `
                    : ""
                }
                
                ${
                  isFileTab
                    ? `
                <div class="form-group">
                    <label for="${prefix}ExcelFile" class="block text-sm font-medium mb-2">ðŸ“ Excel File</label>
                    <input type="file" id="${prefix}ExcelFile" class="form-file w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-red-500 cursor-pointer" accept=".xlsx,.xls,.csv">
                </div>
                `
                    : ""
                }
            </div>
        </div>
    `;
}

// Generate form fields with file upload (for multi-table mode)
function generateFormFieldsWithFileUpload(prefix) {
  const isSource = prefix.includes("source") || prefix.includes("Source");
  const cardType = isSource ? "source" : "target";
  const cardTitle = isSource ? "Source Configuration" : "Target Configuration";
  const fileFieldId = isSource ? "sourceExcelFile" : "targetExcelFile";
  const fileLabel = isSource ? "Source Excel File" : "Target Excel File";
  const fileDescription = isSource
    ? "Upload Excel with source_table_name, source_sql, source_key_columns columns"
    : "Upload Excel with target_table_name, target_sql, target_key_columns columns";

  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-red flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
                    ${cardTitle}
                </h3>
                <p>Configure your data ${
                  isSource ? "source" : "target"
                } connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select database type</option>
                        ${databaseTypes
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <div id="${prefix}HostContainer">
                            <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <div id="${prefix}PortContainer">
                            <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <div id="${prefix}DatabaseContainer">
                        <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <div id="${prefix}UsernameContainer">
                            <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${fileFieldId}" class="block text-sm font-medium mb-2">ðŸ“ ${fileLabel}</label>
                    <input type="file" id="${fileFieldId}" class="form-file w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-red-500 cursor-pointer" accept=".xlsx,.xls">
                    <p class="text-sm text-gray-600 mt-1">${fileDescription}</p>
                </div>
            </div>
        </div>
    `;
}

// Generate Unix server section
function generateUnixServerSection(prefix) {
  return `
        <div class="unix-server-section mb-6">
            <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
                <div class="card-header gradient-header">
                    <h3 class="text-wellsfargo-red flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                        </svg>
                        Unix Server Configuration
                    </h3>
                    <p>Server details for operation execution</p>
                </div>
                <div class="config-content p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="${prefix}UnixHost" class="block text-sm font-medium mb-2">ðŸ–¥ï¸ Unix Host</label>
                            <input type="text" id="${prefix}UnixHost" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Enter Unix server host" maxlength="255">
                        </div>
                        
                        <div class="form-group">
                            <label for="${prefix}UserEmail" class="block text-sm font-medium mb-2">ðŸ“§ User Email <span class="text-red-500">*</span></label>
                            <input type="email" id="${prefix}UserEmail" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Enter email address" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}BatchId" class="block text-sm font-medium mb-2">ðŸ†” Batch ID</label>
                        <input type="text" id="${prefix}BatchId" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Enter Batch ID" maxlength="100">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="${prefix}UnixUsername" class="block text-sm font-medium mb-2">ðŸ‘¤ Unix Username</label>
                            <input type="text" id="${prefix}UnixUsername" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Enter Unix username" maxlength="100">
                        </div>
                        
                        <div class="form-group">
                            <label for="${prefix}UnixPassword" class="block text-sm font-medium mb-2">ðŸ”’ Unix Password</label>
                            <input type="password" id="${prefix}UnixPassword" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Enter Unix password" maxlength="100">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Generate Time Zone field section for comparison forms
function generateTimeZoneSection(prefix) {
  const optionsHtml = commonTimeZones
    .map(
      (tz) =>
        `<option value="${tz}"${tz === "N/A" ? " selected" : ""}>${tz}</option>`
    )
    .join("");

  return `
        <div class="time-zone-section mb-6">
            <div class="source-target-card border-t-4 border-t-wellsfargo-gold shadow-elevated">
                <div class="card-header gradient-header">
                    <h3 class="text-wellsfargo-gold flex items-center gap-2">
                        <span class="text-xl">ðŸ•</span>
                        Time Zone Configuration
                    </h3>
                    <p>Specify time zone for data comparison</p>
                </div>
                <div class="config-content p-6">
                    <div class="form-group">
                        <label for="${prefix}TimeZone" class="block text-sm font-medium mb-2">ðŸŒ Time Zone</label>
                        <div class="relative">
                            <input type="text" 
                                   id="${prefix}TimeZone" 
                                   list="${prefix}TimeZoneList"
                                   class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" 
                                   placeholder="Select or type a time zone (e.g., America/Phoenix)"
                                   value="N/A"
                                   maxlength="100">
                            <datalist id="${prefix}TimeZoneList">
                                ${optionsHtml}
                            </datalist>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">Select from the list or type an IANA time zone. Leave as "N/A" if not applicable.</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Update dropdown options based on database type
function updateDropdownOptions(prefix, dbType) {
  const config = databaseConfigs[dbType];
  if (!config) return;

  // Host, Port, Database Name, Username are now plain text inputs (no dropdowns)
  // Just update placeholder text based on database type for guidance
  const hostInput = document.getElementById(prefix + "Host");
  if (hostInput && config.hosts && config.hosts.length > 0) {
    hostInput.placeholder = `e.g., ${config.hosts[0]}`;
  }

  const portInput = document.getElementById(prefix + "Port");
  if (portInput && config.ports && config.ports.length > 0) {
    portInput.placeholder = config.ports[0];
  }

  const usernameInput = document.getElementById(prefix + "Username");
  if (usernameInput && config.usernames && config.usernames.length > 0) {
    usernameInput.placeholder = `e.g., ${config.usernames[0]}`;
  }

  const databaseInput = document.getElementById(prefix + "Database");
  if (databaseInput && config.databases && config.databases.length > 0) {
    databaseInput.placeholder = `e.g., ${config.databases[0]}`;
  }
}

// Generate Data Comparison form
function generateComparisonForm() {
  console.log("Looking for comparison-form container...");
  const container = document.getElementById("comparison-form");
  if (!container) {
    console.error("comparison-form container not found!");
    return;
  }

  console.log("Found comparison-form container, showing initial message...");
  container.innerHTML =
    '<p class="text-gray-500 text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">ðŸ‘† Please select a comparison type above to continue</p>';
}

// Handle table mode change for Data Comparison
function handleTableModeChange(mode) {
  currentTableMode = mode;
  console.log("Table mode changed to:", mode);

  const container = document.getElementById("comparison-form-fields");
  if (container) {
    // Clear and regenerate form with current table mode
    if (mode === "single") {
      container.innerHTML = `
                <div class="grid lg:grid-cols-2 gap-6">
                    ${generateFormFields("comparisonSource")}
                    ${generateFormFields("comparisonTarget")}
                </div>
                
                ${generateUnixServerSection("comparison")}
            `;
    } else {
      // Multi table mode - show database fields AND file upload option
      container.innerHTML = `
                <div class="grid lg:grid-cols-2 gap-6">
                    ${generateFormFieldsWithFileUpload("comparisonSource")}
                    ${generateFormFieldsWithFileUpload("comparisonTarget")}
                </div>
                
                ${generateUnixServerSection("comparison")}
            `;
    }
    attachFormListeners("comparison");
  }
}

// Generate comparison form based on comparison type
function generateComparisonFormByType(comparisonType) {
  const container = document.getElementById("comparison-form");
  if (!container) return;

  let sourceFields, targetFields;

  // Determine what fields to show for source and target based on comparison type
  switch (comparisonType) {
    case "file-to-file":
      sourceFields = generateFileFields("comparisonSource");
      targetFields = generateFileFields("comparisonTarget");
      break;
    case "file-to-database":
      sourceFields = generateFileFields("comparisonSource");
      targetFields = generateFormFields("comparisonTarget");
      break;
    case "database-to-file":
      sourceFields = generateFormFields("comparisonSource");
      targetFields = generateFileFields("comparisonTarget");
      break;
    case "database-to-database":
      // Use table mode to determine fields
      if (currentTableMode === "single") {
        sourceFields = generateFormFields("comparisonSource");
        targetFields = generateFormFields("comparisonTarget");
      } else {
        sourceFields = generateFormFieldsWithFileUpload("comparisonSource");
        targetFields = generateFormFieldsWithFileUpload("comparisonTarget");
      }
      break;
    default:
      container.innerHTML =
        '<p class="text-gray-500 text-center py-4">Please select a comparison type</p>';
      return;
  }

  container.innerHTML = `
        <form class="space-y-6" onsubmit="executeOperation(event, 'Data Comparison')">
            <div id="comparison-form-fields">
                <div class="grid lg:grid-cols-2 gap-6">
                    ${sourceFields}
                    ${targetFields}
                </div>
                
                ${generateTimeZoneSection("comparison")}
                
                ${generateUnixServerSection("comparison")}
            </div>
            
            <div class="execute-section text-center p-6 border-t border-gray-200">
                <button type="submit" class="execute-button bg-gradient-to-r from-red-600 to-red-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-red-700 hover:to-red-800 transition-all duration-200 shadow-lg">
                    <span class="execute-icon mr-2">â–¶ï¸</span>
                    Execute Data Comparison
                </button>
            </div>
        </form>
    `;

  attachFormListeners("comparison");

  // Attach file field listeners for conditional display
  if (
    comparisonType === "file-to-file" ||
    comparisonType === "file-to-database"
  ) {
    attachFileFieldListeners("comparisonSource");
  }
  if (
    comparisonType === "file-to-file" ||
    comparisonType === "database-to-file"
  ) {
    attachFileFieldListeners("comparisonTarget");
  }

  // Show key columns field for specific comparison types
  showKeyColumnsForComparison(comparisonType);
}

// Generate file configuration fields for source/target
function generateFileFields(prefix) {
  const label = prefix.includes("Source") ? "Source" : "Target";
  const borderColor = prefix.includes("Source")
    ? "border-wellsfargo-red/20"
    : "border-wellsfargo-gold/20";
  const gradientColor = prefix.includes("Source")
    ? "from-wellsfargo-red/10 to-wellsfargo-gold/10"
    : "from-wellsfargo-gold/10 to-wellsfargo-red/10";
  const dotColor = prefix.includes("Source")
    ? "bg-wellsfargo-red"
    : "bg-wellsfargo-gold";
  const titleColor = prefix.includes("Source")
    ? "text-wellsfargo-red"
    : "text-wellsfargo-gold";

  return `
        <div class="card ${borderColor}">
            <div class="card-header bg-gradient-to-r ${gradientColor}">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 ${dotColor} rounded-full"></div>
                    <h4 class="${titleColor}">${label} File Configuration</h4>
                </div>
                <p>Configure your ${label.toLowerCase()} file details</p>
            </div>
            <div class="card-content space-y-4">
                <div class="form-group">
                    <label for="${prefix}FileType" class="block text-sm font-medium mb-2">ðŸ“„ File Type</label>
                    <select id="${prefix}FileType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select file type</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="xml">XML</option>
                        <option value="parquet">Parquet</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}LocationType" class="block text-sm font-medium mb-2">ðŸ“ Location Type</label>
                    <select id="${prefix}LocationType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select location type</option>
                        <option value="unix">File Path (Unix)</option>
                        <option value="hadoop">File Path (Hadoop)</option>
                        <option value="upload">Upload File</option>
                    </select>
                </div>
                
                <div id="${prefix}UnixPathField" class="form-group hidden">
                    <label for="${prefix}UnixPath" class="block text-sm font-medium mb-2">ðŸ“‚ Unix File Path</label>
                    <input type="text" id="${prefix}UnixPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="/path/to/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}HadoopPathField" class="form-group hidden">
                    <label for="${prefix}HadoopPath" class="block text-sm font-medium mb-2">ðŸ“‚ Hadoop File Path</label>
                    <input type="text" id="${prefix}HadoopPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="hdfs:///path/to/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}FileUploadField" class="form-group hidden">
                    <label for="${prefix}FileUpload" class="block text-sm font-medium mb-2">ðŸ“ Upload File</label>
                    <input type="file" id="${prefix}FileUpload" class="form-file w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-red-500 cursor-pointer" accept=".csv,.json,.xml,.parquet,.xlsx,.xls">
                    <p id="${prefix}FileUploadName" class="text-sm text-gray-600 mt-1 hidden"></p>
                </div>
                
                <div id="${prefix}DelimiterField" class="form-group hidden">
                    <label for="${prefix}Delimiter" class="block text-sm font-medium mb-2">âœ‚ï¸ Delimiter</label>
                    <select id="${prefix}Delimiter" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value=",">Comma (,)</option>
                        <option value="|">Pipe (|)</option>
                        <option value="	">Tab</option>
                        <option value=";">Semicolon (;)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}FileSqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}FileSqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" rows="3" placeholder="Enter SQL query to filter file data (optional, default: N/A)"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}KeyColumns" class="block text-sm font-medium mb-2">ðŸ”‘ Key Columns (for matching)</label>
                    <input type="text" id="${prefix}KeyColumns" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="id,customer_id (comma-separated)" maxlength="500">
                </div>
            </div>
        </div>
    `;
}

// Attach file field listeners for conditional display
function attachFileFieldListeners(prefix) {
  const fileTypeSelect = document.getElementById(prefix + "FileType");
  const locationTypeSelect = document.getElementById(prefix + "LocationType");
  const fileUpload = document.getElementById(prefix + "FileUpload");

  if (fileTypeSelect) {
    fileTypeSelect.addEventListener("change", function () {
      const delimiterField = document.getElementById(prefix + "DelimiterField");
      if (this.value === "csv") {
        delimiterField.classList.remove("hidden");
      } else {
        delimiterField.classList.add("hidden");
      }
    });
  }

  if (locationTypeSelect) {
    locationTypeSelect.addEventListener("change", function () {
      const unixPathField = document.getElementById(prefix + "UnixPathField");
      const hadoopPathField = document.getElementById(
        prefix + "HadoopPathField"
      );
      const uploadField = document.getElementById(prefix + "FileUploadField");

      // Hide all path fields first
      unixPathField.classList.add("hidden");
      hadoopPathField.classList.add("hidden");
      uploadField.classList.add("hidden");

      if (this.value === "unix") {
        unixPathField.classList.remove("hidden");
      } else if (this.value === "hadoop") {
        hadoopPathField.classList.remove("hidden");
      } else if (this.value === "upload") {
        uploadField.classList.remove("hidden");
      }
    });
  }

  if (fileUpload) {
    fileUpload.addEventListener("change", function () {
      const fileName = document.getElementById(prefix + "FileUploadName");
      if (this.files && this.files[0]) {
        fileName.textContent = `Selected: ${this.files[0].name}`;
        fileName.classList.remove("hidden");
      } else {
        fileName.classList.add("hidden");
      }
    });
  }
}

// Show key columns field for specific comparison types
function showKeyColumnsForComparison(comparisonType) {
  // Key columns are shown for all comparison types that involve files
  // This is already handled in generateFileFields
}

// Generate Data Load form - DB-to-DB only
function generateDataLoadForm() {
  const container = document.getElementById("load-form");
  if (!container) return;

  container.innerHTML = `
        <form class="space-y-6" onsubmit="executeOperation(event, 'Data Load')">
            <!-- Header: Database to Database Load -->
            <div class="mb-6 p-4 border-2 border-dashed border-load/30 rounded-xl bg-gradient-to-br from-card to-load/5 shadow-sm">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ðŸ—„ï¸</span>
                    <span class="text-lg font-semibold text-foreground">Database to Database Load</span>
                </div>
                <p class="text-sm text-gray-500 mt-1">Load data from source database to target database</p>
            </div>
            
            <div id="load-form-fields">
                <div class="grid lg:grid-cols-2 gap-6">
                    ${generateDataLoadSourceFields("loadSource")}
                    ${generateDataLoadTargetFields("loadTarget")}
                </div>
            </div>
            
            ${generateTimeZoneSection("load")}
            
            ${generateUnixServerSection("load")}
            
            <div class="execute-section text-center p-6 border-t border-gray-200">
                <!-- Data Load Status Display -->
                <div id="dataload-status-container" class="mb-4 hidden">
                    <span id="dataload-status-text" class="text-lg font-semibold"></span>
                </div>
                <button type="submit" id="dataload-run-btn" class="execute-button bg-gradient-to-r from-red-600 to-red-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-red-700 hover:to-red-800 transition-all duration-200 shadow-lg">
                    <span class="execute-icon mr-2">â–¶ï¸</span>
                    <span id="dataload-btn-text">Execute Data Load</span>
                </button>
            </div>
        </form>
    `;

  // Attach event listeners
  attachFormListeners("load");
  attachDataLoadTargetListeners();
}

// Generate Data Load SOURCE fields (database only, no load type)
function generateDataLoadSourceFields(prefix) {
  // Filter out "File" from database types for Data Load
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-red flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
                    Source Configuration
                </h3>
                <p>Configure your source database connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select database type</option>
                        ${dbTypesNoFile
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}TableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
                    <input type="text" id="${prefix}TableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter table name" maxlength="255">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}PrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
                    <input type="text" id="${prefix}PrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
                    <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}SqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}SqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
                </div>
            </div>
        </div>
    `;
}

// Generate Data Load TARGET fields (with Load Type + Hive-specific fields)
function generateDataLoadTargetFields(prefix) {
  // Filter out "File" from database types for Data Load
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-red flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
                    Target Configuration
                </h3>
                <p>Configure your target database connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select database type</option>
                        ${dbTypesNoFile
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}TableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
                    <input type="text" id="${prefix}TableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter table name" maxlength="255">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}PrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
                    <input type="text" id="${prefix}PrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
                    <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}SqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}SqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
                </div>
                
                <!-- Load Type (Target only) -->
                <div class="form-group">
                    <label for="${prefix}LoadType" class="block text-sm font-medium mb-2">âš¡ Load Type</label>
                    <select id="${prefix}LoadType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
                        <option value="">Select load type</option>
                        <option value="overwrite">Overwrite</option>
                        <option value="append">Append</option>
                    </select>
                </div>
                
                <!-- Hive-specific fields (hidden by default) -->
                <div id="${prefix}HiveFields" class="hidden space-y-4 p-4 border-2 border-dashed border-yellow-400 rounded-lg bg-yellow-50">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ</span>
                        <span class="text-sm font-semibold text-yellow-700">Hive-Specific Configuration</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}HadoopPath" class="block text-sm font-medium mb-2">ðŸ“‚ Hadoop Path <span class="text-red-500">*</span></label>
                        <input type="text" id="${prefix}HadoopPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="/user/hive/warehouse/..." maxlength="1000">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}PartitionId" class="block text-sm font-medium mb-2">ðŸ”– Partition ID</label>
                        <input type="text" id="${prefix}PartitionId" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="e.g., year=2024/month=01 (leave empty for N/A)" maxlength="500">
                        <p class="text-sm text-gray-500 mt-1">Leave empty to default to "N/A"</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Attach Data Load target-specific listeners (for Hive fields toggle)
function attachDataLoadTargetListeners() {
  const targetTypeSelect = document.getElementById("loadTargetType");

  if (targetTypeSelect) {
    targetTypeSelect.addEventListener("change", function () {
      const hiveFields = document.getElementById("loadTargetHiveFields");

      if (this.value === "Hive") {
        if (hiveFields) hiveFields.classList.remove("hidden");
      } else {
        if (hiveFields) hiveFields.classList.add("hidden");
      }
    });
  }
}

// Generate file fields for Data Load
function generateFileFieldsForLoad(prefix) {
  return `
        <div class="source-target-card border-t-4 border-t-load shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-load flex items-center gap-2">
                    <div class="w-3 h-3 bg-load rounded-full"></div>
                    Source File Configuration
                </h3>
                <p>Configure your source file details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}FileType" class="block text-sm font-medium mb-2">ðŸ“„ File Type</label>
                    <select id="${prefix}FileType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg">
                        <option value="">Select file type</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="xml">XML</option>
                        <option value="parquet">Parquet</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}LocationType" class="block text-sm font-medium mb-2">ðŸ“ Location Type</label>
                    <select id="${prefix}LocationType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg">
                        <option value="">Select location type</option>
                        <option value="path">File Path (Server)</option>
                        <option value="upload">Upload File</option>
                    </select>
                </div>
                
                <div id="${prefix}FilePathField" class="form-group hidden">
                    <label for="${prefix}FilePath" class="block text-sm font-medium mb-2">ðŸ“‚ File Path</label>
                    <input type="text" id="${prefix}FilePath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg" placeholder="/path/to/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}FileUploadField" class="form-group hidden">
                    <label for="${prefix}FileUpload" class="block text-sm font-medium mb-2">ðŸ“ Upload File</label>
                    <input type="file" id="${prefix}FileUpload" class="form-file w-full p-3 border-2 border-dashed border-gray-300 rounded-lg" accept=".csv,.json,.xml,.parquet,.xlsx,.xls">
                    <p id="${prefix}FileUploadName" class="text-sm text-gray-600 mt-1 hidden"></p>
                </div>
            </div>
        </div>
    `;
}

// Attach load file field listeners
function attachLoadFileFieldListeners() {
  const locationTypeSelect = document.getElementById("loadSourceLocationType");
  const fileUpload = document.getElementById("loadSourceFileUpload");

  if (locationTypeSelect) {
    locationTypeSelect.addEventListener("change", function () {
      const pathField = document.getElementById("loadSourceFilePathField");
      const uploadField = document.getElementById("loadSourceFileUploadField");

      if (this.value === "path") {
        pathField.classList.remove("hidden");
        uploadField.classList.add("hidden");
      } else if (this.value === "upload") {
        pathField.classList.add("hidden");
        uploadField.classList.remove("hidden");
      } else {
        pathField.classList.add("hidden");
        uploadField.classList.add("hidden");
      }
    });
  }

  if (fileUpload) {
    fileUpload.addEventListener("change", function () {
      const fileName = document.getElementById("loadSourceFileUploadName");
      if (this.files && this.files[0]) {
        fileName.textContent = `Selected: ${this.files[0].name}`;
        fileName.classList.remove("hidden");
      } else {
        fileName.classList.add("hidden");
      }
    });
  }
}

// Generate Schema Generation form
function generateSchemaGenerationForm() {
  const container = document.getElementById("schema-form");
  if (!container) return;

  container.innerHTML = `
        <form class="space-y-6" onsubmit="executeSchemaGenerationOperation(event)">
            <div class="grid lg:grid-cols-2 gap-6">
                ${generateSchemaGenerationSourceFields("schemaSource")}
                ${generateSchemaGenerationTargetFields("schemaTarget")}
            </div>
            
            ${generateUnixServerSection("schema")}
            
            <div class="execute-section text-center p-6 border-t border-gray-200">
                <button type="submit" id="schema-run-btn" class="execute-button bg-gradient-to-r from-red-600 to-red-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-red-700 hover:to-red-800 transition-all duration-200 shadow-lg">
                    <span class="execute-icon mr-2">â–¶ï¸</span>
                    <span id="schema-btn-text">Execute Schema Generation</span>
                </button>
            </div>
        </form>
    `;

  // Attach event listeners for schema mode toggle
  attachSchemaGenerationListeners();
}

// Generate Schema Generation SOURCE fields (database with Schema Mode)
function generateSchemaGenerationSourceFields(prefix) {
  // Filter out "File" from database types
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  return `
        <div class="source-target-card border-t-4 border-t-schema shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-schema flex items-center gap-2">
                    <div class="w-3 h-3 bg-schema rounded-full"></div>
                    Source Configuration
                </h3>
                <p>Configure your source database connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                        <option value="">Select database type</option>
                        ${dbTypesNoFile
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="localhost" maxlength="1500">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="5432" maxlength="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="Enter database name" maxlength="255">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="Enter username" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <!-- Schema Mode dropdown -->
                <div class="form-group">
                    <label for="${prefix}SchemaMode" class="block text-sm font-medium mb-2">ðŸ“Š Schema Mode <span class="text-red-500">*</span></label>
                    <select id="${prefix}SchemaMode" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                        <option value="">Select schema mode</option>
                        <option value="single">Single</option>
                        <option value="multiple">Multiple</option>
                    </select>
                </div>
                
                <!-- Single Mode: Table Name field -->
                <div id="${prefix}SingleModeFields" class="hidden">
                    <div class="form-group">
                        <label for="${prefix}TableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name <span class="text-red-500">*</span></label>
                        <input type="text" id="${prefix}TableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="Enter table name" maxlength="255">
                    </div>
                </div>
                
                <!-- Multiple Mode: File Upload field -->
                <div id="${prefix}MultipleModeFields" class="hidden">
                    <div class="form-group">
                        <label for="${prefix}TableListFile" class="block text-sm font-medium mb-2">ðŸ“ Upload Table List File <span class="text-red-500">*</span></label>
                        <input type="file" id="${prefix}TableListFile" class="form-file w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-purple-500 cursor-pointer" accept=".txt,.csv,.xlsx,.xls">
                        <p id="${prefix}TableListFileName" class="text-sm text-gray-600 mt-1 hidden"></p>
                        <p class="text-sm text-gray-500 mt-1">Upload a file containing list of table names (txt, csv, or excel)</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Generate Schema Generation TARGET fields (database with Output File Name)
function generateSchemaGenerationTargetFields(prefix) {
  // Filter out "File" from database types
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-red flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
                    Target Configuration
                </h3>
                <p>Configure your target database connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select database type</option>
                        ${dbTypesNoFile
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <!-- Output File Name (mandatory) -->
                <div class="form-group">
                    <label for="${prefix}OutputFileName" class="block text-sm font-medium mb-2">ðŸ“„ Output File Name <span class="text-red-500">*</span></label>
                    <input type="text" id="${prefix}OutputFileName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="schema_output.sql" maxlength="255">
                    <p class="text-sm text-gray-500 mt-1">Name of the generated schema file for download</p>
                </div>
            </div>
        </div>
    `;
}

// Attach Schema Generation specific listeners
function attachSchemaGenerationListeners() {
  const schemaModeSelect = document.getElementById("schemaSourceSchemaMode");
  const tableListFile = document.getElementById("schemaSourceTableListFile");

  if (schemaModeSelect) {
    schemaModeSelect.addEventListener("change", function () {
      const singleModeFields = document.getElementById(
        "schemaSourceSingleModeFields"
      );
      const multipleModeFields = document.getElementById(
        "schemaSourceMultipleModeFields"
      );

      if (this.value === "single") {
        singleModeFields.classList.remove("hidden");
        multipleModeFields.classList.add("hidden");
      } else if (this.value === "multiple") {
        singleModeFields.classList.add("hidden");
        multipleModeFields.classList.remove("hidden");
      } else {
        singleModeFields.classList.add("hidden");
        multipleModeFields.classList.add("hidden");
      }
    });
  }

  if (tableListFile) {
    tableListFile.addEventListener("change", function () {
      const fileName = document.getElementById("schemaSourceTableListFileName");
      if (this.files && this.files[0]) {
        fileName.textContent = `Selected: ${this.files[0].name}`;
        fileName.classList.remove("hidden");
      } else {
        fileName.classList.add("hidden");
      }
    });
  }
}

// Execute Schema Generation operation (handles file upload for multiple mode)
async function executeSchemaGenerationOperation(event) {
  event.preventDefault();

  const button = document.getElementById("schema-run-btn");
  const schemaMode = document.getElementById("schemaSourceSchemaMode")?.value;
  const outputFileName = document
    .getElementById("schemaTargetOutputFileName")
    ?.value?.trim();

  // Validate required fields
  if (!schemaMode) {
    addLog("âŒ Error: Schema Mode is required");
    alert("Please select a Schema Mode (Single or Multiple)");
    return;
  }

  if (!outputFileName) {
    addLog("âŒ Error: Output File Name is required");
    alert("Please enter an Output File Name");
    return;
  }

  // Validate based on schema mode
  if (schemaMode === "single") {
    const tableName = document
      .getElementById("schemaSourceTableName")
      ?.value?.trim();
    if (!tableName) {
      addLog("âŒ Error: Table Name is required for Single mode");
      alert("Please enter a Table Name");
      return;
    }
  } else if (schemaMode === "multiple") {
    const tableListFile = document.getElementById("schemaSourceTableListFile");
    if (!tableListFile || !tableListFile.files || !tableListFile.files[0]) {
      addLog("âŒ Error: Table List File is required for Multiple mode");
      alert("Please upload a Table List File");
      return;
    }
  }

  try {
    setButtonLoadingState(button, "Schema Generation", true);
    addLog("ðŸš€ Starting Schema Generation...");

    const apiTab = "schema_generation";
    const formData = collectFormData("schema");

    // Add schema-specific fields
    formData.schema_mode = schemaMode;
    formData.output_file_name = outputFileName;

    let response;

    if (schemaMode === "multiple") {
      // Use FormData for file upload
      const tableListFile = document.getElementById(
        "schemaSourceTableListFile"
      );
      const multiFormData = new FormData();

      multiFormData.append("tab", apiTab);
      multiFormData.append("schema_mode", schemaMode);
      multiFormData.append("output_file_name", outputFileName);
      multiFormData.append("table_list_file", tableListFile.files[0]);

      // Append all other form fields
      Object.keys(formData).forEach((key) => {
        if (
          formData[key] !== null &&
          formData[key] !== undefined &&
          key !== "schemaSourceTableListFile"
        ) {
          multiFormData.append(key, formData[key]);
        }
      });

      addLog(`ðŸ“Š Uploading Table List File: ${tableListFile.files[0].name}`);
      addLog(`ðŸ“Š Using /api/static/schema/run-with-upload endpoint`);

      response = await fetch("/api/static/schema/run-with-upload", {
        method: "POST",
        body: multiFormData,
      });
    } else {
      // Standard JSON request for single mode
      response = await fetch("/api/static/run", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          tab: apiTab,
          params: formData,
        }),
      });
    }

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || "Schema Generation operation failed");
    }

    const result = await response.json();
    currentRunId = result.run_id;
    executionStatus = "RUNNING";

    addLog(`ðŸ“‹ Run ID: ${currentRunId}`);

    // Start SSE log streaming with schema-specific handler
    startSchemaGenerationLogStreaming(currentRunId, button);
  } catch (error) {
    console.error("Error executing Schema Generation:", error);
    addLog(`âŒ Error: ${error.message}`);
    executionStatus = "IDLE";
    setButtonLoadingState(button, "Schema Generation", false);
  }
}

// Start Schema Generation specific log streaming (with download handling)
function startSchemaGenerationLogStreaming(runId, button) {
  if (eventSource) {
    eventSource.close();
  }

  eventSource = new EventSource(`/api/static/logs/${runId}`);

  eventSource.onmessage = function (event) {
    try {
      const data = JSON.parse(event.data);

      switch (data.type) {
        case "log":
          addLog(data.message);
          break;

        case "status":
          executionStatus = data.status;
          updateExecutionStatusUI(data.status);
          break;

        case "end":
          eventSource.close();
          eventSource = null;
          executionStatus = data.status || "IDLE";
          setButtonLoadingState(button, "Schema Generation", false);

          if (data.status === "SUCCESS") {
            addLog("âœ… Schema Generation completed successfully!");

            // Enable download button
            const downloadSection = document.getElementById(
              "schema-download-section"
            );
            const downloadBtn = document.getElementById("schema-download-btn");

            if (downloadSection && downloadBtn) {
              downloadSection.classList.remove("hidden");
              downloadBtn.disabled = false;
              downloadBtn.onclick = function () {
                handleSchemaDownload(runId);
              };
              addLog(
                "ðŸ“¥ Download ready! Click the Download button below the logs."
              );
            }
          }
          break;

        case "error":
          addLog(`âŒ ${data.message}`);
          eventSource.close();
          eventSource = null;
          executionStatus = "FAILED";
          setButtonLoadingState(button, "Schema Generation", false);
          break;
      }
    } catch (e) {
      console.error("Error parsing SSE data:", e);
    }
  };

  eventSource.onerror = function (error) {
    console.error("SSE error:", error);
    addLog("âŒ Connection to server lost");
    eventSource.close();
    eventSource = null;
    executionStatus = "FAILED";
    setButtonLoadingState(button, "Schema Generation", false);
  };
}

// Handle Schema Generation download
function handleSchemaDownload(runId) {
  const outputFileName =
    document.getElementById("schemaTargetOutputFileName")?.value?.trim() ||
    "schema_output.sql";

  addLog(`ðŸ“¥ Downloading ${outputFileName}...`);

  const downloadUrl = `/api/static/schema/download/${runId}`;

  fetch(downloadUrl)
    .then((response) => {
      if (!response.ok) {
        throw new Error("Download failed");
      }
      return response.blob();
    })
    .then((blob) => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = outputFileName;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      addLog(`âœ… Downloaded: ${outputFileName}`);
    })
    .catch((error) => {
      console.error("Download error:", error);
      addLog(`âŒ Download failed: ${error.message}`);
    });
}

// Generate File Load form - File-to-Database only
function generateFileLoadForm() {
  const container = document.getElementById("fileload-form");
  if (!container) return;

  container.innerHTML = `
        <form class="space-y-6" onsubmit="executeOperation(event, 'File Load')">
            <!-- Header: File to Database Load -->
            <div class="mb-6 p-4 border-2 border-dashed border-fileload/30 rounded-xl bg-gradient-to-br from-card to-fileload/5 shadow-sm">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ðŸ“</span>
                    <span class="text-lg font-semibold text-foreground">File to Database Load</span>
                </div>
                <p class="text-sm text-gray-500 mt-1">Load data from file to target database</p>
            </div>
            
            <div id="fileload-form-fields">
                <div class="grid lg:grid-cols-2 gap-6">
                    ${generateFileLoadSourceFields("fileloadSource")}
                    ${generateFileLoadTargetFields("fileloadTarget")}
                </div>
            </div>
            
            ${generateTimeZoneSection("fileload")}
            
            ${generateUnixServerSection("fileload")}
            
            <div class="execute-section text-center p-6 border-t border-gray-200">
                <!-- File Load Status Display -->
                <div id="fileload-status-container" class="mb-4 hidden">
                    <span id="fileload-status-text" class="text-lg font-semibold"></span>
                </div>
                <button type="submit" id="fileload-run-btn" class="execute-button bg-gradient-to-r from-red-600 to-red-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-red-700 hover:to-red-800 transition-all duration-200 shadow-lg">
                    <span class="execute-icon mr-2">â–¶ï¸</span>
                    <span id="fileload-btn-text">Execute File Load</span>
                </button>
            </div>
        </form>
    `;

  // Attach event listeners for file fields and target Hive fields
  attachFileLoadSourceListeners();
  attachFileLoadTargetListeners();
  console.log("[FileLoad] Form generated with File-to-Database configuration");
}

// Generate File Load SOURCE fields (file-based, matching Data Comparison file-to-db)
function generateFileLoadSourceFields(prefix) {
  return `
        <div class="source-target-card border-t-4 border-t-fileload shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-fileload flex items-center gap-2">
                    <div class="w-3 h-3 bg-fileload rounded-full"></div>
                    Source File Configuration
                </h3>
                <p>Configure your source file details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}FileType" class="block text-sm font-medium mb-2">ðŸ“„ File Type</label>
                    <select id="${prefix}FileType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
                        <option value="">Select file type</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="xml">XML</option>
                        <option value="parquet">Parquet</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}LocationType" class="block text-sm font-medium mb-2">ðŸ“ Location Type</label>
                    <select id="${prefix}LocationType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
                        <option value="">Select location type</option>
                        <option value="unix">File Path (Unix)</option>
                        <option value="hadoop">File Path (Hadoop)</option>
                        <option value="upload">Upload File</option>
                    </select>
                </div>
                
                <div id="${prefix}UnixPathField" class="form-group hidden">
                    <label for="${prefix}UnixPath" class="block text-sm font-medium mb-2">ðŸ“‚ Unix File Path</label>
                    <input type="text" id="${prefix}UnixPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="/path/to/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}HadoopPathField" class="form-group hidden">
                    <label for="${prefix}HadoopPath" class="block text-sm font-medium mb-2">ðŸ“‚ Hadoop File Path</label>
                    <input type="text" id="${prefix}HadoopPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="hdfs:///path/to/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}FileUploadField" class="form-group hidden">
                    <label for="${prefix}FileUpload" class="block text-sm font-medium mb-2">ðŸ“ Upload File</label>
                    <input type="file" id="${prefix}FileUpload" class="form-file w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-orange-500 cursor-pointer" accept=".csv,.json,.xml,.parquet,.xlsx,.xls">
                    <p id="${prefix}FileUploadName" class="text-sm text-gray-600 mt-1 hidden"></p>
                </div>
                
                <div id="${prefix}DelimiterField" class="form-group hidden">
                    <label for="${prefix}Delimiter" class="block text-sm font-medium mb-2">âœ‚ï¸ Delimiter</label>
                    <select id="${prefix}Delimiter" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
                        <option value=",">Comma (,)</option>
                        <option value="|">Pipe (|)</option>
                        <option value="	">Tab</option>
                        <option value=";">Semicolon (;)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}FileSqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}FileSqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" rows="3" placeholder="Enter SQL query to filter file data (optional, default: N/A)"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}KeyColumns" class="block text-sm font-medium mb-2">ðŸ”‘ Key Columns</label>
                    <input type="text" id="${prefix}KeyColumns" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="id,customer_id (comma-separated)" maxlength="500">
                </div>
            </div>
        </div>
    `;
}

// Generate File Load TARGET fields (database, matching Data Load target)
function generateFileLoadTargetFields(prefix) {
  // Filter out "File" from database types for target
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-red flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
                    Target Configuration
                </h3>
                <p>Configure your target database connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select database type</option>
                        ${dbTypesNoFile
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}TableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
                    <input type="text" id="${prefix}TableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter table name" maxlength="255">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}PrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
                    <input type="text" id="${prefix}PrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
                    <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}SqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}SqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
                </div>
                
                <!-- Load Type (Target only) -->
                <div class="form-group">
                    <label for="${prefix}LoadType" class="block text-sm font-medium mb-2">âš¡ Load Type</label>
                    <select id="${prefix}LoadType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
                        <option value="">Select load type</option>
                        <option value="overwrite">Overwrite</option>
                        <option value="append">Append</option>
                    </select>
                </div>
                
                <!-- Hive-specific fields (hidden by default) -->
                <div id="${prefix}HiveFields" class="hidden space-y-4 p-4 border-2 border-dashed border-yellow-400 rounded-lg bg-yellow-50">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ</span>
                        <span class="text-sm font-semibold text-yellow-700">Hive-Specific Configuration</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}HadoopPath" class="block text-sm font-medium mb-2">ðŸ“‚ Hadoop Path <span class="text-red-500">*</span></label>
                        <input type="text" id="${prefix}HadoopPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="/user/hive/warehouse/..." maxlength="1000">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}PartitionId" class="block text-sm font-medium mb-2">ðŸ”– Partition ID</label>
                        <input type="text" id="${prefix}PartitionId" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="e.g., year=2024/month=01 (leave empty for N/A)" maxlength="500">
                        <p class="text-sm text-gray-500 mt-1">Leave empty to default to "N/A"</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Attach File Load source field listeners (file type, location type, etc.)
function attachFileLoadSourceListeners() {
  const fileTypeSelect = document.getElementById("fileloadSourceFileType");
  const locationTypeSelect = document.getElementById(
    "fileloadSourceLocationType"
  );
  const fileUpload = document.getElementById("fileloadSourceFileUpload");

  if (fileTypeSelect) {
    fileTypeSelect.addEventListener("change", function () {
      const delimiterField = document.getElementById(
        "fileloadSourceDelimiterField"
      );
      if (this.value === "csv") {
        delimiterField.classList.remove("hidden");
        console.log("[FileLoad] Delimiter field shown for CSV");
      } else {
        delimiterField.classList.add("hidden");
      }
    });
  }

  if (locationTypeSelect) {
    locationTypeSelect.addEventListener("change", function () {
      const unixPathField = document.getElementById(
        "fileloadSourceUnixPathField"
      );
      const hadoopPathField = document.getElementById(
        "fileloadSourceHadoopPathField"
      );
      const uploadField = document.getElementById(
        "fileloadSourceFileUploadField"
      );

      // Hide all path fields first
      unixPathField.classList.add("hidden");
      hadoopPathField.classList.add("hidden");
      uploadField.classList.add("hidden");

      if (this.value === "unix") {
        unixPathField.classList.remove("hidden");
        console.log("[FileLoad] Unix path field shown");
      } else if (this.value === "hadoop") {
        hadoopPathField.classList.remove("hidden");
        console.log("[FileLoad] Hadoop path field shown");
      } else if (this.value === "upload") {
        uploadField.classList.remove("hidden");
        console.log("[FileLoad] File upload field shown");
      }
    });
  }

  if (fileUpload) {
    fileUpload.addEventListener("change", function () {
      const fileName = document.getElementById("fileloadSourceFileUploadName");
      if (this.files && this.files[0]) {
        fileName.textContent = `Selected: ${this.files[0].name}`;
        fileName.classList.remove("hidden");
      } else {
        fileName.classList.add("hidden");
      }
    });
  }
}

// Attach File Load target field listeners (for Hive fields toggle)
function attachFileLoadTargetListeners() {
  const targetTypeSelect = document.getElementById("fileloadTargetType");

  if (targetTypeSelect) {
    targetTypeSelect.addEventListener("change", function () {
      const hiveFields = document.getElementById("fileloadTargetHiveFields");

      if (this.value === "Hive") {
        if (hiveFields) {
          hiveFields.classList.remove("hidden");
          console.log("[FileLoad] Hive-specific fields shown");
        }
      } else {
        if (hiveFields) {
          hiveFields.classList.add("hidden");
        }
      }
    });
  }
}

// Generate File Download form
function generateFileDownloadForm() {
  const container = document.getElementById("filedownload-form");
  if (!container) return;

  container.innerHTML = `
        <!-- Source Type Selection -->
        <div class="mb-6 p-6 border-2 border-dashed border-primary/30 rounded-xl bg-gradient-to-br from-card to-primary/5 shadow-sm">
            <label class="text-lg font-semibold mb-4 block text-foreground flex items-center gap-2">
                <span class="text-2xl">ðŸ“¥</span> Source Type
            </label>
            <select id="filedownload-source-type-select" class="form-select w-full p-3 h-12 border-2 border-gray-300 rounded-lg text-base font-medium hover-border-primary transition-colors focus:border-primary focus:ring-2 focus:ring-primary/20">
                <option value="">Select source type</option>
                <option value="file">File</option>
                <option value="database">Database</option>
            </select>
        </div>
        
        <form id="filedownload-main-form" class="space-y-6" onsubmit="executeFileDownloadOperation(event)">
            <div id="filedownload-form-fields">
                <p class="text-gray-500 text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">ðŸ‘† Please select a source type above to continue</p>
            </div>
        </form>
    `;

  // Attach source type selection listener
  const sourceTypeSelect = document.getElementById(
    "filedownload-source-type-select"
  );
  if (sourceTypeSelect) {
    sourceTypeSelect.addEventListener("change", function () {
      handleFileDownloadSourceTypeChange(this.value);
    });
  }
}

// Handle source type change for File Download
function handleFileDownloadSourceTypeChange(sourceType) {
  const formFieldsContainer = document.getElementById(
    "filedownload-form-fields"
  );
  if (!formFieldsContainer) return;

  if (!sourceType) {
    formFieldsContainer.innerHTML =
      '<p class="text-gray-500 text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">ðŸ‘† Please select a source type above to continue</p>';
    return;
  }

  let sourceContent = "";

  if (sourceType === "file") {
    sourceContent = generateFileDownloadSourceFileFields("filedownloadSource");
  } else if (sourceType === "database") {
    sourceContent =
      generateFileDownloadSourceDatabaseFields("filedownloadSource");
  }

  formFieldsContainer.innerHTML = `
        <div class="grid lg:grid-cols-2 gap-6">
            ${sourceContent}
            ${generateFileDownloadTargetFields("filedownloadTarget")}
        </div>
        
        ${generateUnixServerSection("filedownload")}
        
        <div class="execute-section text-center p-6 border-t border-gray-200">
            <!-- File Download Status Display -->
            <div id="filedownload-status-container" class="mb-4 hidden">
                <span id="filedownload-status-text" class="text-lg font-semibold"></span>
            </div>
            <button type="submit" id="filedownload-run-btn" class="execute-button bg-gradient-to-r from-teal-600 to-teal-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-teal-700 hover:to-teal-800 transition-all duration-200 shadow-lg">
                <span class="execute-icon mr-2">â–¶ï¸</span>
                <span id="filedownload-btn-text">Execute File Download</span>
            </button>
        </div>
    `;

  // Attach appropriate listeners based on source type
  if (sourceType === "file") {
    attachFileDownloadSourceFileListeners();
  } else if (sourceType === "database") {
    attachFormListeners("filedownload");
  }

  // Attach target file type listener for delimiter toggle
  attachFileDownloadTargetListeners();
}

// Generate FILE source fields for File Download (matching Data Comparison file behavior)
function generateFileDownloadSourceFileFields(prefix) {
  return `
        <div class="source-target-card border-t-4 border-t-filedownload shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-filedownload-dark flex items-center gap-2">
                    <div class="w-3 h-3 bg-filedownload rounded-full"></div>
                    Source File Configuration
                </h3>
                <p>Configure your source file details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}FileType" class="block text-sm font-medium mb-2">ðŸ“„ File Type</label>
                    <select id="${prefix}FileType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200">
                        <option value="">Select file type</option>
                        <option value="CSV">CSV</option>
                        <option value="TSV">TSV</option>
                        <option value="Excel">Excel</option>
                        <option value="JSON">JSON</option>
                        <option value="Parquet">Parquet</option>
                        <option value="XML">XML</option>
                        <option value="Dat">Dat or txt file with Delimiter</option>
                    </select>
                </div>
                
                <div id="${prefix}DelimiterField" class="form-group hidden">
                    <label for="${prefix}Delimiter" class="block text-sm font-medium mb-2">ðŸ“ Delimiter</label>
                    <input type="text" id="${prefix}Delimiter" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter delimiter (e.g., comma, pipe, tab)" maxlength="10">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}LocationType" class="block text-sm font-medium mb-2">ðŸ“ Location Type</label>
                    <select id="${prefix}LocationType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200">
                        <option value="">Select location type</option>
                        <option value="unix">File Path (Unix)</option>
                        <option value="hadoop">File Path (Hadoop)</option>
                        <option value="upload">Upload from local</option>
                    </select>
                </div>
                
                <div id="${prefix}UnixPathField" class="form-group hidden">
                    <label for="${prefix}UnixPath" class="block text-sm font-medium mb-2">ðŸ“‚ Unix File Path</label>
                    <input type="text" id="${prefix}UnixPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="/path/to/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}HadoopPathField" class="form-group hidden">
                    <label for="${prefix}HadoopPath" class="block text-sm font-medium mb-2">ðŸ“‚ Hadoop File Path</label>
                    <input type="text" id="${prefix}HadoopPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="/user/hadoop/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}LocalUploadField" class="form-group hidden">
                    <label for="${prefix}LocalFile" class="block text-sm font-medium mb-2">ðŸ“¤ Upload Local File <span class="text-red-500">*</span></label>
                    <input type="file" id="${prefix}LocalFile" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                    <p class="text-sm text-gray-500 mt-1">Select a file from your local system to upload</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}KeyColumns" class="block text-sm font-medium mb-2">ðŸ”‘ Key Columns</label>
                    <input type="text" id="${prefix}KeyColumns" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
                    <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}SqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}SqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
                </div>
            </div>
        </div>
    `;
}

// Generate DATABASE source fields for File Download (matching Data Comparison DB behavior)
function generateFileDownloadSourceDatabaseFields(prefix) {
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  return `
        <div class="source-target-card border-t-4 border-t-filedownload shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-filedownload-dark flex items-center gap-2">
                    <div class="w-3 h-3 bg-filedownload rounded-full"></div>
                    Source Database Configuration
                </h3>
                <p>Configure your source database connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200">
                        <option value="">Select database type</option>
                        ${dbTypesNoFile
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="localhost" maxlength="1500">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="5432" maxlength="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter database name" maxlength="255">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter username" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}TableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
                    <input type="text" id="${prefix}TableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter table name" maxlength="255">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}PrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
                    <input type="text" id="${prefix}PrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
                    <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}SqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}SqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
                </div>
            </div>
        </div>
    `;
}

// Generate TARGET file fields for File Download (always file output)
function generateFileDownloadTargetFields(prefix) {
  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-gold shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-gold flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-gold rounded-full"></div>
                    Target File Configuration
                </h3>
                <p>Configure your output file details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}FileType" class="block text-sm font-medium mb-2">ðŸ“„ Target File Type</label>
                    <select id="${prefix}FileType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200">
                        <option value="">Select file type</option>
                        <option value="CSV">CSV</option>
                        <option value="TSV">TSV</option>
                        <option value="JSON">JSON</option>
                        <option value="Parquet">Parquet</option>
                        <option value="XML">XML</option>
                        <option value="Excel">Excel (XLSX)</option>
                    </select>
                </div>
                
                <div id="${prefix}DelimiterField" class="form-group hidden">
                    <label for="${prefix}Delimiter" class="block text-sm font-medium mb-2">ðŸ“ Delimiter <span class="text-red-500">*</span></label>
                    <input type="text" id="${prefix}Delimiter" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="Enter delimiter (e.g., , or | or \\t)" value="," maxlength="10">
                    <p class="text-sm text-gray-500 mt-1">Required for CSV/TSV formats</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}FileName" class="block text-sm font-medium mb-2">ðŸ“ Target File Name <span class="text-red-500">*</span></label>
                    <input type="text" id="${prefix}FileName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="e.g., output_data.csv" maxlength="255" required>
                    <p class="text-sm text-gray-500 mt-1">This will be the downloaded file name</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}NumberOfRows" class="block text-sm font-medium mb-2">ðŸ”¢ Number of Rows</label>
                    <input type="number" id="${prefix}NumberOfRows" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="Enter number of rows (max 100000)" min="1" max="100000">
                    <p class="text-sm text-gray-500 mt-1">Maximum allowed: 100,000 rows. Leave empty for default.</p>
                </div>
            </div>
        </div>
    `;
}

// Attach listeners for File Download source file fields
function attachFileDownloadSourceFileListeners() {
  const fileTypeSelect = document.getElementById("filedownloadSourceFileType");
  const locationTypeSelect = document.getElementById(
    "filedownloadSourceLocationType"
  );

  if (fileTypeSelect) {
    fileTypeSelect.addEventListener("change", function () {
      const delimiterField = document.getElementById(
        "filedownloadSourceDelimiterField"
      );
      if (
        this.value === "CSV" ||
        this.value === "TSV" ||
        this.value === "Dat"
      ) {
        if (delimiterField) delimiterField.classList.remove("hidden");
      } else {
        if (delimiterField) delimiterField.classList.add("hidden");
      }
    });
  }

  if (locationTypeSelect) {
    locationTypeSelect.addEventListener("change", function () {
      const unixPathField = document.getElementById(
        "filedownloadSourceUnixPathField"
      );
      const hadoopPathField = document.getElementById(
        "filedownloadSourceHadoopPathField"
      );
      const localUploadField = document.getElementById(
        "filedownloadSourceLocalUploadField"
      );

      // Hide all path fields first
      if (unixPathField) unixPathField.classList.add("hidden");
      if (hadoopPathField) hadoopPathField.classList.add("hidden");
      if (localUploadField) localUploadField.classList.add("hidden");

      if (this.value === "unix") {
        if (unixPathField) unixPathField.classList.remove("hidden");
      } else if (this.value === "hadoop") {
        if (hadoopPathField) hadoopPathField.classList.remove("hidden");
      } else if (this.value === "upload") {
        if (localUploadField) localUploadField.classList.remove("hidden");
      }
    });
  }
}

// Attach listeners for File Download target fields
function attachFileDownloadTargetListeners() {
  const targetFileTypeSelect = document.getElementById(
    "filedownloadTargetFileType"
  );

  if (targetFileTypeSelect) {
    targetFileTypeSelect.addEventListener("change", function () {
      const delimiterField = document.getElementById(
        "filedownloadTargetDelimiterField"
      );
      if (this.value === "CSV" || this.value === "TSV") {
        if (delimiterField) delimiterField.classList.remove("hidden");
      } else {
        if (delimiterField) delimiterField.classList.add("hidden");
      }
    });
  }
}

// File Download execution state
let fileDownloadRunId = null;
let fileDownloadStatus = "IDLE";
let fileDownloadUrl = "";

// Execute File Download operation
async function executeFileDownloadOperation(event) {
  if (event) {
    event.preventDefault();
  }

  console.log("[FileDownload] Executing File Download operation");

  const button = document.getElementById("filedownload-run-btn");
  const downloadSection = document.getElementById(
    "filedownload-download-section"
  );
  const downloadBtn = document.getElementById("filedownload-download-btn");

  // Hide download button at start
  if (downloadSection) downloadSection.classList.add("hidden");
  if (downloadBtn) downloadBtn.disabled = true;

  // Check if already running
  if (fileDownloadStatus === "RUNNING") {
    addLog("âš ï¸ File Download operation is already running. Please wait.");
    return;
  }

  // Validate required fields
  const sourceType = document.getElementById(
    "filedownload-source-type-select"
  )?.value;
  if (!sourceType) {
    addLog("âŒ Please select a source type (File or Database)");
    return;
  }

  // Validate Target File Name (mandatory)
  const targetFileName = document
    .getElementById("filedownloadTargetFileName")
    ?.value?.trim();
  if (!targetFileName) {
    addLog("âŒ Target File Name is required");
    return;
  }

  // Validate Number of Rows (max 100000)
  const numberOfRowsInput = document.getElementById(
    "filedownloadTargetNumberOfRows"
  );
  const numberOfRows = numberOfRowsInput?.value
    ? parseInt(numberOfRowsInput.value, 10)
    : null;

  if (numberOfRows !== null && numberOfRows > 100000) {
    addLog("âŒ Number of Rows cannot exceed 100,000");
    return;
  }

  if (numberOfRows !== null && (isNaN(numberOfRows) || numberOfRows < 1)) {
    addLog("âŒ Number of Rows must be a positive number");
    return;
  }

  // Validate local file upload if location type is "upload"
  const locationType = document.getElementById(
    "filedownloadSourceLocationType"
  )?.value;
  if (sourceType === "file" && locationType === "upload") {
    const localFileInput = document.getElementById(
      "filedownloadSourceLocalFile"
    );
    if (!localFileInput || !localFileInput.files || !localFileInput.files[0]) {
      addLog("âŒ Please select a local file to upload");
      return;
    }
  }

  // Validate User Email
  const userEmail = document
    .getElementById("filedownloadUserEmail")
    ?.value?.trim();
  if (!isValidEmail(userEmail)) {
    if (!userEmail) {
      addLog("âŒ User Email is required for execution");
    } else {
      addLog("âŒ Please enter a valid email address");
    }
    return;
  }

  // Show loading state on button
  setButtonLoadingState(button, "File Download", true);
  fileDownloadStatus = "RUNNING";

  try {
    // Collect form data
    const formData = collectFileDownloadFormData(sourceType);

    // Add required fields
    formData.source_type = sourceType;
    formData.target_file_name = targetFileName;
    if (numberOfRows !== null) {
      formData.number_of_rows = numberOfRows;
    }

    addLog(`ðŸš€ Starting File Download...`);
    addLog(`ðŸ“ Source Type: ${sourceType}`);
    addLog(`ðŸ“„ Target File Name: ${targetFileName}`);
    if (numberOfRows) addLog(`ðŸ”¢ Number of Rows: ${numberOfRows}`);

    let response;

    // Check if local file upload is needed
    const locationType = document.getElementById(
      "filedownloadSourceLocationType"
    )?.value;
    if (sourceType === "file" && locationType === "upload") {
      // Use multipart/form-data for file upload
      const localFileInput = document.getElementById(
        "filedownloadSourceLocalFile"
      );
      const localFile = localFileInput.files[0];

      addLog(
        `ðŸ“¤ Uploading local file: ${localFile.name} (${(
          localFile.size / 1024
        ).toFixed(2)} KB)`
      );

      const uploadFormData = new FormData();
      uploadFormData.append("tab", "file_download");
      uploadFormData.append("source_type", sourceType);
      uploadFormData.append("source_location_type", "upload");
      uploadFormData.append("source_local_file", localFile);
      uploadFormData.append("target_file_name", targetFileName);
      if (numberOfRows !== null) {
        uploadFormData.append("number_of_rows", numberOfRows);
      }

      // Append all other form fields
      Object.keys(formData).forEach((key) => {
        if (formData[key] !== null && formData[key] !== undefined) {
          uploadFormData.append(key, formData[key]);
        }
      });

      response = await fetch("/api/static/filedownload/run-with-upload", {
        method: "POST",
        body: uploadFormData,
      });
    } else {
      // Standard JSON request
      response = await fetch("/api/static/run", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          tab: "file_download",
          params: formData,
        }),
      });
    }

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || "File Download operation failed");
    }

    const result = await response.json();
    fileDownloadRunId = result.run_id;

    addLog(`ðŸ“‹ Run ID: ${fileDownloadRunId}`);

    // Start SSE log streaming for File Download
    startFileDownloadLogStreaming(fileDownloadRunId, button, targetFileName);
  } catch (error) {
    console.error("Error executing File Download:", error);
    addLog(`âŒ Error: ${error.message}`);
    fileDownloadStatus = "IDLE";
    setButtonLoadingState(button, "File Download", false);
  }
}

// Start SSE log streaming for File Download
function startFileDownloadLogStreaming(runId, button, targetFileName) {
  const eventSrc = new EventSource(`/api/static/logs/${runId}`);

  eventSrc.onmessage = function (event) {
    try {
      const data = JSON.parse(event.data);

      switch (data.type) {
        case "log":
          addLog(data.message);
          break;

        case "status":
          fileDownloadStatus = data.status;
          break;

        case "end":
          eventSrc.close();
          fileDownloadStatus = data.status || "IDLE";
          setButtonLoadingState(button, "File Download", false);

          if (data.status === "SUCCESS") {
            addLog("âœ… File Download completed successfully!");

            // Show download button (in the log section, after the log box)
            const downloadSection = document.getElementById(
              "filedownload-download-section"
            );
            const downloadBtn = document.getElementById(
              "filedownload-download-btn"
            );
            const downloadBtnText = document.getElementById(
              "filedownload-download-btn-text"
            );

            if (downloadSection) downloadSection.classList.remove("hidden");
            if (downloadBtn) {
              downloadBtn.disabled = false;
              downloadBtn.onclick = function () {
                handleFileDownloadDownload(runId, targetFileName);
              };
            }
            if (downloadBtnText)
              downloadBtnText.textContent = `Download ${targetFileName}`;

            // Store download URL
            fileDownloadUrl = `/api/static/filedownload/download/${runId}`;
            addLog(
              `ðŸ“¥ Click "Download ${targetFileName}" button below the logs to save the file.`
            );
          }
          break;

        case "error":
          addLog(`âŒ ${data.message}`);
          eventSrc.close();
          fileDownloadStatus = "FAILED";
          setButtonLoadingState(button, "File Download", false);
          break;
      }
    } catch (e) {
      console.error("Error parsing SSE data:", e);
    }
  };

  eventSrc.onerror = function (error) {
    console.error("SSE error:", error);
    addLog("âŒ Connection to server lost");
    eventSrc.close();
    fileDownloadStatus = "FAILED";
    setButtonLoadingState(button, "File Download", false);
  };
}

// Collect form data for File Download
function collectFileDownloadFormData(sourceType) {
  const data = {};

  // Source fields based on source type
  if (sourceType === "file") {
    data.filedownloadSourceFileType =
      document.getElementById("filedownloadSourceFileType")?.value || "";
    data.filedownloadSourceDelimiter =
      document.getElementById("filedownloadSourceDelimiter")?.value || "";
    data.filedownloadSourceLocationType =
      document.getElementById("filedownloadSourceLocationType")?.value || "";
    data.filedownloadSourceUnixPath =
      document.getElementById("filedownloadSourceUnixPath")?.value || "";
    data.filedownloadSourceHadoopPath =
      document.getElementById("filedownloadSourceHadoopPath")?.value || "";
    data.filedownloadSourceKeyColumns =
      document.getElementById("filedownloadSourceKeyColumns")?.value || "";
    data.filedownloadSourceSqlQuery =
      document.getElementById("filedownloadSourceSqlQuery")?.value || "";
    // Note: Local file is handled separately via FormData in executeFileDownloadOperation
  } else if (sourceType === "database") {
    data.filedownloadSourceType =
      document.getElementById("filedownloadSourceType")?.value || "";
    data.filedownloadSourceHost =
      document.getElementById("filedownloadSourceHost")?.value || "";
    data.filedownloadSourcePort =
      document.getElementById("filedownloadSourcePort")?.value || "";
    data.filedownloadSourceDatabase =
      document.getElementById("filedownloadSourceDatabase")?.value || "";
    data.filedownloadSourceUsername =
      document.getElementById("filedownloadSourceUsername")?.value || "";
    data.filedownloadSourcePassword =
      document.getElementById("filedownloadSourcePassword")?.value || "";
    data.filedownloadSourceTableName =
      document.getElementById("filedownloadSourceTableName")?.value || "";
    data.filedownloadSourcePrimaryKey =
      document.getElementById("filedownloadSourcePrimaryKey")?.value || "";
    data.filedownloadSourceSqlQuery =
      document.getElementById("filedownloadSourceSqlQuery")?.value || "";
  }

  // Target file fields
  data.filedownloadTargetFileType =
    document.getElementById("filedownloadTargetFileType")?.value || "";
  data.filedownloadTargetDelimiter =
    document.getElementById("filedownloadTargetDelimiter")?.value || "";
  data.filedownloadTargetFileName =
    document.getElementById("filedownloadTargetFileName")?.value || "";
  data.filedownloadTargetNumberOfRows =
    document.getElementById("filedownloadTargetNumberOfRows")?.value || "";

  // Unix server fields
  data.filedownloadUnixHost =
    document.getElementById("filedownloadUnixHost")?.value || "";
  data.filedownloadUserEmail =
    document.getElementById("filedownloadUserEmail")?.value || "";
  data.filedownloadBatchId =
    document.getElementById("filedownloadBatchId")?.value || "";
  data.filedownloadUnixUsername =
    document.getElementById("filedownloadUnixUsername")?.value || "";
  data.filedownloadUnixPassword =
    document.getElementById("filedownloadUnixPassword")?.value || "";

  return data;
}

// Handle File Download download button click
function handleFileDownloadDownload(runId, targetFileName) {
  if (!runId) {
    addLog("âŒ No file available to download");
    return;
  }

  try {
    addLog(`ðŸ“¥ Downloading ${targetFileName}...`);

    // Create a temporary anchor element for download
    const link = document.createElement("a");
    link.href = `/api/static/filedownload/download/${runId}`;
    link.download = targetFileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    addLog(`âœ… Download started for ${targetFileName}`);
  } catch (error) {
    console.error("Error downloading file:", error);
    addLog(`âŒ Error downloading file: ${error.message}`);
  }
}

// Attach form event listeners
function attachFormListeners(prefix) {
  // Database type change listeners
  const sourceTypeSelect = document.getElementById(prefix + "SourceType");
  const targetTypeSelect = document.getElementById(prefix + "TargetType");

  if (sourceTypeSelect) {
    sourceTypeSelect.addEventListener("change", function () {
      updateDropdownOptions(prefix + "Source", this.value);
    });
  }

  if (targetTypeSelect) {
    targetTypeSelect.addEventListener("change", function () {
      updateDropdownOptions(prefix + "Target", this.value);
    });
  }

  // Primary key selection listeners
  const sourcePkSelect = document.getElementById(prefix + "SourcePrimaryKey");
  const targetPkSelect = document.getElementById(prefix + "TargetPrimaryKey");

  if (sourcePkSelect) {
    sourcePkSelect.addEventListener("change", function () {
      if (this.value === "manual") {
        handlePrimaryKeySelection(prefix + "Source");
      }
    });
  }

  if (targetPkSelect) {
    targetPkSelect.addEventListener("change", function () {
      if (this.value === "manual") {
        handlePrimaryKeySelection(prefix + "Target");
      }
    });
  }
}

// ============================================================
// STATIC EXECUTION FLOW - SSE BASED
// ============================================================

// Helper function to validate email format
function isValidEmail(email) {
  // Handle null, undefined, or non-string values
  if (email === null || email === undefined) return false;
  if (typeof email !== "string") return false;

  // Trim whitespace
  email = email.trim();
  if (email === "") return false;

  // Use a simple regex pattern for email validation
  // This pattern checks for: something@something.something
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailPattern.test(email);
}

// Execute operation - Main entry point
async function executeOperation(event, operationType) {
  if (event) {
    event.preventDefault();
  }

  console.log(
    `Executing ${operationType} with table mode: ${currentTableMode}`
  );

  // Get the execute button - for Data Load, try specific ID first
  const form = event ? event.target : null;
  let button = null;

  if (operationType === "Data Load") {
    // For Data Load, use the specific button ID to ensure isolation
    button = document.getElementById("dataload-run-btn");
    console.log(
      "[DataLoad] Looking for button #dataload-run-btn, found:",
      !!button
    );
  }

  // Fallback to form's execute button if specific button not found
  if (!button && form) {
    button = form.querySelector(".execute-button");
  }

  // Check if already running
  if (executionStatus === "RUNNING") {
    addLog("âš ï¸ An operation is already running. Please wait or stop it first.");
    return;
  }

  // Reset download button state when starting a new comparison
  if (operationType === "Data Comparison") {
    resetDownloadButton();
  }

  // Show loading state on button
  console.log(
    `[${operationType}] Setting button loading state, button found: ${!!button}`
  );
  setButtonLoadingState(button, operationType, true);

  try {
    // Get the API tab name
    const apiTab = TAB_API_MAP[currentTab];
    if (!apiTab) {
      throw new Error(`Unknown tab: ${currentTab}`);
    }

    // Collect form data based on current tab
    const formData = collectFormData(currentTab);

    // Validate User Email
    const emailKey = `${currentTab}UserEmail`;
    const userEmail = formData[emailKey];
    if (!isValidEmail(userEmail)) {
      if (!userEmail || userEmail.trim() === "") {
        throw new Error("User Email is required for execution");
      } else {
        throw new Error("Please enter a valid email address");
      }
    }

    // Add table mode to form data
    formData.tableMode = currentTableMode;

    // Add comparison type if applicable
    const comparisonTypeSelect = document.getElementById(
      "comparison-type-select"
    );
    if (comparisonTypeSelect) {
      formData.comparisonType = comparisonTypeSelect.value;
    }

    addLog(`ðŸš€ Starting ${operationType}...`);

    let response;

    // Check if this is Multi-Table mode with Excel file for Data Comparison
    if (
      apiTab === "data_comparison" &&
      currentTableMode === "multi" &&
      formData.comparisonType === "database-to-database"
    ) {
      // Use multipart/form-data for Excel file upload
      const sourceExcelInput = document.getElementById("sourceExcelFile");
      const targetExcelInput = document.getElementById("targetExcelFile");

      // Validate both files are provided
      if (
        !sourceExcelInput ||
        !sourceExcelInput.files ||
        !sourceExcelInput.files[0]
      ) {
        throw new Error(
          "Please select a Source Excel file for Multiple Tables mode"
        );
      }
      if (
        !targetExcelInput ||
        !targetExcelInput.files ||
        !targetExcelInput.files[0]
      ) {
        throw new Error(
          "Please select a Target Excel file for Multiple Tables mode"
        );
      }

      const multiFormData = new FormData();
      multiFormData.append("tab", apiTab);
      multiFormData.append("comparison_type", "db_to_db");
      multiFormData.append("mode", "multiple_tables");
      multiFormData.append("source_excel_file", sourceExcelInput.files[0]);
      multiFormData.append("target_excel_file", targetExcelInput.files[0]);

      // Append all other form fields
      Object.keys(formData).forEach((key) => {
        if (formData[key] !== null && formData[key] !== undefined) {
          multiFormData.append(key, formData[key]);
        }
      });

      addLog(`ðŸ“Š Uploading Source Excel: ${sourceExcelInput.files[0].name}`);
      addLog(`ðŸ“Š Uploading Target Excel: ${targetExcelInput.files[0].name}`);
      addLog(
        `ðŸ“Š Using /api/static/comparison/run-multi endpoint for multi-table mode`
      );

      response = await fetch("/api/static/comparison/run-multi", {
        method: "POST",
        body: multiFormData,
      });
    } else if (apiTab === "file_load") {
      // Check if File Load tab has local file upload selected
      const fileloadLocationType = document.getElementById(
        "fileloadSourceLocationType"
      )?.value;

      if (fileloadLocationType === "upload") {
        // Use multipart/form-data for local file upload
        const fileUploadInput = document.getElementById(
          "fileloadSourceFileUpload"
        );

        // Validate file is selected
        if (
          !fileUploadInput ||
          !fileUploadInput.files ||
          !fileUploadInput.files[0]
        ) {
          throw new Error(
            "Please select a file to upload for File Load operation"
          );
        }

        const uploadedFile = fileUploadInput.files[0];

        addLog(
          `ðŸ“¤ Uploading local file: ${uploadedFile.name} (${(
            uploadedFile.size / 1024
          ).toFixed(2)} KB)`
        );

        const uploadFormData = new FormData();
        uploadFormData.append("tab", "file_load");
        uploadFormData.append("source_local_file", uploadedFile);

        // Append all other form fields
        Object.keys(formData).forEach((key) => {
          if (formData[key] !== null && formData[key] !== undefined) {
            uploadFormData.append(key, formData[key]);
          }
        });

        addLog(`ðŸ“¤ Using /api/static/fileload/run-with-upload endpoint`);

        response = await fetch("/api/static/fileload/run-with-upload", {
          method: "POST",
          body: uploadFormData,
        });
      } else {
        // Standard JSON request for unix/hadoop path
        response = await fetch("/api/static/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            tab: apiTab,
            params: formData,
          }),
        });
      }
    } else {
      // Standard JSON request for single table mode
      response = await fetch("/api/static/run", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          tab: apiTab,
          params: formData,
        }),
      });
    }

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || `${operationType} operation failed`);
    }

    const result = await response.json();
    currentRunId = result.run_id;
    executionStatus = "RUNNING";

    // Data Load specific state update
    if (apiTab === "data_load") {
      dataLoadRunStatus = "RUNNING";
      console.log(
        "[DataLoad] Status changed to RUNNING â†’ Waiting for DataLoad"
      );
    }

    addLog(`ðŸ“‹ Run ID: ${currentRunId}`);

    // Start SSE log streaming
    startLogStreaming(currentRunId, button, operationType);
  } catch (error) {
    console.error("Error executing operation:", error);
    addLog(`âŒ Error: ${error.message}`);
    executionStatus = "IDLE";
    setButtonLoadingState(button, operationType, false);
  }
}

// Start SSE log streaming
function startLogStreaming(runId, button, operationType) {
  // Close existing EventSource if any
  if (eventSource) {
    eventSource.close();
  }

  eventSource = new EventSource(`/api/static/logs/${runId}`);

  eventSource.onmessage = function (event) {
    try {
      const data = JSON.parse(event.data);

      switch (data.type) {
        case "log":
          addLog(data.message);
          break;

        case "status":
          executionStatus = data.status;
          updateExecutionStatusUI(data.status);
          break;

        case "end":
          eventSource.close();
          eventSource = null;
          executionStatus = data.status || "IDLE";
          setButtonLoadingState(button, operationType, false);

          if (data.status === "SUCCESS") {
            if (operationType === "Data Comparison") {
              jobComplete = true;

              // Check if download is available (single_table mode)
              if (data.download_available && data.download_url) {
                reportUrl = data.download_url;
                enableDownloadButton();
                addLog(
                  `ðŸ“¥ Download ready: ${data.download_filename || "output.csv"}`
                );
                addLog(
                  "âœ… Comparison complete! Click 'Download Comparison Report' to save the file."
                );
              } else {
                reportUrl = `/reports/comparison_${runId}.csv`;
                enableDownloadButton();
              }
            } else if (operationType === "Data Load") {
              // Data Load specific success handling
              dataLoadRunStatus = "SUCCESS";
              dataLoadButtonLabel = "Execute Data Load";
              console.log("[DataLoad] Status SUCCESS â†’ Data load completed");
              addLog("âœ… Data load completed");
              updateDataLoadStatusUI("Data load completed");
            }
          } else if (
            data.status === "FAILED" &&
            operationType === "Data Load"
          ) {
            dataLoadRunStatus = "FAILED";
            dataLoadButtonLabel = "Execute Data Load";
            console.log("[DataLoad] Status FAILED");
          } else if (
            data.status === "STOPPED" &&
            operationType === "Data Load"
          ) {
            dataLoadRunStatus = "STOPPED";
            dataLoadButtonLabel = "Execute Data Load";
            console.log("[DataLoad] Status STOPPED");
          }
          break;

        case "error":
          addLog(`âŒ ${data.message}`);
          eventSource.close();
          eventSource = null;
          executionStatus = "FAILED";
          setButtonLoadingState(button, operationType, false);
          break;
      }
    } catch (e) {
      console.error("Error parsing SSE data:", e);
    }
  };

  eventSource.onerror = function (error) {
    console.error("SSE error:", error);
    addLog("âŒ Connection to server lost");
    eventSource.close();
    eventSource = null;
    executionStatus = "FAILED";
    setButtonLoadingState(button, operationType, false);
  };
}

// Update execution status in UI
function updateExecutionStatusUI(status) {
  const statusElement = document.getElementById("execution-status");
  if (statusElement) {
    statusElement.textContent = status;
    statusElement.className = `execution-status status-${status.toLowerCase()}`;
  }
}

// Set button loading state
function setButtonLoadingState(button, operationType, isLoading) {
  if (!button) return;

  if (isLoading) {
    button.disabled = true;

    // Data Load specific button label - use dedicated element
    if (operationType === "Data Load") {
      dataLoadRunStatus = "RUNNING";
      dataLoadButtonLabel = "Waiting for DataLoad...";

      // Update Data Load specific button text element
      const dataLoadBtnText = document.getElementById("dataload-btn-text");
      if (dataLoadBtnText) {
        dataLoadBtnText.textContent = "Waiting for DataLoad...";
      }
      button.innerHTML = `<span class="loading-spinner mr-2">âŸ³</span><span id="dataload-btn-text">Waiting for DataLoad...</span>`;
      console.log(
        "[DataLoad] Button updated â†’ Waiting for DataLoad (element: #dataload-run-btn)"
      );

      // Hide success status when starting new run
      const statusContainer = document.getElementById(
        "dataload-status-container"
      );
      if (statusContainer) {
        statusContainer.classList.add("hidden");
      }
    } else {
      button.innerHTML = `<span class="loading-spinner mr-2">âŸ³</span>Waiting for ${operationType}...`;
    }
    button.classList.add("loading");
  } else {
    button.disabled = false;

    // Data Load specific button reset
    if (operationType === "Data Load") {
      dataLoadButtonLabel = "Execute Data Load";
      button.innerHTML = `<span class="execute-icon mr-2">â–¶ï¸</span><span id="dataload-btn-text">Execute Data Load</span>`;
      console.log("[DataLoad] Button reset â†’ Execute Data Load");
    } else {
      button.innerHTML = `<span class="execute-icon mr-2">â–¶ï¸</span>Execute ${operationType}`;
    }
    button.classList.remove("loading");
  }
}

// Update Data Load specific status in UI
function updateDataLoadStatusUI(statusText) {
  console.log("[DataLoad] Updating status UI â†’ " + statusText);

  // Find status container and text element specific to Data Load tab
  const statusContainer = document.getElementById("dataload-status-container");
  const statusElement = document.getElementById("dataload-status-text");

  if (statusContainer && statusElement) {
    statusContainer.classList.remove("hidden");
    statusElement.textContent = statusText;
    statusElement.className =
      "dataload-status-success text-green-600 font-semibold";
    console.log("[DataLoad] Updated #dataload-status-text â†’ " + statusText);
  } else {
    console.log(
      "[DataLoad] Status elements not found: container=" +
        !!statusContainer +
        ", text=" +
        !!statusElement
    );
  }
}

// Stop current execution
async function stopExecution() {
  if (!currentRunId || executionStatus !== "RUNNING") {
    addLog("âš ï¸ No running operation to stop");
    return;
  }

  try {
    const response = await fetch(`/api/static/stop/${currentRunId}`, {
      method: "POST",
    });

    if (response.ok) {
      addLog("â›” Stop request sent");
    } else {
      const errorData = await response.json();
      addLog(`âŒ Failed to stop: ${errorData.error}`);
    }
  } catch (error) {
    console.error("Error stopping execution:", error);
    addLog(`âŒ Error stopping execution: ${error.message}`);
  }
}

// Collect form data for current tab
function collectFormData(tabPrefix) {
  const data = {};

  // Get all form inputs in the current tab
  const tabContent = document.getElementById(tabPrefix);
  if (!tabContent) return data;

  const inputs = tabContent.querySelectorAll("input, select, textarea");
  inputs.forEach((input) => {
    if (input.id) {
      if (input.type === "file") {
        // For file inputs, we'll need to handle file upload separately
        // For now, just store the file name
        data[input.id] = input.files[0] ? input.files[0].name : null;
      } else if (input.type === "radio") {
        if (input.checked) {
          data[input.name] = input.value;
        }
      } else if (input.type === "password") {
        // Include password fields but mark them
        data[input.id] = input.value;
      } else {
        data[input.id] = input.value;
      }
    }
  });

  // Add key columns if they exist
  const comparisonType = document.getElementById("comparison-type-select");
  if (
    comparisonType &&
    (comparisonType.value === "file-to-file" ||
      comparisonType.value === "file-to-database" ||
      comparisonType.value === "database-to-file")
  ) {
    const sourceKeyColumns = document.getElementById(
      "comparisonSourceKeyColumns"
    );
    const targetKeyColumns = document.getElementById(
      "comparisonTargetKeyColumns"
    );
    if (sourceKeyColumns) data["keyColumns"] = sourceKeyColumns.value;
    if (targetKeyColumns) data["keyColumns"] = targetKeyColumns.value;

    // Handle location type mapping to unix_path or hadoop_path
    const sourceLocationType = document.getElementById(
      "comparisonSourceLocationType"
    );
    const targetLocationType = document.getElementById(
      "comparisonTargetLocationType"
    );

    // Source file path handling
    if (sourceLocationType) {
      if (sourceLocationType.value === "unix") {
        const unixPath = document.getElementById("comparisonSourceUnixPath");
        if (unixPath && unixPath.value) {
          data["source_unix_path"] = unixPath.value;
          data["source_hadoop_path"] = ""; // Clear the other path
        }
      } else if (sourceLocationType.value === "hadoop") {
        const hadoopPath = document.getElementById(
          "comparisonSourceHadoopPath"
        );
        if (hadoopPath && hadoopPath.value) {
          data["source_hadoop_path"] = hadoopPath.value;
          data["source_unix_path"] = ""; // Clear the other path
        }
      }
      data["source_location_type"] = sourceLocationType.value;
    }

    // Target file path handling
    if (targetLocationType) {
      if (targetLocationType.value === "unix") {
        const unixPath = document.getElementById("comparisonTargetUnixPath");
        if (unixPath && unixPath.value) {
          data["target_unix_path"] = unixPath.value;
          data["target_hadoop_path"] = ""; // Clear the other path
        }
      } else if (targetLocationType.value === "hadoop") {
        const hadoopPath = document.getElementById(
          "comparisonTargetHadoopPath"
        );
        if (hadoopPath && hadoopPath.value) {
          data["target_hadoop_path"] = hadoopPath.value;
          data["target_unix_path"] = ""; // Clear the other path
        }
      }
      data["target_location_type"] = targetLocationType.value;
    }

    // Handle file SQL query - default to "N/A" if empty
    const sourceFileSqlQuery = document.getElementById(
      "comparisonSourceFileSqlQuery"
    );
    const targetFileSqlQuery = document.getElementById(
      "comparisonTargetFileSqlQuery"
    );

    if (sourceFileSqlQuery) {
      data["source_file_sql_query"] = sourceFileSqlQuery.value.trim() || "N/A";
    }
    if (targetFileSqlQuery) {
      data["target_file_sql_query"] = targetFileSqlQuery.value.trim() || "N/A";
    }
  }

  // Handle Time Zone field - always include it with default "N/A"
  // Check for comparison tab first, then load tab
  let timeZoneInput = document.getElementById("comparisonTimeZone");
  if (!timeZoneInput) {
    timeZoneInput = document.getElementById("loadTimeZone");
  }
  if (timeZoneInput) {
    const tzValue = timeZoneInput.value.trim();
    data["time_zone"] = tzValue || "N/A";
  } else {
    data["time_zone"] = "N/A";
  }

  // Handle Data Load specific fields
  if (tabPrefix === "load") {
    // Target Load Type
    const targetLoadType = document.getElementById("loadTargetLoadType");
    if (targetLoadType) {
      data["target_load_type"] = targetLoadType.value || "";
    }

    // Check if target is Hive for Hive-specific fields
    const targetType = document.getElementById("loadTargetType");
    if (targetType && targetType.value === "Hive") {
      const hadoopPath = document.getElementById("loadTargetHadoopPath");
      const partitionId = document.getElementById("loadTargetPartitionId");

      if (hadoopPath) {
        data["hadoop_path"] = hadoopPath.value.trim() || "";
      }
      if (partitionId) {
        data["partition_id"] = partitionId.value.trim() || "N/A";
      }
    }
  }

  // Handle File Load specific fields (File-to-Database)
  if (tabPrefix === "fileload") {
    console.log("[FileLoad] Collecting form data for File-to-Database load");

    // Source file fields
    const sourceFileType = document.getElementById("fileloadSourceFileType");
    const sourceLocationType = document.getElementById(
      "fileloadSourceLocationType"
    );
    const sourceDelimiter = document.getElementById("fileloadSourceDelimiter");
    const sourceFileSqlQuery = document.getElementById(
      "fileloadSourceFileSqlQuery"
    );
    const sourceKeyColumns = document.getElementById(
      "fileloadSourceKeyColumns"
    );

    if (sourceFileType) {
      data["source_file_type"] = sourceFileType.value || "";
    }

    if (sourceLocationType) {
      data["source_location_type"] = sourceLocationType.value || "";

      if (sourceLocationType.value === "unix") {
        const unixPath = document.getElementById("fileloadSourceUnixPath");
        if (unixPath && unixPath.value) {
          data["source_unix_path"] = unixPath.value;
          data["source_hadoop_path"] = "";
        }
      } else if (sourceLocationType.value === "hadoop") {
        const hadoopPath = document.getElementById("fileloadSourceHadoopPath");
        if (hadoopPath && hadoopPath.value) {
          data["source_hadoop_path"] = hadoopPath.value;
          data["source_unix_path"] = "";
        }
      }
    }

    if (sourceDelimiter) {
      data["source_delimiter"] = sourceDelimiter.value || ",";
    }

    if (sourceFileSqlQuery) {
      data["source_file_sql_query"] = sourceFileSqlQuery.value.trim() || "N/A";
    }

    if (sourceKeyColumns) {
      data["source_key_columns"] = sourceKeyColumns.value || "";
    }

    // Target database fields (same as Data Load)
    const targetLoadType = document.getElementById("fileloadTargetLoadType");
    if (targetLoadType) {
      data["target_load_type"] = targetLoadType.value || "";
    }

    // Check if target is Hive for Hive-specific fields
    const targetType = document.getElementById("fileloadTargetType");
    if (targetType && targetType.value === "Hive") {
      const hadoopPath = document.getElementById("fileloadTargetHadoopPath");
      const partitionId = document.getElementById("fileloadTargetPartitionId");

      if (hadoopPath) {
        data["hadoop_path"] = hadoopPath.value.trim() || "";
      }
      if (partitionId) {
        data["partition_id"] = partitionId.value.trim() || "N/A";
      }
    }

    // Handle Time Zone for File Load
    const fileloadTimeZone = document.getElementById("fileloadTimeZone");
    if (fileloadTimeZone) {
      data["time_zone"] = fileloadTimeZone.value.trim() || "N/A";
    }
  }

  return data;
}

// ============================================================
// WEBSOCKET CONNECTION (Legacy - kept for backwards compatibility)
// ============================================================
function initializeWebSocket() {
  try {
    socket = io();

    socket.on("connect", function () {
      isConnected = true;
      updateConnectionStatus();
      addLog("ðŸ”— Connected to Wells Fargo Data Management Platform");
    });

    socket.on("disconnect", function () {
      isConnected = false;
      updateConnectionStatus();
      addLog("ðŸ”Œ Disconnected from server");
    });

    socket.on("log", function (data) {
      if (!isPaused) {
        addLog(data.message);
      }
    });

    socket.on("operation_complete", function (data) {
      console.log("Operation complete:", data);
      if (data.status === "success") {
        jobComplete = true;
        if (data.report_path) {
          reportUrl = data.report_path;
        }
        enableDownloadButton();
        addLog("âœ… Comparison complete! Report ready to download.");
      }
    });

    socket.on("operation_error", function (data) {
      console.error("Operation error:", data);
      jobComplete = false;
      reportUrl = "";
      disableDownloadButton();
      addLog(`âŒ Comparison failed: ${data.error}`);
    });

    socket.on("error", function (error) {
      console.error("Socket error:", error);
      addLog(`âŒ Connection error: ${error}`);
    });
  } catch (error) {
    console.error("WebSocket initialization failed:", error);
    // Don't show error - SSE is the primary method now
  }
}

// Update connection status indicator
function updateConnectionStatus() {
  const statusElement = document.getElementById("connection-status");
  if (!statusElement) return;

  // Show ready state based on SSE support (always available in modern browsers)
  statusElement.innerHTML =
    '<div class="w-2 h-2 bg-green-500 rounded-full"></div>Ready';
  statusElement.className =
    "status-indicator flex items-center gap-2 text-green-600";
}

// Add log message
function addLog(message) {
  // Handle messages that already have timestamps
  let logEntry;
  if (message.startsWith("[")) {
    logEntry = message;
  } else {
    const timestamp = new Date().toLocaleTimeString();
    logEntry = `[${timestamp}] ${message}`;
  }

  logs.push(logEntry);

  // Keep only last 1000 logs
  if (logs.length > 1000) {
    logs = logs.slice(-1000);
  }

  const logDisplay = document.getElementById("log-display");
  if (logDisplay) {
    // Remove placeholder if exists
    const placeholder = logDisplay.querySelector(".log-placeholder");
    if (placeholder) {
      placeholder.remove();
    }

    // Remove "No logs available" message if exists
    const noLogsMsg = logDisplay.querySelector("div.text-gray-500");
    if (noLogsMsg && noLogsMsg.textContent.includes("No logs available")) {
      noLogsMsg.remove();
    }

    const logElement = document.createElement("div");
    logElement.className =
      "log-entry text-sm font-mono mb-1 p-2 rounded hover:bg-gray-800";
    logElement.textContent = logEntry;

    logDisplay.appendChild(logElement);

    // Auto-scroll to bottom if not paused
    if (!isPaused) {
      logDisplay.scrollTop = logDisplay.scrollHeight;
    }
  }
}

// Initialize log controls
function initializeLogControls() {
  // Clear logs button
  const clearLogsBtn = document.getElementById("clear-logs");
  if (clearLogsBtn) {
    clearLogsBtn.addEventListener("click", clearLogs);
  }

  // Pause logs button
  const pauseLogsBtn = document.getElementById("pause-logs");
  if (pauseLogsBtn) {
    pauseLogsBtn.addEventListener("click", togglePause);
  }

  // Stop execution button (if exists)
  const stopBtn = document.getElementById("stop-execution");
  if (stopBtn) {
    stopBtn.addEventListener("click", stopExecution);
  }
}

// Log management functions
function clearLogs() {
  logs = [];

  // Also clear logs on server if we have a run ID
  if (currentRunId) {
    fetch(`/api/static/clear/${currentRunId}`, { method: "POST" }).catch(
      console.error
    );
  }

  const logDisplay = document.getElementById("log-display");
  if (logDisplay) {
    logDisplay.innerHTML =
      '<div class="log-placeholder text-gray-500">Logs cleared. New logs will appear here...</div>';
  }
}

function togglePause() {
  isPaused = !isPaused;
  const pauseBtn = document.getElementById("pause-logs");
  const pauseIcon = document.getElementById("pause-icon");
  const playIcon = document.getElementById("play-icon");
  const pausedIndicator = document.getElementById("paused-indicator");

  if (pauseBtn) {
    if (isPaused) {
      if (pauseIcon) pauseIcon.classList.add("hidden");
      if (playIcon) playIcon.classList.remove("hidden");
    } else {
      if (pauseIcon) pauseIcon.classList.remove("hidden");
      if (playIcon) playIcon.classList.add("hidden");

      // Auto-scroll to bottom when resuming
      const logDisplay = document.getElementById("log-display");
      if (logDisplay) {
        logDisplay.scrollTop = logDisplay.scrollHeight;
      }
    }
  }

  if (pausedIndicator) {
    if (isPaused) {
      pausedIndicator.classList.remove("hidden");
    } else {
      pausedIndicator.classList.add("hidden");
    }
  }
}

// Download Report Button Functions
function enableDownloadButton() {
  const downloadBtn = document.getElementById("download-report-btn");
  const downloadIcon = document.getElementById("download-icon");
  const checkIcon = document.getElementById("check-icon");
  const spinner = document.getElementById("spinner");
  const btnText = document.getElementById("download-btn-text");

  if (downloadBtn) {
    downloadBtn.disabled = false;
    downloadBtn.classList.add("enabled");

    // Hide spinner, show check icon and download icon
    if (spinner) spinner.classList.add("hidden");
    if (checkIcon) checkIcon.classList.remove("hidden");
    if (downloadIcon) downloadIcon.classList.remove("hidden");
    if (btnText) btnText.textContent = "Download Comparison Report";

    // Add click handler
    downloadBtn.onclick = handleDownloadReport;
  }
}

function disableDownloadButton() {
  // Only update download button for Data Comparison tab - DO NOT affect Data Load
  if (currentTab !== "comparison") {
    console.log(
      "[disableDownloadButton] Skipped - not on comparison tab (currentTab=" +
        currentTab +
        ")"
    );
    return;
  }

  const downloadBtn = document.getElementById("download-report-btn");
  const downloadIcon = document.getElementById("download-icon");
  const checkIcon = document.getElementById("check-icon");
  const spinner = document.getElementById("spinner");
  const btnText = document.getElementById("download-btn-text");

  if (downloadBtn) {
    downloadBtn.disabled = true;
    downloadBtn.classList.remove("enabled");

    // Show spinner, hide icons
    if (spinner) spinner.classList.remove("hidden");
    if (downloadIcon) downloadIcon.classList.add("hidden");
    if (checkIcon) checkIcon.classList.add("hidden");
    if (btnText) btnText.textContent = "Waiting for Comparison...";

    downloadBtn.onclick = null;
  }
}

function resetDownloadButton() {
  disableDownloadButton();
  jobComplete = false;
  reportUrl = "";
}

function handleDownloadReport() {
  if (!reportUrl) {
    addLog("âŒ No report available to download");
    return;
  }

  try {
    addLog("ðŸ“¥ Downloading comparison report...");

    // Check if this is a direct download URL from the new single_table endpoint
    if (reportUrl.startsWith("/api/static/comparison/download/")) {
      // Direct download - the browser will handle the file save dialog
      window.location.href = reportUrl;
    } else {
      // Legacy download method
      const link = document.createElement("a");
      link.href = `/api/download-report?path=${encodeURIComponent(reportUrl)}`;
      link.download = "comparison_report.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  } catch (error) {
    console.error("Download error:", error);
    addLog(`âŒ Download failed: ${error.message}`);
  }
}

// ============================================================
// MISMATCH EXPLORER TAB
// ============================================================

// Mismatch Explorer State
let mismatchJobId = null;
let mismatchRunId = null;
let mismatchCurrentPage = 1;
let mismatchPageSize = 50;
let mismatchTotalRecords = 0;
let mismatchTotalPages = 0;
let mismatchShowOnlyMismatched = true;
let mismatchSelectedPk = null;
let mismatchExecutionStatus = "IDLE"; // IDLE, RUNNING, SUCCESS, FAILED

/**
 * Generate the Mismatch Explorer form
 */
function generateMismatchExplorerForm() {
  const formContainer = document.getElementById("mismatch-form");
  if (!formContainer) {
    console.error("Mismatch form container not found");
    return;
  }

  // Filter out "File" from database types
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  formContainer.innerHTML = `
    <!-- Source Configuration -->
    <div class="grid lg:grid-cols-2 gap-6 mb-6">
      <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
        <div class="card-header gradient-header">
          <h3 class="text-wellsfargo-red flex items-center gap-2">
            <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
            Source Configuration
          </h3>
          <p>Configure your source database connection details</p>
        </div>
        <div class="config-content p-6 space-y-4">
          <div class="form-group">
            <label for="mismatchSourceType" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
            <select id="mismatchSourceType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
              <option value="">Select database type</option>
              ${dbTypesNoFile
                .map((type) => `<option value="${type}">${type}</option>`)
                .join("")}
            </select>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
              <label for="mismatchSourceHost" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
              <input type="text" id="mismatchSourceHost" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
            </div>
            
            <div class="form-group">
              <label for="mismatchSourcePort" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
              <input type="text" id="mismatchSourcePort" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
            </div>
          </div>
          
          <div class="form-group">
            <label for="mismatchSourceDatabase" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
            <input type="text" id="mismatchSourceDatabase" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
              <label for="mismatchSourceUsername" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
              <input type="text" id="mismatchSourceUsername" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
            </div>
            
            <div class="form-group">
              <label for="mismatchSourcePassword" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
              <input type="password" id="mismatchSourcePassword" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
            </div>
          </div>
          
          <div class="form-group">
            <label for="mismatchSourceTableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
            <input type="text" id="mismatchSourceTableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter table name" maxlength="255">
          </div>
          
          <div class="form-group">
            <label for="mismatchSourcePrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
            <input type="text" id="mismatchSourcePrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
            <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
          </div>
          
          <div class="form-group">
            <label for="mismatchSourceSqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
            <textarea id="mismatchSourceSqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
          </div>
        </div>
      </div>
      
      <!-- Target Configuration -->
      <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
        <div class="card-header gradient-header">
          <h3 class="text-wellsfargo-red flex items-center gap-2">
            <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
            Target Configuration
          </h3>
          <p>Configure your target database connection details</p>
        </div>
        <div class="config-content p-6 space-y-4">
          <div class="form-group">
            <label for="mismatchTargetType" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
            <select id="mismatchTargetType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
              <option value="">Select database type</option>
              ${dbTypesNoFile
                .map((type) => `<option value="${type}">${type}</option>`)
                .join("")}
            </select>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
              <label for="mismatchTargetHost" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
              <input type="text" id="mismatchTargetHost" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
            </div>
            
            <div class="form-group">
              <label for="mismatchTargetPort" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
              <input type="text" id="mismatchTargetPort" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
            </div>
          </div>
          
          <div class="form-group">
            <label for="mismatchTargetDatabase" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
            <input type="text" id="mismatchTargetDatabase" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
              <label for="mismatchTargetUsername" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
              <input type="text" id="mismatchTargetUsername" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
            </div>
            
            <div class="form-group">
              <label for="mismatchTargetPassword" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
              <input type="password" id="mismatchTargetPassword" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
            </div>
          </div>
          
          <div class="form-group">
            <label for="mismatchTargetTableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
            <input type="text" id="mismatchTargetTableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter table name" maxlength="255">
          </div>
          
          <div class="form-group">
            <label for="mismatchTargetPrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
            <input type="text" id="mismatchTargetPrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
            <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
          </div>
          
          <div class="form-group">
            <label for="mismatchTargetSqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
            <textarea id="mismatchTargetSqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Comparison Rules with Time Zone -->
    <div class="source-target-card border-t-4 border-t-mismatch shadow-elevated mb-6">
      <div class="card-header gradient-header">
        <h3 class="text-mismatch flex items-center gap-2">
          <span class="text-xl">âš™ï¸</span>
          Comparison Rules
        </h3>
        <p>Configure comparison behavior</p>
      </div>
      <div class="config-content p-6">
        <div class="mismatch-rules-grid mb-4">
          <div class="mismatch-rule-item">
            <label>Trim Spaces</label>
            <div class="mismatch-toggle active" id="rule-trim-spaces" onclick="toggleMismatchRule(this)"></div>
          </div>
          <div class="mismatch-rule-item">
            <label>Ignore Case</label>
            <div class="mismatch-toggle" id="rule-ignore-case" onclick="toggleMismatchRule(this)"></div>
          </div>
          <div class="mismatch-rule-item">
            <label>NULL = Empty String</label>
            <div class="mismatch-toggle active" id="rule-null-equals-empty" onclick="toggleMismatchRule(this)"></div>
          </div>
          <div class="mismatch-rule-item">
            <label>Numeric Tolerance</label>
            <input type="number" id="rule-numeric-tolerance" class="form-input" value="0" min="0" step="0.01" style="width: 80px; padding: 0.5rem;">
          </div>
        </div>
        
        <!-- Time Zone field -->
        <div class="form-group mt-4 pt-4 border-t border-gray-200">
          <label for="mismatchTimeZone" class="block text-sm font-medium mb-2">ðŸŒ Time Zone</label>
          <div class="relative">
            <input type="text" 
                   id="mismatchTimeZone" 
                   list="mismatchTimeZoneList"
                   class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-mismatch focus:ring-2 focus:ring-mismatch/20" 
                   placeholder="Select or type a time zone (e.g., America/Phoenix)"
                   value="N/A"
                   maxlength="100">
            <datalist id="mismatchTimeZoneList">
              ${commonTimeZones
                .map(
                  (tz) =>
                    `<option value="${tz}"${
                      tz === "N/A" ? " selected" : ""
                    }>${tz}</option>`
                )
                .join("")}
            </datalist>
          </div>
          <p class="text-sm text-gray-500 mt-1">Select from the list or type an IANA time zone. Leave as "N/A" if not applicable.</p>
        </div>
      </div>
    </div>

    <!-- Unix Server Configuration -->
    ${generateUnixServerSection("mismatch")}

    <!-- Action Buttons -->
    <div class="execute-section text-center p-6 border-t border-gray-200">
      <div class="flex justify-center gap-4 flex-wrap">
        <button type="button" id="mismatch-execute-btn" class="execute-button bg-gradient-to-r from-red-600 to-red-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-red-700 hover:to-red-800 transition-all duration-200 shadow-lg" onclick="executeMismatchExplorerJob()">
          <span class="execute-icon mr-2">â–¶ï¸</span>
          <span id="mismatch-execute-btn-text">Execute</span>
        </button>
        <button type="button" id="mismatch-fetch-btn" class="execute-button bg-gradient-to-r from-teal-600 to-cyan-600 text-white px-8 py-3 rounded-lg font-semibold hover:from-teal-700 hover:to-cyan-700 transition-all duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" onclick="fetchMismatchResults()" disabled>
          <span class="mr-2">ðŸ”</span>
          <span id="mismatch-fetch-btn-text">Fetch & Compare</span>
        </button>
      </div>
    </div>

    <!-- Results Container -->
    <div id="mismatch-results-container" style="display: none;">
      <div class="mismatch-explorer-container">
        <!-- LEFT: Summary Panel -->
        <div class="mismatch-summary-panel">
          <div class="mismatch-panel-header">
            <h4>ðŸ“‹ Summary</h4>
            <span id="mismatch-record-count" class="text-sm text-muted-foreground"></span>
          </div>
          <div class="mismatch-panel-content" id="mismatch-summary-content">
            <div class="mismatch-empty">
              <div class="mismatch-empty-icon">ðŸ“Š</div>
              <p>Run a comparison to see results</p>
            </div>
          </div>
          <div class="mismatch-pagination" id="mismatch-pagination" style="display: none;">
            <div class="mismatch-pagination-info">
              <span id="mismatch-page-info">Page 1 of 1</span>
            </div>
            <div class="mismatch-pagination-controls">
              <button class="pagination-btn" id="mismatch-prev-btn" onclick="mismatchChangePage(-1)" disabled>â€¹</button>
              <span id="mismatch-page-numbers"></span>
              <button class="pagination-btn" id="mismatch-next-btn" onclick="mismatchChangePage(1)">â€º</button>
            </div>
          </div>
        </div>
        
        <!-- RIGHT: Details Panel -->
        <div class="mismatch-details-panel">
          <div class="mismatch-panel-header">
            <h4>ðŸ”Ž Record Details</h4>
            <div class="mismatch-toggle-container" id="mismatch-toggle-container" style="display: none;">
              <label>Show only mismatches</label>
              <div class="mismatch-toggle active" id="toggle-mismatch-only" onclick="toggleShowOnlyMismatched()"></div>
            </div>
          </div>
          <div class="mismatch-panel-content" id="mismatch-details-content">
            <div class="mismatch-empty">
              <div class="mismatch-empty-icon">ðŸ‘†</div>
              <p>Click "View Details" on a record to see field-level comparison</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

/**
 * Toggle comparison rule
 */
function toggleMismatchRule(element) {
  element.classList.toggle("active");
}

/**
 * Toggle showing only mismatched fields
 */
function toggleShowOnlyMismatched() {
  const toggle = document.getElementById("toggle-mismatch-only");
  toggle.classList.toggle("active");
  mismatchShowOnlyMismatched = toggle.classList.contains("active");

  // Re-render details if we have a selected PK
  if (mismatchSelectedPk) {
    loadMismatchDetails(mismatchSelectedPk);
  }
}

/**
 * Collect comparison rules from UI
 */
function collectMismatchRules() {
  return {
    trim_spaces: document
      .getElementById("rule-trim-spaces")
      .classList.contains("active"),
    ignore_case: document
      .getElementById("rule-ignore-case")
      .classList.contains("active"),
    null_equals_empty: document
      .getElementById("rule-null-equals-empty")
      .classList.contains("active"),
    numeric_tolerance:
      parseFloat(document.getElementById("rule-numeric-tolerance").value) || 0,
    time_zone:
      document.getElementById("mismatchTimeZone").value.trim() || "N/A",
  };
}

/**
 * Collect Mismatch Explorer form data
 */
function collectMismatchFormData() {
  return {
    // Source configuration
    mismatchSourceType: document.getElementById("mismatchSourceType").value,
    mismatchSourceHost: document
      .getElementById("mismatchSourceHost")
      .value.trim(),
    mismatchSourcePort: document
      .getElementById("mismatchSourcePort")
      .value.trim(),
    mismatchSourceDatabase: document
      .getElementById("mismatchSourceDatabase")
      .value.trim(),
    mismatchSourceUsername: document
      .getElementById("mismatchSourceUsername")
      .value.trim(),
    mismatchSourcePassword: document.getElementById("mismatchSourcePassword")
      .value,
    mismatchSourceTableName: document
      .getElementById("mismatchSourceTableName")
      .value.trim(),
    mismatchSourcePrimaryKey: document
      .getElementById("mismatchSourcePrimaryKey")
      .value.trim(),
    mismatchSourceSqlQuery: document
      .getElementById("mismatchSourceSqlQuery")
      .value.trim(),

    // Target configuration
    mismatchTargetType: document.getElementById("mismatchTargetType").value,
    mismatchTargetHost: document
      .getElementById("mismatchTargetHost")
      .value.trim(),
    mismatchTargetPort: document
      .getElementById("mismatchTargetPort")
      .value.trim(),
    mismatchTargetDatabase: document
      .getElementById("mismatchTargetDatabase")
      .value.trim(),
    mismatchTargetUsername: document
      .getElementById("mismatchTargetUsername")
      .value.trim(),
    mismatchTargetPassword: document.getElementById("mismatchTargetPassword")
      .value,
    mismatchTargetTableName: document
      .getElementById("mismatchTargetTableName")
      .value.trim(),
    mismatchTargetPrimaryKey: document
      .getElementById("mismatchTargetPrimaryKey")
      .value.trim(),
    mismatchTargetSqlQuery: document
      .getElementById("mismatchTargetSqlQuery")
      .value.trim(),

    // Rules
    rules: collectMismatchRules(),

    // Unix configuration
    mismatchUnixHost: document.getElementById("mismatchUnixHost").value.trim(),
    mismatchUserEmail: document
      .getElementById("mismatchUserEmail")
      .value.trim(),
    mismatchBatchId: document.getElementById("mismatchBatchId").value.trim(),
    mismatchUnixUsername: document
      .getElementById("mismatchUnixUsername")
      .value.trim(),
    mismatchUnixPassword: document.getElementById("mismatchUnixPassword").value,
  };
}

/**
 * Execute Mismatch Explorer job via Paramiko
 */
async function executeMismatchExplorerJob() {
  // Collect form data
  const formData = collectMismatchFormData();

  // Validation
  if (!formData.mismatchUnixHost) {
    alert("Unix Host is required");
    return;
  }
  if (!formData.mismatchUserEmail) {
    alert("User Email is required");
    return;
  }
  if (!formData.mismatchBatchId) {
    alert("Batch ID is required");
    return;
  }
  if (!formData.mismatchUnixUsername || !formData.mismatchUnixPassword) {
    alert("Unix credentials are required");
    return;
  }

  // Update UI to loading state
  const executeBtn = document.getElementById("mismatch-execute-btn");
  const executeBtnText = document.getElementById("mismatch-execute-btn-text");
  const fetchBtn = document.getElementById("mismatch-fetch-btn");

  executeBtn.disabled = true;
  executeBtnText.textContent = "Running...";
  fetchBtn.disabled = true;
  mismatchExecutionStatus = "RUNNING";

  // Clear logs
  clearLogs();
  addLog("ðŸš€ Starting Mismatch Explorer execution...");

  try {
    const response = await fetch("/api/mismatch-explorer/execute", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData),
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || "Failed to start execution");
    }

    mismatchRunId = data.run_id;
    addLog(`ðŸ“‹ Execution started with Run ID: ${mismatchRunId}`);

    // Start SSE log streaming
    startMismatchLogStreaming(mismatchRunId);
  } catch (error) {
    console.error("Mismatch Explorer execution error:", error);
    addLog(`âŒ Execution failed: ${error.message}`);
    mismatchExecutionStatus = "FAILED";
    executeBtn.disabled = false;
    executeBtnText.textContent = "Execute";
  }
}

/**
 * Start SSE log streaming for Mismatch Explorer
 */
function startMismatchLogStreaming(runId) {
  if (eventSource) {
    eventSource.close();
  }

  eventSource = new EventSource(`/api/static/logs/${runId}`);

  eventSource.onmessage = function (event) {
    try {
      const data = JSON.parse(event.data);

      if (data.message) {
        addLog(data.message);
      }

      if (data.status) {
        const executeBtn = document.getElementById("mismatch-execute-btn");
        const executeBtnText = document.getElementById(
          "mismatch-execute-btn-text"
        );
        const fetchBtn = document.getElementById("mismatch-fetch-btn");
        const fetchBtnText = document.getElementById("mismatch-fetch-btn-text");

        if (data.status === "SUCCESS") {
          mismatchExecutionStatus = "SUCCESS";
          addLog("âœ… Execution completed successfully!");
          addLog('ðŸ’¡ Click "Fetch & Compare" to load results.');

          executeBtn.disabled = false;
          executeBtnText.textContent = "Execute";
          fetchBtn.disabled = false;
          fetchBtnText.textContent = "Fetch & Compare";

          eventSource.close();
        } else if (data.status === "FAILED") {
          mismatchExecutionStatus = "FAILED";
          addLog("âŒ Execution failed.");

          executeBtn.disabled = false;
          executeBtnText.textContent = "Execute";
          fetchBtn.disabled = true;

          eventSource.close();
        }
      }
    } catch (e) {
      console.error("Error parsing SSE message:", e);
    }
  };

  eventSource.onerror = function (error) {
    console.error("SSE error:", error);
    eventSource.close();

    const executeBtn = document.getElementById("mismatch-execute-btn");
    const executeBtnText = document.getElementById("mismatch-execute-btn-text");

    executeBtn.disabled = false;
    executeBtnText.textContent = "Execute";
  };
}

/**
 * Fetch mismatch results from Unix /tmp
 */
async function fetchMismatchResults() {
  if (!mismatchRunId) {
    alert("No execution run ID available. Please execute first.");
    return;
  }

  const fetchBtn = document.getElementById("mismatch-fetch-btn");
  const fetchBtnText = document.getElementById("mismatch-fetch-btn-text");

  fetchBtn.disabled = true;
  fetchBtnText.textContent = "Fetching...";
  addLog("ðŸ“¥ Fetching results from Unix...");

  try {
    const response = await fetch(
      `/api/mismatch-explorer/fetch/${mismatchRunId}`
    );
    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || "Failed to fetch results");
    }

    mismatchJobId = data.jobId;
    mismatchCurrentPage = 1;
    mismatchTotalRecords = data.totalRecords;
    mismatchPageSize = 50;

    // Show results container
    document.getElementById("mismatch-results-container").style.display =
      "block";

    // Load summary
    await loadMismatchSummary();

    // Reset details panel
    mismatchSelectedPk = null;
    document.getElementById("mismatch-details-content").innerHTML = `
      <div class="mismatch-empty">
        <div class="mismatch-empty-icon">ðŸ‘†</div>
        <p>Click "View Details" on a record to see field-level comparison</p>
      </div>
    `;
    document.getElementById("mismatch-toggle-container").style.display = "none";

    addLog(`âœ… Results loaded. Found ${data.totalRecords} record(s).`);
  } catch (error) {
    console.error("Fetch results error:", error);
    addLog(`âŒ Failed to fetch results: ${error.message}`);

    document.getElementById("mismatch-summary-content").innerHTML = `
      <div class="mismatch-error">
        âŒ Error: ${error.message}
      </div>
    `;
  } finally {
    fetchBtn.disabled = false;
    fetchBtnText.textContent = "Fetch & Compare";
  }
}

/**
 * Load paginated summary
 */
async function loadMismatchSummary() {
  const contentEl = document.getElementById("mismatch-summary-content");

  // Show loading
  contentEl.innerHTML = `
    <div class="mismatch-loading">
      <div class="mismatch-loading-spinner"></div>
      <p>Loading summary...</p>
    </div>
  `;

  try {
    const response = await fetch(
      `/api/mismatch-explorer/summary?jobId=${mismatchJobId}&page=${mismatchCurrentPage}&pageSize=${mismatchPageSize}`
    );

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || "Failed to load summary");
    }

    mismatchTotalRecords = data.totalRecords;
    mismatchTotalPages = data.totalPages;

    // Update record count
    document.getElementById(
      "mismatch-record-count"
    ).textContent = `${data.totalRecords} record(s)`;

    // Render table
    if (data.rows.length === 0) {
      contentEl.innerHTML = `
        <div class="mismatch-empty">
          <div class="mismatch-empty-icon">ðŸ“­</div>
          <p>No records found</p>
        </div>
      `;
      document.getElementById("mismatch-pagination").style.display = "none";
      return;
    }

    let tableHtml = `
      <table class="mismatch-summary-table">
        <thead>
          <tr>
            <th>Primary Key</th>
            <th>Mismatches</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
    `;

    data.rows.forEach((row) => {
      const statusClass = row.status === "MATCH" ? "match" : "mismatch";
      tableHtml += `
        <tr>
          <td><code>${escapeHtml(row.pkValue)}</code></td>
          <td>${row.mismatchCount}</td>
          <td><span class="status-badge ${statusClass}">${
        row.status
      }</span></td>
          <td>
            <button class="btn-view-details" onclick="loadMismatchDetails('${escapeHtml(
              row.pkValue
            )}')">
              View Details
            </button>
          </td>
        </tr>
      `;
    });

    tableHtml += "</tbody></table>";
    contentEl.innerHTML = tableHtml;

    // Update pagination
    updateMismatchPagination();
  } catch (error) {
    console.error("Load summary error:", error);
    contentEl.innerHTML = `
      <div class="mismatch-error">
        âŒ Error loading summary: ${error.message}
      </div>
    `;
  }
}

/**
 * Update pagination controls
 */
function updateMismatchPagination() {
  const paginationEl = document.getElementById("mismatch-pagination");

  if (mismatchTotalPages <= 1) {
    paginationEl.style.display = "none";
    return;
  }

  paginationEl.style.display = "flex";

  // Update info
  document.getElementById(
    "mismatch-page-info"
  ).textContent = `Page ${mismatchCurrentPage} of ${mismatchTotalPages}`;

  // Update buttons
  document.getElementById("mismatch-prev-btn").disabled =
    mismatchCurrentPage <= 1;
  document.getElementById("mismatch-next-btn").disabled =
    mismatchCurrentPage >= mismatchTotalPages;

  // Generate page numbers (show up to 5 pages)
  let pageNumbersHtml = "";
  const startPage = Math.max(1, mismatchCurrentPage - 2);
  const endPage = Math.min(mismatchTotalPages, startPage + 4);

  for (let i = startPage; i <= endPage; i++) {
    const activeClass = i === mismatchCurrentPage ? "active" : "";
    pageNumbersHtml += `
      <button class="pagination-btn ${activeClass}" onclick="mismatchGoToPage(${i})">${i}</button>
    `;
  }

  document.getElementById("mismatch-page-numbers").innerHTML = pageNumbersHtml;
}

/**
 * Change page
 */
function mismatchChangePage(delta) {
  const newPage = mismatchCurrentPage + delta;
  if (newPage >= 1 && newPage <= mismatchTotalPages) {
    mismatchCurrentPage = newPage;
    loadMismatchSummary();
  }
}

/**
 * Go to specific page
 */
function mismatchGoToPage(page) {
  mismatchCurrentPage = page;
  loadMismatchSummary();
}

/**
 * Load field-level details for a specific PK
 */
async function loadMismatchDetails(pkValue) {
  mismatchSelectedPk = pkValue;
  const contentEl = document.getElementById("mismatch-details-content");

  // Show loading
  contentEl.innerHTML = `
    <div class="mismatch-loading">
      <div class="mismatch-loading-spinner"></div>
      <p>Loading details...</p>
    </div>
  `;

  // Show toggle
  document.getElementById("mismatch-toggle-container").style.display = "flex";

  try {
    const response = await fetch(
      `/api/mismatch-explorer/details?jobId=${mismatchJobId}&pkValue=${encodeURIComponent(
        pkValue
      )}`
    );

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || "Failed to load details");
    }

    renderMismatchDetails(data);
  } catch (error) {
    console.error("Load details error:", error);
    contentEl.innerHTML = `
      <div class="mismatch-error">
        âŒ Error loading details: ${error.message}
      </div>
    `;
  }
}

/**
 * Render field-level details
 */
function renderMismatchDetails(data) {
  const contentEl = document.getElementById("mismatch-details-content");

  // Filter fields if needed
  let fields = data.fields;
  if (mismatchShowOnlyMismatched) {
    fields = fields.filter((f) => f.status === "MISMATCH");
  }

  if (fields.length === 0) {
    contentEl.innerHTML = `
      <div class="mismatch-empty">
        <div class="mismatch-empty-icon">âœ…</div>
        <p>${
          mismatchShowOnlyMismatched
            ? "No mismatched fields"
            : "No fields to display"
        }</p>
      </div>
    `;
    return;
  }

  let html = `
    <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
      <h5 style="margin: 0; color: hsl(var(--color-mismatch-dark));">
        ðŸ”‘ PK = <code>${escapeHtml(data.pkValue)}</code>
      </h5>
      <button class="btn-export-csv" onclick="exportMismatchRecord('${escapeHtml(
        data.pkValue
      )}')">
        ðŸ“¥ Export CSV
      </button>
    </div>
    <table class="mismatch-details-table">
      <thead>
        <tr>
          <th>Field Name</th>
          <th>Source Value</th>
          <th>Target Value</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
  `;

  fields.forEach((field) => {
    const rowClass = field.status === "MISMATCH" ? "mismatch-row" : "";
    const statusClass = field.status === "MATCH" ? "match" : "mismatch";

    html += `
      <tr class="${rowClass}">
        <td><strong>${escapeHtml(field.fieldName)}</strong></td>
        <td><code>${escapeHtml(String(field.sourceValue))}</code></td>
        <td><code>${escapeHtml(String(field.targetValue))}</code></td>
        <td><span class="status-badge ${statusClass}">${
      field.status
    }</span></td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  contentEl.innerHTML = html;
}

/**
 * Export single record comparison as CSV
 */
function exportMismatchRecord(pkValue) {
  if (!mismatchJobId) {
    alert("No active job to export from");
    return;
  }

  // Trigger download
  window.location.href = `/api/mismatch-explorer/export?jobId=${mismatchJobId}&pkValue=${encodeURIComponent(
    pkValue
  )}`;
  addLog(`ðŸ“¥ Exporting comparison for PK: ${pkValue}`);
}

/**
 * HTML escape helper
 */
function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}


### File-compare-function.sh

// File Compare Form Generation and Handling Functions

// Generate file configuration fields
function generateFileConfig(prefix) {
  return `
        <div class="source-target-card border-t-4 border-t-blue-500 shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-blue-700 flex items-center gap-2">
                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    ${
                      prefix.includes("source") || prefix.includes("Source")
                        ? "Source"
                        : "Target"
                    } File Configuration
                </h3>
                <p>Configure your file details for comparison</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}FileType" class="block text-sm font-medium mb-2">ðŸ“„ File Type</label>
                    <select id="${prefix}FileType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                        <option value="">Select file type</option>
                        <option value="CSV">CSV</option>
                        <option value="Excel">Excel</option>
                        <option value="JSON">JSON</option>
                        <option value="Parquet">Parquet</option>
                        <option value="XML">XML</option>
                        <option value="Dat">Dat or txt file with Delimiter</option>
                    </select>
                </div>
                
                <div id="${prefix}DelimiterContainer" class="form-group hidden">
                    <label for="${prefix}Delimiter" class="block text-sm font-medium mb-2">ðŸ“ Delimiter</label>
                    <input type="text" id="${prefix}Delimiter" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Enter delimiter (e.g., comma, pipe, tab)" maxlength="10">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}FileLocation" class="block text-sm font-medium mb-2">ðŸ“ File Location Type</label>
                    <select id="${prefix}FileLocation" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                        <option value="">Select location type</option>
                        <option value="local">Local File</option>
                        <option value="hadoop">Hadoop File</option>
                        <option value="upload">Upload file from system</option>
                    </select>
                </div>
                
                <div id="${prefix}FilePathContainer" class="form-group">
                    <label for="${prefix}FilePath" class="block text-sm font-medium mb-2">ðŸ“‚ File Path</label>
                    <input type="text" id="${prefix}FilePath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Enter full file path" maxlength="500">
                </div>
                
                <div id="${prefix}FileUploadContainer" class="form-group hidden">
                    <label for="${prefix}FileUpload" class="block text-sm font-medium mb-2">ðŸ“¤ Upload File</label>
                    <input type="file" id="${prefix}FileUpload" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}SqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}SqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
                </div>
            </div>
        </div>
    `;
}

// Generate File Compare Form
function generateFileCompareForm() {
  console.log("Generating file compare form...");
  const container = document.getElementById("filecompare-form");
  if (!container) {
    console.error("filecompare-form container not found!");
    return;
  }

  container.innerHTML = `
        <div class="mb-6 p-4 border rounded-lg bg-gray-50">
            <label class="text-base font-semibold mb-3 block">Comparison Type</label>
            <div class="radio-group flex gap-6" id="filecompare-type-selection">
                <div class="flex items-center space-x-2">
                    <input type="radio" name="fileCompareType" value="file-file" id="fileFileType" checked>
                    <label for="fileFileType">File to File</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="radio" name="fileCompareType" value="file-db" id="fileDbType">
                    <label for="fileDbType">File to Database</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="radio" name="fileCompareType" value="db-file" id="dbFileType">
                    <label for="dbFileType">Database to File</label>
                </div>
            </div>
        </div>
        
        <form class="space-y-6" onsubmit="executeFileCompareOperation(event)">
            <div id="filecompare-form-fields">
                <div class="grid lg:grid-cols-2 gap-6">
                    ${generateFileConfig("filecompareSource")}
                    ${generateFileConfig("filecompareTarget")}
                </div>
                
                ${generateUnixServerSection("filecompare")}
            </div>
            
            <div class="execute-section text-center p-6 border-t border-gray-200">
                <button type="submit" class="execute-button bg-gradient-to-r from-blue-600 to-blue-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition-all duration-200 shadow-lg">
                    <span class="execute-icon mr-2">â–¶ï¸</span>
                    Execute File Comparison
                </button>
            </div>
        </form>
    `;

  // Attach event listeners for comparison type selection
  const radioButtons = document.querySelectorAll(
    'input[name="fileCompareType"]'
  );
  radioButtons.forEach((radio) => {
    radio.addEventListener("change", function () {
      handleFileCompareTypeChange(this.value);
    });
  });

  // Attach event listeners for file type changes
  attachFileTypeListeners("filecompareSource");
  attachFileTypeListeners("filecompareTarget");

  // Attach event listeners for file location changes
  attachFileLocationListeners("filecompareSource");
  attachFileLocationListeners("filecompareTarget");

  console.log("File compare form generated");
}

// Handle file compare type change
function handleFileCompareTypeChange(type) {
  console.log("File compare type changed to:", type);
  const formFieldsContainer = document.getElementById(
    "filecompare-form-fields"
  );

  if (!formFieldsContainer) return;

  let sourceContent = "";
  let targetContent = "";

  switch (type) {
    case "file-file":
      sourceContent = generateFileConfig("filecompareSource");
      targetContent = generateFileConfig("filecompareTarget");
      break;
    case "file-db":
      sourceContent = generateFileConfig("filecompareSource");
      targetContent = generateFormFields("filecompareTarget");
      break;
    case "db-file":
      sourceContent = generateFormFields("filecompareSource");
      targetContent = generateFileConfig("filecompareTarget");
      break;
  }

  formFieldsContainer.innerHTML = `
        <div class="grid lg:grid-cols-2 gap-6">
            ${sourceContent}
            ${targetContent}
        </div>
        
        ${generateUnixServerSection("filecompare")}
    `;

  // Re-attach listeners
  if (type === "file-file" || type === "file-db") {
    attachFileTypeListeners("filecompareSource");
    attachFileLocationListeners("filecompareSource");
  } else {
    attachFormListeners("filecompareSource");
  }

  if (type === "file-file" || type === "db-file") {
    attachFileTypeListeners("filecompareTarget");
    attachFileLocationListeners("filecompareTarget");
  } else {
    attachFormListeners("filecompareTarget");
  }
}

// Attach file type listeners
function attachFileTypeListeners(prefix) {
  const fileTypeSelect = document.getElementById(prefix + "FileType");
  if (fileTypeSelect) {
    fileTypeSelect.addEventListener("change", function () {
      handleFileTypeChange(prefix, this.value);
    });
  }
}

// Handle file type change
function handleFileTypeChange(prefix, fileType) {
  const delimiterContainer = document.getElementById(
    prefix + "DelimiterContainer"
  );

  if (!delimiterContainer) return;

  // Show delimiter field for CSV and Dat files
  if (fileType === "CSV" || fileType === "Dat") {
    delimiterContainer.classList.remove("hidden");
  } else {
    delimiterContainer.classList.add("hidden");
  }
}

// Attach file location listeners
function attachFileLocationListeners(prefix) {
  const fileLocationSelect = document.getElementById(prefix + "FileLocation");
  if (fileLocationSelect) {
    fileLocationSelect.addEventListener("change", function () {
      handleFileLocationChange(prefix, this.value);
    });
  }
}

// Handle file location change
function handleFileLocationChange(prefix, locationType) {
  const filePathContainer = document.getElementById(
    prefix + "FilePathContainer"
  );
  const fileUploadContainer = document.getElementById(
    prefix + "FileUploadContainer"
  );
  const filePathInput = document.getElementById(prefix + "FilePath");

  if (!filePathContainer || !fileUploadContainer) return;

  if (locationType === "upload") {
    // Show upload, hide and disable file path
    filePathContainer.classList.add("hidden");
    fileUploadContainer.classList.remove("hidden");
    if (filePathInput) filePathInput.disabled = true;
  } else {
    // Show file path, hide upload
    filePathContainer.classList.remove("hidden");
    fileUploadContainer.classList.add("hidden");
    if (filePathInput) filePathInput.disabled = false;
  }
}

// Execute file compare operation
function executeFileCompareOperation(event) {
  event.preventDefault();
  console.log("Executing file compare operation...");

  const compareType = document.querySelector(
    'input[name="fileCompareType"]:checked'
  ).value;

  // Collect form data based on comparison type
  const formData = {
    compareType: compareType,
    source: collectConfigData("filecompareSource", compareType === "db-file"),
    target: collectConfigData("filecompareTarget", compareType === "file-db"),
    unixServer: {
      host: document.getElementById("filecompareUnixHost")?.value || "",
      port: document.getElementById("filecompareUnixPort")?.value || "22",
      username: document.getElementById("filecompareUnixUsername")?.value || "",
      password: document.getElementById("filecompareUnixPassword")?.value || "",
      keyFile: document.getElementById("filecompareUnixKeyFile")?.value || "",
    },
  };

  console.log("File compare form data:", formData);

  // Submit to backend
  fetch("/api/execute-operation", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      operation: "File Comparison",
      ...formData,
    }),
  })
    .then((response) => response.json())
    .then((data) => {
      console.log("File compare operation response:", data);
      alert(
        data.message || "File comparison operation submitted successfully!"
      );
    })
    .catch((error) => {
      console.error("Error executing file compare operation:", error);
      alert("Error executing file comparison: " + error.message);
    });
}

// Collect configuration data (file or database)
function collectConfigData(prefix, isDatabase) {
  if (isDatabase) {
    // Collect database configuration
    return {
      type: "database",
      dbType: document.getElementById(prefix + "Type")?.value || "",
      host: document.getElementById(prefix + "Host")?.value || "",
      port: document.getElementById(prefix + "Port")?.value || "",
      database: document.getElementById(prefix + "Database")?.value || "",
      username: document.getElementById(prefix + "Username")?.value || "",
      password: document.getElementById(prefix + "Password")?.value || "",
      tableName: document.getElementById(prefix + "TableName")?.value || "",
      primaryKey:
        document.getElementById(prefix + "PrimaryKey")?.value ||
        document.getElementById(prefix + "PrimaryKeyManual")?.value ||
        "",
      sqlQuery: document.getElementById(prefix + "SqlQuery")?.value || "",
    };
  } else {
    // Collect file configuration
    const locationType =
      document.getElementById(prefix + "FileLocation")?.value || "";
    const fileUploadInput = document.getElementById(prefix + "FileUpload");

    return {
      type: "file",
      fileType: document.getElementById(prefix + "FileType")?.value || "",
      delimiter: document.getElementById(prefix + "Delimiter")?.value || "",
      locationType: locationType,
      filePath:
        locationType === "upload"
          ? ""
          : document.getElementById(prefix + "FilePath")?.value || "",
      uploadedFile:
        locationType === "upload" && fileUploadInput?.files[0]
          ? fileUploadInput.files[0].name
          : "",
      sqlQuery: document.getElementById(prefix + "SqlQuery")?.value || "",
    };
  }
}


### Index.html

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wells Fargo Data Management Platform</title>
    <meta name="description" content="Enterprise Data Operations Platform" />
    <meta name="author" content="Wells Fargo" />

    <meta property="og:title" content="Wells Fargo Data Management Platform" />
    <meta
      property="og:description"
      content="Enterprise Data Operations Platform"
    />
    <meta property="og:type" content="website" />

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/additional-styles.css') }}"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
  </head>
  <body>
    <div
      class="min-h-screen bg-gradient-to-br from-background via-background to-primary/5"
    >
      <!-- Header - Wells Fargo exact match -->
      <header style="background-color: #d71e28">
        <div class="container mx-auto" style="padding: 20px 24px">
          <h1
            class="wells-fargo-header-font"
            style="
              font-size: 30px;
              font-weight: 400;
              letter-spacing: 0;
              line-height: 1;
              color: #ffffff;
              margin: 0;
            "
          >
            WELLS FARGO
          </h1>
        </div>
        <div style="height: 4px; background-color: #ffcd41"></div>
      </header>

      <main class="container mx-auto px-6 py-8">
        <div class="mb-6 animate-fade-in">
          <div
            class="relative bg-gradient-to-br from-wellsfargo-red/5 via-background to-wellsfargo-gold/5 rounded-lg p-4 border border-border/50 shadow-md"
          >
            <div class="text-center">
              <h2 class="text-2xl md:text-3xl font-bold text-foreground">
                Data Management
                <span class="text-wellsfargo-red">Operations</span>
              </h2>
            </div>
          </div>
        </div>

        <!-- Tabs - Updated to 6 tabs -->
        <div class="tabs w-full">
          <div
            class="tab-buttons grid w-full grid-cols-6 mb-6 bg-card/80 backdrop-blur-sm border-2 border-border rounded-xl shadow-lg p-2 gap-1.5"
          >
            <button class="tab-button active text-center" data-tab="comparison">
              Data Comparison
            </button>
            <button class="tab-button text-center" data-tab="load">
              Data Load
            </button>
            <button class="tab-button text-center" data-tab="schema">
              Schema Generation
            </button>
            <button class="tab-button text-center" data-tab="fileload">
              File Load
            </button>
            <button class="tab-button text-center" data-tab="filedownload">
              File Download
            </button>
            <button class="tab-button text-center" data-tab="mismatch">
              Mismatch Explorer
            </button>
          </div>

          <!-- Data Comparison Tab -->
          <div
            id="comparison"
            class="tab-content active space-y-6 animate-slide-up"
          >
            <div
              class="card card-elevated border-t-4 border-t-primary shadow-lg hover-shadow-xl transition-all"
              id="comparison-card"
            >
              <div
                class="card-header bg-gradient-to-br from-background via-background to-primary/5"
              >
                <h3
                  class="text-2xl font-bold text-gradient"
                  id="comparison-heading"
                >
                  Data Comparison
                </h3>
                <p class="text-base text-muted-foreground">
                  Compare data between source and target systems to identify
                  discrepancies and ensure data integrity with advanced
                  validation.
                </p>
              </div>
              <div class="card-content">
                <div class="feature-box feature-box-primary">
                  <div class="feature-blur-decoration"></div>
                  <h4
                    class="font-semibold text-primary mb-3 text-lg flex items-center gap-2 relative z-10"
                  >
                    <span class="text-xl">âœ¨</span> Comparison Features
                  </h4>
                  <ul
                    class="text-sm text-muted-foreground space-y-2.5 relative z-10"
                  >
                    <li class="flex items-start gap-2">
                      <span class="text-primary mt-0.5">â€¢</span>
                      <span>Row count validation with detailed metrics</span>
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-primary mt-0.5">â€¢</span>
                      <span>Schema structure comparison and analysis</span>
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-primary mt-0.5">â€¢</span>
                      <span>Data type validation with mismatch detection</span>
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-primary mt-0.5">â€¢</span>
                      <span
                        >Value-level comparison with comprehensive diff
                        reporting</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-primary mt-0.5">â€¢</span>
                      <span
                        >Multi-format support: File-to-File, File-to-Database,
                        Database-to-File</span
                      >
                    </li>
                  </ul>
                </div>

                <!-- Comparison Type Selection -->
                <div
                  class="mb-6 p-6 border-2 border-dashed border-primary/30 rounded-xl bg-gradient-to-br from-card to-primary/5 shadow-sm"
                >
                  <label
                    class="text-lg font-semibold mb-4 block text-foreground flex items-center gap-2"
                  >
                    <span class="text-2xl">ðŸ”„</span> Comparison Type
                  </label>
                  <select
                    id="comparison-type-select"
                    class="form-select w-full p-3 h-12 border-2 border-gray-300 rounded-lg text-base font-medium hover-border-primary transition-colors focus:border-primary focus:ring-2 focus:ring-primary/20"
                  >
                    <option value="">Select comparison type</option>
                    <option value="file-to-file">File to File</option>
                    <option value="file-to-database">File to Database</option>
                    <option value="database-to-file">Database to File</option>
                    <option value="database-to-database">
                      Database to Database
                    </option>
                  </select>
                </div>

                <!-- Table Mode Selection - Only for Database to Database -->
                <div
                  class="mb-6 p-6 border-2 border-dashed border-accent/30 rounded-xl bg-gradient-to-br from-card to-accent/5 shadow-sm animate-scale-in"
                  id="table-mode-selection"
                  style="display: none"
                >
                  <label
                    class="text-lg font-semibold mb-4 block text-foreground flex items-center gap-2"
                  >
                    <span class="text-2xl">ðŸ“Š</span> Table Comparison Mode
                  </label>
                  <div class="radio-group flex gap-8">
                    <div
                      class="flex items-center space-x-3 cursor-pointer group"
                    >
                      <input
                        type="radio"
                        name="tableMode"
                        value="single"
                        id="single"
                        checked
                        class="w-5 h-5"
                      />
                      <label
                        for="single"
                        class="text-base font-medium cursor-pointer group-hover-text-primary transition-colors"
                        >Single Table</label
                      >
                    </div>
                    <div
                      class="flex items-center space-x-3 cursor-pointer group"
                    >
                      <input
                        type="radio"
                        name="tableMode"
                        value="multi"
                        id="multi"
                        class="w-5 h-5"
                      />
                      <label
                        for="multi"
                        class="text-base font-medium cursor-pointer group-hover-text-primary transition-colors"
                        >Multi Table</label
                      >
                    </div>
                  </div>
                </div>

                <!-- Dynamic form will be inserted here -->
                <div id="comparison-form"></div>
              </div>
            </div>
          </div>

          <!-- Data Load Tab -->
          <div id="load" class="tab-content space-y-6 animate-slide-up">
            <div
              class="card card-elevated border-t-4 border-t-load shadow-load hover-shadow-load-xl transition-all"
              id="load-card"
            >
              <div
                class="card-header bg-gradient-to-br from-background via-background to-load/5"
              >
                <h3
                  class="text-2xl font-bold text-gradient-load"
                  id="load-heading"
                >
                  Data Load
                </h3>
                <p class="text-base text-muted-foreground">
                  Transfer and load data from source systems to target
                  destinations with robust error handling and monitoring.
                </p>
              </div>
              <div class="card-content">
                <div class="feature-box feature-box-load">
                  <div class="feature-blur-decoration"></div>
                  <h4
                    class="font-semibold text-load-dark mb-3 text-lg flex items-center gap-2 relative z-10"
                  >
                    <span class="text-2xl">âš¡</span> Load Capabilities
                  </h4>
                  <ul
                    class="text-sm text-muted-foreground space-y-2.5 relative z-10"
                  >
                    <li class="flex items-start gap-2">
                      <span class="text-load mt-0.5 font-bold">âœ“</span>
                      <span
                        >Incremental and full data loads with transaction
                        support</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-load mt-0.5 font-bold">âœ“</span>
                      <span
                        >Batch processing with configurable sizes and parallel
                        execution</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-load mt-0.5 font-bold">âœ“</span>
                      <span
                        >Advanced error logging and automatic recovery
                        mechanisms</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-load mt-0.5 font-bold">âœ“</span>
                      <span
                        >Real-time progress monitoring with detailed
                        statistics</span
                      >
                    </li>
                  </ul>
                </div>
                <div id="load-form"></div>
              </div>
            </div>
          </div>

          <!-- Schema Generation Tab -->
          <div id="schema" class="tab-content space-y-6 animate-slide-up">
            <div
              class="card card-elevated border-t-4 border-t-schema shadow-schema hover-shadow-schema-xl transition-all"
              id="schema-card"
            >
              <div
                class="card-header bg-gradient-to-br from-background via-background to-schema/5"
              >
                <h3
                  class="text-2xl font-bold text-gradient-schema"
                  id="schema-heading"
                >
                  Schema Generation
                </h3>
                <p class="text-base text-muted-foreground">
                  Automatically generate database schemas and DDL scripts based
                  on source system analysis with best practices.
                </p>
              </div>
              <div class="card-content">
                <div class="feature-box feature-box-schema">
                  <div class="feature-blur-decoration"></div>
                  <h4
                    class="font-semibold text-schema-dark mb-3 text-lg flex items-center gap-2 relative z-10"
                  >
                    <span class="text-2xl">ðŸ”§</span> Generation Features
                  </h4>
                  <ul
                    class="text-sm text-muted-foreground space-y-2.5 relative z-10"
                  >
                    <li class="flex items-start gap-2">
                      <span class="text-schema mt-0.5 font-bold">âœ“</span>
                      <span
                        >Automatic DDL script generation with optimized data
                        types</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-schema mt-0.5 font-bold">âœ“</span>
                      <span
                        >Index and constraint creation with performance
                        tuning</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-schema mt-0.5 font-bold">âœ“</span>
                      <span
                        >Intelligent data type mapping and size
                        optimization</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-schema mt-0.5 font-bold">âœ“</span>
                      <span
                        >Schema validation and industry best practices
                        enforcement</span
                      >
                    </li>
                  </ul>
                </div>
                <div id="schema-form"></div>
              </div>
            </div>
          </div>

          <!-- File Load Tab -->
          <div id="fileload" class="tab-content space-y-6 animate-slide-up">
            <div
              class="card card-elevated border-t-4 border-t-fileload shadow-fileload hover-shadow-fileload-xl transition-all"
              id="fileload-card"
            >
              <div
                class="card-header bg-gradient-to-br from-background via-background to-fileload/5"
              >
                <h3
                  class="text-2xl font-bold text-gradient-fileload"
                  id="fileload-heading"
                >
                  File Load
                </h3>
                <p class="text-base text-muted-foreground">
                  Load data from various file formats (CSV, JSON, XML, Parquet)
                  into target database systems with validation.
                </p>
              </div>
              <div class="card-content">
                <div class="feature-box feature-box-fileload">
                  <div class="feature-blur-decoration"></div>
                  <h4
                    class="font-semibold text-fileload-dark mb-3 text-lg flex items-center gap-2 relative z-10"
                  >
                    <span class="text-2xl">ðŸ“</span> Supported Formats
                  </h4>
                  <ul
                    class="text-sm text-muted-foreground space-y-2.5 relative z-10"
                  >
                    <li class="flex items-start gap-2">
                      <span class="text-fileload mt-0.5 font-bold">âœ“</span>
                      <span
                        >CSV with custom delimiters, encoding, and header
                        detection</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-fileload mt-0.5 font-bold">âœ“</span>
                      <span
                        >JSON with nested object support and schema
                        inference</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-fileload mt-0.5 font-bold">âœ“</span>
                      <span>XML with XPath parsing and attribute handling</span>
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-fileload mt-0.5 font-bold">âœ“</span>
                      <span
                        >Parquet with columnar optimization and
                        compression</span
                      >
                    </li>
                  </ul>
                </div>
                <div id="fileload-form"></div>
              </div>
            </div>
          </div>

          <!-- File Download Tab -->
          <div id="filedownload" class="tab-content space-y-6 animate-slide-up">
            <div
              class="card card-elevated border-t-4 border-t-filedownload shadow-filedownload hover-shadow-filedownload-xl transition-all"
              id="filedownload-card"
            >
              <div
                class="card-header bg-gradient-to-br from-background via-background to-filedownload/5"
              >
                <h3
                  class="text-2xl font-bold text-gradient-filedownload"
                  id="filedownload-heading"
                >
                  File Download
                </h3>
                <p class="text-base text-muted-foreground">
                  Download files from remote servers and transfer them to target
                  destinations securely with integrity verification.
                </p>
              </div>
              <div class="card-content">
                <div class="feature-box feature-box-filedownload">
                  <div class="feature-blur-decoration"></div>
                  <h4
                    class="font-semibold text-filedownload-dark mb-3 text-lg flex items-center gap-2 relative z-10"
                  >
                    <span class="text-2xl">ðŸ”’</span> Download Features
                  </h4>
                  <ul
                    class="text-sm text-muted-foreground space-y-2.5 relative z-10"
                  >
                    <li class="flex items-start gap-2">
                      <span class="text-filedownload mt-0.5 font-bold">âœ“</span>
                      <span
                        >Secure file transfer protocols (SFTP, SCP) with
                        encryption</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-filedownload mt-0.5 font-bold">âœ“</span>
                      <span
                        >Batch file download capabilities with parallel
                        transfers</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-filedownload mt-0.5 font-bold">âœ“</span>
                      <span
                        >File integrity verification using checksums and
                        hashing</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-filedownload mt-0.5 font-bold">âœ“</span>
                      <span
                        >Resume interrupted downloads with automatic retry
                        logic</span
                      >
                    </li>
                  </ul>
                </div>
                <div id="filedownload-form"></div>
              </div>
            </div>
          </div>

          <!-- Mismatch Explorer Tab -->
          <div id="mismatch" class="tab-content space-y-6 animate-slide-up">
            <div
              class="card card-elevated border-t-4 border-t-mismatch shadow-mismatch hover-shadow-mismatch-xl transition-all"
              id="mismatch-card"
            >
              <div
                class="card-header bg-gradient-to-br from-background via-background to-mismatch/5"
              >
                <h3
                  class="text-2xl font-bold text-gradient-mismatch"
                  id="mismatch-heading"
                >
                  Mismatch Explorer
                </h3>
                <p class="text-base text-muted-foreground">
                  Fetch data from Source and Target systems, compare records
                  side-by-side with field-level mismatch highlighting.
                </p>
              </div>
              <div class="card-content">
                <div class="feature-box feature-box-mismatch">
                  <div class="feature-blur-decoration"></div>
                  <h4
                    class="font-semibold text-mismatch-dark mb-3 text-lg flex items-center gap-2 relative z-10"
                  >
                    <span class="text-2xl">ðŸ”</span> Explorer Features
                  </h4>
                  <ul
                    class="text-sm text-muted-foreground space-y-2.5 relative z-10"
                  >
                    <li class="flex items-start gap-2">
                      <span class="text-mismatch mt-0.5 font-bold">âœ“</span>
                      <span
                        >Side-by-side record comparison with field-level
                        highlighting</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-mismatch mt-0.5 font-bold">âœ“</span>
                      <span
                        >Support for up to 10,000 records with efficient
                        pagination</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-mismatch mt-0.5 font-bold">âœ“</span>
                      <span
                        >Configurable comparison rules (trim, case, null
                        handling)</span
                      >
                    </li>
                    <li class="flex items-start gap-2">
                      <span class="text-mismatch mt-0.5 font-bold">âœ“</span>
                      <span>Export individual record comparisons to CSV</span>
                    </li>
                  </ul>
                </div>
                <div id="mismatch-form"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Log Display Section -->
        <div class="log-section space-y-6">
          <div
            class="card card-elevated border border-wellsfargo-gold/40 rounded-lg overflow-hidden"
          >
            <div class="card-header pb-3">
              <div class="flex items-center justify-between">
                <h3
                  class="text-lg font-semibold text-wellsfargo-darkred flex items-center gap-2"
                >
                  <div
                    id="connection-status-indicator"
                    class="w-3 h-3 rounded-full bg-red-500"
                  ></div>
                  <span id="log-title">Real-time Logs - Data Comparison</span>
                </h3>
                <div class="flex gap-2">
                  <button id="pause-logs" class="btn-outline">
                    <svg
                      id="pause-icon"
                      class="icon"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M10 9v6m4-6v6"
                      ></path>
                    </svg>
                    <svg
                      id="play-icon"
                      class="icon hidden"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                      ></path>
                    </svg>
                  </button>
                  <button id="clear-logs" class="btn-outline">
                    <svg
                      class="icon"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                      ></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            <div class="card-content">
              <div
                class="h-64 w-full border border-border rounded-md p-4 bg-black text-green-400 font-mono text-sm overflow-y-auto"
              >
                <div id="log-display">
                  <div class="text-gray-500">
                    No logs available. Click 'Connect' to start receiving
                    real-time logs.
                  </div>
                </div>
              </div>
              <div
                id="paused-indicator"
                class="hidden mt-2 text-sm text-yellow-600 flex items-center gap-1"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 9v6m4-6v6"
                  ></path>
                </svg>
                Logs paused - new messages are being buffered
              </div>
            </div>
          </div>
        </div>

        <!-- Schema Generation - Download Button Section (shown after completion) -->
        <div
          id="schema-download-section"
          class="mt-6 flex justify-center hidden"
        >
          <button
            id="schema-download-btn"
            class="schema-download-button group"
            disabled
          >
            <span class="mr-2 text-xl">ðŸ“¥</span>
            <span id="schema-download-btn-text">Download Schema File</span>
          </button>
        </div>

        <!-- File Download - Download Button Section (shown after completion) -->
        <div
          id="filedownload-download-section"
          class="mt-6 flex justify-center hidden"
        >
          <button
            id="filedownload-download-btn"
            class="filedownload-download-button group"
            disabled
          >
            <span class="mr-2 text-xl">ðŸ“¥</span>
            <span id="filedownload-download-btn-text">Download File</span>
          </button>
        </div>

        <!-- Download Report Button Section - ONLY for Data Comparison tab -->
        <div id="download-report-section" class="mt-8 flex justify-center">
          <button
            id="download-report-btn"
            class="download-report-button group"
            disabled
          >
            <div class="btn-overlay"></div>
            <!-- Spinner for loading state -->
            <div id="spinner" class="spinner"></div>
            <!-- Check icon for complete state -->
            <svg
              id="check-icon"
              class="hidden icon animate-scale-in"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <span id="download-btn-text">Waiting for Comparison...</span>
            <!-- Download icon for complete state -->
            <svg
              id="download-icon"
              class="hidden icon group-hover:animate-bounce"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </button>
        </div>
      </main>

      <!-- Footer -->
      <footer
        class="bg-wellsfargo-red text-white py-5 mt-12 shadow-lg border-t-4 border-wellsfargo-gold"
      >
        <div class="container mx-auto px-6 text-center">
          <p class="text-sm font-medium">
            Wells Fargo Data Management Platform Â© 2024 - Secure, Compliant,
            Enterprise-Ready
          </p>
        </div>
      </footer>
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/file-compare-functions.js') }}"></script>
  </body>
</html>


### Style.css

// Global variables
console.log("JavaScript file loaded successfully");
let socket = null;
let isConnected = false;
let isPaused = false;
let logs = [];
let currentTab = "comparison";
let currentTableMode = "single";
let jobComplete = false;
let reportUrl = "";

// SSE Execution State
let currentRunId = null;
let eventSource = null;
let executionStatus = "IDLE"; // IDLE, RUNNING, SUCCESS, FAILED, STOPPED

// Data Load specific UI state (isolated from other tabs)
let dataLoadRunStatus = "IDLE";
let dataLoadButtonLabel = "Execute Data Load";

// Tab name to API tab mapping
const TAB_API_MAP = {
  comparison: "data_comparison",
  load: "data_load",
  schema: "schema_generation",
  fileload: "file_load",
  filedownload: "file_download",
  mismatch: "mismatch_explorer",
};

// Database configurations matching React component
const databaseConfigs = {
  PostgreSQL: {
    hosts: ["localhost", "postgres-server.local", "db.example.com"],
    ports: ["5432", "5433", "5434"],
    usernames: ["postgres", "admin", "dbuser"],
    databases: ["postgres", "myapp_db", "production_db", "staging_db"],
  },
  MySQL: {
    hosts: ["localhost", "mysql-server.local", "db.example.com"],
    ports: ["3306", "3307", "3308"],
    usernames: ["root", "mysql", "admin", "dbuser"],
    databases: ["mysql", "myapp_db", "production_db", "staging_db"],
  },
  Oracle: {
    hosts: ["localhost", "oracle-server.local", "db.example.com"],
    ports: ["1521", "1522", "1523"],
    usernames: ["system", "oracle", "admin", "dbuser"],
    databases: ["XE", "ORCL", "ORCLPDB", "production_db"],
  },
  "SQL Server": {
    hosts: ["localhost", "sqlserver.local", "db.example.com"],
    ports: ["1433", "1434", "1435"],
    usernames: ["sa", "admin", "dbuser"],
    databases: ["master", "myapp_db", "production_db", "staging_db"],
  },
  MongoDB: {
    hosts: ["localhost", "mongo-server.local", "db.example.com"],
    ports: ["27017", "27018", "27019"],
    usernames: ["admin", "root", "mongouser"],
    databases: ["admin", "myapp_db", "production_db", "staging_db"],
  },
  Snowflake: {
    hosts: [
      "account.snowflakecomputing.com",
      "account.us-east-1.snowflakecomputing.com",
    ],
    ports: ["443"],
    usernames: ["admin", "snowflake_user"],
    databases: ["DEMO_DB", "PRODUCTION_DB", "STAGING_DB", "ANALYTICS_DB"],
  },
  Hive: {
    hosts: ["hive-server.local", "hive.example.com", "localhost"],
    ports: ["10000", "10001"],
    usernames: ["hive", "hadoop", "admin"],
    databases: ["default", "warehouse", "staging", "production"],
  },
};

const databaseTypes = [
  "PostgreSQL",
  "MySQL",
  "Oracle",
  "SQL Server",
  "MongoDB",
  "Snowflake",
  "Hive",
  "Teradata",
  "File",
];

// Common IANA time zones for dropdown
const commonTimeZones = [
  "N/A",
  "UTC",
  "America/New_York",
  "America/Chicago",
  "America/Denver",
  "America/Phoenix",
  "America/Los_Angeles",
  "America/Anchorage",
  "Pacific/Honolulu",
  "Europe/London",
  "Europe/Paris",
  "Europe/Berlin",
  "Europe/Moscow",
  "Asia/Dubai",
  "Asia/Kolkata",
  "Asia/Singapore",
  "Asia/Tokyo",
  "Asia/Shanghai",
  "Asia/Hong_Kong",
  "Australia/Sydney",
  "Australia/Melbourne",
  "Pacific/Auckland",
  "Africa/Johannesburg",
  "America/Sao_Paulo",
  "America/Mexico_City",
  "America/Toronto",
  "Europe/Amsterdam",
  "Europe/Zurich",
  "Asia/Seoul",
  "Asia/Jakarta",
];

// Initialize when page loads
document.addEventListener("DOMContentLoaded", function () {
  console.log("Data Management Platform loaded");
  console.log("Starting initialization...");

  // Initialize tab switching
  console.log("Initializing tabs...");
  initializeTabs();

  // Initialize download section visibility for initial tab (comparison is default)
  updateDownloadSectionVisibility(currentTab);

  // Initialize log controls
  console.log("Initializing log controls...");
  initializeLogControls();

  // Initialize table mode selection
  console.log("Initializing table mode selection...");
  initializeTableModeSelection();

  // Generate initial forms
  console.log("Generating comparison form...");
  generateComparisonForm();
  console.log("Generating data load form...");
  generateDataLoadForm();
  console.log("Generating schema generation form...");
  generateSchemaGenerationForm();
  console.log("Generating file load form...");
  generateFileLoadForm();
  console.log("Generating file download form...");
  generateFileDownloadForm();
  console.log("Generating mismatch explorer form...");
  generateMismatchExplorerForm();

  // Initialize WebSocket connection (legacy - kept for backwards compatibility)
  console.log("Initializing WebSocket...");
  initializeWebSocket();

  // Initialize comparison type selection
  console.log("Initializing comparison type selection...");
  initializeComparisonTypeSelection();

  // Update connection status to show ready
  updateConnectionStatus();

  console.log("Initialization complete");
});

// Initialize table mode selection functionality
function initializeTableModeSelection() {
  const radioButtons = document.querySelectorAll('input[name="tableMode"]');
  radioButtons.forEach((radio) => {
    radio.addEventListener("change", function () {
      currentTableMode = this.value;
      console.log("Table mode changed to:", currentTableMode);
      handleTableModeChange(this.value);
    });
  });
}

// Initialize comparison type selection functionality
function initializeComparisonTypeSelection() {
  const comparisonTypeSelect = document.getElementById(
    "comparison-type-select"
  );
  if (comparisonTypeSelect) {
    comparisonTypeSelect.addEventListener("change", function () {
      const selectedType = this.value;
      console.log("Comparison type changed to:", selectedType);
      handleComparisonTypeChange(selectedType);
    });
  }
}

// Handle comparison type changes
function handleComparisonTypeChange(comparisonType) {
  const tableModeSection = document.getElementById("table-mode-selection");
  const comparisonForm = document.getElementById("comparison-form");

  // Show table mode selection only for database-to-database
  if (comparisonType === "database-to-database") {
    tableModeSection.style.display = "block";
  } else {
    tableModeSection.style.display = "none";
  }

  // Regenerate the comparison form based on the selected type
  if (comparisonType) {
    generateComparisonFormByType(comparisonType);
  } else {
    comparisonForm.innerHTML =
      '<p class="text-gray-500 text-center py-4">Please select a comparison type to continue</p>';
  }
}

// Tab switching functionality
function initializeTabs() {
  const tabButtons = document.querySelectorAll(".tab-button");
  const tabContents = document.querySelectorAll(".tab-content");

  console.log("Found tab buttons:", tabButtons.length);
  console.log("Found tab contents:", tabContents.length);

  tabButtons.forEach((button) => {
    console.log("Attaching event to button:", button.dataset.tab);
    button.addEventListener("click", function () {
      const targetTab = this.dataset.tab;
      console.log("Tab clicked:", targetTab);

      // Remove active class from all buttons and contents
      tabButtons.forEach((btn) => btn.classList.remove("active"));
      tabContents.forEach((content) => content.classList.remove("active"));

      // Add active class to clicked button and corresponding content
      this.classList.add("active");
      const targetContent = document.getElementById(targetTab);
      if (targetContent) {
        targetContent.classList.add("active");
        currentTab = targetTab;
        console.log("Tab switched to:", targetTab);

        // Update Real-time Logs title based on active tab
        updateLogTitle(targetTab);

        // Show/hide download button section based on tab
        updateDownloadSectionVisibility(targetTab);
      } else {
        console.error("Target content not found for tab:", targetTab);
      }
    });
  });
}

// Update the Real-time Logs title based on the active tab
function updateLogTitle(tabId) {
  const logTitleElement = document.getElementById("log-title");
  if (!logTitleElement) return;

  // Map tab IDs to display names
  const tabTitles = {
    comparison: "Data Comparison",
    load: "Data Load",
    schema: "Schema Generation",
    fileload: "File Load",
    filedownload: "File Download",
    mismatch: "Mismatch Explorer",
  };

  const tabDisplayName = tabTitles[tabId] || "Data Comparison";
  logTitleElement.textContent = `Real-time Logs - ${tabDisplayName}`;
  console.log("[UI] Log title updated to Real-time Logs - " + tabDisplayName);
}

// Show/hide download sections based on active tab
// Data Comparison download section, File Download download section, Schema Generation download section
function updateDownloadSectionVisibility(tabId) {
  const downloadSection = document.getElementById("download-report-section");
  const fileDownloadSection = document.getElementById(
    "filedownload-download-section"
  );
  const schemaDownloadSection = document.getElementById(
    "schema-download-section"
  );

  // Handle Data Comparison download section
  if (downloadSection) {
    if (tabId === "comparison") {
      downloadSection.classList.remove("hidden");
      console.log("[UI] Download section shown (comparison tab)");
    } else {
      downloadSection.classList.add("hidden");
      console.log("[UI] Download section hidden (tab=" + tabId + ")");
    }
  }

  // Handle File Download download section (only visible on filedownload tab when download is ready)
  if (fileDownloadSection) {
    if (tabId !== "filedownload") {
      // Hide when not on File Download tab
      fileDownloadSection.classList.add("hidden");
    }
    // Note: The section visibility is managed by startFileDownloadLogStreaming on success
  }

  // Handle Schema Generation download section (only visible on schema tab when download is ready)
  if (schemaDownloadSection) {
    if (tabId !== "schema") {
      // Hide when not on Schema Generation tab
      schemaDownloadSection.classList.add("hidden");
    }
    // Note: The section visibility is managed by startSchemaGenerationLogStreaming on success
  }
}

// Generate enhanced dropdown with manual entry option
function generateDropdownWithCustom(
  id,
  options,
  placeholder,
  currentValue = ""
) {
  const hasManualEntry = id.includes("Manual");

  if (hasManualEntry) {
    return `
            <div class="input-with-dropdown">
                <input type="text" 
                       id="${id}" 
                       class="form-input" 
                       placeholder="${placeholder}" 
                       value="${currentValue}"
                       maxlength="1500">
                <button type="button" 
                        class="back-button" 
                        onclick="switchToDropdown('${id}')">
                    â† Back to dropdown
                </button>
            </div>
        `;
  }

  return `
        <select id="${id}" class="form-select">
            <option value="">${placeholder}</option>
            ${options
              .map(
                (option) =>
                  `<option value="${option}" ${
                    option === currentValue ? "selected" : ""
                  }>${option}</option>`
              )
              .join("")}
            <option value="custom">Enter manually...</option>
        </select>
    `;
}

// Handle dropdown to manual switch
function handleDropdownChange(selectId, fieldType) {
  const select = document.getElementById(selectId);
  if (select.value === "custom") {
    const manualId = selectId + "Manual";
    const placeholder = `Enter custom ${fieldType}`;

    select.parentElement.innerHTML = generateDropdownWithCustom(
      manualId,
      [],
      placeholder
    );

    // Focus the new input
    const newInput = document.getElementById(manualId);
    if (newInput) {
      newInput.focus();
    }
  }
}

// Switch back to dropdown from manual entry
function switchToDropdown(manualId) {
  const input = document.getElementById(manualId);
  const baseId = manualId.replace("Manual", "");
  const fieldType = getFieldType(baseId);
  const dbType = getSelectedDatabaseType(baseId);

  let options = [];
  if (dbType && databaseConfigs[dbType]) {
    if (fieldType === "host") options = databaseConfigs[dbType].hosts;
    else if (fieldType === "port") options = databaseConfigs[dbType].ports;
    else if (fieldType === "username")
      options = databaseConfigs[dbType].usernames;
    else if (fieldType === "database")
      options = databaseConfigs[dbType].databases;
  }

  const placeholder = `Select ${fieldType}`;
  input.parentElement.innerHTML = generateDropdownWithCustom(
    baseId,
    options,
    placeholder
  );

  // Re-attach event listener
  const newSelect = document.getElementById(baseId);
  if (newSelect) {
    newSelect.addEventListener("change", function () {
      handleDropdownChange(this.id, fieldType);
    });
  }
}

// Get field type from ID
function getFieldType(id) {
  if (id.includes("Host")) return "host";
  if (id.includes("Port")) return "port";
  if (id.includes("Username")) return "username";
  if (id.includes("Database")) return "database";
  return "";
}

// Get selected database type for a field
function getSelectedDatabaseType(fieldId) {
  const prefix = fieldId.split(/Host|Port|Username|Database/)[0];
  const typeSelectId = prefix + "Type";
  const typeSelect = document.getElementById(typeSelectId);
  return typeSelect ? typeSelect.value : "";
}

// Generate form fields for source or target
function generateFormFields(prefix, isFileTab = false) {
  const isSource = prefix.includes("source") || prefix.includes("Source");
  const cardType = isSource ? "source" : "target";
  const cardTitle = isSource ? "Source Configuration" : "Target Configuration";

  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-red flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
                    ${cardTitle}
                </h3>
                <p>Configure your data ${
                  isSource ? "source" : "target"
                } connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select database type</option>
                        ${databaseTypes
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <div id="${prefix}HostContainer">
                            <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <div id="${prefix}PortContainer">
                            <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <div id="${prefix}DatabaseContainer">
                        <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <div id="${prefix}UsernameContainer">
                            <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                ${
                  !isFileTab
                    ? `
                <div class="form-group">
                    <label for="${prefix}TableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
                    <input type="text" id="${prefix}TableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter table name" maxlength="255">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}PrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
                    <input type="text" id="${prefix}PrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
                    <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}SqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}SqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
                </div>
                `
                    : ""
                }
                
                ${
                  isFileTab
                    ? `
                <div class="form-group">
                    <label for="${prefix}ExcelFile" class="block text-sm font-medium mb-2">ðŸ“ Excel File</label>
                    <input type="file" id="${prefix}ExcelFile" class="form-file w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-red-500 cursor-pointer" accept=".xlsx,.xls,.csv">
                </div>
                `
                    : ""
                }
            </div>
        </div>
    `;
}

// Generate form fields with file upload (for multi-table mode)
function generateFormFieldsWithFileUpload(prefix) {
  const isSource = prefix.includes("source") || prefix.includes("Source");
  const cardType = isSource ? "source" : "target";
  const cardTitle = isSource ? "Source Configuration" : "Target Configuration";
  const fileFieldId = isSource ? "sourceExcelFile" : "targetExcelFile";
  const fileLabel = isSource ? "Source Excel File" : "Target Excel File";
  const fileDescription = isSource
    ? "Upload Excel with source_table_name, source_sql, source_key_columns columns"
    : "Upload Excel with target_table_name, target_sql, target_key_columns columns";

  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-red flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
                    ${cardTitle}
                </h3>
                <p>Configure your data ${
                  isSource ? "source" : "target"
                } connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select database type</option>
                        ${databaseTypes
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <div id="${prefix}HostContainer">
                            <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <div id="${prefix}PortContainer">
                            <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <div id="${prefix}DatabaseContainer">
                        <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <div id="${prefix}UsernameContainer">
                            <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${fileFieldId}" class="block text-sm font-medium mb-2">ðŸ“ ${fileLabel}</label>
                    <input type="file" id="${fileFieldId}" class="form-file w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-red-500 cursor-pointer" accept=".xlsx,.xls">
                    <p class="text-sm text-gray-600 mt-1">${fileDescription}</p>
                </div>
            </div>
        </div>
    `;
}

// Generate Unix server section
function generateUnixServerSection(prefix) {
  return `
        <div class="unix-server-section mb-6">
            <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
                <div class="card-header gradient-header">
                    <h3 class="text-wellsfargo-red flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                        </svg>
                        Unix Server Configuration
                    </h3>
                    <p>Server details for operation execution</p>
                </div>
                <div class="config-content p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="${prefix}UnixHost" class="block text-sm font-medium mb-2">ðŸ–¥ï¸ Unix Host</label>
                            <input type="text" id="${prefix}UnixHost" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Enter Unix server host" maxlength="255">
                        </div>
                        
                        <div class="form-group">
                            <label for="${prefix}UserEmail" class="block text-sm font-medium mb-2">ðŸ“§ User Email <span class="text-red-500">*</span></label>
                            <input type="email" id="${prefix}UserEmail" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Enter email address" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}BatchId" class="block text-sm font-medium mb-2">ðŸ†” Batch ID</label>
                        <input type="text" id="${prefix}BatchId" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Enter Batch ID" maxlength="100">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="${prefix}UnixUsername" class="block text-sm font-medium mb-2">ðŸ‘¤ Unix Username</label>
                            <input type="text" id="${prefix}UnixUsername" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Enter Unix username" maxlength="100">
                        </div>
                        
                        <div class="form-group">
                            <label for="${prefix}UnixPassword" class="block text-sm font-medium mb-2">ðŸ”’ Unix Password</label>
                            <input type="password" id="${prefix}UnixPassword" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Enter Unix password" maxlength="100">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Generate Time Zone field section for comparison forms
function generateTimeZoneSection(prefix) {
  const optionsHtml = commonTimeZones
    .map(
      (tz) =>
        `<option value="${tz}"${tz === "N/A" ? " selected" : ""}>${tz}</option>`
    )
    .join("");

  return `
        <div class="time-zone-section mb-6">
            <div class="source-target-card border-t-4 border-t-wellsfargo-gold shadow-elevated">
                <div class="card-header gradient-header">
                    <h3 class="text-wellsfargo-gold flex items-center gap-2">
                        <span class="text-xl">ðŸ•</span>
                        Time Zone Configuration
                    </h3>
                    <p>Specify time zone for data comparison</p>
                </div>
                <div class="config-content p-6">
                    <div class="form-group">
                        <label for="${prefix}TimeZone" class="block text-sm font-medium mb-2">ðŸŒ Time Zone</label>
                        <div class="relative">
                            <input type="text" 
                                   id="${prefix}TimeZone" 
                                   list="${prefix}TimeZoneList"
                                   class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" 
                                   placeholder="Select or type a time zone (e.g., America/Phoenix)"
                                   value="N/A"
                                   maxlength="100">
                            <datalist id="${prefix}TimeZoneList">
                                ${optionsHtml}
                            </datalist>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">Select from the list or type an IANA time zone. Leave as "N/A" if not applicable.</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Update dropdown options based on database type
function updateDropdownOptions(prefix, dbType) {
  const config = databaseConfigs[dbType];
  if (!config) return;

  // Host, Port, Database Name, Username are now plain text inputs (no dropdowns)
  // Just update placeholder text based on database type for guidance
  const hostInput = document.getElementById(prefix + "Host");
  if (hostInput && config.hosts && config.hosts.length > 0) {
    hostInput.placeholder = `e.g., ${config.hosts[0]}`;
  }

  const portInput = document.getElementById(prefix + "Port");
  if (portInput && config.ports && config.ports.length > 0) {
    portInput.placeholder = config.ports[0];
  }

  const usernameInput = document.getElementById(prefix + "Username");
  if (usernameInput && config.usernames && config.usernames.length > 0) {
    usernameInput.placeholder = `e.g., ${config.usernames[0]}`;
  }

  const databaseInput = document.getElementById(prefix + "Database");
  if (databaseInput && config.databases && config.databases.length > 0) {
    databaseInput.placeholder = `e.g., ${config.databases[0]}`;
  }
}

// Generate Data Comparison form
function generateComparisonForm() {
  console.log("Looking for comparison-form container...");
  const container = document.getElementById("comparison-form");
  if (!container) {
    console.error("comparison-form container not found!");
    return;
  }

  console.log("Found comparison-form container, showing initial message...");
  container.innerHTML =
    '<p class="text-gray-500 text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">ðŸ‘† Please select a comparison type above to continue</p>';
}

// Handle table mode change for Data Comparison
function handleTableModeChange(mode) {
  currentTableMode = mode;
  console.log("Table mode changed to:", mode);

  const container = document.getElementById("comparison-form-fields");
  if (container) {
    // Clear and regenerate form with current table mode
    if (mode === "single") {
      container.innerHTML = `
                <div class="grid lg:grid-cols-2 gap-6">
                    ${generateFormFields("comparisonSource")}
                    ${generateFormFields("comparisonTarget")}
                </div>
                
                ${generateUnixServerSection("comparison")}
            `;
    } else {
      // Multi table mode - show database fields AND file upload option
      container.innerHTML = `
                <div class="grid lg:grid-cols-2 gap-6">
                    ${generateFormFieldsWithFileUpload("comparisonSource")}
                    ${generateFormFieldsWithFileUpload("comparisonTarget")}
                </div>
                
                ${generateUnixServerSection("comparison")}
            `;
    }
    attachFormListeners("comparison");
  }
}

// Generate comparison form based on comparison type
function generateComparisonFormByType(comparisonType) {
  const container = document.getElementById("comparison-form");
  if (!container) return;

  let sourceFields, targetFields;

  // Determine what fields to show for source and target based on comparison type
  switch (comparisonType) {
    case "file-to-file":
      sourceFields = generateFileFields("comparisonSource");
      targetFields = generateFileFields("comparisonTarget");
      break;
    case "file-to-database":
      sourceFields = generateFileFields("comparisonSource");
      targetFields = generateFormFields("comparisonTarget");
      break;
    case "database-to-file":
      sourceFields = generateFormFields("comparisonSource");
      targetFields = generateFileFields("comparisonTarget");
      break;
    case "database-to-database":
      // Use table mode to determine fields
      if (currentTableMode === "single") {
        sourceFields = generateFormFields("comparisonSource");
        targetFields = generateFormFields("comparisonTarget");
      } else {
        sourceFields = generateFormFieldsWithFileUpload("comparisonSource");
        targetFields = generateFormFieldsWithFileUpload("comparisonTarget");
      }
      break;
    default:
      container.innerHTML =
        '<p class="text-gray-500 text-center py-4">Please select a comparison type</p>';
      return;
  }

  container.innerHTML = `
        <form class="space-y-6" onsubmit="executeOperation(event, 'Data Comparison')">
            <div id="comparison-form-fields">
                <div class="grid lg:grid-cols-2 gap-6">
                    ${sourceFields}
                    ${targetFields}
                </div>
                
                ${generateTimeZoneSection("comparison")}
                
                ${generateUnixServerSection("comparison")}
            </div>
            
            <div class="execute-section text-center p-6 border-t border-gray-200">
                <button type="submit" class="execute-button bg-gradient-to-r from-red-600 to-red-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-red-700 hover:to-red-800 transition-all duration-200 shadow-lg">
                    <span class="execute-icon mr-2">â–¶ï¸</span>
                    Execute Data Comparison
                </button>
            </div>
        </form>
    `;

  attachFormListeners("comparison");

  // Attach file field listeners for conditional display
  if (
    comparisonType === "file-to-file" ||
    comparisonType === "file-to-database"
  ) {
    attachFileFieldListeners("comparisonSource");
  }
  if (
    comparisonType === "file-to-file" ||
    comparisonType === "database-to-file"
  ) {
    attachFileFieldListeners("comparisonTarget");
  }

  // Show key columns field for specific comparison types
  showKeyColumnsForComparison(comparisonType);
}

// Generate file configuration fields for source/target
function generateFileFields(prefix) {
  const label = prefix.includes("Source") ? "Source" : "Target";
  const borderColor = prefix.includes("Source")
    ? "border-wellsfargo-red/20"
    : "border-wellsfargo-gold/20";
  const gradientColor = prefix.includes("Source")
    ? "from-wellsfargo-red/10 to-wellsfargo-gold/10"
    : "from-wellsfargo-gold/10 to-wellsfargo-red/10";
  const dotColor = prefix.includes("Source")
    ? "bg-wellsfargo-red"
    : "bg-wellsfargo-gold";
  const titleColor = prefix.includes("Source")
    ? "text-wellsfargo-red"
    : "text-wellsfargo-gold";

  return `
        <div class="card ${borderColor}">
            <div class="card-header bg-gradient-to-r ${gradientColor}">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 ${dotColor} rounded-full"></div>
                    <h4 class="${titleColor}">${label} File Configuration</h4>
                </div>
                <p>Configure your ${label.toLowerCase()} file details</p>
            </div>
            <div class="card-content space-y-4">
                <div class="form-group">
                    <label for="${prefix}FileType" class="block text-sm font-medium mb-2">ðŸ“„ File Type</label>
                    <select id="${prefix}FileType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select file type</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="xml">XML</option>
                        <option value="parquet">Parquet</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}LocationType" class="block text-sm font-medium mb-2">ðŸ“ Location Type</label>
                    <select id="${prefix}LocationType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select location type</option>
                        <option value="unix">File Path (Unix)</option>
                        <option value="hadoop">File Path (Hadoop)</option>
                        <option value="upload">Upload File</option>
                    </select>
                </div>
                
                <div id="${prefix}UnixPathField" class="form-group hidden">
                    <label for="${prefix}UnixPath" class="block text-sm font-medium mb-2">ðŸ“‚ Unix File Path</label>
                    <input type="text" id="${prefix}UnixPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="/path/to/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}HadoopPathField" class="form-group hidden">
                    <label for="${prefix}HadoopPath" class="block text-sm font-medium mb-2">ðŸ“‚ Hadoop File Path</label>
                    <input type="text" id="${prefix}HadoopPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="hdfs:///path/to/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}FileUploadField" class="form-group hidden">
                    <label for="${prefix}FileUpload" class="block text-sm font-medium mb-2">ðŸ“ Upload File</label>
                    <input type="file" id="${prefix}FileUpload" class="form-file w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-red-500 cursor-pointer" accept=".csv,.json,.xml,.parquet,.xlsx,.xls">
                    <p id="${prefix}FileUploadName" class="text-sm text-gray-600 mt-1 hidden"></p>
                </div>
                
                <div id="${prefix}DelimiterField" class="form-group hidden">
                    <label for="${prefix}Delimiter" class="block text-sm font-medium mb-2">âœ‚ï¸ Delimiter</label>
                    <select id="${prefix}Delimiter" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value=",">Comma (,)</option>
                        <option value="|">Pipe (|)</option>
                        <option value="	">Tab</option>
                        <option value=";">Semicolon (;)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}FileSqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}FileSqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" rows="3" placeholder="Enter SQL query to filter file data (optional, default: N/A)"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}KeyColumns" class="block text-sm font-medium mb-2">ðŸ”‘ Key Columns (for matching)</label>
                    <input type="text" id="${prefix}KeyColumns" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="id,customer_id (comma-separated)" maxlength="500">
                </div>
            </div>
        </div>
    `;
}

// Attach file field listeners for conditional display
function attachFileFieldListeners(prefix) {
  const fileTypeSelect = document.getElementById(prefix + "FileType");
  const locationTypeSelect = document.getElementById(prefix + "LocationType");
  const fileUpload = document.getElementById(prefix + "FileUpload");

  if (fileTypeSelect) {
    fileTypeSelect.addEventListener("change", function () {
      const delimiterField = document.getElementById(prefix + "DelimiterField");
      if (this.value === "csv") {
        delimiterField.classList.remove("hidden");
      } else {
        delimiterField.classList.add("hidden");
      }
    });
  }

  if (locationTypeSelect) {
    locationTypeSelect.addEventListener("change", function () {
      const unixPathField = document.getElementById(prefix + "UnixPathField");
      const hadoopPathField = document.getElementById(
        prefix + "HadoopPathField"
      );
      const uploadField = document.getElementById(prefix + "FileUploadField");

      // Hide all path fields first
      unixPathField.classList.add("hidden");
      hadoopPathField.classList.add("hidden");
      uploadField.classList.add("hidden");

      if (this.value === "unix") {
        unixPathField.classList.remove("hidden");
      } else if (this.value === "hadoop") {
        hadoopPathField.classList.remove("hidden");
      } else if (this.value === "upload") {
        uploadField.classList.remove("hidden");
      }
    });
  }

  if (fileUpload) {
    fileUpload.addEventListener("change", function () {
      const fileName = document.getElementById(prefix + "FileUploadName");
      if (this.files && this.files[0]) {
        fileName.textContent = `Selected: ${this.files[0].name}`;
        fileName.classList.remove("hidden");
      } else {
        fileName.classList.add("hidden");
      }
    });
  }
}

// Show key columns field for specific comparison types
function showKeyColumnsForComparison(comparisonType) {
  // Key columns are shown for all comparison types that involve files
  // This is already handled in generateFileFields
}

// Generate Data Load form - DB-to-DB only
function generateDataLoadForm() {
  const container = document.getElementById("load-form");
  if (!container) return;

  container.innerHTML = `
        <form class="space-y-6" onsubmit="executeOperation(event, 'Data Load')">
            <!-- Header: Database to Database Load -->
            <div class="mb-6 p-4 border-2 border-dashed border-load/30 rounded-xl bg-gradient-to-br from-card to-load/5 shadow-sm">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ðŸ—„ï¸</span>
                    <span class="text-lg font-semibold text-foreground">Database to Database Load</span>
                </div>
                <p class="text-sm text-gray-500 mt-1">Load data from source database to target database</p>
            </div>
            
            <div id="load-form-fields">
                <div class="grid lg:grid-cols-2 gap-6">
                    ${generateDataLoadSourceFields("loadSource")}
                    ${generateDataLoadTargetFields("loadTarget")}
                </div>
            </div>
            
            ${generateTimeZoneSection("load")}
            
            ${generateUnixServerSection("load")}
            
            <div class="execute-section text-center p-6 border-t border-gray-200">
                <!-- Data Load Status Display -->
                <div id="dataload-status-container" class="mb-4 hidden">
                    <span id="dataload-status-text" class="text-lg font-semibold"></span>
                </div>
                <button type="submit" id="dataload-run-btn" class="execute-button bg-gradient-to-r from-red-600 to-red-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-red-700 hover:to-red-800 transition-all duration-200 shadow-lg">
                    <span class="execute-icon mr-2">â–¶ï¸</span>
                    <span id="dataload-btn-text">Execute Data Load</span>
                </button>
            </div>
        </form>
    `;

  // Attach event listeners
  attachFormListeners("load");
  attachDataLoadTargetListeners();
}

// Generate Data Load SOURCE fields (database only, no load type)
function generateDataLoadSourceFields(prefix) {
  // Filter out "File" from database types for Data Load
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-red flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
                    Source Configuration
                </h3>
                <p>Configure your source database connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select database type</option>
                        ${dbTypesNoFile
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}TableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
                    <input type="text" id="${prefix}TableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter table name" maxlength="255">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}PrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
                    <input type="text" id="${prefix}PrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
                    <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}SqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}SqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
                </div>
            </div>
        </div>
    `;
}

// Generate Data Load TARGET fields (with Load Type + Hive-specific fields)
function generateDataLoadTargetFields(prefix) {
  // Filter out "File" from database types for Data Load
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-red flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
                    Target Configuration
                </h3>
                <p>Configure your target database connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select database type</option>
                        ${dbTypesNoFile
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}TableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
                    <input type="text" id="${prefix}TableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter table name" maxlength="255">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}PrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
                    <input type="text" id="${prefix}PrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
                    <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}SqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}SqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
                </div>
                
                <!-- Load Type (Target only) -->
                <div class="form-group">
                    <label for="${prefix}LoadType" class="block text-sm font-medium mb-2">âš¡ Load Type</label>
                    <select id="${prefix}LoadType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
                        <option value="">Select load type</option>
                        <option value="overwrite">Overwrite</option>
                        <option value="append">Append</option>
                    </select>
                </div>
                
                <!-- Hive-specific fields (hidden by default) -->
                <div id="${prefix}HiveFields" class="hidden space-y-4 p-4 border-2 border-dashed border-yellow-400 rounded-lg bg-yellow-50">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ</span>
                        <span class="text-sm font-semibold text-yellow-700">Hive-Specific Configuration</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}HadoopPath" class="block text-sm font-medium mb-2">ðŸ“‚ Hadoop Path <span class="text-red-500">*</span></label>
                        <input type="text" id="${prefix}HadoopPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="/user/hive/warehouse/..." maxlength="1000">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}PartitionId" class="block text-sm font-medium mb-2">ðŸ”– Partition ID</label>
                        <input type="text" id="${prefix}PartitionId" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="e.g., year=2024/month=01 (leave empty for N/A)" maxlength="500">
                        <p class="text-sm text-gray-500 mt-1">Leave empty to default to "N/A"</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Attach Data Load target-specific listeners (for Hive fields toggle)
function attachDataLoadTargetListeners() {
  const targetTypeSelect = document.getElementById("loadTargetType");

  if (targetTypeSelect) {
    targetTypeSelect.addEventListener("change", function () {
      const hiveFields = document.getElementById("loadTargetHiveFields");

      if (this.value === "Hive") {
        if (hiveFields) hiveFields.classList.remove("hidden");
      } else {
        if (hiveFields) hiveFields.classList.add("hidden");
      }
    });
  }
}

// Generate file fields for Data Load
function generateFileFieldsForLoad(prefix) {
  return `
        <div class="source-target-card border-t-4 border-t-load shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-load flex items-center gap-2">
                    <div class="w-3 h-3 bg-load rounded-full"></div>
                    Source File Configuration
                </h3>
                <p>Configure your source file details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}FileType" class="block text-sm font-medium mb-2">ðŸ“„ File Type</label>
                    <select id="${prefix}FileType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg">
                        <option value="">Select file type</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="xml">XML</option>
                        <option value="parquet">Parquet</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}LocationType" class="block text-sm font-medium mb-2">ðŸ“ Location Type</label>
                    <select id="${prefix}LocationType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg">
                        <option value="">Select location type</option>
                        <option value="path">File Path (Server)</option>
                        <option value="upload">Upload File</option>
                    </select>
                </div>
                
                <div id="${prefix}FilePathField" class="form-group hidden">
                    <label for="${prefix}FilePath" class="block text-sm font-medium mb-2">ðŸ“‚ File Path</label>
                    <input type="text" id="${prefix}FilePath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg" placeholder="/path/to/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}FileUploadField" class="form-group hidden">
                    <label for="${prefix}FileUpload" class="block text-sm font-medium mb-2">ðŸ“ Upload File</label>
                    <input type="file" id="${prefix}FileUpload" class="form-file w-full p-3 border-2 border-dashed border-gray-300 rounded-lg" accept=".csv,.json,.xml,.parquet,.xlsx,.xls">
                    <p id="${prefix}FileUploadName" class="text-sm text-gray-600 mt-1 hidden"></p>
                </div>
            </div>
        </div>
    `;
}

// Attach load file field listeners
function attachLoadFileFieldListeners() {
  const locationTypeSelect = document.getElementById("loadSourceLocationType");
  const fileUpload = document.getElementById("loadSourceFileUpload");

  if (locationTypeSelect) {
    locationTypeSelect.addEventListener("change", function () {
      const pathField = document.getElementById("loadSourceFilePathField");
      const uploadField = document.getElementById("loadSourceFileUploadField");

      if (this.value === "path") {
        pathField.classList.remove("hidden");
        uploadField.classList.add("hidden");
      } else if (this.value === "upload") {
        pathField.classList.add("hidden");
        uploadField.classList.remove("hidden");
      } else {
        pathField.classList.add("hidden");
        uploadField.classList.add("hidden");
      }
    });
  }

  if (fileUpload) {
    fileUpload.addEventListener("change", function () {
      const fileName = document.getElementById("loadSourceFileUploadName");
      if (this.files && this.files[0]) {
        fileName.textContent = `Selected: ${this.files[0].name}`;
        fileName.classList.remove("hidden");
      } else {
        fileName.classList.add("hidden");
      }
    });
  }
}

// Generate Schema Generation form
function generateSchemaGenerationForm() {
  const container = document.getElementById("schema-form");
  if (!container) return;

  container.innerHTML = `
        <form class="space-y-6" onsubmit="executeSchemaGenerationOperation(event)">
            <div class="grid lg:grid-cols-2 gap-6">
                ${generateSchemaGenerationSourceFields("schemaSource")}
                ${generateSchemaGenerationTargetFields("schemaTarget")}
            </div>
            
            ${generateUnixServerSection("schema")}
            
            <div class="execute-section text-center p-6 border-t border-gray-200">
                <button type="submit" id="schema-run-btn" class="execute-button bg-gradient-to-r from-red-600 to-red-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-red-700 hover:to-red-800 transition-all duration-200 shadow-lg">
                    <span class="execute-icon mr-2">â–¶ï¸</span>
                    <span id="schema-btn-text">Execute Schema Generation</span>
                </button>
            </div>
        </form>
    `;

  // Attach event listeners for schema mode toggle
  attachSchemaGenerationListeners();
}

// Generate Schema Generation SOURCE fields (database with Schema Mode)
function generateSchemaGenerationSourceFields(prefix) {
  // Filter out "File" from database types
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  return `
        <div class="source-target-card border-t-4 border-t-schema shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-schema flex items-center gap-2">
                    <div class="w-3 h-3 bg-schema rounded-full"></div>
                    Source Configuration
                </h3>
                <p>Configure your source database connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                        <option value="">Select database type</option>
                        ${dbTypesNoFile
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="localhost" maxlength="1500">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="5432" maxlength="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="Enter database name" maxlength="255">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="Enter username" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <!-- Schema Mode dropdown -->
                <div class="form-group">
                    <label for="${prefix}SchemaMode" class="block text-sm font-medium mb-2">ðŸ“Š Schema Mode <span class="text-red-500">*</span></label>
                    <select id="${prefix}SchemaMode" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                        <option value="">Select schema mode</option>
                        <option value="single">Single</option>
                        <option value="multiple">Multiple</option>
                    </select>
                </div>
                
                <!-- Single Mode: Table Name field -->
                <div id="${prefix}SingleModeFields" class="hidden">
                    <div class="form-group">
                        <label for="${prefix}TableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name <span class="text-red-500">*</span></label>
                        <input type="text" id="${prefix}TableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="Enter table name" maxlength="255">
                    </div>
                </div>
                
                <!-- Multiple Mode: File Upload field -->
                <div id="${prefix}MultipleModeFields" class="hidden">
                    <div class="form-group">
                        <label for="${prefix}TableListFile" class="block text-sm font-medium mb-2">ðŸ“ Upload Table List File <span class="text-red-500">*</span></label>
                        <input type="file" id="${prefix}TableListFile" class="form-file w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-purple-500 cursor-pointer" accept=".txt,.csv,.xlsx,.xls">
                        <p id="${prefix}TableListFileName" class="text-sm text-gray-600 mt-1 hidden"></p>
                        <p class="text-sm text-gray-500 mt-1">Upload a file containing list of table names (txt, csv, or excel)</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Generate Schema Generation TARGET fields (database with Output File Name)
function generateSchemaGenerationTargetFields(prefix) {
  // Filter out "File" from database types
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-red flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
                    Target Configuration
                </h3>
                <p>Configure your target database connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select database type</option>
                        ${dbTypesNoFile
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <!-- Output File Name (mandatory) -->
                <div class="form-group">
                    <label for="${prefix}OutputFileName" class="block text-sm font-medium mb-2">ðŸ“„ Output File Name <span class="text-red-500">*</span></label>
                    <input type="text" id="${prefix}OutputFileName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="schema_output.sql" maxlength="255">
                    <p class="text-sm text-gray-500 mt-1">Name of the generated schema file for download</p>
                </div>
            </div>
        </div>
    `;
}

// Attach Schema Generation specific listeners
function attachSchemaGenerationListeners() {
  const schemaModeSelect = document.getElementById("schemaSourceSchemaMode");
  const tableListFile = document.getElementById("schemaSourceTableListFile");

  if (schemaModeSelect) {
    schemaModeSelect.addEventListener("change", function () {
      const singleModeFields = document.getElementById(
        "schemaSourceSingleModeFields"
      );
      const multipleModeFields = document.getElementById(
        "schemaSourceMultipleModeFields"
      );

      if (this.value === "single") {
        singleModeFields.classList.remove("hidden");
        multipleModeFields.classList.add("hidden");
      } else if (this.value === "multiple") {
        singleModeFields.classList.add("hidden");
        multipleModeFields.classList.remove("hidden");
      } else {
        singleModeFields.classList.add("hidden");
        multipleModeFields.classList.add("hidden");
      }
    });
  }

  if (tableListFile) {
    tableListFile.addEventListener("change", function () {
      const fileName = document.getElementById("schemaSourceTableListFileName");
      if (this.files && this.files[0]) {
        fileName.textContent = `Selected: ${this.files[0].name}`;
        fileName.classList.remove("hidden");
      } else {
        fileName.classList.add("hidden");
      }
    });
  }
}

// Execute Schema Generation operation (handles file upload for multiple mode)
async function executeSchemaGenerationOperation(event) {
  event.preventDefault();

  const button = document.getElementById("schema-run-btn");
  const schemaMode = document.getElementById("schemaSourceSchemaMode")?.value;
  const outputFileName = document
    .getElementById("schemaTargetOutputFileName")
    ?.value?.trim();

  // Validate required fields
  if (!schemaMode) {
    addLog("âŒ Error: Schema Mode is required");
    alert("Please select a Schema Mode (Single or Multiple)");
    return;
  }

  if (!outputFileName) {
    addLog("âŒ Error: Output File Name is required");
    alert("Please enter an Output File Name");
    return;
  }

  // Validate based on schema mode
  if (schemaMode === "single") {
    const tableName = document
      .getElementById("schemaSourceTableName")
      ?.value?.trim();
    if (!tableName) {
      addLog("âŒ Error: Table Name is required for Single mode");
      alert("Please enter a Table Name");
      return;
    }
  } else if (schemaMode === "multiple") {
    const tableListFile = document.getElementById("schemaSourceTableListFile");
    if (!tableListFile || !tableListFile.files || !tableListFile.files[0]) {
      addLog("âŒ Error: Table List File is required for Multiple mode");
      alert("Please upload a Table List File");
      return;
    }
  }

  try {
    setButtonLoadingState(button, "Schema Generation", true);
    addLog("ðŸš€ Starting Schema Generation...");

    const apiTab = "schema_generation";
    const formData = collectFormData("schema");

    // Add schema-specific fields
    formData.schema_mode = schemaMode;
    formData.output_file_name = outputFileName;

    let response;

    if (schemaMode === "multiple") {
      // Use FormData for file upload
      const tableListFile = document.getElementById(
        "schemaSourceTableListFile"
      );
      const multiFormData = new FormData();

      multiFormData.append("tab", apiTab);
      multiFormData.append("schema_mode", schemaMode);
      multiFormData.append("output_file_name", outputFileName);
      multiFormData.append("table_list_file", tableListFile.files[0]);

      // Append all other form fields
      Object.keys(formData).forEach((key) => {
        if (
          formData[key] !== null &&
          formData[key] !== undefined &&
          key !== "schemaSourceTableListFile"
        ) {
          multiFormData.append(key, formData[key]);
        }
      });

      addLog(`ðŸ“Š Uploading Table List File: ${tableListFile.files[0].name}`);
      addLog(`ðŸ“Š Using /api/static/schema/run-with-upload endpoint`);

      response = await fetch("/api/static/schema/run-with-upload", {
        method: "POST",
        body: multiFormData,
      });
    } else {
      // Standard JSON request for single mode
      response = await fetch("/api/static/run", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          tab: apiTab,
          params: formData,
        }),
      });
    }

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || "Schema Generation operation failed");
    }

    const result = await response.json();
    currentRunId = result.run_id;
    executionStatus = "RUNNING";

    addLog(`ðŸ“‹ Run ID: ${currentRunId}`);

    // Start SSE log streaming with schema-specific handler
    startSchemaGenerationLogStreaming(currentRunId, button);
  } catch (error) {
    console.error("Error executing Schema Generation:", error);
    addLog(`âŒ Error: ${error.message}`);
    executionStatus = "IDLE";
    setButtonLoadingState(button, "Schema Generation", false);
  }
}

// Start Schema Generation specific log streaming (with download handling)
function startSchemaGenerationLogStreaming(runId, button) {
  if (eventSource) {
    eventSource.close();
  }

  eventSource = new EventSource(`/api/static/logs/${runId}`);

  eventSource.onmessage = function (event) {
    try {
      const data = JSON.parse(event.data);

      switch (data.type) {
        case "log":
          addLog(data.message);
          break;

        case "status":
          executionStatus = data.status;
          updateExecutionStatusUI(data.status);
          break;

        case "end":
          eventSource.close();
          eventSource = null;
          executionStatus = data.status || "IDLE";
          setButtonLoadingState(button, "Schema Generation", false);

          if (data.status === "SUCCESS") {
            addLog("âœ… Schema Generation completed successfully!");

            // Enable download button
            const downloadSection = document.getElementById(
              "schema-download-section"
            );
            const downloadBtn = document.getElementById("schema-download-btn");

            if (downloadSection && downloadBtn) {
              downloadSection.classList.remove("hidden");
              downloadBtn.disabled = false;
              downloadBtn.onclick = function () {
                handleSchemaDownload(runId);
              };
              addLog(
                "ðŸ“¥ Download ready! Click the Download button below the logs."
              );
            }
          }
          break;

        case "error":
          addLog(`âŒ ${data.message}`);
          eventSource.close();
          eventSource = null;
          executionStatus = "FAILED";
          setButtonLoadingState(button, "Schema Generation", false);
          break;
      }
    } catch (e) {
      console.error("Error parsing SSE data:", e);
    }
  };

  eventSource.onerror = function (error) {
    console.error("SSE error:", error);
    addLog("âŒ Connection to server lost");
    eventSource.close();
    eventSource = null;
    executionStatus = "FAILED";
    setButtonLoadingState(button, "Schema Generation", false);
  };
}

// Handle Schema Generation download
function handleSchemaDownload(runId) {
  const outputFileName =
    document.getElementById("schemaTargetOutputFileName")?.value?.trim() ||
    "schema_output.sql";

  addLog(`ðŸ“¥ Downloading ${outputFileName}...`);

  const downloadUrl = `/api/static/schema/download/${runId}`;

  fetch(downloadUrl)
    .then((response) => {
      if (!response.ok) {
        throw new Error("Download failed");
      }
      return response.blob();
    })
    .then((blob) => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = outputFileName;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      addLog(`âœ… Downloaded: ${outputFileName}`);
    })
    .catch((error) => {
      console.error("Download error:", error);
      addLog(`âŒ Download failed: ${error.message}`);
    });
}

// Generate File Load form - File-to-Database only
function generateFileLoadForm() {
  const container = document.getElementById("fileload-form");
  if (!container) return;

  container.innerHTML = `
        <form class="space-y-6" onsubmit="executeOperation(event, 'File Load')">
            <!-- Header: File to Database Load -->
            <div class="mb-6 p-4 border-2 border-dashed border-fileload/30 rounded-xl bg-gradient-to-br from-card to-fileload/5 shadow-sm">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ðŸ“</span>
                    <span class="text-lg font-semibold text-foreground">File to Database Load</span>
                </div>
                <p class="text-sm text-gray-500 mt-1">Load data from file to target database</p>
            </div>
            
            <div id="fileload-form-fields">
                <div class="grid lg:grid-cols-2 gap-6">
                    ${generateFileLoadSourceFields("fileloadSource")}
                    ${generateFileLoadTargetFields("fileloadTarget")}
                </div>
            </div>
            
            ${generateTimeZoneSection("fileload")}
            
            ${generateUnixServerSection("fileload")}
            
            <div class="execute-section text-center p-6 border-t border-gray-200">
                <!-- File Load Status Display -->
                <div id="fileload-status-container" class="mb-4 hidden">
                    <span id="fileload-status-text" class="text-lg font-semibold"></span>
                </div>
                <button type="submit" id="fileload-run-btn" class="execute-button bg-gradient-to-r from-red-600 to-red-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-red-700 hover:to-red-800 transition-all duration-200 shadow-lg">
                    <span class="execute-icon mr-2">â–¶ï¸</span>
                    <span id="fileload-btn-text">Execute File Load</span>
                </button>
            </div>
        </form>
    `;

  // Attach event listeners for file fields and target Hive fields
  attachFileLoadSourceListeners();
  attachFileLoadTargetListeners();
  console.log("[FileLoad] Form generated with File-to-Database configuration");
}

// Generate File Load SOURCE fields (file-based, matching Data Comparison file-to-db)
function generateFileLoadSourceFields(prefix) {
  return `
        <div class="source-target-card border-t-4 border-t-fileload shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-fileload flex items-center gap-2">
                    <div class="w-3 h-3 bg-fileload rounded-full"></div>
                    Source File Configuration
                </h3>
                <p>Configure your source file details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}FileType" class="block text-sm font-medium mb-2">ðŸ“„ File Type</label>
                    <select id="${prefix}FileType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
                        <option value="">Select file type</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="xml">XML</option>
                        <option value="parquet">Parquet</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}LocationType" class="block text-sm font-medium mb-2">ðŸ“ Location Type</label>
                    <select id="${prefix}LocationType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
                        <option value="">Select location type</option>
                        <option value="unix">File Path (Unix)</option>
                        <option value="hadoop">File Path (Hadoop)</option>
                        <option value="upload">Upload File</option>
                    </select>
                </div>
                
                <div id="${prefix}UnixPathField" class="form-group hidden">
                    <label for="${prefix}UnixPath" class="block text-sm font-medium mb-2">ðŸ“‚ Unix File Path</label>
                    <input type="text" id="${prefix}UnixPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="/path/to/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}HadoopPathField" class="form-group hidden">
                    <label for="${prefix}HadoopPath" class="block text-sm font-medium mb-2">ðŸ“‚ Hadoop File Path</label>
                    <input type="text" id="${prefix}HadoopPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="hdfs:///path/to/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}FileUploadField" class="form-group hidden">
                    <label for="${prefix}FileUpload" class="block text-sm font-medium mb-2">ðŸ“ Upload File</label>
                    <input type="file" id="${prefix}FileUpload" class="form-file w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-orange-500 cursor-pointer" accept=".csv,.json,.xml,.parquet,.xlsx,.xls">
                    <p id="${prefix}FileUploadName" class="text-sm text-gray-600 mt-1 hidden"></p>
                </div>
                
                <div id="${prefix}DelimiterField" class="form-group hidden">
                    <label for="${prefix}Delimiter" class="block text-sm font-medium mb-2">âœ‚ï¸ Delimiter</label>
                    <select id="${prefix}Delimiter" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
                        <option value=",">Comma (,)</option>
                        <option value="|">Pipe (|)</option>
                        <option value="	">Tab</option>
                        <option value=";">Semicolon (;)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}FileSqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}FileSqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" rows="3" placeholder="Enter SQL query to filter file data (optional, default: N/A)"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}KeyColumns" class="block text-sm font-medium mb-2">ðŸ”‘ Key Columns</label>
                    <input type="text" id="${prefix}KeyColumns" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="id,customer_id (comma-separated)" maxlength="500">
                </div>
            </div>
        </div>
    `;
}

// Generate File Load TARGET fields (database, matching Data Load target)
function generateFileLoadTargetFields(prefix) {
  // Filter out "File" from database types for target
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-red flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
                    Target Configuration
                </h3>
                <p>Configure your target database connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
                        <option value="">Select database type</option>
                        ${dbTypesNoFile
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}TableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
                    <input type="text" id="${prefix}TableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter table name" maxlength="255">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}PrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
                    <input type="text" id="${prefix}PrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
                    <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}SqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}SqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
                </div>
                
                <!-- Load Type (Target only) -->
                <div class="form-group">
                    <label for="${prefix}LoadType" class="block text-sm font-medium mb-2">âš¡ Load Type</label>
                    <select id="${prefix}LoadType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
                        <option value="">Select load type</option>
                        <option value="overwrite">Overwrite</option>
                        <option value="append">Append</option>
                    </select>
                </div>
                
                <!-- Hive-specific fields (hidden by default) -->
                <div id="${prefix}HiveFields" class="hidden space-y-4 p-4 border-2 border-dashed border-yellow-400 rounded-lg bg-yellow-50">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ</span>
                        <span class="text-sm font-semibold text-yellow-700">Hive-Specific Configuration</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}HadoopPath" class="block text-sm font-medium mb-2">ðŸ“‚ Hadoop Path <span class="text-red-500">*</span></label>
                        <input type="text" id="${prefix}HadoopPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="/user/hive/warehouse/..." maxlength="1000">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}PartitionId" class="block text-sm font-medium mb-2">ðŸ”– Partition ID</label>
                        <input type="text" id="${prefix}PartitionId" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="e.g., year=2024/month=01 (leave empty for N/A)" maxlength="500">
                        <p class="text-sm text-gray-500 mt-1">Leave empty to default to "N/A"</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Attach File Load source field listeners (file type, location type, etc.)
function attachFileLoadSourceListeners() {
  const fileTypeSelect = document.getElementById("fileloadSourceFileType");
  const locationTypeSelect = document.getElementById(
    "fileloadSourceLocationType"
  );
  const fileUpload = document.getElementById("fileloadSourceFileUpload");

  if (fileTypeSelect) {
    fileTypeSelect.addEventListener("change", function () {
      const delimiterField = document.getElementById(
        "fileloadSourceDelimiterField"
      );
      if (this.value === "csv") {
        delimiterField.classList.remove("hidden");
        console.log("[FileLoad] Delimiter field shown for CSV");
      } else {
        delimiterField.classList.add("hidden");
      }
    });
  }

  if (locationTypeSelect) {
    locationTypeSelect.addEventListener("change", function () {
      const unixPathField = document.getElementById(
        "fileloadSourceUnixPathField"
      );
      const hadoopPathField = document.getElementById(
        "fileloadSourceHadoopPathField"
      );
      const uploadField = document.getElementById(
        "fileloadSourceFileUploadField"
      );

      // Hide all path fields first
      unixPathField.classList.add("hidden");
      hadoopPathField.classList.add("hidden");
      uploadField.classList.add("hidden");

      if (this.value === "unix") {
        unixPathField.classList.remove("hidden");
        console.log("[FileLoad] Unix path field shown");
      } else if (this.value === "hadoop") {
        hadoopPathField.classList.remove("hidden");
        console.log("[FileLoad] Hadoop path field shown");
      } else if (this.value === "upload") {
        uploadField.classList.remove("hidden");
        console.log("[FileLoad] File upload field shown");
      }
    });
  }

  if (fileUpload) {
    fileUpload.addEventListener("change", function () {
      const fileName = document.getElementById("fileloadSourceFileUploadName");
      if (this.files && this.files[0]) {
        fileName.textContent = `Selected: ${this.files[0].name}`;
        fileName.classList.remove("hidden");
      } else {
        fileName.classList.add("hidden");
      }
    });
  }
}

// Attach File Load target field listeners (for Hive fields toggle)
function attachFileLoadTargetListeners() {
  const targetTypeSelect = document.getElementById("fileloadTargetType");

  if (targetTypeSelect) {
    targetTypeSelect.addEventListener("change", function () {
      const hiveFields = document.getElementById("fileloadTargetHiveFields");

      if (this.value === "Hive") {
        if (hiveFields) {
          hiveFields.classList.remove("hidden");
          console.log("[FileLoad] Hive-specific fields shown");
        }
      } else {
        if (hiveFields) {
          hiveFields.classList.add("hidden");
        }
      }
    });
  }
}

// Generate File Download form
function generateFileDownloadForm() {
  const container = document.getElementById("filedownload-form");
  if (!container) return;

  container.innerHTML = `
        <!-- Source Type Selection -->
        <div class="mb-6 p-6 border-2 border-dashed border-primary/30 rounded-xl bg-gradient-to-br from-card to-primary/5 shadow-sm">
            <label class="text-lg font-semibold mb-4 block text-foreground flex items-center gap-2">
                <span class="text-2xl">ðŸ“¥</span> Source Type
            </label>
            <select id="filedownload-source-type-select" class="form-select w-full p-3 h-12 border-2 border-gray-300 rounded-lg text-base font-medium hover-border-primary transition-colors focus:border-primary focus:ring-2 focus:ring-primary/20">
                <option value="">Select source type</option>
                <option value="file">File</option>
                <option value="database">Database</option>
            </select>
        </div>
        
        <form id="filedownload-main-form" class="space-y-6" onsubmit="executeFileDownloadOperation(event)">
            <div id="filedownload-form-fields">
                <p class="text-gray-500 text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">ðŸ‘† Please select a source type above to continue</p>
            </div>
        </form>
    `;

  // Attach source type selection listener
  const sourceTypeSelect = document.getElementById(
    "filedownload-source-type-select"
  );
  if (sourceTypeSelect) {
    sourceTypeSelect.addEventListener("change", function () {
      handleFileDownloadSourceTypeChange(this.value);
    });
  }
}

// Handle source type change for File Download
function handleFileDownloadSourceTypeChange(sourceType) {
  const formFieldsContainer = document.getElementById(
    "filedownload-form-fields"
  );
  if (!formFieldsContainer) return;

  if (!sourceType) {
    formFieldsContainer.innerHTML =
      '<p class="text-gray-500 text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">ðŸ‘† Please select a source type above to continue</p>';
    return;
  }

  let sourceContent = "";

  if (sourceType === "file") {
    sourceContent = generateFileDownloadSourceFileFields("filedownloadSource");
  } else if (sourceType === "database") {
    sourceContent =
      generateFileDownloadSourceDatabaseFields("filedownloadSource");
  }

  formFieldsContainer.innerHTML = `
        <div class="grid lg:grid-cols-2 gap-6">
            ${sourceContent}
            ${generateFileDownloadTargetFields("filedownloadTarget")}
        </div>
        
        ${generateUnixServerSection("filedownload")}
        
        <div class="execute-section text-center p-6 border-t border-gray-200">
            <!-- File Download Status Display -->
            <div id="filedownload-status-container" class="mb-4 hidden">
                <span id="filedownload-status-text" class="text-lg font-semibold"></span>
            </div>
            <button type="submit" id="filedownload-run-btn" class="execute-button bg-gradient-to-r from-teal-600 to-teal-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-teal-700 hover:to-teal-800 transition-all duration-200 shadow-lg">
                <span class="execute-icon mr-2">â–¶ï¸</span>
                <span id="filedownload-btn-text">Execute File Download</span>
            </button>
        </div>
    `;

  // Attach appropriate listeners based on source type
  if (sourceType === "file") {
    attachFileDownloadSourceFileListeners();
  } else if (sourceType === "database") {
    attachFormListeners("filedownload");
  }

  // Attach target file type listener for delimiter toggle
  attachFileDownloadTargetListeners();
}

// Generate FILE source fields for File Download (matching Data Comparison file behavior)
function generateFileDownloadSourceFileFields(prefix) {
  return `
        <div class="source-target-card border-t-4 border-t-filedownload shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-filedownload-dark flex items-center gap-2">
                    <div class="w-3 h-3 bg-filedownload rounded-full"></div>
                    Source File Configuration
                </h3>
                <p>Configure your source file details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}FileType" class="block text-sm font-medium mb-2">ðŸ“„ File Type</label>
                    <select id="${prefix}FileType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200">
                        <option value="">Select file type</option>
                        <option value="CSV">CSV</option>
                        <option value="TSV">TSV</option>
                        <option value="Excel">Excel</option>
                        <option value="JSON">JSON</option>
                        <option value="Parquet">Parquet</option>
                        <option value="XML">XML</option>
                        <option value="Dat">Dat or txt file with Delimiter</option>
                    </select>
                </div>
                
                <div id="${prefix}DelimiterField" class="form-group hidden">
                    <label for="${prefix}Delimiter" class="block text-sm font-medium mb-2">ðŸ“ Delimiter</label>
                    <input type="text" id="${prefix}Delimiter" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter delimiter (e.g., comma, pipe, tab)" maxlength="10">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}LocationType" class="block text-sm font-medium mb-2">ðŸ“ Location Type</label>
                    <select id="${prefix}LocationType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200">
                        <option value="">Select location type</option>
                        <option value="unix">File Path (Unix)</option>
                        <option value="hadoop">File Path (Hadoop)</option>
                        <option value="upload">Upload from local</option>
                    </select>
                </div>
                
                <div id="${prefix}UnixPathField" class="form-group hidden">
                    <label for="${prefix}UnixPath" class="block text-sm font-medium mb-2">ðŸ“‚ Unix File Path</label>
                    <input type="text" id="${prefix}UnixPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="/path/to/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}HadoopPathField" class="form-group hidden">
                    <label for="${prefix}HadoopPath" class="block text-sm font-medium mb-2">ðŸ“‚ Hadoop File Path</label>
                    <input type="text" id="${prefix}HadoopPath" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="/user/hadoop/file.csv" maxlength="1000">
                </div>
                
                <div id="${prefix}LocalUploadField" class="form-group hidden">
                    <label for="${prefix}LocalFile" class="block text-sm font-medium mb-2">ðŸ“¤ Upload Local File <span class="text-red-500">*</span></label>
                    <input type="file" id="${prefix}LocalFile" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                    <p class="text-sm text-gray-500 mt-1">Select a file from your local system to upload</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}KeyColumns" class="block text-sm font-medium mb-2">ðŸ”‘ Key Columns</label>
                    <input type="text" id="${prefix}KeyColumns" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
                    <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}SqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}SqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
                </div>
            </div>
        </div>
    `;
}

// Generate DATABASE source fields for File Download (matching Data Comparison DB behavior)
function generateFileDownloadSourceDatabaseFields(prefix) {
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  return `
        <div class="source-target-card border-t-4 border-t-filedownload shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-filedownload-dark flex items-center gap-2">
                    <div class="w-3 h-3 bg-filedownload rounded-full"></div>
                    Source Database Configuration
                </h3>
                <p>Configure your source database connection details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}Type" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
                    <select id="${prefix}Type" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200">
                        <option value="">Select database type</option>
                        ${dbTypesNoFile
                          .map(
                            (type) => `<option value="${type}">${type}</option>`
                          )
                          .join("")}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Host" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
                        <input type="text" id="${prefix}Host" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="localhost" maxlength="1500">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Port" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
                        <input type="text" id="${prefix}Port" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="5432" maxlength="10">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}Database" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
                    <input type="text" id="${prefix}Database" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter database name" maxlength="255">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="${prefix}Username" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
                        <input type="text" id="${prefix}Username" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter username" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="${prefix}Password" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
                        <input type="password" id="${prefix}Password" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter password" maxlength="100">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}TableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
                    <input type="text" id="${prefix}TableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter table name" maxlength="255">
                </div>
                
                <div class="form-group">
                    <label for="${prefix}PrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
                    <input type="text" id="${prefix}PrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
                    <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}SqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
                    <textarea id="${prefix}SqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
                </div>
            </div>
        </div>
    `;
}

// Generate TARGET file fields for File Download (always file output)
function generateFileDownloadTargetFields(prefix) {
  return `
        <div class="source-target-card border-t-4 border-t-wellsfargo-gold shadow-elevated">
            <div class="card-header gradient-header">
                <h3 class="text-wellsfargo-gold flex items-center gap-2">
                    <div class="w-3 h-3 bg-wellsfargo-gold rounded-full"></div>
                    Target File Configuration
                </h3>
                <p>Configure your output file details</p>
            </div>
            <div class="config-content p-6 space-y-4">
                <div class="form-group">
                    <label for="${prefix}FileType" class="block text-sm font-medium mb-2">ðŸ“„ Target File Type</label>
                    <select id="${prefix}FileType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200">
                        <option value="">Select file type</option>
                        <option value="CSV">CSV</option>
                        <option value="TSV">TSV</option>
                        <option value="JSON">JSON</option>
                        <option value="Parquet">Parquet</option>
                        <option value="XML">XML</option>
                        <option value="Excel">Excel (XLSX)</option>
                    </select>
                </div>
                
                <div id="${prefix}DelimiterField" class="form-group hidden">
                    <label for="${prefix}Delimiter" class="block text-sm font-medium mb-2">ðŸ“ Delimiter <span class="text-red-500">*</span></label>
                    <input type="text" id="${prefix}Delimiter" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="Enter delimiter (e.g., , or | or \\t)" value="," maxlength="10">
                    <p class="text-sm text-gray-500 mt-1">Required for CSV/TSV formats</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}FileName" class="block text-sm font-medium mb-2">ðŸ“ Target File Name <span class="text-red-500">*</span></label>
                    <input type="text" id="${prefix}FileName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="e.g., output_data.csv" maxlength="255" required>
                    <p class="text-sm text-gray-500 mt-1">This will be the downloaded file name</p>
                </div>
                
                <div class="form-group">
                    <label for="${prefix}NumberOfRows" class="block text-sm font-medium mb-2">ðŸ”¢ Number of Rows</label>
                    <input type="number" id="${prefix}NumberOfRows" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200" placeholder="Enter number of rows (max 100000)" min="1" max="100000">
                    <p class="text-sm text-gray-500 mt-1">Maximum allowed: 100,000 rows. Leave empty for default.</p>
                </div>
            </div>
        </div>
    `;
}

// Attach listeners for File Download source file fields
function attachFileDownloadSourceFileListeners() {
  const fileTypeSelect = document.getElementById("filedownloadSourceFileType");
  const locationTypeSelect = document.getElementById(
    "filedownloadSourceLocationType"
  );

  if (fileTypeSelect) {
    fileTypeSelect.addEventListener("change", function () {
      const delimiterField = document.getElementById(
        "filedownloadSourceDelimiterField"
      );
      if (
        this.value === "CSV" ||
        this.value === "TSV" ||
        this.value === "Dat"
      ) {
        if (delimiterField) delimiterField.classList.remove("hidden");
      } else {
        if (delimiterField) delimiterField.classList.add("hidden");
      }
    });
  }

  if (locationTypeSelect) {
    locationTypeSelect.addEventListener("change", function () {
      const unixPathField = document.getElementById(
        "filedownloadSourceUnixPathField"
      );
      const hadoopPathField = document.getElementById(
        "filedownloadSourceHadoopPathField"
      );
      const localUploadField = document.getElementById(
        "filedownloadSourceLocalUploadField"
      );

      // Hide all path fields first
      if (unixPathField) unixPathField.classList.add("hidden");
      if (hadoopPathField) hadoopPathField.classList.add("hidden");
      if (localUploadField) localUploadField.classList.add("hidden");

      if (this.value === "unix") {
        if (unixPathField) unixPathField.classList.remove("hidden");
      } else if (this.value === "hadoop") {
        if (hadoopPathField) hadoopPathField.classList.remove("hidden");
      } else if (this.value === "upload") {
        if (localUploadField) localUploadField.classList.remove("hidden");
      }
    });
  }
}

// Attach listeners for File Download target fields
function attachFileDownloadTargetListeners() {
  const targetFileTypeSelect = document.getElementById(
    "filedownloadTargetFileType"
  );

  if (targetFileTypeSelect) {
    targetFileTypeSelect.addEventListener("change", function () {
      const delimiterField = document.getElementById(
        "filedownloadTargetDelimiterField"
      );
      if (this.value === "CSV" || this.value === "TSV") {
        if (delimiterField) delimiterField.classList.remove("hidden");
      } else {
        if (delimiterField) delimiterField.classList.add("hidden");
      }
    });
  }
}

// File Download execution state
let fileDownloadRunId = null;
let fileDownloadStatus = "IDLE";
let fileDownloadUrl = "";

// Execute File Download operation
async function executeFileDownloadOperation(event) {
  if (event) {
    event.preventDefault();
  }

  console.log("[FileDownload] Executing File Download operation");

  const button = document.getElementById("filedownload-run-btn");
  const downloadSection = document.getElementById(
    "filedownload-download-section"
  );
  const downloadBtn = document.getElementById("filedownload-download-btn");

  // Hide download button at start
  if (downloadSection) downloadSection.classList.add("hidden");
  if (downloadBtn) downloadBtn.disabled = true;

  // Check if already running
  if (fileDownloadStatus === "RUNNING") {
    addLog("âš ï¸ File Download operation is already running. Please wait.");
    return;
  }

  // Validate required fields
  const sourceType = document.getElementById(
    "filedownload-source-type-select"
  )?.value;
  if (!sourceType) {
    addLog("âŒ Please select a source type (File or Database)");
    return;
  }

  // Validate Target File Name (mandatory)
  const targetFileName = document
    .getElementById("filedownloadTargetFileName")
    ?.value?.trim();
  if (!targetFileName) {
    addLog("âŒ Target File Name is required");
    return;
  }

  // Validate Number of Rows (max 100000)
  const numberOfRowsInput = document.getElementById(
    "filedownloadTargetNumberOfRows"
  );
  const numberOfRows = numberOfRowsInput?.value
    ? parseInt(numberOfRowsInput.value, 10)
    : null;

  if (numberOfRows !== null && numberOfRows > 100000) {
    addLog("âŒ Number of Rows cannot exceed 100,000");
    return;
  }

  if (numberOfRows !== null && (isNaN(numberOfRows) || numberOfRows < 1)) {
    addLog("âŒ Number of Rows must be a positive number");
    return;
  }

  // Validate local file upload if location type is "upload"
  const locationType = document.getElementById(
    "filedownloadSourceLocationType"
  )?.value;
  if (sourceType === "file" && locationType === "upload") {
    const localFileInput = document.getElementById(
      "filedownloadSourceLocalFile"
    );
    if (!localFileInput || !localFileInput.files || !localFileInput.files[0]) {
      addLog("âŒ Please select a local file to upload");
      return;
    }
  }

  // Validate User Email
  const userEmail = document
    .getElementById("filedownloadUserEmail")
    ?.value?.trim();
  if (!isValidEmail(userEmail)) {
    if (!userEmail) {
      addLog("âŒ User Email is required for execution");
    } else {
      addLog("âŒ Please enter a valid email address");
    }
    return;
  }

  // Show loading state on button
  setButtonLoadingState(button, "File Download", true);
  fileDownloadStatus = "RUNNING";

  try {
    // Collect form data
    const formData = collectFileDownloadFormData(sourceType);

    // Add required fields
    formData.source_type = sourceType;
    formData.target_file_name = targetFileName;
    if (numberOfRows !== null) {
      formData.number_of_rows = numberOfRows;
    }

    addLog(`ðŸš€ Starting File Download...`);
    addLog(`ðŸ“ Source Type: ${sourceType}`);
    addLog(`ðŸ“„ Target File Name: ${targetFileName}`);
    if (numberOfRows) addLog(`ðŸ”¢ Number of Rows: ${numberOfRows}`);

    let response;

    // Check if local file upload is needed
    const locationType = document.getElementById(
      "filedownloadSourceLocationType"
    )?.value;
    if (sourceType === "file" && locationType === "upload") {
      // Use multipart/form-data for file upload
      const localFileInput = document.getElementById(
        "filedownloadSourceLocalFile"
      );
      const localFile = localFileInput.files[0];

      addLog(
        `ðŸ“¤ Uploading local file: ${localFile.name} (${(
          localFile.size / 1024
        ).toFixed(2)} KB)`
      );

      const uploadFormData = new FormData();
      uploadFormData.append("tab", "file_download");
      uploadFormData.append("source_type", sourceType);
      uploadFormData.append("source_location_type", "upload");
      uploadFormData.append("source_local_file", localFile);
      uploadFormData.append("target_file_name", targetFileName);
      if (numberOfRows !== null) {
        uploadFormData.append("number_of_rows", numberOfRows);
      }

      // Append all other form fields
      Object.keys(formData).forEach((key) => {
        if (formData[key] !== null && formData[key] !== undefined) {
          uploadFormData.append(key, formData[key]);
        }
      });

      response = await fetch("/api/static/filedownload/run-with-upload", {
        method: "POST",
        body: uploadFormData,
      });
    } else {
      // Standard JSON request
      response = await fetch("/api/static/run", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          tab: "file_download",
          params: formData,
        }),
      });
    }

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || "File Download operation failed");
    }

    const result = await response.json();
    fileDownloadRunId = result.run_id;

    addLog(`ðŸ“‹ Run ID: ${fileDownloadRunId}`);

    // Start SSE log streaming for File Download
    startFileDownloadLogStreaming(fileDownloadRunId, button, targetFileName);
  } catch (error) {
    console.error("Error executing File Download:", error);
    addLog(`âŒ Error: ${error.message}`);
    fileDownloadStatus = "IDLE";
    setButtonLoadingState(button, "File Download", false);
  }
}

// Start SSE log streaming for File Download
function startFileDownloadLogStreaming(runId, button, targetFileName) {
  const eventSrc = new EventSource(`/api/static/logs/${runId}`);

  eventSrc.onmessage = function (event) {
    try {
      const data = JSON.parse(event.data);

      switch (data.type) {
        case "log":
          addLog(data.message);
          break;

        case "status":
          fileDownloadStatus = data.status;
          break;

        case "end":
          eventSrc.close();
          fileDownloadStatus = data.status || "IDLE";
          setButtonLoadingState(button, "File Download", false);

          if (data.status === "SUCCESS") {
            addLog("âœ… File Download completed successfully!");

            // Show download button (in the log section, after the log box)
            const downloadSection = document.getElementById(
              "filedownload-download-section"
            );
            const downloadBtn = document.getElementById(
              "filedownload-download-btn"
            );
            const downloadBtnText = document.getElementById(
              "filedownload-download-btn-text"
            );

            if (downloadSection) downloadSection.classList.remove("hidden");
            if (downloadBtn) {
              downloadBtn.disabled = false;
              downloadBtn.onclick = function () {
                handleFileDownloadDownload(runId, targetFileName);
              };
            }
            if (downloadBtnText)
              downloadBtnText.textContent = `Download ${targetFileName}`;

            // Store download URL
            fileDownloadUrl = `/api/static/filedownload/download/${runId}`;
            addLog(
              `ðŸ“¥ Click "Download ${targetFileName}" button below the logs to save the file.`
            );
          }
          break;

        case "error":
          addLog(`âŒ ${data.message}`);
          eventSrc.close();
          fileDownloadStatus = "FAILED";
          setButtonLoadingState(button, "File Download", false);
          break;
      }
    } catch (e) {
      console.error("Error parsing SSE data:", e);
    }
  };

  eventSrc.onerror = function (error) {
    console.error("SSE error:", error);
    addLog("âŒ Connection to server lost");
    eventSrc.close();
    fileDownloadStatus = "FAILED";
    setButtonLoadingState(button, "File Download", false);
  };
}

// Collect form data for File Download
function collectFileDownloadFormData(sourceType) {
  const data = {};

  // Source fields based on source type
  if (sourceType === "file") {
    data.filedownloadSourceFileType =
      document.getElementById("filedownloadSourceFileType")?.value || "";
    data.filedownloadSourceDelimiter =
      document.getElementById("filedownloadSourceDelimiter")?.value || "";
    data.filedownloadSourceLocationType =
      document.getElementById("filedownloadSourceLocationType")?.value || "";
    data.filedownloadSourceUnixPath =
      document.getElementById("filedownloadSourceUnixPath")?.value || "";
    data.filedownloadSourceHadoopPath =
      document.getElementById("filedownloadSourceHadoopPath")?.value || "";
    data.filedownloadSourceKeyColumns =
      document.getElementById("filedownloadSourceKeyColumns")?.value || "";
    data.filedownloadSourceSqlQuery =
      document.getElementById("filedownloadSourceSqlQuery")?.value || "";
    // Note: Local file is handled separately via FormData in executeFileDownloadOperation
  } else if (sourceType === "database") {
    data.filedownloadSourceType =
      document.getElementById("filedownloadSourceType")?.value || "";
    data.filedownloadSourceHost =
      document.getElementById("filedownloadSourceHost")?.value || "";
    data.filedownloadSourcePort =
      document.getElementById("filedownloadSourcePort")?.value || "";
    data.filedownloadSourceDatabase =
      document.getElementById("filedownloadSourceDatabase")?.value || "";
    data.filedownloadSourceUsername =
      document.getElementById("filedownloadSourceUsername")?.value || "";
    data.filedownloadSourcePassword =
      document.getElementById("filedownloadSourcePassword")?.value || "";
    data.filedownloadSourceTableName =
      document.getElementById("filedownloadSourceTableName")?.value || "";
    data.filedownloadSourcePrimaryKey =
      document.getElementById("filedownloadSourcePrimaryKey")?.value || "";
    data.filedownloadSourceSqlQuery =
      document.getElementById("filedownloadSourceSqlQuery")?.value || "";
  }

  // Target file fields
  data.filedownloadTargetFileType =
    document.getElementById("filedownloadTargetFileType")?.value || "";
  data.filedownloadTargetDelimiter =
    document.getElementById("filedownloadTargetDelimiter")?.value || "";
  data.filedownloadTargetFileName =
    document.getElementById("filedownloadTargetFileName")?.value || "";
  data.filedownloadTargetNumberOfRows =
    document.getElementById("filedownloadTargetNumberOfRows")?.value || "";

  // Unix server fields
  data.filedownloadUnixHost =
    document.getElementById("filedownloadUnixHost")?.value || "";
  data.filedownloadUserEmail =
    document.getElementById("filedownloadUserEmail")?.value || "";
  data.filedownloadBatchId =
    document.getElementById("filedownloadBatchId")?.value || "";
  data.filedownloadUnixUsername =
    document.getElementById("filedownloadUnixUsername")?.value || "";
  data.filedownloadUnixPassword =
    document.getElementById("filedownloadUnixPassword")?.value || "";

  return data;
}

// Handle File Download download button click
function handleFileDownloadDownload(runId, targetFileName) {
  if (!runId) {
    addLog("âŒ No file available to download");
    return;
  }

  try {
    addLog(`ðŸ“¥ Downloading ${targetFileName}...`);

    // Create a temporary anchor element for download
    const link = document.createElement("a");
    link.href = `/api/static/filedownload/download/${runId}`;
    link.download = targetFileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    addLog(`âœ… Download started for ${targetFileName}`);
  } catch (error) {
    console.error("Error downloading file:", error);
    addLog(`âŒ Error downloading file: ${error.message}`);
  }
}

// Attach form event listeners
function attachFormListeners(prefix) {
  // Database type change listeners
  const sourceTypeSelect = document.getElementById(prefix + "SourceType");
  const targetTypeSelect = document.getElementById(prefix + "TargetType");

  if (sourceTypeSelect) {
    sourceTypeSelect.addEventListener("change", function () {
      updateDropdownOptions(prefix + "Source", this.value);
    });
  }

  if (targetTypeSelect) {
    targetTypeSelect.addEventListener("change", function () {
      updateDropdownOptions(prefix + "Target", this.value);
    });
  }

  // Primary key selection listeners
  const sourcePkSelect = document.getElementById(prefix + "SourcePrimaryKey");
  const targetPkSelect = document.getElementById(prefix + "TargetPrimaryKey");

  if (sourcePkSelect) {
    sourcePkSelect.addEventListener("change", function () {
      if (this.value === "manual") {
        handlePrimaryKeySelection(prefix + "Source");
      }
    });
  }

  if (targetPkSelect) {
    targetPkSelect.addEventListener("change", function () {
      if (this.value === "manual") {
        handlePrimaryKeySelection(prefix + "Target");
      }
    });
  }
}

// ============================================================
// STATIC EXECUTION FLOW - SSE BASED
// ============================================================

// Helper function to validate email format
function isValidEmail(email) {
  // Handle null, undefined, or non-string values
  if (email === null || email === undefined) return false;
  if (typeof email !== "string") return false;

  // Trim whitespace
  email = email.trim();
  if (email === "") return false;

  // Use a simple regex pattern for email validation
  // This pattern checks for: something@something.something
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailPattern.test(email);
}

// Execute operation - Main entry point
async function executeOperation(event, operationType) {
  if (event) {
    event.preventDefault();
  }

  console.log(
    `Executing ${operationType} with table mode: ${currentTableMode}`
  );

  // Get the execute button - for Data Load, try specific ID first
  const form = event ? event.target : null;
  let button = null;

  if (operationType === "Data Load") {
    // For Data Load, use the specific button ID to ensure isolation
    button = document.getElementById("dataload-run-btn");
    console.log(
      "[DataLoad] Looking for button #dataload-run-btn, found:",
      !!button
    );
  }

  // Fallback to form's execute button if specific button not found
  if (!button && form) {
    button = form.querySelector(".execute-button");
  }

  // Check if already running
  if (executionStatus === "RUNNING") {
    addLog("âš ï¸ An operation is already running. Please wait or stop it first.");
    return;
  }

  // Reset download button state when starting a new comparison
  if (operationType === "Data Comparison") {
    resetDownloadButton();
  }

  // Show loading state on button
  console.log(
    `[${operationType}] Setting button loading state, button found: ${!!button}`
  );
  setButtonLoadingState(button, operationType, true);

  try {
    // Get the API tab name
    const apiTab = TAB_API_MAP[currentTab];
    if (!apiTab) {
      throw new Error(`Unknown tab: ${currentTab}`);
    }

    // Collect form data based on current tab
    const formData = collectFormData(currentTab);

    // Validate User Email
    const emailKey = `${currentTab}UserEmail`;
    const userEmail = formData[emailKey];
    if (!isValidEmail(userEmail)) {
      if (!userEmail || userEmail.trim() === "") {
        throw new Error("User Email is required for execution");
      } else {
        throw new Error("Please enter a valid email address");
      }
    }

    // Add table mode to form data
    formData.tableMode = currentTableMode;

    // Add comparison type if applicable
    const comparisonTypeSelect = document.getElementById(
      "comparison-type-select"
    );
    if (comparisonTypeSelect) {
      formData.comparisonType = comparisonTypeSelect.value;
    }

    addLog(`ðŸš€ Starting ${operationType}...`);

    let response;

    // Check if this is Multi-Table mode with Excel file for Data Comparison
    if (
      apiTab === "data_comparison" &&
      currentTableMode === "multi" &&
      formData.comparisonType === "database-to-database"
    ) {
      // Use multipart/form-data for Excel file upload
      const sourceExcelInput = document.getElementById("sourceExcelFile");
      const targetExcelInput = document.getElementById("targetExcelFile");

      // Validate both files are provided
      if (
        !sourceExcelInput ||
        !sourceExcelInput.files ||
        !sourceExcelInput.files[0]
      ) {
        throw new Error(
          "Please select a Source Excel file for Multiple Tables mode"
        );
      }
      if (
        !targetExcelInput ||
        !targetExcelInput.files ||
        !targetExcelInput.files[0]
      ) {
        throw new Error(
          "Please select a Target Excel file for Multiple Tables mode"
        );
      }

      const multiFormData = new FormData();
      multiFormData.append("tab", apiTab);
      multiFormData.append("comparison_type", "db_to_db");
      multiFormData.append("mode", "multiple_tables");
      multiFormData.append("source_excel_file", sourceExcelInput.files[0]);
      multiFormData.append("target_excel_file", targetExcelInput.files[0]);

      // Append all other form fields
      Object.keys(formData).forEach((key) => {
        if (formData[key] !== null && formData[key] !== undefined) {
          multiFormData.append(key, formData[key]);
        }
      });

      addLog(`ðŸ“Š Uploading Source Excel: ${sourceExcelInput.files[0].name}`);
      addLog(`ðŸ“Š Uploading Target Excel: ${targetExcelInput.files[0].name}`);
      addLog(
        `ðŸ“Š Using /api/static/comparison/run-multi endpoint for multi-table mode`
      );

      response = await fetch("/api/static/comparison/run-multi", {
        method: "POST",
        body: multiFormData,
      });
    } else if (apiTab === "file_load") {
      // Check if File Load tab has local file upload selected
      const fileloadLocationType = document.getElementById(
        "fileloadSourceLocationType"
      )?.value;

      if (fileloadLocationType === "upload") {
        // Use multipart/form-data for local file upload
        const fileUploadInput = document.getElementById(
          "fileloadSourceFileUpload"
        );

        // Validate file is selected
        if (
          !fileUploadInput ||
          !fileUploadInput.files ||
          !fileUploadInput.files[0]
        ) {
          throw new Error(
            "Please select a file to upload for File Load operation"
          );
        }

        const uploadedFile = fileUploadInput.files[0];

        addLog(
          `ðŸ“¤ Uploading local file: ${uploadedFile.name} (${(
            uploadedFile.size / 1024
          ).toFixed(2)} KB)`
        );

        const uploadFormData = new FormData();
        uploadFormData.append("tab", "file_load");
        uploadFormData.append("source_local_file", uploadedFile);

        // Append all other form fields
        Object.keys(formData).forEach((key) => {
          if (formData[key] !== null && formData[key] !== undefined) {
            uploadFormData.append(key, formData[key]);
          }
        });

        addLog(`ðŸ“¤ Using /api/static/fileload/run-with-upload endpoint`);

        response = await fetch("/api/static/fileload/run-with-upload", {
          method: "POST",
          body: uploadFormData,
        });
      } else {
        // Standard JSON request for unix/hadoop path
        response = await fetch("/api/static/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            tab: apiTab,
            params: formData,
          }),
        });
      }
    } else {
      // Standard JSON request for single table mode
      response = await fetch("/api/static/run", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          tab: apiTab,
          params: formData,
        }),
      });
    }

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || `${operationType} operation failed`);
    }

    const result = await response.json();
    currentRunId = result.run_id;
    executionStatus = "RUNNING";

    // Data Load specific state update
    if (apiTab === "data_load") {
      dataLoadRunStatus = "RUNNING";
      console.log(
        "[DataLoad] Status changed to RUNNING â†’ Waiting for DataLoad"
      );
    }

    addLog(`ðŸ“‹ Run ID: ${currentRunId}`);

    // Start SSE log streaming
    startLogStreaming(currentRunId, button, operationType);
  } catch (error) {
    console.error("Error executing operation:", error);
    addLog(`âŒ Error: ${error.message}`);
    executionStatus = "IDLE";
    setButtonLoadingState(button, operationType, false);
  }
}

// Start SSE log streaming
function startLogStreaming(runId, button, operationType) {
  // Close existing EventSource if any
  if (eventSource) {
    eventSource.close();
  }

  eventSource = new EventSource(`/api/static/logs/${runId}`);

  eventSource.onmessage = function (event) {
    try {
      const data = JSON.parse(event.data);

      switch (data.type) {
        case "log":
          addLog(data.message);
          break;

        case "status":
          executionStatus = data.status;
          updateExecutionStatusUI(data.status);
          break;

        case "end":
          eventSource.close();
          eventSource = null;
          executionStatus = data.status || "IDLE";
          setButtonLoadingState(button, operationType, false);

          if (data.status === "SUCCESS") {
            if (operationType === "Data Comparison") {
              jobComplete = true;

              // Check if download is available (single_table mode)
              if (data.download_available && data.download_url) {
                reportUrl = data.download_url;
                enableDownloadButton();
                addLog(
                  `ðŸ“¥ Download ready: ${data.download_filename || "output.csv"}`
                );
                addLog(
                  "âœ… Comparison complete! Click 'Download Comparison Report' to save the file."
                );
              } else {
                reportUrl = `/reports/comparison_${runId}.csv`;
                enableDownloadButton();
              }
            } else if (operationType === "Data Load") {
              // Data Load specific success handling
              dataLoadRunStatus = "SUCCESS";
              dataLoadButtonLabel = "Execute Data Load";
              console.log("[DataLoad] Status SUCCESS â†’ Data load completed");
              addLog("âœ… Data load completed");
              updateDataLoadStatusUI("Data load completed");
            }
          } else if (
            data.status === "FAILED" &&
            operationType === "Data Load"
          ) {
            dataLoadRunStatus = "FAILED";
            dataLoadButtonLabel = "Execute Data Load";
            console.log("[DataLoad] Status FAILED");
          } else if (
            data.status === "STOPPED" &&
            operationType === "Data Load"
          ) {
            dataLoadRunStatus = "STOPPED";
            dataLoadButtonLabel = "Execute Data Load";
            console.log("[DataLoad] Status STOPPED");
          }
          break;

        case "error":
          addLog(`âŒ ${data.message}`);
          eventSource.close();
          eventSource = null;
          executionStatus = "FAILED";
          setButtonLoadingState(button, operationType, false);
          break;
      }
    } catch (e) {
      console.error("Error parsing SSE data:", e);
    }
  };

  eventSource.onerror = function (error) {
    console.error("SSE error:", error);
    addLog("âŒ Connection to server lost");
    eventSource.close();
    eventSource = null;
    executionStatus = "FAILED";
    setButtonLoadingState(button, operationType, false);
  };
}

// Update execution status in UI
function updateExecutionStatusUI(status) {
  const statusElement = document.getElementById("execution-status");
  if (statusElement) {
    statusElement.textContent = status;
    statusElement.className = `execution-status status-${status.toLowerCase()}`;
  }
}

// Set button loading state
function setButtonLoadingState(button, operationType, isLoading) {
  if (!button) return;

  if (isLoading) {
    button.disabled = true;

    // Data Load specific button label - use dedicated element
    if (operationType === "Data Load") {
      dataLoadRunStatus = "RUNNING";
      dataLoadButtonLabel = "Waiting for DataLoad...";

      // Update Data Load specific button text element
      const dataLoadBtnText = document.getElementById("dataload-btn-text");
      if (dataLoadBtnText) {
        dataLoadBtnText.textContent = "Waiting for DataLoad...";
      }
      button.innerHTML = `<span class="loading-spinner mr-2">âŸ³</span><span id="dataload-btn-text">Waiting for DataLoad...</span>`;
      console.log(
        "[DataLoad] Button updated â†’ Waiting for DataLoad (element: #dataload-run-btn)"
      );

      // Hide success status when starting new run
      const statusContainer = document.getElementById(
        "dataload-status-container"
      );
      if (statusContainer) {
        statusContainer.classList.add("hidden");
      }
    } else {
      button.innerHTML = `<span class="loading-spinner mr-2">âŸ³</span>Waiting for ${operationType}...`;
    }
    button.classList.add("loading");
  } else {
    button.disabled = false;

    // Data Load specific button reset
    if (operationType === "Data Load") {
      dataLoadButtonLabel = "Execute Data Load";
      button.innerHTML = `<span class="execute-icon mr-2">â–¶ï¸</span><span id="dataload-btn-text">Execute Data Load</span>`;
      console.log("[DataLoad] Button reset â†’ Execute Data Load");
    } else {
      button.innerHTML = `<span class="execute-icon mr-2">â–¶ï¸</span>Execute ${operationType}`;
    }
    button.classList.remove("loading");
  }
}

// Update Data Load specific status in UI
function updateDataLoadStatusUI(statusText) {
  console.log("[DataLoad] Updating status UI â†’ " + statusText);

  // Find status container and text element specific to Data Load tab
  const statusContainer = document.getElementById("dataload-status-container");
  const statusElement = document.getElementById("dataload-status-text");

  if (statusContainer && statusElement) {
    statusContainer.classList.remove("hidden");
    statusElement.textContent = statusText;
    statusElement.className =
      "dataload-status-success text-green-600 font-semibold";
    console.log("[DataLoad] Updated #dataload-status-text â†’ " + statusText);
  } else {
    console.log(
      "[DataLoad] Status elements not found: container=" +
        !!statusContainer +
        ", text=" +
        !!statusElement
    );
  }
}

// Stop current execution
async function stopExecution() {
  if (!currentRunId || executionStatus !== "RUNNING") {
    addLog("âš ï¸ No running operation to stop");
    return;
  }

  try {
    const response = await fetch(`/api/static/stop/${currentRunId}`, {
      method: "POST",
    });

    if (response.ok) {
      addLog("â›” Stop request sent");
    } else {
      const errorData = await response.json();
      addLog(`âŒ Failed to stop: ${errorData.error}`);
    }
  } catch (error) {
    console.error("Error stopping execution:", error);
    addLog(`âŒ Error stopping execution: ${error.message}`);
  }
}

// Collect form data for current tab
function collectFormData(tabPrefix) {
  const data = {};

  // Get all form inputs in the current tab
  const tabContent = document.getElementById(tabPrefix);
  if (!tabContent) return data;

  const inputs = tabContent.querySelectorAll("input, select, textarea");
  inputs.forEach((input) => {
    if (input.id) {
      if (input.type === "file") {
        // For file inputs, we'll need to handle file upload separately
        // For now, just store the file name
        data[input.id] = input.files[0] ? input.files[0].name : null;
      } else if (input.type === "radio") {
        if (input.checked) {
          data[input.name] = input.value;
        }
      } else if (input.type === "password") {
        // Include password fields but mark them
        data[input.id] = input.value;
      } else {
        data[input.id] = input.value;
      }
    }
  });

  // Add key columns if they exist
  const comparisonType = document.getElementById("comparison-type-select");
  if (
    comparisonType &&
    (comparisonType.value === "file-to-file" ||
      comparisonType.value === "file-to-database" ||
      comparisonType.value === "database-to-file")
  ) {
    const sourceKeyColumns = document.getElementById(
      "comparisonSourceKeyColumns"
    );
    const targetKeyColumns = document.getElementById(
      "comparisonTargetKeyColumns"
    );
    if (sourceKeyColumns) data["keyColumns"] = sourceKeyColumns.value;
    if (targetKeyColumns) data["keyColumns"] = targetKeyColumns.value;

    // Handle location type mapping to unix_path or hadoop_path
    const sourceLocationType = document.getElementById(
      "comparisonSourceLocationType"
    );
    const targetLocationType = document.getElementById(
      "comparisonTargetLocationType"
    );

    // Source file path handling
    if (sourceLocationType) {
      if (sourceLocationType.value === "unix") {
        const unixPath = document.getElementById("comparisonSourceUnixPath");
        if (unixPath && unixPath.value) {
          data["source_unix_path"] = unixPath.value;
          data["source_hadoop_path"] = ""; // Clear the other path
        }
      } else if (sourceLocationType.value === "hadoop") {
        const hadoopPath = document.getElementById(
          "comparisonSourceHadoopPath"
        );
        if (hadoopPath && hadoopPath.value) {
          data["source_hadoop_path"] = hadoopPath.value;
          data["source_unix_path"] = ""; // Clear the other path
        }
      }
      data["source_location_type"] = sourceLocationType.value;
    }

    // Target file path handling
    if (targetLocationType) {
      if (targetLocationType.value === "unix") {
        const unixPath = document.getElementById("comparisonTargetUnixPath");
        if (unixPath && unixPath.value) {
          data["target_unix_path"] = unixPath.value;
          data["target_hadoop_path"] = ""; // Clear the other path
        }
      } else if (targetLocationType.value === "hadoop") {
        const hadoopPath = document.getElementById(
          "comparisonTargetHadoopPath"
        );
        if (hadoopPath && hadoopPath.value) {
          data["target_hadoop_path"] = hadoopPath.value;
          data["target_unix_path"] = ""; // Clear the other path
        }
      }
      data["target_location_type"] = targetLocationType.value;
    }

    // Handle file SQL query - default to "N/A" if empty
    const sourceFileSqlQuery = document.getElementById(
      "comparisonSourceFileSqlQuery"
    );
    const targetFileSqlQuery = document.getElementById(
      "comparisonTargetFileSqlQuery"
    );

    if (sourceFileSqlQuery) {
      data["source_file_sql_query"] = sourceFileSqlQuery.value.trim() || "N/A";
    }
    if (targetFileSqlQuery) {
      data["target_file_sql_query"] = targetFileSqlQuery.value.trim() || "N/A";
    }
  }

  // Handle Time Zone field - always include it with default "N/A"
  // Check for comparison tab first, then load tab
  let timeZoneInput = document.getElementById("comparisonTimeZone");
  if (!timeZoneInput) {
    timeZoneInput = document.getElementById("loadTimeZone");
  }
  if (timeZoneInput) {
    const tzValue = timeZoneInput.value.trim();
    data["time_zone"] = tzValue || "N/A";
  } else {
    data["time_zone"] = "N/A";
  }

  // Handle Data Load specific fields
  if (tabPrefix === "load") {
    // Target Load Type
    const targetLoadType = document.getElementById("loadTargetLoadType");
    if (targetLoadType) {
      data["target_load_type"] = targetLoadType.value || "";
    }

    // Check if target is Hive for Hive-specific fields
    const targetType = document.getElementById("loadTargetType");
    if (targetType && targetType.value === "Hive") {
      const hadoopPath = document.getElementById("loadTargetHadoopPath");
      const partitionId = document.getElementById("loadTargetPartitionId");

      if (hadoopPath) {
        data["hadoop_path"] = hadoopPath.value.trim() || "";
      }
      if (partitionId) {
        data["partition_id"] = partitionId.value.trim() || "N/A";
      }
    }
  }

  // Handle File Load specific fields (File-to-Database)
  if (tabPrefix === "fileload") {
    console.log("[FileLoad] Collecting form data for File-to-Database load");

    // Source file fields
    const sourceFileType = document.getElementById("fileloadSourceFileType");
    const sourceLocationType = document.getElementById(
      "fileloadSourceLocationType"
    );
    const sourceDelimiter = document.getElementById("fileloadSourceDelimiter");
    const sourceFileSqlQuery = document.getElementById(
      "fileloadSourceFileSqlQuery"
    );
    const sourceKeyColumns = document.getElementById(
      "fileloadSourceKeyColumns"
    );

    if (sourceFileType) {
      data["source_file_type"] = sourceFileType.value || "";
    }

    if (sourceLocationType) {
      data["source_location_type"] = sourceLocationType.value || "";

      if (sourceLocationType.value === "unix") {
        const unixPath = document.getElementById("fileloadSourceUnixPath");
        if (unixPath && unixPath.value) {
          data["source_unix_path"] = unixPath.value;
          data["source_hadoop_path"] = "";
        }
      } else if (sourceLocationType.value === "hadoop") {
        const hadoopPath = document.getElementById("fileloadSourceHadoopPath");
        if (hadoopPath && hadoopPath.value) {
          data["source_hadoop_path"] = hadoopPath.value;
          data["source_unix_path"] = "";
        }
      }
    }

    if (sourceDelimiter) {
      data["source_delimiter"] = sourceDelimiter.value || ",";
    }

    if (sourceFileSqlQuery) {
      data["source_file_sql_query"] = sourceFileSqlQuery.value.trim() || "N/A";
    }

    if (sourceKeyColumns) {
      data["source_key_columns"] = sourceKeyColumns.value || "";
    }

    // Target database fields (same as Data Load)
    const targetLoadType = document.getElementById("fileloadTargetLoadType");
    if (targetLoadType) {
      data["target_load_type"] = targetLoadType.value || "";
    }

    // Check if target is Hive for Hive-specific fields
    const targetType = document.getElementById("fileloadTargetType");
    if (targetType && targetType.value === "Hive") {
      const hadoopPath = document.getElementById("fileloadTargetHadoopPath");
      const partitionId = document.getElementById("fileloadTargetPartitionId");

      if (hadoopPath) {
        data["hadoop_path"] = hadoopPath.value.trim() || "";
      }
      if (partitionId) {
        data["partition_id"] = partitionId.value.trim() || "N/A";
      }
    }

    // Handle Time Zone for File Load
    const fileloadTimeZone = document.getElementById("fileloadTimeZone");
    if (fileloadTimeZone) {
      data["time_zone"] = fileloadTimeZone.value.trim() || "N/A";
    }
  }

  return data;
}

// ============================================================
// WEBSOCKET CONNECTION (Legacy - kept for backwards compatibility)
// ============================================================
function initializeWebSocket() {
  try {
    socket = io();

    socket.on("connect", function () {
      isConnected = true;
      updateConnectionStatus();
      addLog("ðŸ”— Connected to Wells Fargo Data Management Platform");
    });

    socket.on("disconnect", function () {
      isConnected = false;
      updateConnectionStatus();
      addLog("ðŸ”Œ Disconnected from server");
    });

    socket.on("log", function (data) {
      if (!isPaused) {
        addLog(data.message);
      }
    });

    socket.on("operation_complete", function (data) {
      console.log("Operation complete:", data);
      if (data.status === "success") {
        jobComplete = true;
        if (data.report_path) {
          reportUrl = data.report_path;
        }
        enableDownloadButton();
        addLog("âœ… Comparison complete! Report ready to download.");
      }
    });

    socket.on("operation_error", function (data) {
      console.error("Operation error:", data);
      jobComplete = false;
      reportUrl = "";
      disableDownloadButton();
      addLog(`âŒ Comparison failed: ${data.error}`);
    });

    socket.on("error", function (error) {
      console.error("Socket error:", error);
      addLog(`âŒ Connection error: ${error}`);
    });
  } catch (error) {
    console.error("WebSocket initialization failed:", error);
    // Don't show error - SSE is the primary method now
  }
}

// Update connection status indicator
function updateConnectionStatus() {
  const statusElement = document.getElementById("connection-status");
  if (!statusElement) return;

  // Show ready state based on SSE support (always available in modern browsers)
  statusElement.innerHTML =
    '<div class="w-2 h-2 bg-green-500 rounded-full"></div>Ready';
  statusElement.className =
    "status-indicator flex items-center gap-2 text-green-600";
}

// Add log message
function addLog(message) {
  // Handle messages that already have timestamps
  let logEntry;
  if (message.startsWith("[")) {
    logEntry = message;
  } else {
    const timestamp = new Date().toLocaleTimeString();
    logEntry = `[${timestamp}] ${message}`;
  }

  logs.push(logEntry);

  // Keep only last 1000 logs
  if (logs.length > 1000) {
    logs = logs.slice(-1000);
  }

  const logDisplay = document.getElementById("log-display");
  if (logDisplay) {
    // Remove placeholder if exists
    const placeholder = logDisplay.querySelector(".log-placeholder");
    if (placeholder) {
      placeholder.remove();
    }

    // Remove "No logs available" message if exists
    const noLogsMsg = logDisplay.querySelector("div.text-gray-500");
    if (noLogsMsg && noLogsMsg.textContent.includes("No logs available")) {
      noLogsMsg.remove();
    }

    const logElement = document.createElement("div");
    logElement.className =
      "log-entry text-sm font-mono mb-1 p-2 rounded hover:bg-gray-800";
    logElement.textContent = logEntry;

    logDisplay.appendChild(logElement);

    // Auto-scroll to bottom if not paused
    if (!isPaused) {
      logDisplay.scrollTop = logDisplay.scrollHeight;
    }
  }
}

// Initialize log controls
function initializeLogControls() {
  // Clear logs button
  const clearLogsBtn = document.getElementById("clear-logs");
  if (clearLogsBtn) {
    clearLogsBtn.addEventListener("click", clearLogs);
  }

  // Pause logs button
  const pauseLogsBtn = document.getElementById("pause-logs");
  if (pauseLogsBtn) {
    pauseLogsBtn.addEventListener("click", togglePause);
  }

  // Stop execution button (if exists)
  const stopBtn = document.getElementById("stop-execution");
  if (stopBtn) {
    stopBtn.addEventListener("click", stopExecution);
  }
}

// Log management functions
function clearLogs() {
  logs = [];

  // Also clear logs on server if we have a run ID
  if (currentRunId) {
    fetch(`/api/static/clear/${currentRunId}`, { method: "POST" }).catch(
      console.error
    );
  }

  const logDisplay = document.getElementById("log-display");
  if (logDisplay) {
    logDisplay.innerHTML =
      '<div class="log-placeholder text-gray-500">Logs cleared. New logs will appear here...</div>';
  }
}

function togglePause() {
  isPaused = !isPaused;
  const pauseBtn = document.getElementById("pause-logs");
  const pauseIcon = document.getElementById("pause-icon");
  const playIcon = document.getElementById("play-icon");
  const pausedIndicator = document.getElementById("paused-indicator");

  if (pauseBtn) {
    if (isPaused) {
      if (pauseIcon) pauseIcon.classList.add("hidden");
      if (playIcon) playIcon.classList.remove("hidden");
    } else {
      if (pauseIcon) pauseIcon.classList.remove("hidden");
      if (playIcon) playIcon.classList.add("hidden");

      // Auto-scroll to bottom when resuming
      const logDisplay = document.getElementById("log-display");
      if (logDisplay) {
        logDisplay.scrollTop = logDisplay.scrollHeight;
      }
    }
  }

  if (pausedIndicator) {
    if (isPaused) {
      pausedIndicator.classList.remove("hidden");
    } else {
      pausedIndicator.classList.add("hidden");
    }
  }
}

// Download Report Button Functions
function enableDownloadButton() {
  const downloadBtn = document.getElementById("download-report-btn");
  const downloadIcon = document.getElementById("download-icon");
  const checkIcon = document.getElementById("check-icon");
  const spinner = document.getElementById("spinner");
  const btnText = document.getElementById("download-btn-text");

  if (downloadBtn) {
    downloadBtn.disabled = false;
    downloadBtn.classList.add("enabled");

    // Hide spinner, show check icon and download icon
    if (spinner) spinner.classList.add("hidden");
    if (checkIcon) checkIcon.classList.remove("hidden");
    if (downloadIcon) downloadIcon.classList.remove("hidden");
    if (btnText) btnText.textContent = "Download Comparison Report";

    // Add click handler
    downloadBtn.onclick = handleDownloadReport;
  }
}

function disableDownloadButton() {
  // Only update download button for Data Comparison tab - DO NOT affect Data Load
  if (currentTab !== "comparison") {
    console.log(
      "[disableDownloadButton] Skipped - not on comparison tab (currentTab=" +
        currentTab +
        ")"
    );
    return;
  }

  const downloadBtn = document.getElementById("download-report-btn");
  const downloadIcon = document.getElementById("download-icon");
  const checkIcon = document.getElementById("check-icon");
  const spinner = document.getElementById("spinner");
  const btnText = document.getElementById("download-btn-text");

  if (downloadBtn) {
    downloadBtn.disabled = true;
    downloadBtn.classList.remove("enabled");

    // Show spinner, hide icons
    if (spinner) spinner.classList.remove("hidden");
    if (downloadIcon) downloadIcon.classList.add("hidden");
    if (checkIcon) checkIcon.classList.add("hidden");
    if (btnText) btnText.textContent = "Waiting for Comparison...";

    downloadBtn.onclick = null;
  }
}

function resetDownloadButton() {
  disableDownloadButton();
  jobComplete = false;
  reportUrl = "";
}

function handleDownloadReport() {
  if (!reportUrl) {
    addLog("âŒ No report available to download");
    return;
  }

  try {
    addLog("ðŸ“¥ Downloading comparison report...");

    // Check if this is a direct download URL from the new single_table endpoint
    if (reportUrl.startsWith("/api/static/comparison/download/")) {
      // Direct download - the browser will handle the file save dialog
      window.location.href = reportUrl;
    } else {
      // Legacy download method
      const link = document.createElement("a");
      link.href = `/api/download-report?path=${encodeURIComponent(reportUrl)}`;
      link.download = "comparison_report.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  } catch (error) {
    console.error("Download error:", error);
    addLog(`âŒ Download failed: ${error.message}`);
  }
}

// ============================================================
// MISMATCH EXPLORER TAB
// ============================================================

// Mismatch Explorer State
let mismatchJobId = null;
let mismatchRunId = null;
let mismatchCurrentPage = 1;
let mismatchPageSize = 50;
let mismatchTotalRecords = 0;
let mismatchTotalPages = 0;
let mismatchShowOnlyMismatched = true;
let mismatchSelectedPk = null;
let mismatchExecutionStatus = "IDLE"; // IDLE, RUNNING, SUCCESS, FAILED

/**
 * Generate the Mismatch Explorer form
 */
function generateMismatchExplorerForm() {
  const formContainer = document.getElementById("mismatch-form");
  if (!formContainer) {
    console.error("Mismatch form container not found");
    return;
  }

  // Filter out "File" from database types
  const dbTypesNoFile = databaseTypes.filter((type) => type !== "File");

  formContainer.innerHTML = `
    <!-- Source Configuration -->
    <div class="grid lg:grid-cols-2 gap-6 mb-6">
      <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
        <div class="card-header gradient-header">
          <h3 class="text-wellsfargo-red flex items-center gap-2">
            <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
            Source Configuration
          </h3>
          <p>Configure your source database connection details</p>
        </div>
        <div class="config-content p-6 space-y-4">
          <div class="form-group">
            <label for="mismatchSourceType" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
            <select id="mismatchSourceType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
              <option value="">Select database type</option>
              ${dbTypesNoFile
                .map((type) => `<option value="${type}">${type}</option>`)
                .join("")}
            </select>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
              <label for="mismatchSourceHost" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
              <input type="text" id="mismatchSourceHost" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
            </div>
            
            <div class="form-group">
              <label for="mismatchSourcePort" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
              <input type="text" id="mismatchSourcePort" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
            </div>
          </div>
          
          <div class="form-group">
            <label for="mismatchSourceDatabase" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
            <input type="text" id="mismatchSourceDatabase" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
              <label for="mismatchSourceUsername" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
              <input type="text" id="mismatchSourceUsername" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
            </div>
            
            <div class="form-group">
              <label for="mismatchSourcePassword" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
              <input type="password" id="mismatchSourcePassword" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
            </div>
          </div>
          
          <div class="form-group">
            <label for="mismatchSourceTableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
            <input type="text" id="mismatchSourceTableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter table name" maxlength="255">
          </div>
          
          <div class="form-group">
            <label for="mismatchSourcePrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
            <input type="text" id="mismatchSourcePrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
            <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
          </div>
          
          <div class="form-group">
            <label for="mismatchSourceSqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
            <textarea id="mismatchSourceSqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
          </div>
        </div>
      </div>
      
      <!-- Target Configuration -->
      <div class="source-target-card border-t-4 border-t-wellsfargo-red shadow-elevated">
        <div class="card-header gradient-header">
          <h3 class="text-wellsfargo-red flex items-center gap-2">
            <div class="w-3 h-3 bg-wellsfargo-red rounded-full"></div>
            Target Configuration
          </h3>
          <p>Configure your target database connection details</p>
        </div>
        <div class="config-content p-6 space-y-4">
          <div class="form-group">
            <label for="mismatchTargetType" class="block text-sm font-medium mb-2">ðŸ—„ï¸ Database Type</label>
            <select id="mismatchTargetType" class="form-select w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200">
              <option value="">Select database type</option>
              ${dbTypesNoFile
                .map((type) => `<option value="${type}">${type}</option>`)
                .join("")}
            </select>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
              <label for="mismatchTargetHost" class="block text-sm font-medium mb-2">ðŸŒ Host</label>
              <input type="text" id="mismatchTargetHost" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="localhost" maxlength="1500">
            </div>
            
            <div class="form-group">
              <label for="mismatchTargetPort" class="block text-sm font-medium mb-2">ðŸ”Œ Port</label>
              <input type="text" id="mismatchTargetPort" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="5432" maxlength="10">
            </div>
          </div>
          
          <div class="form-group">
            <label for="mismatchTargetDatabase" class="block text-sm font-medium mb-2">ðŸ’¾ Database Name</label>
            <input type="text" id="mismatchTargetDatabase" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter database name" maxlength="255">
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
              <label for="mismatchTargetUsername" class="block text-sm font-medium mb-2">ðŸ‘¤ Username</label>
              <input type="text" id="mismatchTargetUsername" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter username" maxlength="100">
            </div>
            
            <div class="form-group">
              <label for="mismatchTargetPassword" class="block text-sm font-medium mb-2">ðŸ”’ Password</label>
              <input type="password" id="mismatchTargetPassword" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter password" maxlength="100">
            </div>
          </div>
          
          <div class="form-group">
            <label for="mismatchTargetTableName" class="block text-sm font-medium mb-2">ðŸ“‹ Table Name</label>
            <input type="text" id="mismatchTargetTableName" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter table name" maxlength="255">
          </div>
          
          <div class="form-group">
            <label for="mismatchTargetPrimaryKey" class="block text-sm font-medium mb-2">ðŸ”‘ Primary Key</label>
            <input type="text" id="mismatchTargetPrimaryKey" class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" placeholder="Enter primary key column(s), e.g., ID or ID,COUNTRY_CODE" maxlength="500">
            <p class="text-sm text-gray-500 mt-1">For composite keys, enter comma-separated column names</p>
          </div>
          
          <div class="form-group">
            <label for="mismatchTargetSqlQuery" class="block text-sm font-medium mb-2">ðŸ“ SQL Query (Optional)</label>
            <textarea id="mismatchTargetSqlQuery" class="form-textarea w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200" rows="3" placeholder="Enter custom SQL query (optional)"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Comparison Rules with Time Zone -->
    <div class="source-target-card border-t-4 border-t-mismatch shadow-elevated mb-6">
      <div class="card-header gradient-header">
        <h3 class="text-mismatch flex items-center gap-2">
          <span class="text-xl">âš™ï¸</span>
          Comparison Rules
        </h3>
        <p>Configure comparison behavior</p>
      </div>
      <div class="config-content p-6">
        <div class="mismatch-rules-grid mb-4">
          <div class="mismatch-rule-item">
            <label>Trim Spaces</label>
            <div class="mismatch-toggle active" id="rule-trim-spaces" onclick="toggleMismatchRule(this)"></div>
          </div>
          <div class="mismatch-rule-item">
            <label>Ignore Case</label>
            <div class="mismatch-toggle" id="rule-ignore-case" onclick="toggleMismatchRule(this)"></div>
          </div>
          <div class="mismatch-rule-item">
            <label>NULL = Empty String</label>
            <div class="mismatch-toggle active" id="rule-null-equals-empty" onclick="toggleMismatchRule(this)"></div>
          </div>
          <div class="mismatch-rule-item">
            <label>Numeric Tolerance</label>
            <input type="number" id="rule-numeric-tolerance" class="form-input" value="0" min="0" step="0.01" style="width: 80px; padding: 0.5rem;">
          </div>
        </div>
        
        <!-- Time Zone field -->
        <div class="form-group mt-4 pt-4 border-t border-gray-200">
          <label for="mismatchTimeZone" class="block text-sm font-medium mb-2">ðŸŒ Time Zone</label>
          <div class="relative">
            <input type="text" 
                   id="mismatchTimeZone" 
                   list="mismatchTimeZoneList"
                   class="form-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-mismatch focus:ring-2 focus:ring-mismatch/20" 
                   placeholder="Select or type a time zone (e.g., America/Phoenix)"
                   value="N/A"
                   maxlength="100">
            <datalist id="mismatchTimeZoneList">
              ${commonTimeZones
                .map(
                  (tz) =>
                    `<option value="${tz}"${
                      tz === "N/A" ? " selected" : ""
                    }>${tz}</option>`
                )
                .join("")}
            </datalist>
          </div>
          <p class="text-sm text-gray-500 mt-1">Select from the list or type an IANA time zone. Leave as "N/A" if not applicable.</p>
        </div>
      </div>
    </div>

    <!-- Unix Server Configuration -->
    ${generateUnixServerSection("mismatch")}

    <!-- Action Buttons -->
    <div class="execute-section text-center p-6 border-t border-gray-200">
      <div class="flex justify-center gap-4 flex-wrap">
        <button type="button" id="mismatch-execute-btn" class="execute-button bg-gradient-to-r from-red-600 to-red-700 text-white px-8 py-3 rounded-lg font-semibold hover:from-red-700 hover:to-red-800 transition-all duration-200 shadow-lg" onclick="executeMismatchExplorerJob()">
          <span class="execute-icon mr-2">â–¶ï¸</span>
          <span id="mismatch-execute-btn-text">Execute</span>
        </button>
        <button type="button" id="mismatch-fetch-btn" class="execute-button bg-gradient-to-r from-teal-600 to-cyan-600 text-white px-8 py-3 rounded-lg font-semibold hover:from-teal-700 hover:to-cyan-700 transition-all duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" onclick="fetchMismatchResults()" disabled>
          <span class="mr-2">ðŸ”</span>
          <span id="mismatch-fetch-btn-text">Fetch & Compare</span>
        </button>
      </div>
    </div>

    <!-- Results Container -->
    <div id="mismatch-results-container" style="display: none;">
      <div class="mismatch-explorer-container">
        <!-- LEFT: Summary Panel -->
        <div class="mismatch-summary-panel">
          <div class="mismatch-panel-header">
            <h4>ðŸ“‹ Summary</h4>
            <span id="mismatch-record-count" class="text-sm text-muted-foreground"></span>
          </div>
          <div class="mismatch-panel-content" id="mismatch-summary-content">
            <div class="mismatch-empty">
              <div class="mismatch-empty-icon">ðŸ“Š</div>
              <p>Run a comparison to see results</p>
            </div>
          </div>
          <div class="mismatch-pagination" id="mismatch-pagination" style="display: none;">
            <div class="mismatch-pagination-info">
              <span id="mismatch-page-info">Page 1 of 1</span>
            </div>
            <div class="mismatch-pagination-controls">
              <button class="pagination-btn" id="mismatch-prev-btn" onclick="mismatchChangePage(-1)" disabled>â€¹</button>
              <span id="mismatch-page-numbers"></span>
              <button class="pagination-btn" id="mismatch-next-btn" onclick="mismatchChangePage(1)">â€º</button>
            </div>
          </div>
        </div>
        
        <!-- RIGHT: Details Panel -->
        <div class="mismatch-details-panel">
          <div class="mismatch-panel-header">
            <h4>ðŸ”Ž Record Details</h4>
            <div class="mismatch-toggle-container" id="mismatch-toggle-container" style="display: none;">
              <label>Show only mismatches</label>
              <div class="mismatch-toggle active" id="toggle-mismatch-only" onclick="toggleShowOnlyMismatched()"></div>
            </div>
          </div>
          <div class="mismatch-panel-content" id="mismatch-details-content">
            <div class="mismatch-empty">
              <div class="mismatch-empty-icon">ðŸ‘†</div>
              <p>Click "View Details" on a record to see field-level comparison</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

/**
 * Toggle comparison rule
 */
function toggleMismatchRule(element) {
  element.classList.toggle("active");
}

/**
 * Toggle showing only mismatched fields
 */
function toggleShowOnlyMismatched() {
  const toggle = document.getElementById("toggle-mismatch-only");
  toggle.classList.toggle("active");
  mismatchShowOnlyMismatched = toggle.classList.contains("active");

  // Re-render details if we have a selected PK
  if (mismatchSelectedPk) {
    loadMismatchDetails(mismatchSelectedPk);
  }
}

/**
 * Collect comparison rules from UI
 */
function collectMismatchRules() {
  return {
    trim_spaces: document
      .getElementById("rule-trim-spaces")
      .classList.contains("active"),
    ignore_case: document
      .getElementById("rule-ignore-case")
      .classList.contains("active"),
    null_equals_empty: document
      .getElementById("rule-null-equals-empty")
      .classList.contains("active"),
    numeric_tolerance:
      parseFloat(document.getElementById("rule-numeric-tolerance").value) || 0,
    time_zone:
      document.getElementById("mismatchTimeZone").value.trim() || "N/A",
  };
}

/**
 * Collect Mismatch Explorer form data
 */
function collectMismatchFormData() {
  return {
    // Source configuration
    mismatchSourceType: document.getElementById("mismatchSourceType").value,
    mismatchSourceHost: document
      .getElementById("mismatchSourceHost")
      .value.trim(),
    mismatchSourcePort: document
      .getElementById("mismatchSourcePort")
      .value.trim(),
    mismatchSourceDatabase: document
      .getElementById("mismatchSourceDatabase")
      .value.trim(),
    mismatchSourceUsername: document
      .getElementById("mismatchSourceUsername")
      .value.trim(),
    mismatchSourcePassword: document.getElementById("mismatchSourcePassword")
      .value,
    mismatchSourceTableName: document
      .getElementById("mismatchSourceTableName")
      .value.trim(),
    mismatchSourcePrimaryKey: document
      .getElementById("mismatchSourcePrimaryKey")
      .value.trim(),
    mismatchSourceSqlQuery: document
      .getElementById("mismatchSourceSqlQuery")
      .value.trim(),

    // Target configuration
    mismatchTargetType: document.getElementById("mismatchTargetType").value,
    mismatchTargetHost: document
      .getElementById("mismatchTargetHost")
      .value.trim(),
    mismatchTargetPort: document
      .getElementById("mismatchTargetPort")
      .value.trim(),
    mismatchTargetDatabase: document
      .getElementById("mismatchTargetDatabase")
      .value.trim(),
    mismatchTargetUsername: document
      .getElementById("mismatchTargetUsername")
      .value.trim(),
    mismatchTargetPassword: document.getElementById("mismatchTargetPassword")
      .value,
    mismatchTargetTableName: document
      .getElementById("mismatchTargetTableName")
      .value.trim(),
    mismatchTargetPrimaryKey: document
      .getElementById("mismatchTargetPrimaryKey")
      .value.trim(),
    mismatchTargetSqlQuery: document
      .getElementById("mismatchTargetSqlQuery")
      .value.trim(),

    // Rules
    rules: collectMismatchRules(),

    // Unix configuration
    mismatchUnixHost: document.getElementById("mismatchUnixHost").value.trim(),
    mismatchUserEmail: document
      .getElementById("mismatchUserEmail")
      .value.trim(),
    mismatchBatchId: document.getElementById("mismatchBatchId").value.trim(),
    mismatchUnixUsername: document
      .getElementById("mismatchUnixUsername")
      .value.trim(),
    mismatchUnixPassword: document.getElementById("mismatchUnixPassword").value,
  };
}

/**
 * Execute Mismatch Explorer job via Paramiko
 */
async function executeMismatchExplorerJob() {
  // Collect form data
  const formData = collectMismatchFormData();

  // Validation
  if (!formData.mismatchUnixHost) {
    alert("Unix Host is required");
    return;
  }
  if (!formData.mismatchUserEmail) {
    alert("User Email is required");
    return;
  }
  if (!formData.mismatchBatchId) {
    alert("Batch ID is required");
    return;
  }
  if (!formData.mismatchUnixUsername || !formData.mismatchUnixPassword) {
    alert("Unix credentials are required");
    return;
  }

  // Update UI to loading state
  const executeBtn = document.getElementById("mismatch-execute-btn");
  const executeBtnText = document.getElementById("mismatch-execute-btn-text");
  const fetchBtn = document.getElementById("mismatch-fetch-btn");

  executeBtn.disabled = true;
  executeBtnText.textContent = "Running...";
  fetchBtn.disabled = true;
  mismatchExecutionStatus = "RUNNING";

  // Clear logs
  clearLogs();
  addLog("ðŸš€ Starting Mismatch Explorer execution...");

  try {
    const response = await fetch("/api/mismatch-explorer/execute", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData),
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || "Failed to start execution");
    }

    mismatchRunId = data.run_id;
    addLog(`ðŸ“‹ Execution started with Run ID: ${mismatchRunId}`);

    // Start SSE log streaming
    startMismatchLogStreaming(mismatchRunId);
  } catch (error) {
    console.error("Mismatch Explorer execution error:", error);
    addLog(`âŒ Execution failed: ${error.message}`);
    mismatchExecutionStatus = "FAILED";
    executeBtn.disabled = false;
    executeBtnText.textContent = "Execute";
  }
}

/**
 * Start SSE log streaming for Mismatch Explorer
 */
function startMismatchLogStreaming(runId) {
  if (eventSource) {
    eventSource.close();
  }

  eventSource = new EventSource(`/api/static/logs/${runId}`);

  eventSource.onmessage = function (event) {
    try {
      const data = JSON.parse(event.data);

      if (data.message) {
        addLog(data.message);
      }

      if (data.status) {
        const executeBtn = document.getElementById("mismatch-execute-btn");
        const executeBtnText = document.getElementById(
          "mismatch-execute-btn-text"
        );
        const fetchBtn = document.getElementById("mismatch-fetch-btn");
        const fetchBtnText = document.getElementById("mismatch-fetch-btn-text");

        if (data.status === "SUCCESS") {
          mismatchExecutionStatus = "SUCCESS";
          addLog("âœ… Execution completed successfully!");
          addLog('ðŸ’¡ Click "Fetch & Compare" to load results.');

          executeBtn.disabled = false;
          executeBtnText.textContent = "Execute";
          fetchBtn.disabled = false;
          fetchBtnText.textContent = "Fetch & Compare";

          eventSource.close();
        } else if (data.status === "FAILED") {
          mismatchExecutionStatus = "FAILED";
          addLog("âŒ Execution failed.");

          executeBtn.disabled = false;
          executeBtnText.textContent = "Execute";
          fetchBtn.disabled = true;

          eventSource.close();
        }
      }
    } catch (e) {
      console.error("Error parsing SSE message:", e);
    }
  };

  eventSource.onerror = function (error) {
    console.error("SSE error:", error);
    eventSource.close();

    const executeBtn = document.getElementById("mismatch-execute-btn");
    const executeBtnText = document.getElementById("mismatch-execute-btn-text");

    executeBtn.disabled = false;
    executeBtnText.textContent = "Execute";
  };
}

/**
 * Fetch mismatch results from Unix /tmp
 */
async function fetchMismatchResults() {
  if (!mismatchRunId) {
    alert("No execution run ID available. Please execute first.");
    return;
  }

  const fetchBtn = document.getElementById("mismatch-fetch-btn");
  const fetchBtnText = document.getElementById("mismatch-fetch-btn-text");

  fetchBtn.disabled = true;
  fetchBtnText.textContent = "Fetching...";
  addLog("ðŸ“¥ Fetching results from Unix...");

  try {
    const response = await fetch(
      `/api/mismatch-explorer/fetch/${mismatchRunId}`
    );
    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || "Failed to fetch results");
    }

    mismatchJobId = data.jobId;
    mismatchCurrentPage = 1;
    mismatchTotalRecords = data.totalRecords;
    mismatchPageSize = 50;

    // Show results container
    document.getElementById("mismatch-results-container").style.display =
      "block";

    // Load summary
    await loadMismatchSummary();

    // Reset details panel
    mismatchSelectedPk = null;
    document.getElementById("mismatch-details-content").innerHTML = `
      <div class="mismatch-empty">
        <div class="mismatch-empty-icon">ðŸ‘†</div>
        <p>Click "View Details" on a record to see field-level comparison</p>
      </div>
    `;
    document.getElementById("mismatch-toggle-container").style.display = "none";

    addLog(`âœ… Results loaded. Found ${data.totalRecords} record(s).`);
  } catch (error) {
    console.error("Fetch results error:", error);
    addLog(`âŒ Failed to fetch results: ${error.message}`);

    document.getElementById("mismatch-summary-content").innerHTML = `
      <div class="mismatch-error">
        âŒ Error: ${error.message}
      </div>
    `;
  } finally {
    fetchBtn.disabled = false;
    fetchBtnText.textContent = "Fetch & Compare";
  }
}

/**
 * Load paginated summary
 */
async function loadMismatchSummary() {
  const contentEl = document.getElementById("mismatch-summary-content");

  // Show loading
  contentEl.innerHTML = `
    <div class="mismatch-loading">
      <div class="mismatch-loading-spinner"></div>
      <p>Loading summary...</p>
    </div>
  `;

  try {
    const response = await fetch(
      `/api/mismatch-explorer/summary?jobId=${mismatchJobId}&page=${mismatchCurrentPage}&pageSize=${mismatchPageSize}`
    );

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || "Failed to load summary");
    }

    mismatchTotalRecords = data.totalRecords;
    mismatchTotalPages = data.totalPages;

    // Update record count
    document.getElementById(
      "mismatch-record-count"
    ).textContent = `${data.totalRecords} record(s)`;

    // Render table
    if (data.rows.length === 0) {
      contentEl.innerHTML = `
        <div class="mismatch-empty">
          <div class="mismatch-empty-icon">ðŸ“­</div>
          <p>No records found</p>
        </div>
      `;
      document.getElementById("mismatch-pagination").style.display = "none";
      return;
    }

    let tableHtml = `
      <table class="mismatch-summary-table">
        <thead>
          <tr>
            <th>Primary Key</th>
            <th>Mismatches</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
    `;

    data.rows.forEach((row) => {
      const statusClass = row.status === "MATCH" ? "match" : "mismatch";
      tableHtml += `
        <tr>
          <td><code>${escapeHtml(row.pkValue)}</code></td>
          <td>${row.mismatchCount}</td>
          <td><span class="status-badge ${statusClass}">${
        row.status
      }</span></td>
          <td>
            <button class="btn-view-details" onclick="loadMismatchDetails('${escapeHtml(
              row.pkValue
            )}')">
              View Details
            </button>
          </td>
        </tr>
      `;
    });

    tableHtml += "</tbody></table>";
    contentEl.innerHTML = tableHtml;

    // Update pagination
    updateMismatchPagination();
  } catch (error) {
    console.error("Load summary error:", error);
    contentEl.innerHTML = `
      <div class="mismatch-error">
        âŒ Error loading summary: ${error.message}
      </div>
    `;
  }
}

/**
 * Update pagination controls
 */
function updateMismatchPagination() {
  const paginationEl = document.getElementById("mismatch-pagination");

  if (mismatchTotalPages <= 1) {
    paginationEl.style.display = "none";
    return;
  }

  paginationEl.style.display = "flex";

  // Update info
  document.getElementById(
    "mismatch-page-info"
  ).textContent = `Page ${mismatchCurrentPage} of ${mismatchTotalPages}`;

  // Update buttons
  document.getElementById("mismatch-prev-btn").disabled =
    mismatchCurrentPage <= 1;
  document.getElementById("mismatch-next-btn").disabled =
    mismatchCurrentPage >= mismatchTotalPages;

  // Generate page numbers (show up to 5 pages)
  let pageNumbersHtml = "";
  const startPage = Math.max(1, mismatchCurrentPage - 2);
  const endPage = Math.min(mismatchTotalPages, startPage + 4);

  for (let i = startPage; i <= endPage; i++) {
    const activeClass = i === mismatchCurrentPage ? "active" : "";
    pageNumbersHtml += `
      <button class="pagination-btn ${activeClass}" onclick="mismatchGoToPage(${i})">${i}</button>
    `;
  }

  document.getElementById("mismatch-page-numbers").innerHTML = pageNumbersHtml;
}

/**
 * Change page
 */
function mismatchChangePage(delta) {
  const newPage = mismatchCurrentPage + delta;
  if (newPage >= 1 && newPage <= mismatchTotalPages) {
    mismatchCurrentPage = newPage;
    loadMismatchSummary();
  }
}

/**
 * Go to specific page
 */
function mismatchGoToPage(page) {
  mismatchCurrentPage = page;
  loadMismatchSummary();
}

/**
 * Load field-level details for a specific PK
 */
async function loadMismatchDetails(pkValue) {
  mismatchSelectedPk = pkValue;
  const contentEl = document.getElementById("mismatch-details-content");

  // Show loading
  contentEl.innerHTML = `
    <div class="mismatch-loading">
      <div class="mismatch-loading-spinner"></div>
      <p>Loading details...</p>
    </div>
  `;

  // Show toggle
  document.getElementById("mismatch-toggle-container").style.display = "flex";

  try {
    const response = await fetch(
      `/api/mismatch-explorer/details?jobId=${mismatchJobId}&pkValue=${encodeURIComponent(
        pkValue
      )}`
    );

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || "Failed to load details");
    }

    renderMismatchDetails(data);
  } catch (error) {
    console.error("Load details error:", error);
    contentEl.innerHTML = `
      <div class="mismatch-error">
        âŒ Error loading details: ${error.message}
      </div>
    `;
  }
}

/**
 * Render field-level details
 */
function renderMismatchDetails(data) {
  const contentEl = document.getElementById("mismatch-details-content");

  // Filter fields if needed
  let fields = data.fields;
  if (mismatchShowOnlyMismatched) {
    fields = fields.filter((f) => f.status === "MISMATCH");
  }

  if (fields.length === 0) {
    contentEl.innerHTML = `
      <div class="mismatch-empty">
        <div class="mismatch-empty-icon">âœ…</div>
        <p>${
          mismatchShowOnlyMismatched
            ? "No mismatched fields"
            : "No fields to display"
        }</p>
      </div>
    `;
    return;
  }

  let html = `
    <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
      <h5 style="margin: 0; color: hsl(var(--color-mismatch-dark));">
        ðŸ”‘ PK = <code>${escapeHtml(data.pkValue)}</code>
      </h5>
      <button class="btn-export-csv" onclick="exportMismatchRecord('${escapeHtml(
        data.pkValue
      )}')">
        ðŸ“¥ Export CSV
      </button>
    </div>
    <table class="mismatch-details-table">
      <thead>
        <tr>
          <th>Field Name</th>
          <th>Source Value</th>
          <th>Target Value</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
  `;

  fields.forEach((field) => {
    const rowClass = field.status === "MISMATCH" ? "mismatch-row" : "";
    const statusClass = field.status === "MATCH" ? "match" : "mismatch";

    html += `
      <tr class="${rowClass}">
        <td><strong>${escapeHtml(field.fieldName)}</strong></td>
        <td><code>${escapeHtml(String(field.sourceValue))}</code></td>
        <td><code>${escapeHtml(String(field.targetValue))}</code></td>
        <td><span class="status-badge ${statusClass}">${
      field.status
    }</span></td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  contentEl.innerHTML = html;
}

/**
 * Export single record comparison as CSV
 */
function exportMismatchRecord(pkValue) {
  if (!mismatchJobId) {
    alert("No active job to export from");
    return;
  }

  // Trigger download
  window.location.href = `/api/mismatch-explorer/export?jobId=${mismatchJobId}&pkValue=${encodeURIComponent(
    pkValue
  )}`;
  addLog(`ðŸ“¥ Exporting comparison for PK: ${pkValue}`);
}

/**
 * HTML escape helper
 */
function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}


### Additional-styles.css

/* Tab-Specific Color Classes */
.text-primary {
  color: hsl(var(--primary));
}
.text-muted-foreground {
  color: hsl(var(--muted-foreground));
}
.text-load {
  color: hsl(var(--color-load));
}
.text-load-dark {
  color: hsl(var(--color-load-dark));
}
.text-schema {
  color: hsl(var(--color-schema));
}
.text-schema-dark {
  color: hsl(var(--color-schema-dark));
}
.text-fileload {
  color: hsl(var(--color-fileload));
}
.text-fileload-dark {
  color: hsl(var(--color-fileload-dark));
}
.text-filedownload {
  color: hsl(var(--color-filedownload));
}
.text-filedownload-dark {
  color: hsl(var(--color-filedownload-dark));
}

.from-card {
  --gradient-start: hsl(var(--card));
}
.to-primary\/5 {
  --gradient-end: hsl(var(--primary) / 0.05);
}
.to-load\/5 {
  --gradient-end: hsl(var(--color-load) / 0.05);
}
.to-schema\/5 {
  --gradient-end: hsl(var(--color-schema) / 0.05);
}
.to-fileload\/5 {
  --gradient-end: hsl(var(--color-fileload) / 0.05);
}
.to-filedownload\/5 {
  --gradient-end: hsl(var(--color-filedownload) / 0.05);
}
.to-accent\/5 {
  --gradient-end: hsl(var(--accent) / 0.05);
}

/* Border Classes */
.border-t-primary {
  border-top-color: hsl(var(--primary));
}
.border-t-load {
  border-top-color: hsl(var(--color-load));
}
.border-t-schema {
  border-top-color: hsl(var(--color-schema));
}
.border-t-fileload {
  border-top-color: hsl(var(--color-fileload));
}
.border-t-filedownload {
  border-top-color: hsl(var(--color-filedownload));
}

.border-primary\/20 {
  border-color: hsl(var(--primary) / 0.2);
}
.border-primary\/30 {
  border-color: hsl(var(--primary) / 0.3);
}
.border-accent\/30 {
  border-color: hsl(var(--accent) / 0.3);
}
.border-2 {
  border-width: 2px;
}
.border-dashed {
  border-style: dashed;
}

/* Text Gradient Classes */
.text-gradient {
  background: linear-gradient(
    135deg,
    hsl(var(--primary)) 0%,
    hsl(var(--primary)) 100%
  );
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.text-gradient-load {
  background: linear-gradient(
    to right,
    hsl(var(--color-load)) 0%,
    hsl(var(--color-load-light)) 100%
  );
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.text-gradient-schema {
  background: linear-gradient(
    to right,
    hsl(var(--color-schema)) 0%,
    hsl(var(--color-schema-light)) 100%
  );
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.text-gradient-fileload {
  background: linear-gradient(
    to right,
    hsl(var(--color-fileload)) 0%,
    hsl(var(--color-fileload-light)) 100%
  );
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.text-gradient-filedownload {
  background: linear-gradient(
    to right,
    hsl(var(--color-filedownload)) 0%,
    hsl(var(--color-filedownload-light)) 100%
  );
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* Shadow Classes */
.hover-shadow-xl:hover {
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
    0 8px 10px -6px rgba(0, 0, 0, 0.1);
}

.shadow-load {
  box-shadow: 0 10px 30px -5px hsl(var(--color-load) / 0.2);
}

.hover-shadow-load-xl:hover {
  box-shadow: 0 20px 40px -5px hsl(var(--color-load) / 0.3);
}

.shadow-schema {
  box-shadow: 0 10px 30px -5px hsl(var(--color-schema) / 0.2);
}

.hover-shadow-schema-xl:hover {
  box-shadow: 0 20px 40px -5px hsl(var(--color-schema) / 0.3);
}

.shadow-fileload {
  box-shadow: 0 10px 30px -5px hsl(var(--color-fileload) / 0.2);
}

.hover-shadow-fileload-xl:hover {
  box-shadow: 0 20px 40px -5px hsl(var(--color-fileload) / 0.3);
}

.shadow-filedownload {
  box-shadow: 0 10px 30px -5px hsl(var(--color-filedownload) / 0.2);
}

.hover-shadow-filedownload-xl:hover {
  box-shadow: 0 20px 40px -5px hsl(var(--color-filedownload) / 0.3);
}

/* Feature Box Styles */
.feature-box {
  position: relative;
  overflow: hidden;
  padding: 1.5rem;
  border-radius: 0.75rem;
  border: 2px solid;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  margin-bottom: 1.5rem;
}

.feature-box-primary {
  background: linear-gradient(
    to bottom right,
    hsl(var(--primary) / 0.08),
    hsl(var(--primary) / 0.05),
    hsl(var(--accent) / 0.05)
  );
  border-color: hsl(var(--primary) / 0.2);
}

.feature-box-load {
  background: linear-gradient(
    to bottom right,
    hsl(var(--color-load) / 0.08),
    hsl(var(--color-load) / 0.05),
    hsl(var(--color-load-light) / 0.08)
  );
  border-color: hsl(var(--color-load) / 0.2);
}

.feature-box-schema {
  background: linear-gradient(
    to bottom right,
    hsl(var(--color-schema) / 0.08),
    hsl(var(--color-schema) / 0.05),
    hsl(var(--color-schema-light) / 0.08)
  );
  border-color: hsl(var(--color-schema) / 0.2);
}

.feature-box-fileload {
  background: linear-gradient(
    to bottom right,
    hsl(var(--color-fileload) / 0.08),
    hsl(var(--color-fileload) / 0.05),
    hsl(var(--color-fileload-light) / 0.08)
  );
  border-color: hsl(var(--color-fileload) / 0.2);
}

.feature-box-filedownload {
  background: linear-gradient(
    to bottom right,
    hsl(var(--color-filedownload) / 0.08),
    hsl(var(--color-filedownload) / 0.05),
    hsl(var(--color-filedownload-light) / 0.08)
  );
  border-color: hsl(var(--color-filedownload) / 0.2);
}

.feature-blur-decoration {
  position: absolute;
  top: 0;
  right: 0;
  width: 8rem;
  height: 8rem;
  background: currentColor;
  opacity: 0.1;
  border-radius: 9999px;
  filter: blur(3rem);
}

/* Animation Classes */
@keyframes slide-up {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes scale-in {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.animate-slide-up {
  animation: slide-up 0.4s ease-out;
}

.animate-scale-in {
  animation: scale-in 0.3s ease-out;
}

/* Utility Classes */
.relative {
  position: relative;
}
.z-10 {
  z-index: 10;
}
.z-50 {
  z-index: 50;
}
.items-start {
  align-items: flex-start;
}
.gap-2 {
  gap: 0.5rem;
}
.gap-3 {
  gap: 0.75rem;
}
.gap-8 {
  gap: 2rem;
}
.space-x-3 > * + * {
  margin-left: 0.75rem;
}
.cursor-pointer {
  cursor: pointer;
}
.h-12 {
  height: 3rem;
}
.h-5 {
  height: 1.25rem;
}
.w-5 {
  width: 1.25rem;
}
.p-6 {
  padding: 1.5rem;
}
.rounded-xl {
  border-radius: 0.75rem;
}
.transition-colors {
  transition-property: color, background-color, border-color;
  transition-duration: 200ms;
}
.hover-border-primary:hover {
  border-color: hsl(var(--primary));
}
.group-hover-text-primary:hover {
  color: hsl(var(--primary));
}

/* Enhanced Form Styles */
.form-select:hover {
  border-color: hsl(var(--muted));
}

/* Card Elevated Enhancement */
.card-elevated {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
    0 2px 4px -2px rgba(0, 0, 0, 0.1);
}


### Params

#!/bin/bash

echo "================= RECEIVED ARGUMENTS ================="
echo "================= RECEIVED ARGUMENTS ================="

echo "  : $1"
echo "  : $2"
echo "  : $3"

echo "  : $4"
echo "  : $5"
echo "  : $6"
echo "  : $7"
echo "  : $8"
echo "  : $9"
echo "  : ${10}"
echo "  : ${11}"
echo "  : ${12}"
echo "  : ${13}"
echo "  : ${14}"

echo "  : ${15}"
echo "  : ${16}"
echo "  : ${17}"
echo "  : ${18}"
echo "  : ${19}"
echo "  : ${20}"
echo "  : ${21}"
echo "  : ${22}"
echo "  : ${23}"
echo "  : ${24}"
echo "  : ${25}"
echo "  : ${26}"
echo "  : ${27}"
echo "  : ${28}"
echo "  : ${29}"
echo "  : ${30}"

echo "================= RECEIVED ARGUMENTS ================="
echo "================= RECEIVED ARGUMENTS ================="

database_to_database - multi_tables
====================================
[20:56:21] ================= RECEIVED ARGUMENTS =================
[20:56:21] : --comparison-type-select=database-to-database
[20:56:21] : --table_mode=multi
[20:56:21] : --comparison_source_type=Oracle
[20:56:21] : --comparison_source_host=oracle-server.local
[20:56:21] : --comparison_source_port=1521
[20:56:21] : --comparison_source_database=ORCL
[20:56:21] : --comparison_source_username=oracle_user
[20:56:21] : --comparison_source_password=123
[20:56:21] : --source_excel_file=source.xlsx
[20:56:21] : --comparison_target_type=Hive
[20:56:21] : --comparison_target_host=hive:host
[20:56:21] : --comparison_target_port=10000
[20:56:21] : --comparison_target_database=dsas_raw
[20:56:21] : --comparison_target_username=test
[20:56:21] : --comparison_target_password=123
[20:56:21] : --target_excel_file=target.xlsx
[20:56:21] : --comparison_unix_host=ec2-44-200-184-241.compute-1.amazonaws.com
[20:56:21] : --comparison_user_email=chandu5012@gmail.com
[20:56:21] : --comparison_batch_id=etldsacd
[20:56:21] : --comparison_unix_username=chandra
[20:56:21] : --comparison_unix_password=chandra
[20:56:21] : --time_zone=N/A
[20:56:21] : --comparison_type=database-to-database
[20:56:21] : --source_sql_query=select * from test_1
[20:56:21] : --source_table_name=test_1
[20:56:21] : --source_key_columns=id
[20:56:21] : --target_sql_query=select * from test_1
[20:56:21] : --target_table_name=test_1
[20:56:21] : --target_key_columns=id
[20:56:21] : --row_index=2
[20:56:21] ================= RECEIVED ARGUMENTS =================

database_to_database - single_table
====================================
[21:07:04] ================= RECEIVED ARGUMENTS =================
[21:07:04] : --comparison-type-select=database-to-database
[21:07:04] : --table_mode=single
[21:07:04] : --comparison_source_type=Oracle
[21:07:04] : --comparison_source_host=oracle-server.local
[21:07:04] : --comparison_source_port=1521
[21:07:04] : --comparison_source_database=ORCL
[21:07:04] : --comparison_source_username=oracle_user
[21:07:04] : --comparison_source_table_name=test_tab
[21:07:04] : --comparison_source_primary_key=id
[21:07:04] : --comparison_source_sql_query=select * from tab
[21:07:04] : --comparison_target_type=Hive
[21:07:04] : --comparison_target_host=hive:host
[21:07:04] : --comparison_target_port=10000
[21:07:04] : --comparison_target_database=dsas_raw
[21:07:04] : --comparison_target_username=test
[21:07:04] : --comparison_target_table_name=test_tab
[21:07:04] : --comparison_target_primary_key=id
[21:07:04] : --comparison_target_sql_query=select * from emp
[21:07:04] : --comparison_time_zone=N/A
[21:07:04] : --comparison_unix_host=ec2-44-200-184-241.compute-1.amazonaws.com
[21:07:04] : --comparison_user_email=chandu5012@gmail.com
[21:07:04] : --comparison_batch_id=etldsacd
[21:07:04] : --comparison_unix_username=chandra
[21:07:04] : --comparison_unix_password=chandra
[21:07:04] : --time_zone=N/A
[21:07:04] : --comparison_type=database-to-database
[21:07:04] : --source_file_sql_query=N/A
[21:07:04] : --target_file_sql_query=N/A
[21:07:04] :
[21:07:04] :
[21:07:04] ================= RECEIVED ARGUMENTS =================

file_to_database - single_table
====================================
[21:15:24] ================= RECEIVED ARGUMENTS =================
[21:15:24] ================= RECEIVED ARGUMENTS =================
[21:15:24] : --comparison-type-select=file-to-database
[21:15:24] : --table_mode=single
[21:15:24] : --comparison_source_file_type=csv
[21:15:24] : --comparison_source_location_type=unix
[21:15:24] : --comparison_source_unix_path=/path/csv
[21:15:24] : --comparison_source_delimiter=|
[21:15:24] : --comparison_source_file_sql_query=select * from emp
[21:15:24] : --comparison_source_key_columns=id
[21:15:24] : --comparison_target_type=Oracle
[21:15:24] : --comparison_target_host=sqlserver://localhost:$external-#internal-@normal%itisok
[21:15:24] : --comparison_target_port=1234
[21:15:24] : --comparison_target_database=test_db
[21:15:24] : --comparison_target_username=test
[21:15:24] : --comparison_target_password=123
[21:15:24] : --comparison_target_table_name=test_tab
[21:15:24] : --comparison_target_primary_key=id
[21:15:24] : --comparison_target_sql_query=select * from emp
[21:15:24] : --comparison_time_zone=N/A
[21:15:24] : --comparison_unix_host=ec2-44-200-184-241.compute-1.amazonaws.com
[21:15:24] : --comparison_user_email=GUJJARI0918@GMAIL.COM
[21:15:24] : --comparison_batch_id=etldsacd
[21:15:24] : --comparison_unix_username=chandra
[21:15:24] : --comparison_unix_password=chandra
[21:15:24] : --key_columns=id
======================

database_to_file - single_table
====================================

[21:20:49] ================= RECEIVED ARGUMENTS =================
[21:20:49] ================= RECEIVED ARGUMENTS =================
[21:20:49] : --comparison_source_type=Oracle
[21:20:49] : --comparison_source_host=sqlserver://localhost:$external-#internal-@normal%itisok
[21:20:49] : --comparison_source_port=1234
[21:20:49] : --comparison_source_database=test_db
[21:20:49] : --comparison_source_username=test
[21:20:49] : --comparison_source_password=1213
[21:20:49] : --comparison_source_table_name=system
[21:20:49] : --comparison_source_primary_key=id
[21:20:49] : --comparison_source_sql_query=select * from emp
[21:20:49] : --comparison_target_file_type=csv
[21:20:49] : --comparison_target_location_type=hadoop
[21:20:49] : --comparison_target_hadoop_path=/hadoop/
[21:20:49] : --comparison_target_delimiter=|
[21:20:49] : --comparison_target_file_sql_query=select * from emp
[21:20:49] : --comparison_target_key_columns=id
[21:20:49] : --comparison_time_zone=N/A
[21:20:49] : --comparison_unix_host=ec2-44-200-184-241.compute-1.amazonaws.com
[21:20:49] : --comparison_user_email=GUJJARI0918@GMAIL.COM
[21:20:49] : --comparison_batch_id=etldsacd
[21:20:49] : --comparison_unix_username=chandra
[21:20:49] : --comparison_unix_password=chandra
[21:20:49] : --key_columns=id
[21:20:49] : --target_hadoop_path=/hadoop/
[21:20:49] : --target_location_type=hadoop
[21:20:49] : --target_file_sql_query=select * from emp
[21:20:49] : --time_zone=N/A
[21:20:49] : --comparison_type=database-to-file
[21:20:49] : --source_file_sql_query=N/A
[21:20:49] ================= RECEIVED ARGUMENTS =================

file_to_file - single_table
====================================
[21:26:21] ================= RECEIVED ARGUMENTS =================
[21:26:21] : --comparison-type-select=file-to-file
[21:26:21] : --table_mode=single
[21:26:21] : --comparison_source_file_type=excel
[21:26:21] : --comparison_source_location_type=upload
[21:26:21] : --comparison_source_file_upload=machine-readable-business-employment-data-dec-2024-quarter.csv
[21:26:21] : --comparison_source_delimiter=,
[21:26:21] : --comparison_source_file_sql_query=select * from emp
[21:26:21] : --comparison_target_file_type=csv
[21:26:21] : --comparison_target_location_type=unix
[21:26:21] : --comparison_target_unix_path=/path/path.csv
[21:26:21] : --comparison_target_delimiter=,
[21:26:21] : --comparison_target_key_columns=id
[21:26:21] : --comparison_time_zone=N/A
[21:26:21] : --comparison_unix_host=ec2-44-200-184-241.compute-1.amazonaws.com
[21:26:21] : --comparison_user_email=GUJJARI0918@GMAIL.COM
[21:26:21] : --comparison_batch_id=etldsacd
[21:26:21] : --comparison_unix_username=chandra
[21:26:21] : --comparison_unix_password=chandra
[21:26:21] : --key_columns=id
[21:26:21] : --source_location_type=upload
[21:26:21] : --target_unix_path=/path/path.csv
[21:26:21] : --target_location_type=unix
[21:26:21] : --source_file_sql_query=select * from emp
[21:26:21] : --target_file_sql_query=N/A
[21:26:21] : --time_zone=N/A
[21:26:21] : --comparison_type=file-to-file
[21:26:21] :
[21:26:21] :
[21:26:21] :
[21:26:21] :
[21:26:21] ================= RECEIVED ARGUMENTS =================

Data Load -- 
====================================
[21:39:49] ================= RECEIVED ARGUMENTS =================
[21:39:49] : --load_source_type=Oracle
[21:39:49] : --load_source_host=sqlserver://localhost
[21:39:49] : --load_source_port=1234
[21:39:49] : --load_source_database=test
[21:39:49] : --load_source_username=system
[21:39:49] : --load_source_password=1233
[21:39:49] : --load_source_table_name=test_db
[21:39:49] : --load_source_primary_key=id
[21:39:49] : --load_source_sql_query=select * from emp
[21:39:49] : --load_target_type=Hive
[21:39:49] : --load_target_host=hive:host
[21:39:49] : --load_target_port=10000
[21:39:49] : --load_target_database=test
[21:39:49] : --load_target_username=system
[21:39:49] : --load_target_password=12223
[21:39:49] : --load_target_table_name=test_db
[21:39:49] : --load_target_primary_key=id
[21:39:49] : --load_target_sql_query=select * from emp
[21:39:49] : --load_target_load_type=overwrite
[21:39:49] : --load_target_hadoop_path=/datalke/hadoop/raw/db_type
[21:39:49] : --load_target_partition_id=id
[21:39:49] : --load_time_zone=N/A
[21:39:49] : --load_unix_host=ec2-44-200-184-241.compute-1.amazonaws.com
[21:39:49] : --load_user_email=GUJJARI0918@GMAIL.COM
[21:39:49] : --load_batch_id=etldsacd
[21:39:49] : --load_unix_username=chandra
[21:39:49] : --load_unix_password=chandra
[21:39:49] : --time_zone=N/A
[21:39:49] : --target_load_type=overwrite
[21:39:49] : --hadoop_path=/datalke/hadoop/raw/db_type
[21:39:49] : --partition_id=id
[21:39:49] : --table_mode=single
[21:39:49] : --source_file_sql_query=N/A
[21:39:49] ================= RECEIVED ARGUMENTS =================

File to Database:
[10:19:49] ================= RECEIVED ARGUMENTS =================
[10:19:49] : --fileload_source_file_type=csv
[10:19:49] : --fileload_source_location_type=unix
[10:19:49] : --fileload_source_unix_path=/path/csv/
[10:19:49] : --fileload_source_delimiter=,
[10:19:49] : --fileload_source_file_sql_query=select * from emp
[10:19:49] : --fileload_source_key_columns=id
[10:19:49] : --fileload_target_type=Hive
[10:19:49] : --fileload_target_host=123
[10:19:49] : --fileload_target_port=111
[10:19:49] : --fileload_target_database=222
[10:19:49] : --fileload_target_username=122
[10:19:49] : --fileload_target_password=jjk
[10:19:49] : --fileload_target_table_name=122
[10:19:49] : --fileload_target_primary_key=211
[10:19:49] : --fileload_target_sql_query=select * from emp
[10:19:49] : --fileload_target_load_type=overwrite
[10:19:49] : --fileload_target_hadoop_path=/tmp/in
[10:19:49] : --fileload_target_partition_id=partition
[10:19:49] : --fileload_time_zone=N/A
[10:19:49] : --fileload_unix_host=ec2-44-200-184-241.compute-1.amazonaws.com
[10:19:49] : --fileload_user_email=GUJJARI0918@GMAIL.COM
[10:19:49] : --fileload_batch_id=etldsacd
[10:19:49] : --fileload_unix_username=chandra
[10:19:49] : --fileload_unix_password=chandra
[10:19:49] : --time_zone=N/A
[10:19:49] : --source_file_type=csv
[10:19:49] : --source_location_type=unix
[10:19:49] : --source_unix_path=/path/csv/
[10:19:49] : --source_delimiter=,
[10:19:49] : --source_file_sql_query=select * from emp
[10:19:49] : --source_key_columns=id
[10:19:49] : --target_load_type=overwrite
[10:19:49] : --hadoop_path=/tmp/in
[10:19:49] ================= RECEIVED ARGUMENTS =================


File Download - File
[10:23:07] ================= RECEIVED ARGUMENTS =================
[10:23:07] : --filedownload_source_file_type=CSV
[10:23:07] : --filedownload_source_delimiter=|
[10:23:07] : --filedownload_source_location_type=unix
[10:23:07] : --filedownload_source_unix_path=/csv/path/
[10:23:07] : --filedownload_source_key_columns=id
[10:23:07] : --filedownload_source_sql_query=select * from emp
[10:23:07] : --filedownload_target_file_type=CSV
[10:23:07] : --filedownload_target_delimiter=,
[10:23:07] : --filedownload_target_file_name=test_tab,csv
[10:23:07] : --filedownload_target_number_of_rows=10000
[10:23:07] : --filedownload_unix_host=ec2-44-200-184-241.compute-1.amazonaws.com
[10:23:07] : --filedownload_user_email=GUJJARI0918@GMAIL.COM
[10:23:07] : --filedownload_batch_id=etldsacd
[10:23:07] : --filedownload_unix_username=chandra
[10:23:07] : --filedownload_unix_password=chandra
[10:23:07] : --source_type=file
[10:23:07] : --target_file_name=test_tab,csv
[10:23:07] : --number_of_rows=10000
[10:23:07] : --target_file_type=CSV
[10:23:07] : --target_delimiter=,
[10:23:07] : --time_zone=N/A
[10:23:07] : --source_file_sql_query=N/A
[10:23:07] : --target_file_sql_query=N/A
[10:23:07] :
[10:23:07] :
[10:23:07] :
[10:23:07] :
[10:23:07] :
[10:23:07] :
[10:23:07] :
[10:23:07] :
[10:23:07] :
[10:23:07] ================= RECEIVED ARGUMENTS =================

File Download - Database
[10:27:16] ================= RECEIVED ARGUMENTS =================
[10:27:16] : --filedownload_source_type=Oracle
[10:27:16] : --filedownload_source_host=lllll
[10:27:16] : --filedownload_source_port=122
[10:27:16] : --filedownload_source_database=111
[10:27:16] : --filedownload_source_username=1222
[10:27:16] : --filedownload_source_password=1234
[10:27:16] : --filedownload_source_table_name=1222
[10:27:16] : --filedownload_source_primary_key=12122
[10:27:16] : --filedownload_source_sql_query=select * from emp
[10:27:16] : --filedownload_target_file_type=CSV
[10:27:16] : --filedownload_target_delimiter=,
[10:27:16] : --filedownload_target_file_name=test_tab,csv
[10:27:16] : --filedownload_target_number_of_rows=1000
[10:27:16] : --filedownload_unix_host=ec2-44-200-184-241.compute-1.amazonaws.com
[10:27:16] : --filedownload_user_email=GUJJARI0918@GMAIL.COM
[10:27:16] : --filedownload_batch_id=etldsacd
[10:27:16] : --filedownload_unix_username=chandra
[10:27:16] : --filedownload_unix_password=chandra
[10:27:16] : --source_type=database
[10:27:16] : --target_file_name=test_tab,csv
[10:27:16] : --number_of_rows=1000
[10:27:16] : --target_file_type=CSV
[10:27:16] : --target_delimiter=,
[10:27:16] : --time_zone=N/A
[10:27:16] : --source_file_sql_query=N/A
[10:27:16] : --target_file_sql_query=N/A
[10:27:16] :
[10:27:16] :
[10:27:16] :
[10:27:16] :
[10:27:16] :
[10:27:16] :
[10:27:16] :
[10:27:16] ================= RECEIVED ARGUMENTS =================

Schema Generation:
[10:30:30] ================= RECEIVED ARGUMENTS =================
[10:30:30] : --schema_source_type=Oracle
[10:30:30] : --schema_source_host=jkkkk
[10:30:30] : --schema_source_port=4555
[10:30:30] : --schema_source_database=uiii
[10:30:30] : --schema_source_username=ooo
[10:30:30] : --schema_source_password=aaaa
[10:30:30] : --schema_source_schema_mode=single
[10:30:30] : --schema_source_table_name=test
[10:30:30] : --schema_target_type=PostgreSQL
[10:30:30] : --schema_target_host=llll
[10:30:30] : --schema_target_port=7888
[10:30:30] : --schema_target_database=kkkk
[10:30:30] : --schema_target_username=ppp
[10:30:30] : --schema_target_password=aaaa
[10:30:30] : --schema_target_output_file_name=schema_output.sql
[10:30:30] : --schema_unix_host=ec2-44-200-184-241.compute-1.amazonaws.com
[10:30:30] : --schema_user_email=GUJJARI0918@GMAIL.COM
[10:30:30] : --schema_batch_id=etldsacd
[10:30:30] : --schema_unix_username=chandra
[10:30:30] : --schema_unix_password=chandra
[10:30:30] : --time_zone=N/A
[10:30:30] : --schema_mode=single
[10:30:30] : --output_file_name=schema_output.sql
[10:30:30] : --source_file_sql_query=N/A
[10:30:30] : --target_file_sql_query=N/A
[10:30:30] :
[10:30:30] :
[10:30:30] :
[10:30:30] :
[10:30:30] :
[10:30:30] :
[10:30:30] :
[10:30:30] :

[10:30:30] ================= RECEIVED ARGUMENTS =================
[10:32:24] ================= RECEIVED ARGUMENTS =================
[10:32:24] : --tab=schema_generation
[10:32:24] : --schema_mode=multiple
[10:32:24] : --output_file_name=schema_output.sql
[10:32:24] : --schema_source_type=Oracle
[10:32:24] : --schema_source_host=jkkkk
[10:32:24] : --schema_source_port=4555
[10:32:24] : --schema_source_database=uiii
[10:32:24] : --schema_source_username=ooo
[10:32:24] : --schema_source_password=aaaa
[10:32:24] : --schema_source_schema_mode=multiple
[10:32:24] : --schema_source_table_name=test
[10:32:24] : --schema_target_type=PostgreSQL
[10:32:24] : --schema_target_host=llll
[10:32:24] : --schema_target_port=7888
[10:32:24] : --schema_target_database=kkkk
[10:32:24] : --schema_target_username=ppp
[10:32:24] : --schema_target_password=aaaa
[10:32:24] : --schema_target_output_file_name=schema_output.sql
[10:32:24] : --schema_unix_host=ec2-44-200-184-241.compute-1.amazonaws.com
[10:32:24] : --schema_user_email=GUJJARI0918@GMAIL.COM
[10:32:24] : --schema_batch_id=etldsacd
[10:32:24] : --schema_unix_username=chandra
[10:32:24] : --schema_unix_password=chandra
[10:32:24] : --time_zone=N/A
[10:32:24] : --schema_source_table_list_path=/tmp/Lovable.txt
[10:32:24] : --source_file_sql_query=N/A
[10:32:24] : --target_file_sql_query=N/A
[10:32:24] :
[10:32:24] :
[10:32:24] :
[10:32:24] :
[10:32:24] :
[10:32:24] :
[10:32:24] ================= RECEIVED ARGUMENTS =================
[10:32:24] ================= RECEIVED ARGUMENTS =================
[10:32:24] ðŸ”Œ Unix server connection closed








[18:49:51] ================= RECEIVED ARGUMENTS =================
[18:49:51] : --run_id=mismatch_268ac90a56e2
[18:49:51] : --source_db_type=Oracle
[18:49:51] : --source_host=1111
[18:49:51] : --source_port=111
[18:49:51] : --source_database=111
[18:49:51] : --source_username=11
[18:49:51] : --source_password=11
[18:49:51] : --source_table=11
[18:49:51] : --source_pk=11
[18:49:51] : --source_sql=11
[18:49:51] : --target_db_type=Oracle
[18:49:51] : --target_host=111
[18:49:51] : --target_port=11
[18:49:51] : --target_database=11
[18:49:51] : --target_username=11
[18:49:51] : --target_password=11
[18:49:51] : --target_table=11
[18:49:51] : --target_pk=11
[18:49:51] : --target_sql=11
[18:49:51] : --trim_spaces=true
[18:49:51] : --ignore_case=false
[18:49:51] : --null_equals_empty=true
[18:49:51] : --numeric_tolerance=0
[18:49:51] : --time_zone=N/A
[18:49:51] :
[18:49:51] :
[18:49:51] :
[18:49:51] :
[18:49:51] :
[18:49:51] :
[18:49:51] :
[18:49:51] :
[18:49:51] :
[18:49:51] ================= RECEIVED ARGUMENTS =================










